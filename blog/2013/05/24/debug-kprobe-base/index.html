
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Linux内核kprobe机制 - kk Blog —— 通用基础</title>

  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="kk Blog —— 通用基础" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/category.js" type="text/javascript"></script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kk Blog —— 通用基础</a></h1>
  
    <h2>cp -rf * .</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
<li>
<form action="/search" method="get">
    <input class="search" name="query" id="query" type="text" placeholder="search...">
    <input id="btnSubmit" value="search" type="submit">
</form>
<script type="text/javascript">
var query = GetRequest("query");
if (query != null) {
	document.getElementById("query").value = query;
}
</script>
</li>
  <li><a href="/atom.xml" rel="subscribe-rss">RSS</a></li>
  
</ul>
  
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/download">Download</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h2 class="entry-title">Linux内核kprobe机制</h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-05-24T10:22:00+08:00'><span class='date'>2013-05-24</span> <span class='time'>10:22:00</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><ul>
<li>探测点处理函数在运行时是失效抢占的，依赖于特定的架构，探测点处理函数运行时也可能是中断失效的。</li>
<li><p>因此，对于任何探测点处理函数，不要使用导致睡眠或进程调度的任何内核函数（如尝试获得semaphore)。</p>

<p>Kprobe机制是内核提供的一种调试机制，它提供了一种方法，能够在不修改现有代码的基础上，灵活的跟踪内核函数的执行。它的基本工作原理是：用户指定一个探测点，并把一个用户定义的处理函数关联到该探测点，当内核执行到该探测点时，相应的关联函数被执行，然后继续执行正常的代码路径。</p>

<p>Kprobe提供了三种形式的探测点，一种是最基本的kprobe，能够在指定代码执行前、执行后进行探测，但此时不能访问被探测函数内的相关变量信 息；一种是jprobe，用于探测某一函数的入口，并且能够访问对应的函数参数；一种是kretprobe，用于完成指定函数返回值的探测功能。其中最基 本的就是kprobe机制，jprobe以及kretprobe的实现都依赖于kprobe，但其代码的实现都很巧妙，强烈建议每一个内核爱好者阅读。</p></li>
</ul>


<h4>代码：</h4>

<h5>首先是struct kprobe结构，每一个探测点的基本结构。</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>structkprobe {
</span><span class='line'>&#9;/*用于保存kprobe的全局hash表，以被探测的addr为key*/
</span><span class='line'>&#9;structhlist_node hlist;
</span><span class='line'>
</span><span class='line'>&#9;/* list of kprobes for multi-handler support */
</span><span class='line'>&#9;/*当对同一个探测点存在多个探测函数时，所有的函数挂在这条链上*/
</span><span class='line'>&#9;structlist_head list;
</span><span class='line'>
</span><span class='line'>&#9;/*count the number of times this probe was temporarily disarmed */
</span><span class='line'>&#9;unsigned longnmissed;
</span><span class='line'>
</span><span class='line'>&#9;/* location of the probe point */
</span><span class='line'>&#9;/*被探测的目标地址*/
</span><span class='line'>&#9;kprobe_opcode_t *addr;
</span><span class='line'>
</span><span class='line'>&#9;/* Allow user to indicate symbol name of the probe point */
</span><span class='line'>&#9;/*symblo_name的存在，允许用户指定函数名而非确定的地址*/
</span><span class='line'>&#9;constchar*symbol_name;
</span><span class='line'>
</span><span class='line'>&#9;/* Offset into the symbol */
</span><span class='line'>&#9;/*如果被探测点为函数内部某个指令，需要使用addr + offset的方式*/
</span><span class='line'>&#9;unsigned intoffset;
</span><span class='line'>
</span><span class='line'>&#9;/* Called before addr is executed. */
</span><span class='line'>&#9;/*探测函数，在目标探测点执行之前调用*/
</span><span class='line'>&#9;kprobe_pre_handler_t pre_handler;
</span><span class='line'>
</span><span class='line'>&#9;/* Called after addr is executed, unless... */
</span><span class='line'>&#9;/*探测函数，在目标探测点执行之后调用*/
</span><span class='line'>&#9;kprobe_post_handler_t post_handler;
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * ... called if executing addr causes a fault (eg. page fault).
</span><span class='line'>&#9; * Return 1 if it handled fault, otherwise kernel will see it.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;kprobe_fault_handler_t fault_handler;
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * ... called if breakpoint trap occurs in probe handler.
</span><span class='line'>&#9; * Return 1 if it handled break, otherwise kernel will see it.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;kprobe_break_handler_t break_handler;
</span><span class='line'>
</span><span class='line'>&#9;/*opcode 以及 ainsn 用于保存被替换的指令码*/
</span><span class='line'>
</span><span class='line'>&#9;/* Saved opcode (which has been replaced with breakpoint) */
</span><span class='line'>&#9;kprobe_opcode_t opcode;
</span><span class='line'>
</span><span class='line'>&#9;/* copy of the original instruction */
</span><span class='line'>&#9;structarch_specific_insn ainsn;
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * Indicates various status flags.
</span><span class='line'>&#9; * Protected by kprobe_mutex after this kprobe is registered.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;u32 flags;
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>  对于kprobe功能的实现主要利用了内核中的两个功能特性：异常（尤其是int 3），单步执行（EFLAGS中的TF标志）。</p>

<h5>大概的流程：</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> 1）在注册探测点的时候，对被探测函数的指令码进行替换，替换为int 3的指令码；
</span><span class='line'> 2）在执行int 3的异常执行中，通过通知链的方式调用kprobe的异常处理函数；
</span><span class='line'> 3）在kprobe的异常出来函数中，判断是否存在pre_handler钩子，存在则执行；
</span><span class='line'> 4）执行完后，准备进入单步调试，通过设置EFLAGS中的TF标志位，并且把异常返回的地址修改为保存的原指令码；
</span><span class='line'> 5）代码返回，执行原有指令，执行结束后触发单步异常；
</span><span class='line'> 6）在单步异常的处理中，清除单步标志，执行post_handler流程，并最终返回；</span></code></pre></td></tr></table></div></figure>


<p>  下面又进入代码时间，首先看一下kprobe模块的初始化代码，初始化代码主要做了两件事：标记出哪些代码是不能被探测的，这些代码属于kprobe实现的关键代码；注册通知链到die_notifier，用于接收异常通知。</p>

<h5>初始化代码位于kernel/kprobes.c中</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staticint__init init_kprobes(void)
</span><span class='line'>{
</span><span class='line'>&#9;inti,err =0;
</span><span class='line'>&#9;&#9;....
</span><span class='line'>
</span><span class='line'>&#9; /*kprobe_blacklist中保存的是kprobe实现的关键代码路径，这些函数不应该被kprobe探测*/
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * Lookup and populate the kprobe_blacklist.
</span><span class='line'>&#9; *
</span><span class='line'>&#9; * Unlike the kretprobe blacklist, we'll need to determine
</span><span class='line'>&#9; * the range of addresses that belong to the said functions,
</span><span class='line'>&#9; * since a kprobe need not necessarily be at the beginning
</span><span class='line'>&#9; * of a function.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;for(kb =kprobe_blacklist;kb-&gt;name!=NULL;kb++){
</span><span class='line'>&#9;&#9;kprobe_lookup_name(kb-&gt;name,addr);
</span><span class='line'>&#9;&#9;if(!addr)
</span><span class='line'>&#9;&#9;&#9;continue;
</span><span class='line'>
</span><span class='line'>&#9;&#9;kb-&gt;start_addr =(unsigned long)addr;
</span><span class='line'>&#9;&#9;symbol_name =kallsyms_lookup(kb-&gt;start_addr,
</span><span class='line'>&#9;&#9;&#9;&#9;&size,&offset,&modname,namebuf);
</span><span class='line'>&#9;&#9;if(!symbol_name)
</span><span class='line'>&#9;&#9;&#9;kb-&gt;range =0;
</span><span class='line'>&#9;&#9;else
</span><span class='line'>&#9;&#9;&#9;kb-&gt;range =size;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;&#9;....
</span><span class='line'>&#9;if(!err)
</span><span class='line'>&#9;&#9;/*注册通知链到die_notifier，用于接收int 3的异常信息*/
</span><span class='line'>&#9;&#9;err =register_die_notifier(&kprobe_exceptions_nb);
</span><span class='line'>&#9;&#9; ....
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h5>其中的通知链：</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staticstructnotifier_block kprobe_exceptions_nb ={
</span><span class='line'>&#9;.notifier_call =kprobe_exceptions_notify,
</span><span class='line'>&#9;/*优先级最高，保证最先执行*/
</span><span class='line'>&#9;.priority =0x7fffffff /* we need to be notified first */
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<h6>kprobe的注册流程register_kprobe。</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int__kprobes register_kprobe(structkprobe *p)
</span><span class='line'>{
</span><span class='line'>&#9;intret =0;
</span><span class='line'>&#9;structkprobe *old_p;
</span><span class='line'>&#9;structmodule *probed_mod;
</span><span class='line'>&#9;kprobe_opcode_t *addr;
</span><span class='line'>
</span><span class='line'>&#9;/*获取被探测点的地址，指定了symbol_name，则从kallsyms中获取；指定了offset，则返回addr + offset*/
</span><span class='line'>&#9;addr =kprobe_addr(p);
</span><span class='line'>&#9;if(!addr)
</span><span class='line'>&#9;&#9;return-EINVAL;
</span><span class='line'>&#9;p-&gt;addr =addr;
</span><span class='line'>
</span><span class='line'>&#9;/*判断同一个kprobe是否被重复注册*/
</span><span class='line'>&#9;ret =check_kprobe_rereg(p);
</span><span class='line'>&#9;if(ret)
</span><span class='line'>&#9;&#9;returnret;
</span><span class='line'>
</span><span class='line'>&#9;jump_label_lock();
</span><span class='line'>&#9;preempt_disable();
</span><span class='line'>&#9;/*判断被注册的函数是否位于内核的代码段内，或位于不能探测的kprobe实现路径中*/
</span><span class='line'>&#9;if(!kernel_text_address((unsigned long)p-&gt;addr)||
</span><span class='line'>&#9;&#9;in_kprobes_functions((unsigned long)p-&gt;addr)||
</span><span class='line'>&#9;&#9;ftrace_text_reserved(p-&gt;addr,p-&gt;addr)||
</span><span class='line'>&#9;&#9;jump_label_text_reserved(p-&gt;addr,p-&gt;addr))
</span><span class='line'>&#9;&#9;gotofail_with_jump_label;
</span><span class='line'>
</span><span class='line'>&#9;/* User can pass only KPROBE_FLAG_DISABLED to register_kprobe */
</span><span class='line'>&#9;p-&gt;flags&=KPROBE_FLAG_DISABLED;
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * Check if are we probing a module.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;/*判断被探测的地址是否属于某一个模块，并且位于模块的text section内*/
</span><span class='line'>&#9;probed_mod =__module_text_address((unsigned long)p-&gt;addr);
</span><span class='line'>&#9;if(probed_mod){
</span><span class='line'>&#9;&#9;/*如果被探测的为模块地址，首先要增加模块的引用计数*/
</span><span class='line'>&#9;&#9;/*
</span><span class='line'>&#9;&#9; * We must hold a refcount of the probed module while updating
</span><span class='line'>&#9;&#9; * its code to prohibit unexpected unloading.
</span><span class='line'>&#9;&#9; */
</span><span class='line'>&#9;&#9;if(unlikely(!try_module_get(probed_mod)))
</span><span class='line'>&#9;&#9;&#9;gotofail_with_jump_label;
</span><span class='line'>
</span><span class='line'>&#9;&#9;/*
</span><span class='line'>&#9;&#9; * If the module freed .init.text, we couldn't insert
</span><span class='line'>&#9;&#9; * kprobes in there.
</span><span class='line'>&#9;&#9; */
</span><span class='line'>&#9;&#9;/*如果被探测的地址位于模块的init地址段内，但该段代码区间已被释放，则直接退出*/
</span><span class='line'>&#9;&#9;if(within_module_init((unsigned long)p-&gt;addr,probed_mod)&&
</span><span class='line'>&#9;&#9;&#9;probed_mod-&gt;state!=MODULE_STATE_COMING){
</span><span class='line'>&#9;&#9;&#9;module_put(probed_mod);
</span><span class='line'>&#9;&#9;&#9;gotofail_with_jump_label;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;preempt_enable();
</span><span class='line'>&#9;jump_label_unlock();
</span><span class='line'>
</span><span class='line'>&#9;p-&gt;nmissed =0;
</span><span class='line'>&#9;INIT_LIST_HEAD(&p-&gt;list);
</span><span class='line'>&#9;mutex_lock(&kprobe_mutex);
</span><span class='line'>
</span><span class='line'>&#9;jump_label_lock();/* needed to call jump_label_text_reserved() */
</span><span class='line'>
</span><span class='line'>&#9;get_online_cpus();    /* For avoiding text_mutex deadlock. */
</span><span class='line'>&#9;mutex_lock(&text_mutex);
</span><span class='line'>
</span><span class='line'>&#9;/*判断在同一个探测点是否已经注册了其他的探测函数*/
</span><span class='line'>&#9;old_p =get_kprobe(p-&gt;addr);
</span><span class='line'>&#9;if(old_p){
</span><span class='line'>&#9;&#9;/* Since this may unoptimize old_p, locking text_mutex. */
</span><span class='line'>&#9;&#9;/*如果已经存在注册过的kprobe，则将探测点的函数修改为aggr_pre_handler，并将所有的handler挂载到其链表上，由其负责所有handler函数的执行*/
</span><span class='line'>&#9;&#9;ret =register_aggr_kprobe(old_p,p);
</span><span class='line'>&#9;&#9;gotoout;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;/* 分配特定的内存地址用于保存原有的指令
</span><span class='line'>&#9; * 按照内核注释，被分配的地址必须must be on special executable page on x86.
</span><span class='line'>&#9; * 该地址被保存在kprobe-&gt;ainsn.insn
</span><span class='line'>&#9; */
</span><span class='line'>&#9;ret =arch_prepare_kprobe(p);
</span><span class='line'>&#9;if(ret)
</span><span class='line'>&#9;&#9;gotoout;
</span><span class='line'>
</span><span class='line'>&#9;/*将kprobe加入到相应的hash表内*/
</span><span class='line'>&#9;INIT_HLIST_NODE(&p-&gt;hlist);
</span><span class='line'>&#9;hlist_add_head_rcu(&p-&gt;hlist,
</span><span class='line'>&#9;&#9;&#9;   &kprobe_table[hash_ptr(p-&gt;addr,KPROBE_HASH_BITS)]);
</span><span class='line'>
</span><span class='line'>&#9;if(!kprobes_all_disarmed &&!kprobe_disabled(p))
</span><span class='line'>/*将探测点的指令码修改为int 3指令*/
</span><span class='line'>&#9;&#9;__arm_kprobe(p);
</span><span class='line'>
</span><span class='line'>&#9;/* Try to optimize kprobe */
</span><span class='line'>&#9;try_to_optimize_kprobe(p);
</span><span class='line'>
</span><span class='line'>out:
</span><span class='line'>&#9;mutex_unlock(&text_mutex);
</span><span class='line'>&#9;put_online_cpus();
</span><span class='line'>&#9;jump_label_unlock();
</span><span class='line'>&#9;mutex_unlock(&kprobe_mutex);
</span><span class='line'>
</span><span class='line'>&#9;if(probed_mod)
</span><span class='line'>&#9;&#9;module_put(probed_mod);
</span><span class='line'>
</span><span class='line'>&#9;returnret;
</span><span class='line'>
</span><span class='line'>fail_with_jump_label:
</span><span class='line'>&#9;preempt_enable();
</span><span class='line'>&#9;jump_label_unlock();
</span><span class='line'>&#9;return-EINVAL;</span></code></pre></td></tr></table></div></figure>


<h5>注册完毕，就开始kprobe的执行流程了。对于该探测点，由于其起始指令已经被修改为int3，因此在执行到该地址时，必然会触发3号中断向量的处理流程do_int3.</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* May run on IST stack. */
</span><span class='line'>dotraplinkage void__kprobes do_int3(structpt_regs *regs,longerror_code)
</span><span class='line'>{
</span><span class='line'>#ifdef CONFIG_KGDB_LOW_LEVEL_TRAP
</span><span class='line'>&#9;if(kgdb_ll_trap(DIE_INT3,"int3",regs,error_code,3,SIGTRAP)
</span><span class='line'>&#9;&#9;&#9;==NOTIFY_STOP)
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>#endif /* CONFIG_KGDB_LOW_LEVEL_TRAP */
</span><span class='line'>#ifdef CONFIG_KPROBES
</span><span class='line'>&#9;/*在这里以DIE_INT3，通知kprobe注册的通知链*/
</span><span class='line'>&#9;if(notify_die(DIE_INT3,"int3",regs,error_code,3,SIGTRAP)
</span><span class='line'>&#9;&#9;&#9;==NOTIFY_STOP)
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>#else
</span><span class='line'>&#9;if(notify_die(DIE_TRAP,"int3",regs,error_code,3,SIGTRAP)
</span><span class='line'>&#9;&#9;&#9;==NOTIFY_STOP)
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>#endif
</span><span class='line'>
</span><span class='line'>&#9;preempt_conditional_sti(regs);
</span><span class='line'>&#9;do_trap(3,SIGTRAP,"int3",regs,error_code,NULL);
</span><span class='line'>&#9;preempt_conditional_cli(regs);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h5>在do_int3中触发kprobe注册的通知链函数，kprobe_exceptions_notify。由于kprobe以及jprobe等机制的处 理核心都在此函数内，这里只针对kprobe的流程进行分析：进入函数的原因是DIE_INT3,并且是第一次进入该函数。</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int__kprobes kprobe_exceptions_notify(structnotifier_block *self,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;   unsigned longval,void*data)
</span><span class='line'>{
</span><span class='line'>&#9;structdie_args *args =data;
</span><span class='line'>&#9;intret =NOTIFY_DONE;
</span><span class='line'>
</span><span class='line'>&#9;if(args-&gt;regs &&user_mode_vm(args-&gt;regs))
</span><span class='line'>&#9;&#9;returnret;
</span><span class='line'>
</span><span class='line'>&#9;switch(val){
</span><span class='line'>&#9;caseDIE_INT3:
</span><span class='line'>/*对于kprobe，进入kprobe_handle*/
</span><span class='line'>&#9;&#9;if(kprobe_handler(args-&gt;regs))
</span><span class='line'>&#9;&#9;&#9;ret =NOTIFY_STOP;
</span><span class='line'>&#9;&#9;break;
</span><span class='line'>&#9;caseDIE_DEBUG:
</span><span class='line'>&#9;&#9;if(post_kprobe_handler(args-&gt;regs)){
</span><span class='line'>&#9;&#9;&#9;/*
</span><span class='line'>&#9;&#9;&#9; * Reset the BS bit in dr6 (pointed by args-&gt;err) to
</span><span class='line'>&#9;&#9;&#9; * denote completion of processing
</span><span class='line'>&#9;&#9;&#9; */
</span><span class='line'>&#9;&#9;&#9;(*(unsigned long*)ERR_PTR(args-&gt;err))&=~DR_STEP;
</span><span class='line'>&#9;&#9;&#9;ret =NOTIFY_STOP;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;break;
</span><span class='line'>&#9;caseDIE_GPF:
</span><span class='line'>&#9;&#9;/*
</span><span class='line'>&#9;&#9; * To be potentially processing a kprobe fault and to
</span><span class='line'>&#9;&#9; * trust the result from kprobe_running(), we have
</span><span class='line'>&#9;&#9; * be non-preemptible.
</span><span class='line'>&#9;&#9; */
</span><span class='line'>&#9;&#9;if(!preemptible()&&kprobe_running()&&
</span><span class='line'>&#9;&#9;&#9;kprobe_fault_handler(args-&gt;regs,args-&gt;trapnr))
</span><span class='line'>&#9;&#9;&#9;ret =NOTIFY_STOP;
</span><span class='line'>&#9;&#9;break;
</span><span class='line'>&#9;default:
</span><span class='line'>&#9;&#9;break;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;returnret;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>staticint__kprobes kprobe_handler(structpt_regs *regs)
</span><span class='line'>{
</span><span class='line'>&#9;kprobe_opcode_t *addr;
</span><span class='line'>&#9;structkprobe *p;
</span><span class='line'>&#9;structkprobe_ctlblk *kcb;
</span><span class='line'>
</span><span class='line'>&#9;/*对于int 3中断，其被Intel定义为Trap，那么异常发生时EIP寄存器内指向的为异常指令的后一条指令*/
</span><span class='line'>&#9;addr =(kprobe_opcode_t *)(regs-&gt;ip -sizeof(kprobe_opcode_t));
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * We don't want to be preempted for the entire
</span><span class='line'>&#9; * duration of kprobe processing. We conditionally
</span><span class='line'>&#9; * re-enable preemption at the end of this function,
</span><span class='line'>&#9; * and also in reenter_kprobe() and setup_singlestep().
</span><span class='line'>&#9; */
</span><span class='line'>&#9;preempt_disable();
</span><span class='line'>
</span><span class='line'>&#9;kcb =get_kprobe_ctlblk();
</span><span class='line'>&#9;/*获取addr对应的kprobe*/
</span><span class='line'>&#9;p =get_kprobe(addr);
</span><span class='line'>
</span><span class='line'>&#9;if(p){
</span><span class='line'>/*如果异常的进入是由kprobe导致，则进入reenter_kprobe(jprobe需要，到时候分析)*/
</span><span class='line'>&#9;&#9;if(kprobe_running()){
</span><span class='line'>&#9;&#9;&#9;if(reenter_kprobe(p,regs,kcb))
</span><span class='line'>&#9;&#9;&#9;&#9;return1;
</span><span class='line'>&#9;&#9;}else{
</span><span class='line'>&#9;&#9;&#9;set_current_kprobe(p,regs,kcb);
</span><span class='line'>&#9;&#9;&#9;kcb-&gt;kprobe_status =KPROBE_HIT_ACTIVE;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;/*
</span><span class='line'>&#9;&#9;&#9; * If we have no pre-handler or it returned 0, we
</span><span class='line'>&#9;&#9;&#9; * continue with normal processing.  If we have a
</span><span class='line'>&#9;&#9;&#9; * pre-handler and it returned non-zero, it prepped
</span><span class='line'>&#9;&#9;&#9; * for calling the break_handler below on re-entry
</span><span class='line'>&#9;&#9;&#9; * for jprobe processing, so get out doing nothing
</span><span class='line'>&#9;&#9;&#9; * more here.
</span><span class='line'>&#9;&#9;&#9; */
</span><span class='line'>&#9;/*执行在此地址上挂载的pre_handle函数*/
</span><span class='line'>&#9;&#9;&#9;if(!p-&gt;pre_handler ||!p-&gt;pre_handler(p,regs))
</span><span class='line'>/*设置单步调试模式，为post_handle函数的执行做准备*/
</span><span class='line'>&#9;&#9;&#9;&#9;setup_singlestep(p,regs,kcb,0);
</span><span class='line'>&#9;&#9;&#9;return1;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}elseif(*addr !=BREAKPOINT_INSTRUCTION){
</span><span class='line'>&#9;&#9;/*
</span><span class='line'>&#9;&#9; * The breakpoint instruction was removed right
</span><span class='line'>&#9;&#9; * after we hit it.  Another cpu has removed
</span><span class='line'>&#9;&#9; * either a probepoint or a debugger breakpoint
</span><span class='line'>&#9;&#9; * at this address.  In either case, no further
</span><span class='line'>&#9;&#9; * handling of this interrupt is appropriate.
</span><span class='line'>&#9;&#9; * Back up over the (now missing) int3 and run
</span><span class='line'>&#9;&#9; * the original instruction.
</span><span class='line'>&#9;&#9; */
</span><span class='line'>&#9;&#9;regs-&gt;ip =(unsigned long)addr;
</span><span class='line'>&#9;&#9;preempt_enable_no_resched();
</span><span class='line'>&#9;&#9;return1;
</span><span class='line'>&#9;}elseif(kprobe_running()){
</span><span class='line'>&#9;&#9;p =__this_cpu_read(current_kprobe);
</span><span class='line'>&#9;&#9;if(p-&gt;break_handler &&p-&gt;break_handler(p,regs)){
</span><span class='line'>&#9;&#9;&#9;setup_singlestep(p,regs,kcb,0);
</span><span class='line'>&#9;&#9;&#9;return1;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}/* else: not a kprobe fault; let the kernel handle it */
</span><span class='line'>
</span><span class='line'>&#9;preempt_enable_no_resched();
</span><span class='line'>&#9;return0;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>staticvoid__kprobes setup_singlestep(structkprobe *p,structpt_regs *regs,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;   structkprobe_ctlblk *kcb,intreenter)
</span><span class='line'>{
</span><span class='line'>&#9;if(setup_detour_execution(p,regs,reenter))
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>
</span><span class='line'>#if!defined(CONFIG_PREEMPT)
</span><span class='line'>&#9;if(p-&gt;ainsn.boostable ==1 &&!p-&gt;post_handler){
</span><span class='line'>&#9;&#9;/* Boost up -- we can execute copied instructions directly */
</span><span class='line'>&#9;&#9;if(!reenter)
</span><span class='line'>&#9;&#9;&#9;reset_current_kprobe();
</span><span class='line'>&#9;&#9;/*
</span><span class='line'>&#9;&#9; * Reentering boosted probe doesn't reset current_kprobe,
</span><span class='line'>&#9;&#9; * nor set current_kprobe, because it doesn't use single
</span><span class='line'>&#9;&#9; * stepping.
</span><span class='line'>&#9;&#9; */
</span><span class='line'>&#9;&#9;regs-&gt;ip =(unsigned long)p-&gt;ainsn.insn;
</span><span class='line'>&#9;&#9;preempt_enable_no_resched();
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>&#9;}
</span><span class='line'>#endif
</span><span class='line'>&#9;/*jprobe*/
</span><span class='line'>&#9;if(reenter){
</span><span class='line'>&#9;&#9;save_previous_kprobe(kcb);
</span><span class='line'>&#9;&#9;set_current_kprobe(p,regs,kcb);
</span><span class='line'>&#9;&#9;kcb-&gt;kprobe_status =KPROBE_REENTER;
</span><span class='line'>&#9;}else
</span><span class='line'>&#9;&#9;kcb-&gt;kprobe_status =KPROBE_HIT_SS;
</span><span class='line'>&#9;/* Prepare real single stepping */
</span><span class='line'>&#9;/*准备单步模式，设置EFLAGS的TF标志位，清楚IF标志位(禁止中断)*/
</span><span class='line'>&#9;clear_btf();
</span><span class='line'>&#9;regs-&gt;flags|=X86_EFLAGS_TF;
</span><span class='line'>&#9;regs-&gt;flags&=~X86_EFLAGS_IF;
</span><span class='line'>&#9;/* single step inline if the instruction is an int3 */
</span><span class='line'>&#9;if(p-&gt;opcode ==BREAKPOINT_INSTRUCTION)
</span><span class='line'>&#9;&#9;regs-&gt;ip =(unsigned long)p-&gt;addr;
</span><span class='line'>&#9;else
</span><span class='line'>/*设置异常返回的指令为保存的被探测点的指令*/
</span><span class='line'>&#9;&#9;regs-&gt;ip =(unsigned long)p-&gt;ainsn.insn;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h5>对应kprobe,pre_handle的执行就结束了，按照代码，程序开始执行保存的被探测点的指令，由于开启了单步调试模式，执行完指令后会继续触发异常，这次的是do_debug异常处理流程。</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dotraplinkage void__kprobes do_debug(structpt_regs *regs,longerror_code)
</span><span class='line'>{
</span><span class='line'>&#9;....
</span><span class='line'>
</span><span class='line'>&#9;/*在do_debug中，以DIE_DEBUG再一次触发kprobe的通知链*/
</span><span class='line'>&#9;if(notify_die(DIE_DEBUG,"debug",regs,PTR_ERR(&dr6),error_code,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;SIGTRAP)==NOTIFY_STOP)
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>   
</span><span class='line'>&#9;....
</span><span class='line'>&#9;return;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>/*对于kprobe_exceptions_notify，其DIE_DEBUG处理流程*/
</span><span class='line'>caseDIE_DEBUG:
</span><span class='line'>&#9;&#9;if(post_kprobe_handler(args-&gt;regs)){
</span><span class='line'>&#9;&#9;&#9;/*
</span><span class='line'>&#9;&#9;&#9; * Reset the BS bit in dr6 (pointed by args-&gt;err) to
</span><span class='line'>&#9;&#9;&#9; * denote completion of processing
</span><span class='line'>&#9;&#9;&#9; */
</span><span class='line'>&#9;&#9;&#9;(*(unsigned long*)ERR_PTR(args-&gt;err))&=~DR_STEP;
</span><span class='line'>&#9;&#9;&#9;ret =NOTIFY_STOP;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;break;
</span><span class='line'>
</span><span class='line'>staticint__kprobes post_kprobe_handler(structpt_regs *regs)
</span><span class='line'>{
</span><span class='line'>&#9;structkprobe *cur =kprobe_running();
</span><span class='line'>&#9;structkprobe_ctlblk *kcb =get_kprobe_ctlblk();
</span><span class='line'>
</span><span class='line'>&#9;if(!cur)
</span><span class='line'>&#9;&#9;return0;
</span><span class='line'>
</span><span class='line'>&#9;/*设置异常返回的EIP为下一条需要执行的指令*/
</span><span class='line'>&#9;resume_execution(cur,regs,kcb);
</span><span class='line'>&#9;/*恢复异常执行前的EFLAGS*/
</span><span class='line'>&#9;regs-&gt;flags|=kcb-&gt;kprobe_saved_flags;
</span><span class='line'>
</span><span class='line'>&#9;/*执行post_handler函数*/
</span><span class='line'>&#9;if((kcb-&gt;kprobe_status !=KPROBE_REENTER)&&cur-&gt;post_handler){
</span><span class='line'>&#9;&#9;kcb-&gt;kprobe_status =KPROBE_HIT_SSDONE;
</span><span class='line'>&#9;&#9;cur-&gt;post_handler(cur,regs,0);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;/* Restore back the original saved kprobes variables and continue. */
</span><span class='line'>&#9;if(kcb-&gt;kprobe_status ==KPROBE_REENTER){
</span><span class='line'>&#9;&#9;restore_previous_kprobe(kcb);
</span><span class='line'>&#9;&#9;gotoout;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;reset_current_kprobe();
</span><span class='line'>out:
</span><span class='line'>&#9;preempt_enable_no_resched();
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * if somebody else is singlestepping across a probe point, flags
</span><span class='line'>&#9; * will have TF set, in which case, continue the remaining processing
</span><span class='line'>&#9; * of do_debug, as if this is not a probe hit.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;if(regs-&gt;flags&X86_EFLAGS_TF)
</span><span class='line'>&#9;&#9;return0;
</span><span class='line'>
</span><span class='line'>&#9;return1;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>至此，一个典型的kprobe的流程已经执行完毕了。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">kk</span></span>

      




<time class='entry-date' datetime='2013-05-24T10:22:00+08:00'><span class='date'>2013-05-24</span> <span class='time'>10:22:00</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/cats/debug/'>debug</a>, <a class='category' href='/blog/cats/debug~kprobe/'>kprobe</a>
  
</span>


    </p>
    
      
    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/05/23/command-addr2line/" title="Previous Post: addr2line命令">&laquo; addr2line命令</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/05/24/debug-kretprobe/" title="Next Post: Linux内核kretprobe机制">Linux内核kretprobe机制 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>
<aside class="sidebar" id='load_sidebar'>
</aside>
<script type="text/javascript">
  $('#load_sidebar').load('/sidebar.html');
</script>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - kk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <a title="Top" href="#" id="scroll2top" style="position: fixed; height: 50px; bottom: 30px; right: 25px; cursor: pointer; z-index: 9999; display: block; opacity: 1;"><img src="/images/scrollup.png"></a>
  <script src="/javascripts/scroll2top.js"></script>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253604690'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1253604690' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  





</body>
</html>
