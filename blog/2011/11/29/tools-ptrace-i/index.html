
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Playing with ptrace, Part I — 玩转ptrace(一) - kk Blog —— 通用基础</title>

  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="kk Blog —— 通用基础" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/category.js" type="text/javascript"></script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kk Blog —— 通用基础</a></h1>
  
    <h2>慢慢搬迁中......</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
<li>
<form action="/search" method="get">
    <input class="search" name="query" type="text" placeholder="Search..." x-webkit-speech />
    <input id="btnSubmit" value="search" type="submit">
</form>
</li>
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h2 class="entry-title">Playing with ptrace, Part I — 玩转ptrace(一)</h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-11-29T19:20:00+08:00'><span class='date'>2011-11-29</span> <span class='time'>19:20:00</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="http://www.kgdb.info/gdb/playing_with_ptrace_part_i/">原文</a><br/>
版权所有 © 转载时必须以链接形式注明作者和原始出处！</p>

<p> Playing with ptrace, Part I<br/>
by Pradeep Padala <a href="&#x6d;&#97;&#105;&#x6c;&#116;&#111;&#58;&#112;&#95;&#x70;&#97;&#x64;&#x61;&#108;&#97;&#64;&#x79;&#97;&#x68;&#111;&#111;&#x2e;&#99;&#111;&#109;">&#112;&#95;&#x70;&#97;&#x64;&#97;&#x6c;&#x61;&#x40;&#121;&#97;&#x68;&#111;&#111;&#46;&#99;&#111;&#x6d;</a> <a href="http://www.cise.ufl.edu/~ppadala  ">http://www.cise.ufl.edu/~ppadala  </a>
Created 2002-11-01 02:00</p>

<p>翻译: Magic.D E-mail: adamgic@163.com<br/>
译者序：</p>

<p>在开发Hust Online Judge的过程中，查阅了不少资料，关于调试器技术的资料在网上是很少，即便是UNIX编程巨著《UNIX环境高级编程》中，相关内容也不多，直到我在 <a href="http://www.linuxjournal.com">http://www.linuxjournal.com</a> 上找到这篇文章，如获至宝，特翻译之，作为鄙人翻译技术文档的第一次尝试，必定会有不少蹩脚之处，各位就将就一下吧，欢迎大力拍砖。</p>

<p>你想过怎么实现对系统调用的拦截吗？你尝试过通过改变系统调用的参数来愚弄你的系统kernel吗？你想过调试器是如何使运行中的进程暂停并且控制它吗？</p>

<p>你可能会开始考虑怎么使用复杂的kernel编程来达到目的，那么，你错了。实际上Linux提供了一种优雅的机制来完成这些：ptrace系统函数。 ptrace提供了一种使父进程得以监视和控制其它进程的方式，它还能够改变子进程中的寄存器和内核映像，因而可以实现断点调试和系统调用的跟踪。</p>

<p>使用ptrace，你可以在用户层拦截和修改系统调用(sys call)</p>

<p>在这篇文章中，我们将学习如何拦截一个系统调用，然后修改它的参数。在本文的第二部分我们将学习更先进的技术：设置断点，插入代码到一个正在运行的程序中；我们将潜入到机器内部，偷窥和纂改进程的寄存器和数据段。</p>

<h4>基本知识</h4>

<p>操作系统提供了一种标准的服务来让程序员实现对底层硬件和服务的控制（比如文件系统），叫做系统调用(system calls)。当一个程序需要作系统调用的时候，它将相关参数放进系统调用相关的寄存器，然后调用软中断0×80，这个中断就像一个让程序得以接触到内核模式的窗口，程序将参数和系统调用号交给内核，内核来完成系统调用的执行。</p>

<p>在i386体系中(本文中所有的代码都是面向i386体系)，系统调用号将放入%eax,它的参数则依次放入%ebx, %ecx, %edx, %esi 和 %edi。 比如，在以下的调用</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Write(2, “Hello”, 5)</span></code></pre></td></tr></table></div></figure>


<p>的汇编形式大概是这样的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>movl $4, %eax
</span><span class='line'>movl $2, %ebx
</span><span class='line'>movl $hello, %ecx
</span><span class='line'>movl $5, %edx
</span><span class='line'>int $0×80</span></code></pre></td></tr></table></div></figure>


<p>这里的$hello指向的是标准字符串”Hello”。</p>

<p>那么，ptrace会在什么时候出现呢？在执行系统调用之前，内核会先检查当前进程是否处于被“跟踪”(traced)的状态。如果是的话，内核暂停当前进程并将控制权交给跟踪进程，使跟踪进程得以察看或者修改被跟踪进程的寄存器。</p>

<p>让我们来看一个例子，演示这个跟踪程序的过程</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;sys/ptrace.h&gt;
</span><span class='line'>#include &lt;sys/types.h&gt;
</span><span class='line'>#include &lt;sys/wait.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;linux/user.h&gt;   /* For constants
</span><span class='line'>                               ORIG_EAX etc */
</span><span class='line'>int main()
</span><span class='line'>{
</span><span class='line'>    pid_t child;
</span><span class='line'>    long orig_eax;
</span><span class='line'>    child = fork();
</span><span class='line'>    if(child ==0){
</span><span class='line'>        ptrace(PTRACE_TRACEME,0, NULL, NULL);
</span><span class='line'>        execl("/bin/ls","ls", NULL);
</span><span class='line'>    } else {
</span><span class='line'>        wait(NULL);
</span><span class='line'>        orig_eax = ptrace(PTRACE_PEEKUSER,
</span><span class='line'>                      child,4* ORIG_EAX,
</span><span class='line'>                      NULL);
</span><span class='line'>        printf("The child made a "
</span><span class='line'>            "system call %ld\n", orig_eax);
</span><span class='line'>        ptrace(PTRACE_CONT, child, NULL, NULL);
</span><span class='line'>    }
</span><span class='line'>    return0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>运行这个程序，将会在输出ls命令的结果的同时，输出:
The child made a system call 11</p>

<p>说明：11是execve的系统调用号，这是该程序调用的第一个系统调用。<br/>
想知道系统调用号的详细内容，察看 /usr/include/asm/unistd.h。</p>

<p>在以上的示例中，父进程fork出了一个子进程，然后跟踪它。在调用exec函数之前，子进程用PTRACE_TRACEME作为第一个参数调用了 ptrace函数，它告诉内核：让别人跟踪我吧！然后，在子进程调用了execve()之后，它将控制权交还给父进程。当时父进程正使用wait()函数来等待来自内核的通知，现在它得到了通知，于是它可以开始察看子进程都作了些什么，比如看看寄存器的值之类。</p>

<p>出现系统调用之后，内核会将eax中的值（此时存的是系统调用号）保存起来，我们可以使用PTRACE_PEEKUSER作为ptrace的第一个参数来读到这个值。<br/>
我们察看完系统调用的信息后，可以使用PTRACE_CONT作为ptrace的第一个参数，调用ptrace使子进程继续系统调用的过程。<br/>
ptrace函数的参数<br/>
Ptrace有四个参数</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>long ptrace(enum __ptrace_request request,
</span><span class='line'>pid_t pid,
</span><span class='line'>void *addr,
</span><span class='line'>void *data);</span></code></pre></td></tr></table></div></figure>


<p>第一个参数决定了ptrace的行为与其它参数的使用方法，可取的值有:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>PTRACE_ME
</span><span class='line'>PTRACE_PEEKTEXT
</span><span class='line'>PTRACE_PEEKDATA
</span><span class='line'>PTRACE_PEEKUSER
</span><span class='line'>PTRACE_POKETEXT
</span><span class='line'>PTRACE_POKEDATA
</span><span class='line'>PTRACE_POKEUSER
</span><span class='line'>PTRACE_GETREGS
</span><span class='line'>PTRACE_GETFPREGS,
</span><span class='line'>PTRACE_SETREGS
</span><span class='line'>PTRACE_SETFPREGS
</span><span class='line'>PTRACE_CONT
</span><span class='line'>PTRACE_SYSCALL,
</span><span class='line'>PTRACE_SINGLESTEP
</span><span class='line'>PTRACE_DETACH</span></code></pre></td></tr></table></div></figure>


<p>在下文中将对这些常量的用法进行说明。<br/>
读取系统调用的参数</p>

<p>通过将PTRACE_PEEKUSER作为ptrace 的第一个参数进行调用，可以取得与子进程相关的寄存器值。</p>

<p>先看下面这个例子</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;sys/ptrace.h&gt;
</span><span class='line'>#include &lt;sys/types.h&gt;
</span><span class='line'>#include &lt;sys/wait.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;linux/user.h&gt;
</span><span class='line'>#include &lt;sys/syscall.h&gt;   /* For SYS_write etc */
</span><span class='line'>int main()
</span><span class='line'>{
</span><span class='line'>    pid_t child;
</span><span class='line'>    long orig_eax, eax;
</span><span class='line'>    long params[3];
</span><span class='line'>    int status;
</span><span class='line'>    int insyscall =0;
</span><span class='line'>    child = fork();
</span><span class='line'>    if(child ==0){
</span><span class='line'>        ptrace(PTRACE_TRACEME,0, NULL, NULL);
</span><span class='line'>        execl("/bin/ls","ls", NULL);
</span><span class='line'>    } else {
</span><span class='line'>        while(1) {
</span><span class='line'>            wait(&status);
</span><span class='line'>            if(WIFEXITED(status))
</span><span class='line'>            break;
</span><span class='line'>              orig_eax = ptrace(PTRACE_PEEKUSER,
</span><span class='line'>            child,4* ORIG_EAX, NULL);
</span><span class='line'>            if(orig_eax == SYS_write) {
</span><span class='line'>                if(insyscall == 0) {
</span><span class='line'>                    /* Syscall entry */
</span><span class='line'>                        insyscall =1;
</span><span class='line'>                        params[0]= ptrace(PTRACE_PEEKUSER,
</span><span class='line'>                                       child,4* EBX,
</span><span class='line'>                                       NULL);
</span><span class='line'>                        params[1]= ptrace(PTRACE_PEEKUSER,
</span><span class='line'>                                       child,4* ECX,
</span><span class='line'>                                       NULL);
</span><span class='line'>                        params[2]= ptrace(PTRACE_PEEKUSER,
</span><span class='line'>                         child,4* EDX,
</span><span class='line'>                        NULL);
</span><span class='line'>                    printf("Write called with "
</span><span class='line'>                        "%ld, %ld, %ld\n",
</span><span class='line'>                        params[0], params[1],
</span><span class='line'>                        params[2]);
</span><span class='line'>                } else {/* Syscall exit */
</span><span class='line'>                    eax = ptrace(PTRACE_PEEKUSER,
</span><span class='line'>                        child,4* EAX, NULL);
</span><span class='line'>                    printf("Write returned "
</span><span class='line'>                        "with %ld\n", eax);
</span><span class='line'>                            insyscall =0;
</span><span class='line'>                }
</span><span class='line'>            }
</span><span class='line'>            ptrace(PTRACE_SYSCALL,
</span><span class='line'>                child, NULL, NULL);
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    return0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>这个程序的输出是这样的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ppadala@linux:~/ptrace &gt; ls
</span><span class='line'>a.out        dummy.s      ptrace.txt
</span><span class='line'>libgpm.html  registers.c  syscallparams.c
</span><span class='line'>dummy        ptrace.html  simple.c
</span><span class='line'>ppadala@linux:~/ptrace &gt; ./a.out
</span><span class='line'>Write called with 1,1075154944,48
</span><span class='line'>a.out        dummy.s      ptrace.txt
</span><span class='line'>Write returned with 48
</span><span class='line'>Write called with 1,1075154944,59
</span><span class='line'>libgpm.html  registers.c  syscallparams.c
</span><span class='line'>Write returned with 59
</span><span class='line'>Write called with 1,1075154944,30
</span><span class='line'>dummy        ptrace.html  simple.c
</span><span class='line'>Write returned with 30</span></code></pre></td></tr></table></div></figure>


<p>以上的例子中我们跟踪了write系统调用，而ls命令的执行将产生三个write系统调用。使用PTRACE_SYSCALL作为ptrace的第一个参数，使内核在子进程做出系统调用或者准备退出的时候暂停它。这种行为与使用PTRACE_CONT，然后在下一个系统调用/进程退出时暂停它是等价的。</p>

<p>在前一个例子中，我们用PTRACE_PEEKUSER来察看write系统调用的参数。系统调用的返回值会被放入%eax。</p>

<p>wait函数使用status变量来检查子进程是否已退出。它是用来判断子进程是被ptrace暂停掉还是已经运行结束并退出。有一组宏可以通过status的值来判断进程的状态，比如WIFEXITED等，详情可以察看wait(2) man。
读取寄存器的值</p>

<p>如果你想在系统调用或者进程终止的时候读取它的寄存器，使用前面那个例子的方法是可以的，但是这是笨拙的方法。使用PRACE_GETREGS作为ptrace的第一个参数来调用，可以只需一次函数调用就取得所有的相关寄存器值。
获得寄存器值得例子如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;sys/ptrace.h&gt;
</span><span class='line'>#include &lt;sys/types.h&gt;
</span><span class='line'>#include &lt;sys/wait.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;linux/user.h&gt;
</span><span class='line'>#include &lt;sys/syscall.h&gt;
</span><span class='line'>int main()
</span><span class='line'>{
</span><span class='line'>    pid_t child;
</span><span class='line'>    long orig_eax, eax;
</span><span class='line'>    long params[3];
</span><span class='line'>    int status;
</span><span class='line'>    int insyscall =0;
</span><span class='line'>    struct user_regs_struct regs;
</span><span class='line'>    child = fork();
</span><span class='line'>    if(child == 0) {
</span><span class='line'>        ptrace(PTRACE_TRACEME,0, NULL, NULL);
</span><span class='line'>        execl("/bin/ls","ls", NULL);
</span><span class='line'>    } else {
</span><span class='line'>        while(1) {
</span><span class='line'>            wait(&status);
</span><span class='line'>            if(WIFEXITED(status))
</span><span class='line'>            break;
</span><span class='line'>            orig_eax = ptrace(PTRACE_PEEKUSER,
</span><span class='line'>                child,4* ORIG_EAX,
</span><span class='line'>                NULL);
</span><span class='line'>            if(orig_eax == SYS_write) {
</span><span class='line'>                if(insyscall == 0) {
</span><span class='line'>                    /* Syscall entry */
</span><span class='line'>                    insyscall =1;
</span><span class='line'>                    ptrace(PTRACE_GETREGS, child,
</span><span class='line'>                        NULL,&regs);
</span><span class='line'>                    printf("Write called with "
</span><span class='line'>                        "%ld, %ld, %ld\n",
</span><span class='line'>                        regs.ebx, regs.ecx,
</span><span class='line'>                        regs.edx);
</span><span class='line'>                } else { /* Syscall exit */
</span><span class='line'>                    eax = ptrace(PTRACE_PEEKUSER,
</span><span class='line'>                        child,4* EAX,
</span><span class='line'>                        NULL);
</span><span class='line'>                    printf("Write returned "
</span><span class='line'>                        "with %ld\n", eax);
</span><span class='line'>                        insyscall =0;
</span><span class='line'>                }
</span><span class='line'>            }
</span><span class='line'>            ptrace(PTRACE_SYSCALL, child,
</span><span class='line'>                NULL, NULL);
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    return0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>这段代码与前面的例子是比较相似的，不同的是它使用了PTRACE_GETREGS。 其中的user_regs_struct结构是在中定义的。<br/>
来点好玩的</p>

<p>现在该做点有意思的事情了，我们将要把传给write系统调用的字符串给反转。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;sys/ptrace.h&gt;
</span><span class='line'>#include &lt;sys/types.h&gt;
</span><span class='line'>#include &lt;sys/wait.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;linux/user.h&gt;
</span><span class='line'>#include &lt;sys/syscall.h&gt;
</span><span class='line'>constint long_size =sizeof(long);
</span><span class='line'>void reverse(char*str)
</span><span class='line'>{
</span><span class='line'>    int i, j;
</span><span class='line'>    char temp;
</span><span class='line'>    for(i =0, j = strlen(str)-2;
</span><span class='line'>        i &lt;= j;++i,--j){
</span><span class='line'>        temp = str[i];
</span><span class='line'>        str[i]= str[j];
</span><span class='line'>        str[j]= temp;
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>void getdata(pid_t child,long addr, char*str,int len)
</span><span class='line'>{
</span><span class='line'>    char*laddr;
</span><span class='line'>    int i, j;
</span><span class='line'>    union u {
</span><span class='line'>        long val;
</span><span class='line'>        char chars[long_size];
</span><span class='line'>    } data;
</span><span class='line'>    i =0;
</span><span class='line'>    j = len / long_size;
</span><span class='line'>    laddr = str;
</span><span class='line'>    while(i &lt; j) {
</span><span class='line'>        data.val= ptrace(PTRACE_PEEKDATA,
</span><span class='line'>            child, addr + i *4,
</span><span class='line'>            NULL);
</span><span class='line'>        memcpy(laddr, data.chars, long_size);
</span><span class='line'>        ++i;
</span><span class='line'>        laddr += long_size;
</span><span class='line'>    }
</span><span class='line'>    j = len % long_size;
</span><span class='line'>    if(j != 0) {
</span><span class='line'>        data.val= ptrace(PTRACE_PEEKDATA,
</span><span class='line'>            child, addr + i *4,
</span><span class='line'>            NULL);
</span><span class='line'>        memcpy(laddr, data.chars, j);
</span><span class='line'>    }
</span><span class='line'>    str[len]='\0';
</span><span class='line'>}
</span><span class='line'>void putdata(pid_t child,long addr, char*str,int len)
</span><span class='line'>{
</span><span class='line'>    char*laddr;
</span><span class='line'>    int i, j;
</span><span class='line'>    union u {
</span><span class='line'>        long val;
</span><span class='line'>        char chars[long_size];
</span><span class='line'>    } data;
</span><span class='line'>    i =0;
</span><span class='line'>    j = len / long_size;
</span><span class='line'>    laddr = str;
</span><span class='line'>    while(i &lt; j) {
</span><span class='line'>        memcpy(data.chars, laddr, long_size);
</span><span class='line'>        ptrace(PTRACE_POKEDATA, child,
</span><span class='line'>            addr + i *4, data.val);
</span><span class='line'>            ++i;
</span><span class='line'>        laddr += long_size;
</span><span class='line'>    }
</span><span class='line'>    j = len % long_size;
</span><span class='line'>    if(j != 0) {
</span><span class='line'>        memcpy(data.chars, laddr, j);
</span><span class='line'>        ptrace(PTRACE_POKEDATA, child,
</span><span class='line'>        addr + i *4, data.val);
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>int main()
</span><span class='line'>{
</span><span class='line'>    pid_t child;
</span><span class='line'>    child = fork();
</span><span class='line'>    if(child ==0){
</span><span class='line'>        ptrace(PTRACE_TRACEME,0, NULL, NULL);
</span><span class='line'>        execl("/bin/ls","ls", NULL);
</span><span class='line'>    } else {
</span><span class='line'>        long orig_eax;
</span><span class='line'>        long params[3];
</span><span class='line'>        int status;
</span><span class='line'>        char*str,*laddr;
</span><span class='line'>        int toggle =0;
</span><span class='line'>        while(1) {
</span><span class='line'>            wait(&status);
</span><span class='line'>            if(WIFEXITED(status))
</span><span class='line'>            break;
</span><span class='line'>            orig_eax = ptrace(PTRACE_PEEKUSER,
</span><span class='line'>                child,4* ORIG_EAX,
</span><span class='line'>                NULL);
</span><span class='line'>            if(orig_eax == SYS_write){
</span><span class='line'>                if(toggle ==0){
</span><span class='line'>                toggle =1;
</span><span class='line'>                params[0]= ptrace(PTRACE_PEEKUSER,
</span><span class='line'>                    child,4* EBX,
</span><span class='line'>                    NULL);
</span><span class='line'>                params[1]= ptrace(PTRACE_PEEKUSER,
</span><span class='line'>                    child,4* ECX,
</span><span class='line'>                    NULL);
</span><span class='line'>                params[2]= ptrace(PTRACE_PEEKUSER,
</span><span class='line'>                    child,4* EDX,
</span><span class='line'>                    NULL);
</span><span class='line'>                str =(char*)calloc((params[2]+1) * sizeof(char));
</span><span class='line'>                getdata(child, params[1], str, params[2]);
</span><span class='line'>                reverse(str);
</span><span class='line'>                putdata(child, params[1], str, params[2]);
</span><span class='line'>            } else {
</span><span class='line'>                toggle =0;
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>        ptrace(PTRACE_SYSCALL, child, NULL, NULL);
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    return0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>输出是这样的：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ppadala@linux:~/ptrace &gt; ls
</span><span class='line'>a.out dummy.s ptrace.txt
</span><span class='line'>libgpm.html registers.c syscallparams.c
</span><span class='line'>dummy ptrace.html simple.c
</span><span class='line'>ppadala@linux:~/ptrace &gt; ./a.out
</span><span class='line'>txt.ecartp s.ymmud tuo.a
</span><span class='line'>c.sretsiger lmth.mpgbil c.llacys_egnahc
</span><span class='line'>c.elpmis lmth.ecartp ymmud</span></code></pre></td></tr></table></div></figure>


<p>这个例子中涵盖了前面讨论过的所有知识点，当然还有些新的内容。这里我们用PTRACE_POKEDATA作为第一个参数，以此来改变子进程中的变量值。它以与PTRACE_PEEKDATA相似的方式工作，当然，它不只是偷窥变量的值了，它可以修改它们。</p>

<h4>单步</h4>

<p>ptrace 提供了对子进程进行单步的功能。 ptrace(PTRACE_SINGLESTEP, …) 会使内核在子进程的每一条指令执行前先将其阻塞，然后将控制权交给父进程。下面的例子可以查出子进程当前将要执行的指令。为了便于理解，我用汇编写了这个受控程序，而不是让你为c的库函数到底会作那些系统调用而头痛。</p>

<p>以下是被控程序的代码 dummy1.s，使用gcc –o dummy1 dummy1.s来编译</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.data
</span><span class='line'>hello:
</span><span class='line'>    .string"hello world\n"
</span><span class='line'>.globl main
</span><span class='line'>main:
</span><span class='line'>    movl $4,%eax
</span><span class='line'>    movl $2,%ebx
</span><span class='line'>    movl $hello,%ecx
</span><span class='line'>    movl $12,%edx
</span><span class='line'>int $0x80
</span><span class='line'>    movl $1,%eax
</span><span class='line'>    xorl %ebx,%ebx
</span><span class='line'>int $0x80
</span><span class='line'>    ret</span></code></pre></td></tr></table></div></figure>


<p>以下的程序则用来完成单步</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;sys/ptrace.h&gt;
</span><span class='line'>#include &lt;sys/types.h&gt;
</span><span class='line'>#include &lt;sys/wait.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;linux/user.h&gt;
</span><span class='line'>#include &lt;sys/syscall.h&gt;
</span><span class='line'>int main()
</span><span class='line'>{
</span><span class='line'>    pid_t child;
</span><span class='line'>    const int long_size =sizeof(long);
</span><span class='line'>    child = fork();
</span><span class='line'>    if(child ==0){
</span><span class='line'>        ptrace(PTRACE_TRACEME,0, NULL, NULL);
</span><span class='line'>        execl("./dummy1","dummy1", NULL);
</span><span class='line'>    } else {
</span><span class='line'>        int status;
</span><span class='line'>        union u {
</span><span class='line'>        long val;
</span><span class='line'>        char chars[long_size];
</span><span class='line'>    } data;
</span><span class='line'>    struct user_regs_struct regs;
</span><span class='line'>    int start =0;
</span><span class='line'>    long ins;
</span><span class='line'>    while(1) {
</span><span class='line'>        wait(&status);
</span><span class='line'>        if(WIFEXITED(status))
</span><span class='line'>        break;
</span><span class='line'>        ptrace(PTRACE_GETREGS, child, NULL,&regs);
</span><span class='line'>        if(start ==1){
</span><span class='line'>            ins = ptrace(PTRACE_PEEKTEXT,
</span><span class='line'>                child, regs.eip,
</span><span class='line'>                NULL);
</span><span class='line'>            printf("EIP: %lx Instruction executed: %lx ",
</span><span class='line'>                regs.eip, ins);
</span><span class='line'>        }
</span><span class='line'>        if(regs.orig_eax== SYS_write){
</span><span class='line'>            start =1;
</span><span class='line'>            ptrace(PTRACE_SINGLESTEP, child, NULL, NULL);
</span><span class='line'>        }
</span><span class='line'>        else
</span><span class='line'>            ptrace(PTRACE_SYSCALL, child, NULL, NULL);
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    return0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>程序的输出是这样的：<br/>
你可能需要察看Intel的用户手册来了解这些指令代码的意思。<br/>
更复杂的单步，比如设置断点，则需要很仔细的设计和更复杂的代码才可以实现。</p>

<p>在第二部分，我们将会看到如何在程序中加入断点，以及将代码插入到已经在运行的程序中</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">kk</span></span>

      




<time class='entry-date' datetime='2011-11-29T19:20:00+08:00'><span class='date'>2011-11-29</span> <span class='time'>19:20:00</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/cats/language/'>language</a>, <a class='category' href='/blog/cats/language~c/'>c</a>
  
</span>


    </p>
    
      
    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/11/29/tools-ptrace/" title="Previous Post: linux ptrace函数">&laquo; linux ptrace函数</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/11/29/tools-ptrace-ii/" title="Next Post: Playing with ptrace, Part I — 玩转ptrace(二)">Playing with ptrace, Part I — 玩转ptrace(二) &raquo;</a>
      
    </p>
  </footer>
</article>

</div>
<aside class="sidebar" id='load_sidebar'>
</aside>
<script type="text/javascript">
  $('#load_sidebar').load('/sidebar.html');
</script>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - kk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <a title="Top" href="#" id="scroll2top" style="position: fixed; height: 50px; bottom: 50px; right: 30px; cursor: pointer; z-index: 9999; display: block; opacity: 1;"><img src="/images/scrollup.png"></a>
  <script src="/javascripts/scroll2top.js"></script>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253604690'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1253604690' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  





</body>
</html>
