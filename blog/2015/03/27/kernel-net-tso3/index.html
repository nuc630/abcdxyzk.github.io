
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>TCP的TSO/GSO处理（二） - kk Blog —— 通用基础</title>

  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="kk Blog —— 通用基础" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/category.js" type="text/javascript"></script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kk Blog —— 通用基础</a></h1>
  
    <h2>cp -rf * .</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
<li>
<form action="/search" method="get">
    <input class="search" name="query" id="query" type="text" placeholder="search...">
    <input id="btnSubmit" value="search" type="submit">
</form>
<script type="text/javascript">
var query = GetRequest("query");
if (query != null) {
	document.getElementById("query").value = query;
}
</script>
</li>
  <li><a href="/atom.xml" rel="subscribe-rss">RSS</a></li>
  
</ul>
  
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/download">Download</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h2 class="entry-title">TCP的TSO/GSO处理（二）</h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-27T17:45:00+08:00'><span class='date'>2015-03-27</span> <span class='time'>17:45:00</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="http://book.51cto.com/art/201206/345021.htm">http://book.51cto.com/art/201206/345021.htm</a></p>

<p>有些网络设备硬件可以完成一些传统上由CPU完成的任务，最常见的例子就是计算三层和四层校验和。有些网络设备甚至可以维护四层协议的状态机，由硬件完成分段或分片，因此传输层通过网络层提交给网络设备时可能是个GSO段，参见1.3.1节。本节论述SKB的成员都是用来支持GSO的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>unsigned short gso_size </span></code></pre></td></tr></table></div></figure>


<p>生成GSO段时的MSS，因为GSO段的长度是与发送该段的套接口中合适MSS的整数倍。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>unsigned short gso_segs </span></code></pre></td></tr></table></div></figure>


<p>GSO段的长度是gso_size的倍数，即用gso_size来分割大段时产生的段数。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>unsigned short gso_type </span></code></pre></td></tr></table></div></figure>


<p>该SKB中的数据支持的GSO类型，见表3-5。</p>

<p>表3-5  gso_type的取值</p>

<p>gso_type            描述<br/>
SKB_GSO_TCPV4   IPv4的TCP段卸载<br/>
SKB_GSO_UDP     IPv4的UDP分片卸载<br/>
SKB_GSO_DODGY   表明数据报是从一个不可信赖的来源发出的<br/>
SKB_GSO_TCP_ECN IPv4的TCP段卸载，当设置TCP首部的CWR时，使用此gos_type。CWR参见29.4节<br/>
SKB_GSO_TCPV6   IPv6的TCP段卸载</p>

<hr />

<p><a href="http://blog.csdn.net/majieyue/article/details/11881325">http://blog.csdn.net/majieyue/article/details/11881325</a></p>

<p>GSO用来扩展之前的TSO，目前已经并入upstream内核。TSO只能支持tcp协议，而GSO可以支持tcpv4, tcpv6, udp等协议。在GSO之前，skb_shinfo(skb)有两个成员ufo_size, tso_size，分别表示udp fragmentation offloading支持的分片长度，以及tcp segmentation offloading支持的分段长度，现在都用skb_shinfo(skb)->gso_size代替。skb_shinfo(skb)->ufo_segs, skb_shinfo(skb)->tso_segs也被替换成了skb_shinfo(skb)->gso_segs，表示分片的个数。</p>

<p>skb_shinfo(skb)->gso_type包括SKB_GSO_TCPv4, SKB_GSO_UDPv4，同时NETIF_F_XXX的标志也增加了相应的bit，标识设备是否支持TSO, GSO, e.g.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NETIF_F_TSO = SKB_GSO_TCPV4 &lt;&lt; NETIF_F_GSO_SHIFT
</span><span class='line'>NETIF_F_UFO = SKB_GSO_UDPV4 &lt;&lt; NETIF_F_GSO_SHIFT
</span><span class='line'>#define NETIF_F_GSO_SHIFT 16</span></code></pre></td></tr></table></div></figure>


<p>dev_hard_start_xmit在调用设备驱动的发送函数之前，会通过netif_needs_gso判断是否需要软件做GSO，如果需要，那么会调用到dev_gso_segment</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> *  dev_gso_segment - Perform emulated hardware segmentation on skb.
</span><span class='line'> *  @skb: buffer to segment
</span><span class='line'> *
</span><span class='line'> *  This function segments the given skb and stores the list of segments
</span><span class='line'> *  in skb-&gt;next.
</span><span class='line'> */
</span><span class='line'>static int dev_gso_segment(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>    struct net_device *dev = skb-&gt;dev;
</span><span class='line'>    struct sk_buff *segs;
</span><span class='line'>    int features = dev-&gt;features & ~(illegal_highdma(dev, skb) ?
</span><span class='line'>                     NETIF_F_SG : 0);
</span><span class='line'>
</span><span class='line'>    segs = skb_gso_segment(skb, features);
</span><span class='line'>
</span><span class='line'>    /* Verifying header integrity only. */
</span><span class='line'>    if (!segs)
</span><span class='line'>        return 0;
</span><span class='line'>
</span><span class='line'>    if (IS_ERR(segs))
</span><span class='line'>        return PTR_ERR(segs);
</span><span class='line'>
</span><span class='line'>    skb-&gt;next = segs;
</span><span class='line'>    DEV_GSO_CB(skb)-&gt;destructor = skb-&gt;destructor;
</span><span class='line'>    skb-&gt;destructor = dev_gso_skb_destructor;
</span><span class='line'>
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>分析skb_gso_segment之前，看下析构过程，此时skb经过分片之后已经是一个skb list，通过skb->next串在一起，此时把初始的skb->destructor函数存到skb->cb中，然后把skb->destructor变更为dev_gso_skb_destructor。</p>

<p>dev_gso_skb_destructor会把skb->next一个个通过kfree_skb释放掉，最后调用DEV_GSO_CB(skb)->destructor，即skb初始的析构函数做最后的清理。</p>

<p>skb_gso_segment是通过软件方式模拟网卡分段的函数。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct sk_buff *skb_gso_segment(struct sk_buff *skb, int features)
</span><span class='line'>{
</span><span class='line'>    struct sk_buff *segs = ERR_PTR(-EPROTONOSUPPORT);
</span><span class='line'>    struct packet_type *ptype;
</span><span class='line'>    __be16 type = skb-&gt;protocol;
</span><span class='line'>    int err;
</span><span class='line'>
</span><span class='line'>    skb_reset_mac_header(skb);
</span><span class='line'>    skb-&gt;mac_len = skb-&gt;network_header - skb-&gt;mac_header;
</span><span class='line'>    __skb_pull(skb, skb-&gt;mac_len);
</span><span class='line'>
</span><span class='line'>    if (unlikely(skb-&gt;ip_summed != CHECKSUM_PARTIAL)) {
</span><span class='line'>        struct net_device *dev = skb-&gt;dev;
</span><span class='line'>        struct ethtool_drvinfo info = {};
</span><span class='line'>
</span><span class='line'>        if (dev && dev-&gt;ethtool_ops && dev-&gt;ethtool_ops-&gt;get_drvinfo)
</span><span class='line'>            dev-&gt;ethtool_ops-&gt;get_drvinfo(dev, &info);
</span><span class='line'>
</span><span class='line'>        WARN(1, "%s: caps=(0x%lx, 0x%lx) len=%d data_len=%d "
</span><span class='line'>            "ip_summed=%d",
</span><span class='line'>             info.driver, dev ? dev-&gt;features : 0L,
</span><span class='line'>             skb-&gt;sk ? skb-&gt;sk-&gt;sk_route_caps : 0L,
</span><span class='line'>             skb-&gt;len, skb-&gt;data_len, skb-&gt;ip_summed);
</span><span class='line'>
</span><span class='line'>        if (skb_header_cloned(skb) &&
</span><span class='line'>            (err = pskb_expand_head(skb, 0, 0, GFP_ATOMIC)))
</span><span class='line'>            return ERR_PTR(err);
</span><span class='line'>
</span><span class='line'>如果skb header是clone，分离出来
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>如果skb-&gt;ip_summed 不是 CHECKSUM_PARTIAL，那么报个warning，因为GSO类型的skb其ip_summed一般都是CHECKSUM_PARTIAL
</span><span class='line'>
</span><span class='line'>    rcu_read_lock();
</span><span class='line'>    list_for_each_entry_rcu(ptype,
</span><span class='line'>            &ptype_base[ntohs(type) & PTYPE_HASH_MASK], list) {
</span><span class='line'>        if (ptype-&gt;type == type && !ptype-&gt;dev && ptype-&gt;gso_segment) {
</span><span class='line'>            if (unlikely(skb-&gt;ip_summed != CHECKSUM_PARTIAL)) {
</span><span class='line'>                err = ptype-&gt;gso_send_check(skb);
</span><span class='line'>                segs = ERR_PTR(err);
</span><span class='line'>                if (err || skb_gso_ok(skb, features))
</span><span class='line'>                    break;
</span><span class='line'>                __skb_push(skb, (skb-&gt;data -
</span><span class='line'>                         skb_network_header(skb)));
</span><span class='line'>            }
</span><span class='line'>            segs = ptype-&gt;gso_segment(skb, features);
</span><span class='line'>            break;
</span><span class='line'>
</span><span class='line'>把skb-&gt;data指向network header，然后调用inet_gso_segment，四层的gso_segment会在inet_gso_segment中被调用
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    rcu_read_unlock();
</span><span class='line'>
</span><span class='line'>    __skb_push(skb, skb-&gt;data - skb_mac_header(skb));
</span><span class='line'>
</span><span class='line'>把skb-&gt;data再次指向mac header
</span><span class='line'>
</span><span class='line'>    return segs;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>static struct sk_buff *inet_gso_segment(struct sk_buff *skb, int features)
</span><span class='line'>{
</span><span class='line'>    struct sk_buff *segs = ERR_PTR(-EINVAL);
</span><span class='line'>    struct iphdr *iph;
</span><span class='line'>    const struct net_protocol *ops;
</span><span class='line'>    int proto;
</span><span class='line'>    int ihl;
</span><span class='line'>    int id;
</span><span class='line'>    unsigned int offset = 0;
</span><span class='line'>
</span><span class='line'>    if (!(features & NETIF_F_V4_CSUM))
</span><span class='line'>        features &= ~NETIF_F_SG;
</span><span class='line'>如果设备不支持NETIF_F_V4_CSUM，那么就当设备不支持SG
</span><span class='line'>
</span><span class='line'>    if (unlikely(skb_shinfo(skb)-&gt;gso_type &
</span><span class='line'>             ~(SKB_GSO_TCPV4 |
</span><span class='line'>               SKB_GSO_UDP |
</span><span class='line'>               SKB_GSO_DODGY |
</span><span class='line'>               SKB_GSO_TCP_ECN |
</span><span class='line'>               0)))
</span><span class='line'>        goto out;
</span><span class='line'>gso_type不合法，直接返错
</span><span class='line'>
</span><span class='line'>    if (unlikely(!pskb_may_pull(skb, sizeof(*iph))))
</span><span class='line'>        goto out;
</span><span class='line'>20字节ip头部无法获得，返错
</span><span class='line'>
</span><span class='line'>    iph = ip_hdr(skb);
</span><span class='line'>    ihl = iph-&gt;ihl * 4;
</span><span class='line'>    if (ihl &lt; sizeof(*iph))
</span><span class='line'>        goto out;
</span><span class='line'>
</span><span class='line'>    if (unlikely(!pskb_may_pull(skb, ihl)))
</span><span class='line'>        goto out;
</span><span class='line'>实际ip头部无法获得，返错
</span><span class='line'>
</span><span class='line'>    __skb_pull(skb, ihl);
</span><span class='line'>    skb_reset_transport_header(skb);
</span><span class='line'>    iph = ip_hdr(skb);
</span><span class='line'>
</span><span class='line'>OK，现在拿到ip头部了
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    id = ntohs(iph-&gt;id);
</span><span class='line'>
</span><span class='line'>ip包的id
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    proto = iph-&gt;protocol & (MAX_INET_PROTOS - 1);
</span><span class='line'>    segs = ERR_PTR(-EPROTONOSUPPORT);
</span><span class='line'>
</span><span class='line'>    rcu_read_lock();
</span><span class='line'>    ops = rcu_dereference(inet_protos[proto]);
</span><span class='line'>    if (likely(ops && ops-&gt;gso_segment))
</span><span class='line'>        segs = ops-&gt;gso_segment(skb, features);
</span><span class='line'>
</span><span class='line'>如果是tcp，那么调用tcp_tso_segment，如果是udp，那么调用udp4_ufo_fragment
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    rcu_read_unlock();
</span><span class='line'>
</span><span class='line'>    if (!segs || IS_ERR(segs))
</span><span class='line'>        goto out;
</span><span class='line'>
</span><span class='line'>    skb = segs;
</span><span class='line'>    do {
</span><span class='line'>        iph = ip_hdr(skb);
</span><span class='line'>        if (proto == IPPROTO_UDP) {
</span><span class='line'>            iph-&gt;id = htons(id);
</span><span class='line'>            iph-&gt;frag_off = htons(offset &gt;&gt; 3);
</span><span class='line'>            if (skb-&gt;next != NULL)
</span><span class='line'>                iph-&gt;frag_off |= htons(IP_MF);
</span><span class='line'>            offset += (skb-&gt;len - skb-&gt;mac_len - iph-&gt;ihl * 4);
</span><span class='line'>        } else
</span><span class='line'>            iph-&gt;id = htons(id++);
</span><span class='line'>        iph-&gt;tot_len = htons(skb-&gt;len - skb-&gt;mac_len);
</span><span class='line'>        iph-&gt;check = 0;
</span><span class='line'>        iph-&gt;check = ip_fast_csum(skb_network_header(skb), iph-&gt;ihl);
</span><span class='line'>    } while ((skb = skb-&gt;next));
</span><span class='line'>
</span><span class='line'>对每一个skb segment，填充ip包头，计算ip checksum。如果是tcp segmentation，那么ip头的id递增。如果是udp fragmentation，那么ip头的id不变，每次计算增加的offset，等于是在做ip分片
</span><span class='line'>
</span><span class='line'>out:
</span><span class='line'>    return segs;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>下面来看TCP协议的分段函数tcp_tso_segment</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct sk_buff *tcp_tso_segment(struct sk_buff *skb, int features)
</span><span class='line'>{
</span><span class='line'>    struct sk_buff *segs = ERR_PTR(-EINVAL);
</span><span class='line'>    struct tcphdr *th;
</span><span class='line'>    unsigned thlen;
</span><span class='line'>    unsigned int seq;
</span><span class='line'>    __be32 delta;
</span><span class='line'>    unsigned int oldlen;
</span><span class='line'>    unsigned int mss;
</span><span class='line'>
</span><span class='line'>    if (!pskb_may_pull(skb, sizeof(*th)))
</span><span class='line'>        goto out;
</span><span class='line'>
</span><span class='line'>    th = tcp_hdr(skb);
</span><span class='line'>    thlen = th-&gt;doff * 4;
</span><span class='line'>    if (thlen &lt; sizeof(*th))
</span><span class='line'>        goto out;
</span><span class='line'>
</span><span class='line'>    if (!pskb_may_pull(skb, thlen))
</span><span class='line'>        goto out;
</span><span class='line'>
</span><span class='line'>    oldlen = (u16)~skb-&gt;len;
</span><span class='line'>    __skb_pull(skb, thlen);
</span><span class='line'>把tcp header移到skb header里，把skb-&gt;len存到oldlen中，此时skb-&gt;len就只有tcp payload的长度
</span><span class='line'>
</span><span class='line'>    mss = skb_shinfo(skb)-&gt;gso_size;
</span><span class='line'>    if (unlikely(skb-&gt;len &lt;= mss))
</span><span class='line'>        goto out;
</span><span class='line'>
</span><span class='line'>    if (skb_gso_ok(skb, features | NETIF_F_GSO_ROBUST)) {
</span><span class='line'>        /* Packet is from an untrusted source, reset gso_segs. */
</span><span class='line'>        int type = skb_shinfo(skb)-&gt;gso_type;
</span><span class='line'>
</span><span class='line'>        if (unlikely(type &
</span><span class='line'>                 ~(SKB_GSO_TCPV4 |
</span><span class='line'>                   SKB_GSO_DODGY |
</span><span class='line'>                   SKB_GSO_TCP_ECN |
</span><span class='line'>                   SKB_GSO_TCPV6 |
</span><span class='line'>                   0) ||
</span><span class='line'>                 !(type & (SKB_GSO_TCPV4 | SKB_GSO_TCPV6))))
</span><span class='line'>            goto out;
</span><span class='line'>
</span><span class='line'>        skb_shinfo(skb)-&gt;gso_segs = DIV_ROUND_UP(skb-&gt;len, mss);
</span><span class='line'>重新计算skb_shinfo(skb)-&gt;gso_segs的个数，基于skb-&gt;len和mss值
</span><span class='line'>
</span><span class='line'>        segs = NULL;
</span><span class='line'>        goto out;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    segs = skb_segment(skb, features);
</span><span class='line'>    if (IS_ERR(segs))
</span><span class='line'>        goto out;
</span><span class='line'>skb_segment是真正的分段实现，后面再分析
</span><span class='line'>
</span><span class='line'>    delta = htonl(oldlen + (thlen + mss));
</span><span class='line'>
</span><span class='line'>    skb = segs;
</span><span class='line'>    th = tcp_hdr(skb);
</span><span class='line'>    seq = ntohl(th-&gt;seq);
</span><span class='line'>
</span><span class='line'>    do {
</span><span class='line'>        th-&gt;fin = th-&gt;psh = 0;
</span><span class='line'>
</span><span class='line'>        th-&gt;check = ~csum_fold((__force __wsum)((__force u32)th-&gt;check +
</span><span class='line'>                       (__force u32)delta));
</span><span class='line'>        if (skb-&gt;ip_summed != CHECKSUM_PARTIAL)
</span><span class='line'>            th-&gt;check =
</span><span class='line'>                 csum_fold(csum_partial(skb_transport_header(skb),
</span><span class='line'>                            thlen, skb-&gt;csum));
</span><span class='line'>对每个分段都要计算tcp checksum
</span><span class='line'>
</span><span class='line'>        seq += mss;
</span><span class='line'>        skb = skb-&gt;next;
</span><span class='line'>        th = tcp_hdr(skb);
</span><span class='line'>
</span><span class='line'>        th-&gt;seq = htonl(seq);
</span><span class='line'>
</span><span class='line'>对每个分段重新计算sequence值
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        th-&gt;cwr = 0;
</span><span class='line'>    } while (skb-&gt;next);
</span><span class='line'>
</span><span class='line'>    delta = htonl(oldlen + (skb-&gt;tail - skb-&gt;transport_header) +
</span><span class='line'>              skb-&gt;data_len);
</span><span class='line'>    th-&gt;check = ~csum_fold((__force __wsum)((__force u32)th-&gt;check +
</span><span class='line'>                (__force u32)delta));
</span><span class='line'>    if (skb-&gt;ip_summed != CHECKSUM_PARTIAL)
</span><span class='line'>        th-&gt;check = csum_fold(csum_partial(skb_transport_header(skb),
</span><span class='line'>                           thlen, skb-&gt;csum));
</span><span class='line'>
</span><span class='line'>out:
</span><span class='line'>    return segs;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>UDP协议的分片函数是udp4_ufo_fragment</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct sk_buff *udp4_ufo_fragment(struct sk_buff *skb, int features)
</span><span class='line'>{
</span><span class='line'>    struct sk_buff *segs = ERR_PTR(-EINVAL);
</span><span class='line'>    unsigned int mss;
</span><span class='line'>    int offset;
</span><span class='line'>    __wsum csum;
</span><span class='line'>
</span><span class='line'>    mss = skb_shinfo(skb)-&gt;gso_size;
</span><span class='line'>    if (unlikely(skb-&gt;len &lt;= mss))
</span><span class='line'>        goto out;
</span><span class='line'>
</span><span class='line'>    if (skb_gso_ok(skb, features | NETIF_F_GSO_ROBUST)) {
</span><span class='line'>        /* Packet is from an untrusted source, reset gso_segs. */
</span><span class='line'>        int type = skb_shinfo(skb)-&gt;gso_type;
</span><span class='line'>
</span><span class='line'>        if (unlikely(type & ~(SKB_GSO_UDP | SKB_GSO_DODGY) ||
</span><span class='line'>                 !(type & (SKB_GSO_UDP))))
</span><span class='line'>            goto out;
</span><span class='line'>
</span><span class='line'>        skb_shinfo(skb)-&gt;gso_segs = DIV_ROUND_UP(skb-&gt;len, mss);
</span><span class='line'>
</span><span class='line'>        segs = NULL;
</span><span class='line'>        goto out;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    /* Do software UFO. Complete and fill in the UDP checksum as HW cannot
</span><span class='line'>     * do checksum of UDP packets sent as multiple IP fragments.
</span><span class='line'>     */
</span><span class='line'>    offset = skb-&gt;csum_start - skb_headroom(skb);
</span><span class='line'>    csum = skb_checksum(skb, offset, skb-&gt;len - offset, 0);
</span><span class='line'>    offset += skb-&gt;csum_offset;
</span><span class='line'>    *(__sum16 *)(skb-&gt;data + offset) = csum_fold(csum);
</span><span class='line'>    skb-&gt;ip_summed = CHECKSUM_NONE;
</span><span class='line'>
</span><span class='line'>计算udp的checksum
</span><span class='line'>
</span><span class='line'>    /* Fragment the skb. IP headers of the fragments are updated in
</span><span class='line'>     * inet_gso_segment()
</span><span class='line'>     */
</span><span class='line'>    segs = skb_segment(skb, features);
</span><span class='line'>out:
</span><span class='line'>    return segs;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>udp的分段其实和ip的分片没什么区别，只是多一个计算checksum的步骤</p>

<p>最后来分析下skb_segment</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct sk_buff *skb_segment(struct sk_buff *skb, int features)
</span><span class='line'>{
</span><span class='line'>    struct sk_buff *segs = NULL;
</span><span class='line'>    struct sk_buff *tail = NULL;
</span><span class='line'>    struct sk_buff *fskb = skb_shinfo(skb)-&gt;frag_list;
</span><span class='line'>    unsigned int mss = skb_shinfo(skb)-&gt;gso_size;
</span><span class='line'>    unsigned int doffset = skb-&gt;data - skb_mac_header(skb);
</span><span class='line'>    unsigned int offset = doffset;
</span><span class='line'>    unsigned int headroom;
</span><span class='line'>    unsigned int len;
</span><span class='line'>    int sg = features & NETIF_F_SG;
</span><span class='line'>    int nfrags = skb_shinfo(skb)-&gt;nr_frags;
</span><span class='line'>    int err = -ENOMEM;
</span><span class='line'>    int i = 0;
</span><span class='line'>    int pos;
</span><span class='line'>
</span><span class='line'>    __skb_push(skb, doffset);
</span><span class='line'>    headroom = skb_headroom(skb);
</span><span class='line'>    pos = skb_headlen(skb);
</span><span class='line'>
</span><span class='line'>skb-&gt;data指向mac header，计算headroom，skb_headlen长度
</span><span class='line'>
</span><span class='line'>    do {
</span><span class='line'>        struct sk_buff *nskb;
</span><span class='line'>        skb_frag_t *frag;
</span><span class='line'>        int hsize;
</span><span class='line'>        int size;
</span><span class='line'>
</span><span class='line'>        len = skb-&gt;len - offset;
</span><span class='line'>        if (len &gt; mss)
</span><span class='line'>            len = mss;
</span><span class='line'>len为skb-&gt;len减去直到offset的部分。开始时，offset只是mac header + ip header + tcp header的长度，len即tcp payload的长度。随着segment增加, offset每次都增加mss长度。因此len的定义是每个segment的payload长度（最后一个segment的payload可能小于一个mss长度）
</span><span class='line'>
</span><span class='line'>        hsize = skb_headlen(skb) - offset;
</span><span class='line'>
</span><span class='line'>hsize为skb header减去offset后的大小，如果hsize小于0，那么说明payload在skb的frags, frag_list中。随着offset一直增长，必定会有hsize一直&lt;0的情况开始出现，除非skb是一个完全linearize化的skb
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        if (hsize &lt; 0)
</span><span class='line'>            hsize = 0;
</span><span class='line'>
</span><span class='line'>这种情况说明skb_headlen没有tcp payload的部分，需要pull数据过来
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        if (hsize &gt; len || !sg)
</span><span class='line'>            hsize = len;
</span><span class='line'>
</span><span class='line'>如果不支持sg同时hsize大于len，那么hsize就为len，此时说明segment的payload还在skb header中
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        if (!hsize && i &gt;= nfrags) {
</span><span class='line'>            BUG_ON(fskb-&gt;len != len);
</span><span class='line'>
</span><span class='line'>            pos += len;
</span><span class='line'>            nskb = skb_clone(fskb, GFP_ATOMIC);
</span><span class='line'>            fskb = fskb-&gt;next;
</span><span class='line'>
</span><span class='line'>            if (unlikely(!nskb))
</span><span class='line'>                goto err;
</span><span class='line'>
</span><span class='line'>            hsize = skb_end_pointer(nskb) - nskb-&gt;head;
</span><span class='line'>            if (skb_cow_head(nskb, doffset + headroom)) {
</span><span class='line'>                kfree_skb(nskb);
</span><span class='line'>                goto err;
</span><span class='line'>            }
</span><span class='line'>
</span><span class='line'>            nskb-&gt;truesize += skb_end_pointer(nskb) - nskb-&gt;head -
</span><span class='line'>                      hsize;
</span><span class='line'>            skb_release_head_state(nskb);
</span><span class='line'>            __skb_push(nskb, doffset);
</span><span class='line'>        } else {
</span><span class='line'>
</span><span class='line'>            nskb = alloc_skb(hsize + doffset + headroom,
</span><span class='line'>                     GFP_ATOMIC);
</span><span class='line'>
</span><span class='line'>            if (unlikely(!nskb))
</span><span class='line'>                goto err;
</span><span class='line'>
</span><span class='line'>            skb_reserve(nskb, headroom);
</span><span class='line'>            __skb_put(nskb, doffset);
</span><span class='line'>
</span><span class='line'>alloc新的skb，skb-&gt;data到skb-&gt;head之间保留headroom，skb-&gt;tail到skb-&gt;data之间保留mac header + ip header + tcp header + hsize的长度
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        if (segs)
</span><span class='line'>            tail-&gt;next = nskb;
</span><span class='line'>        else
</span><span class='line'>            segs = nskb;
</span><span class='line'>        tail = nskb;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        __copy_skb_header(nskb, skb);
</span><span class='line'>        nskb-&gt;mac_len = skb-&gt;mac_len;
</span><span class='line'>把老skb的skb_buff内容拷贝到新skb中
</span><span class='line'>
</span><span class='line'>        /* nskb and skb might have different headroom */
</span><span class='line'>        if (nskb-&gt;ip_summed == CHECKSUM_PARTIAL)
</span><span class='line'>            nskb-&gt;csum_start += skb_headroom(nskb) - headroom;
</span><span class='line'>修正下checksum计算的位置
</span><span class='line'>
</span><span class='line'>        skb_reset_mac_header(nskb);
</span><span class='line'>        skb_set_network_header(nskb, skb-&gt;mac_len);
</span><span class='line'>        nskb-&gt;transport_header = (nskb-&gt;network_header +
</span><span class='line'>                      skb_network_header_len(skb));
</span><span class='line'>        skb_copy_from_linear_data(skb, nskb-&gt;data, doffset);
</span><span class='line'>
</span><span class='line'>把skb-&gt;data开始doffset长度的内容拷贝到nskb-&gt;data中，即把mac header , ip header, tcp header都复制过去
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        if (fskb != skb_shinfo(skb)-&gt;frag_list)
</span><span class='line'>            continue;
</span><span class='line'>
</span><span class='line'>        if (!sg) {
</span><span class='line'>            nskb-&gt;ip_summed = CHECKSUM_NONE;
</span><span class='line'>            nskb-&gt;csum = skb_copy_and_csum_bits(skb, offset,
</span><span class='line'>                                skb_put(nskb, len),
</span><span class='line'>                                len, 0);
</span><span class='line'>            continue;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        frag = skb_shinfo(nskb)-&gt;frags;
</span><span class='line'>
</span><span class='line'>        skb_copy_from_linear_data_offset(skb, offset,
</span><span class='line'>                         skb_put(nskb, hsize), hsize);
</span><span class='line'>
</span><span class='line'>如果hsize不为0，那么拷贝hsize的内容到nskb header中
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        while (pos &lt; offset + len && i &lt; nfrags) {
</span><span class='line'>
</span><span class='line'>offset + len长度超过了pos，即超过了nskb header，这时需要用到frag
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>            *frag = skb_shinfo(skb)-&gt;frags[i];
</span><span class='line'>            get_page(frag-&gt;page);
</span><span class='line'>            size = frag-&gt;size;
</span><span class='line'>
</span><span class='line'>            if (pos &lt; offset) {
</span><span class='line'>                frag-&gt;page_offset += offset - pos;
</span><span class='line'>                frag-&gt;size -= offset - pos;
</span><span class='line'>            }
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>            skb_shinfo(nskb)-&gt;nr_frags++;
</span><span class='line'>
</span><span class='line'>            if (pos + size &lt;= offset + len) {
</span><span class='line'>                i++;
</span><span class='line'>                pos += size;
</span><span class='line'>            } else {
</span><span class='line'>                frag-&gt;size -= pos + size - (offset + len);
</span><span class='line'>                goto skip_fraglist;
</span><span class='line'>            }
</span><span class='line'>
</span><span class='line'>            frag++;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>如果skb header空间不够，那么通过frag，把一个mss的内容拷贝到nskb的frag中
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        if (pos &lt; offset + len) {
</span><span class='line'>            struct sk_buff *fskb2 = fskb;
</span><span class='line'>
</span><span class='line'>            BUG_ON(pos + fskb-&gt;len != offset + len);
</span><span class='line'>
</span><span class='line'>            pos += fskb-&gt;len;
</span><span class='line'>            fskb = fskb-&gt;next;
</span><span class='line'>
</span><span class='line'>            if (fskb2-&gt;next) {
</span><span class='line'>                fskb2 = skb_clone(fskb2, GFP_ATOMIC);
</span><span class='line'>                if (!fskb2)
</span><span class='line'>                    goto err;
</span><span class='line'>            } else
</span><span class='line'>                skb_get(fskb2);
</span><span class='line'>
</span><span class='line'>            SKB_FRAG_ASSERT(nskb);
</span><span class='line'>            skb_shinfo(nskb)-&gt;frag_list = fskb2;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>如果frag都用完还是无法满足mss的大小，那么就要用到frag_list，这段代码跳过去了，因为基本永远不会走到这里
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>skip_fraglist:
</span><span class='line'>        nskb-&gt;data_len = len - hsize;
</span><span class='line'>        nskb-&gt;len += nskb-&gt;data_len;
</span><span class='line'>        nskb-&gt;truesize += nskb-&gt;data_len;
</span><span class='line'>    } while ((offset += len) &lt; skb-&gt;len);
</span><span class='line'>
</span><span class='line'>完成一个nskb之后，继续下一个seg，一直到offset &gt;= skb-&gt;len
</span><span class='line'>
</span><span class='line'>    return segs;
</span><span class='line'>
</span><span class='line'>err:
</span><span class='line'>    while ((skb = segs)) {
</span><span class='line'>        segs = skb-&gt;next;
</span><span class='line'>        kfree_skb(skb);
</span><span class='line'>    }
</span><span class='line'>    return ERR_PTR(err);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>



</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">kk</span></span>

      




<time class='entry-date' datetime='2015-03-27T17:45:00+08:00'><span class='date'>2015-03-27</span> <span class='time'>17:45:00</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/cats/kernel/'>kernel</a>, <a class='category' href='/blog/cats/kernel~net/'>net</a>
  
</span>


    </p>
    
      
    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/03/23/kernel-net-frto/" title="Previous Post: FRTO—虚假超时剖析">&laquo; FRTO—虚假超时剖析</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/03/27/kernel-net-netdevice/" title="Next Post: 内核网络设备的注册与初始化(eth0...)">内核网络设备的注册与初始化(eth0...) &raquo;</a>
      
    </p>
  </footer>
</article>

</div>
<aside class="sidebar" id='load_sidebar'>
</aside>
<script type="text/javascript">
  $('#load_sidebar').load('/sidebar.html');
</script>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - kk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <a title="Top" href="#" id="scroll2top" style="position: fixed; height: 50px; bottom: 30px; right: 25px; cursor: pointer; z-index: 9999; display: block; opacity: 1;"><img src="/images/scrollup.png"></a>
  <script src="/javascripts/scroll2top.js"></script>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253604690'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1253604690' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  





</body>
</html>
