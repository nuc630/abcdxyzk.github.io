
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>内核网络设备的注册与初始化(eth0...) - kk Blog —— 通用基础</title>

  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="kk Blog —— 通用基础" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/category.js" type="text/javascript"></script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kk Blog —— 通用基础</a></h1>
  
    <h2>cp -rf * .</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
<li>
<form action="/search" method="get">
    <input class="search" name="query" id="query" type="text" placeholder="search...">
    <input id="btnSubmit" value="search" type="submit">
</form>
<script type="text/javascript">
var query = GetRequest("query");
if (query != null) {
	document.getElementById("query").value = query;
}
</script>
</li>
  <li><a href="/atom.xml" rel="subscribe-rss">RSS</a></li>
  
</ul>
  
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/download">Download</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h2 class="entry-title">内核网络设备的注册与初始化(eth0...)</h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-27T17:56:00+08:00'><span class='date'>2015-03-27</span> <span class='time'>17:56:00</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><h4>找到eth0&hellip;之类的设备的数据结构</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># crash vmlinux
</span><span class='line'>
</span><span class='line'>p init_net
</span><span class='line'>找到：
</span><span class='line'>  dev_base_head = {
</span><span class='line'>&#9;next = 0xffff88003e48b070, 
</span><span class='line'>&#9;prev = 0xffff880037582070
</span><span class='line'>  },
</span><span class='line'>next 就是 struct net_device *dev; 中 dev-&gt;dev_list;
</span><span class='line'>算算 dev_list 在 dev 中的偏移为0x50（可能会不同）
</span><span class='line'>
</span><span class='line'>struct net_device 0xffff88003e48b020
</span><span class='line'>然后根据 dev中的dev_list.next取下一个net_device
</span><span class='line'>  dev_list = {
</span><span class='line'>&#9;next = 0xffff880037582070, 
</span><span class='line'>&#9;prev = 0xffffffff81b185b0
</span><span class='line'>  },</span></code></pre></td></tr></table></div></figure>


<h4>找到net_device对应的XXX_adapter, 如ixgbe_adapter</h4>

<p>ixgbe模块在申请net_device时会把需要预留给ixgbe_adapter的空间大小传给alloc_etherdev</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>netdev = alloc_etherdev(sizeof(struct ixgbe_adapter));
</span><span class='line'>
</span><span class='line'>adapter = netdev_priv(netdev);
</span><span class='line'>
</span><span class='line'>static inline void *netdev_priv(const struct net_device *dev)
</span><span class='line'>{
</span><span class='line'>&#9;return (char *)dev + ALIGN(sizeof(struct net_device), NETDEV_ALIGN);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>所以ixgbe_adapter在net_device结构按32位对其后面，偏移0x6c0（视内核而定）</p>

<hr />

<p><a href="http://blog.csdn.net/sfrysh/article/details/5736752">http://blog.csdn.net/sfrysh/article/details/5736752</a></p>

<p>首先来看如何分配内存给一个网络设备。</p>

<p>内核通过alloc_netdev来分配内存给一个指定的网络设备:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define alloc_netdev(sizeof_priv, name, setup) /   
</span><span class='line'>&#9;alloc_netdev_mq(sizeof_priv, name, setup, 1)   
</span><span class='line'>  
</span><span class='line'>struct net_device *alloc_netdev_mq(int sizeof_priv, const char *name,   
</span><span class='line'>&#9;&#9;void (*setup)(struct net_device *), unsigned int queue_count)  </span></code></pre></td></tr></table></div></figure>


<p>其中alloc_netdev_mq中的第一个元素是每个网络设备的私有数据(主要是包含一些硬件参数，比如中断之类的)的大小，也就是net_device结构中的priv的大小。第二个参数是设备名，我们传递进来一般都是一个待format的字符串，比如"eth%d",到时多个相同类型网卡设备就会依次为eth0,1(内核会通过dev_alloc_name来进行设置)&hellip; 第三个参数setup是一个初始化net_device结构的回调函数。</p>

<p>可是一般我们不需要直接调用alloc_netdev的，内核提供了一些包装好的函数：</p>

<p>这里我们只看alloc_etherdev：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define alloc_etherdev(sizeof_priv) alloc_etherdev_mq(sizeof_priv, 1)   
</span><span class='line'>struct net_device *alloc_etherdev_mq(int sizeof_priv, unsigned int queue_count)   
</span><span class='line'>{   
</span><span class='line'>&#9;return alloc_netdev_mq(sizeof_priv, "eth%d", ether_setup, queue_count);   
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<p>这里实际是根据网卡的类型进行包装，也就类似于oo中的基类，ether_setup初始化一些所有相同类型的网络设备的一些相同配置的域：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void ether_setup(struct net_device *dev)   
</span><span class='line'>{   
</span><span class='line'>&#9;dev-&gt;header_ops      = &eth_header_ops;   
</span><span class='line'>  
</span><span class='line'>&#9;dev-&gt;change_mtu      = eth_change_mtu;   
</span><span class='line'>&#9;dev-&gt;set_mac_address     = eth_mac_addr;   
</span><span class='line'>&#9;dev-&gt;validate_addr   = eth_validate_addr;   
</span><span class='line'>  
</span><span class='line'>&#9;dev-&gt;type        = ARPHRD_ETHER;   
</span><span class='line'>&#9;dev-&gt;hard_header_len     = ETH_HLEN;   
</span><span class='line'>&#9;dev-&gt;mtu     = ETH_DATA_LEN;   
</span><span class='line'>&#9;dev-&gt;addr_len        = ETH_ALEN;   
</span><span class='line'>&#9;dev-&gt;tx_queue_len    = 1000; /* Ethernet wants good queues */  
</span><span class='line'>&#9;dev-&gt;flags       = IFF_BROADCAST|IFF_MULTICAST;   
</span><span class='line'>  
</span><span class='line'>&#9;memset(dev-&gt;broadcast, 0xFF, ETH_ALEN);   
</span><span class='line'>  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<p>接下来我们来看注册网络设备的一些细节。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int register_netdev(struct net_device *dev)   
</span><span class='line'>{   
</span><span class='line'>&#9;int err;   
</span><span class='line'>  
</span><span class='line'>&#9;rtnl_lock();   
</span><span class='line'>  
</span><span class='line'>&#9;/*  
</span><span class='line'>&#9; * If the name is a format string the caller wants us to do a  
</span><span class='line'>&#9; * name allocation.  
</span><span class='line'>&#9; */  
</span><span class='line'>&#9;if (strchr(dev-&gt;name, '%')) {   
</span><span class='line'>&#9;&#9;// 这里通过dev_alloc_name函数来对设备名进行设置。   
</span><span class='line'>&#9;&#9;err = dev_alloc_name(dev, dev-&gt;name);   
</span><span class='line'>&#9;&#9;if (err &lt; 0)   
</span><span class='line'>&#9;&#9;&#9;goto out;   
</span><span class='line'>&#9;}   
</span><span class='line'>&#9;// 注册当前的网络设备到全局的网络设备链表中.下面会详细看这个函数.   
</span><span class='line'>&#9;err = register_netdevice(dev);   
</span><span class='line'>out:   
</span><span class='line'>&#9;rtnl_unlock();   
</span><span class='line'>&#9;return err;   
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<p>整个网络设备就是一个链表，他需要很方便的遍历所有设备，以及很快的定位某个指定的设备。为此net_device包含了下面3个链表(有关内核中数据结构的介绍，可以去自己google下)：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 可以根据index来定位设备   
</span><span class='line'>struct hlist_node   index_hlist;   
</span><span class='line'>// 可以根据name来定位设备   
</span><span class='line'>struct hlist_node   name_hlist;   
</span><span class='line'>// 通过dev_list，将此设备插入到全局的dev_base_head中，我们下面会介绍这个。   
</span><span class='line'>struct list_head    dev_list;  </span></code></pre></td></tr></table></div></figure>


<p>当设备注册成功后，还需要通知内核的其他组件，这里通过netdev_chain类型的notifier chain来通知其他组件。事件是NETDEV_REGISTER..其他设备通过register_netdevice_notifier来注册自己感兴趣的事件到此notifier chain上。</p>

<p>网络设备(比如打开或关闭一个设备)，与用户空间的通信通过rtmsg_ifinfo函数，也就是RTMGRP_LINK的netlink。</p>

<p>每个设备还包含两个状态，一个是state字段，表示排队策略状态(用位图表示)，一个是注册状态。</p>

<p>包的排队策略也就是qos了。。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int register_netdevice(struct net_device *dev)   
</span><span class='line'>{   
</span><span class='line'>&#9;struct hlist_head *head;   
</span><span class='line'>&#9;struct hlist_node *p;   
</span><span class='line'>&#9;int ret;   
</span><span class='line'>&#9;struct net *net;   
</span><span class='line'>  
</span><span class='line'>&#9;BUG_ON(dev_boot_phase);   
</span><span class='line'>&#9;ASSERT_RTNL();   
</span><span class='line'>  
</span><span class='line'>&#9;might_sleep();   
</span><span class='line'>  
</span><span class='line'>&#9;/* When net_device's are persistent, this will be fatal. */  
</span><span class='line'>&#9;BUG_ON(dev-&gt;reg_state != NETREG_UNINITIALIZED);   
</span><span class='line'>&#9;BUG_ON(!dev_net(dev));   
</span><span class='line'>&#9;net = dev_net(dev);   
</span><span class='line'>  
</span><span class='line'>&#9;// 初始化相关的锁   
</span><span class='line'>&#9;spin_lock_init(&dev-&gt;addr_list_lock);   
</span><span class='line'>&#9;netdev_set_addr_lockdep_class(dev);   
</span><span class='line'>&#9;netdev_init_queue_locks(dev);   
</span><span class='line'>  
</span><span class='line'>&#9;dev-&gt;iflink = -1;   
</span><span class='line'>  
</span><span class='line'>&#9;/* Init, if this function is available */  
</span><span class='line'>&#9;if (dev-&gt;init) {   
</span><span class='line'>&#9;&#9;ret = dev-&gt;init(dev);   
</span><span class='line'>&#9;&#9;if (ret) {   
</span><span class='line'>&#9;&#9;&#9;if (ret &gt; 0)   
</span><span class='line'>&#9;&#9;&#9;&#9;ret = -EIO;   
</span><span class='line'>&#9;&#9;&#9;goto out;   
</span><span class='line'>&#9;&#9;}   
</span><span class='line'>&#9;}   
</span><span class='line'>  
</span><span class='line'>&#9;if (!dev_valid_name(dev-&gt;name)) {   
</span><span class='line'>&#9;&#9;ret = -EINVAL;   
</span><span class='line'>&#9;&#9;goto err_uninit;   
</span><span class='line'>&#9;}   
</span><span class='line'>&#9;// 给设备分配一个唯一的identifier.   
</span><span class='line'>&#9;dev-&gt;ifindex = dev_new_index(net);   
</span><span class='line'>&#9;if (dev-&gt;iflink == -1)   
</span><span class='line'>&#9;&#9;dev-&gt;iflink = dev-&gt;ifindex;   
</span><span class='line'>  
</span><span class='line'>&#9;// 在全局的链表中检测是否有重复的名字   
</span><span class='line'>&#9;head = dev_name_hash(net, dev-&gt;name);   
</span><span class='line'>&#9;hlist_for_each(p, head) {   
</span><span class='line'>&#9;&#9;struct net_device *d   
</span><span class='line'>&#9;&#9;&#9;= hlist_entry(p, struct net_device, name_hlist);   
</span><span class='line'>&#9;&#9;if (!strncmp(d-&gt;name, dev-&gt;name, IFNAMSIZ)) {   
</span><span class='line'>&#9;&#9;&#9;ret = -EEXIST;   
</span><span class='line'>&#9;&#9;&#9;goto err_uninit;   
</span><span class='line'>&#9;&#9;}   
</span><span class='line'>&#9;}   
</span><span class='line'>&#9;// 下面是检测一些特性的组合是否合法。   
</span><span class='line'>&#9;/* Fix illegal checksum combinations */  
</span><span class='line'>&#9;if ((dev-&gt;features & NETIF_F_HW_CSUM) &&   
</span><span class='line'>&#9;&#9;(dev-&gt;features & (NETIF_F_IP_CSUM|NETIF_F_IPV6_CSUM))) {   
</span><span class='line'>&#9;&#9;printk(KERN_NOTICE "%s: mixed HW and IP checksum settings./n",   
</span><span class='line'>&#9;&#9;&#9;   dev-&gt;name);   
</span><span class='line'>&#9;&#9;dev-&gt;features &= ~(NETIF_F_IP_CSUM|NETIF_F_IPV6_CSUM);   
</span><span class='line'>&#9;}   
</span><span class='line'>  
</span><span class='line'>&#9;if ((dev-&gt;features & NETIF_F_NO_CSUM) &&   
</span><span class='line'>&#9;&#9;(dev-&gt;features & (NETIF_F_HW_CSUM|NETIF_F_IP_CSUM|NETIF_F_IPV6_CSUM))) {   
</span><span class='line'>&#9;&#9;printk(KERN_NOTICE "%s: mixed no checksumming and other settings./n",   
</span><span class='line'>&#9;&#9;&#9;   dev-&gt;name);   
</span><span class='line'>&#9;&#9;dev-&gt;features &= ~(NETIF_F_IP_CSUM|NETIF_F_IPV6_CSUM|NETIF_F_HW_CSUM);   
</span><span class='line'>&#9;}   
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>&#9;/* Fix illegal SG+CSUM combinations. */  
</span><span class='line'>&#9;if ((dev-&gt;features & NETIF_F_SG) &&   
</span><span class='line'>&#9;&#9;!(dev-&gt;features & NETIF_F_ALL_CSUM)) {   
</span><span class='line'>&#9;&#9;printk(KERN_NOTICE "%s: Dropping NETIF_F_SG since no checksum feature./n",   
</span><span class='line'>&#9;&#9;&#9;   dev-&gt;name);   
</span><span class='line'>&#9;&#9;dev-&gt;features &= ~NETIF_F_SG;   
</span><span class='line'>&#9;}   
</span><span class='line'>  
</span><span class='line'>&#9;/* TSO requires that SG is present as well. */  
</span><span class='line'>&#9;if ((dev-&gt;features & NETIF_F_TSO) &&   
</span><span class='line'>&#9;&#9;!(dev-&gt;features & NETIF_F_SG)) {   
</span><span class='line'>&#9;&#9;printk(KERN_NOTICE "%s: Dropping NETIF_F_TSO since no SG feature./n",   
</span><span class='line'>&#9;&#9;&#9;   dev-&gt;name);   
</span><span class='line'>&#9;&#9;dev-&gt;features &= ~NETIF_F_TSO;   
</span><span class='line'>&#9;}   
</span><span class='line'>&#9;if (dev-&gt;features & NETIF_F_UFO) {   
</span><span class='line'>&#9;&#9;if (!(dev-&gt;features & NETIF_F_HW_CSUM)) {   
</span><span class='line'>&#9;&#9;&#9;printk(KERN_ERR "%s: Dropping NETIF_F_UFO since no "  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;"NETIF_F_HW_CSUM feature./n",   
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;dev-&gt;name);   
</span><span class='line'>&#9;&#9;&#9;dev-&gt;features &= ~NETIF_F_UFO;   
</span><span class='line'>&#9;&#9;}   
</span><span class='line'>&#9;&#9;if (!(dev-&gt;features & NETIF_F_SG)) {   
</span><span class='line'>&#9;&#9;&#9;printk(KERN_ERR "%s: Dropping NETIF_F_UFO since no "  
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;"NETIF_F_SG feature./n",   
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;dev-&gt;name);   
</span><span class='line'>&#9;&#9;&#9;dev-&gt;features &= ~NETIF_F_UFO;   
</span><span class='line'>&#9;&#9;}   
</span><span class='line'>&#9;}   
</span><span class='line'>  
</span><span class='line'>&#9;/* Enable software GSO if SG is supported. */  
</span><span class='line'>&#9;if (dev-&gt;features & NETIF_F_SG)   
</span><span class='line'>&#9;&#9;dev-&gt;features |= NETIF_F_GSO;   
</span><span class='line'>  
</span><span class='line'>&#9;// 初始化设备驱动的kobject并创建相关的sysfs   
</span><span class='line'>&#9;netdev_initialize_kobject(dev);   
</span><span class='line'>&#9;ret = netdev_register_kobject(dev);   
</span><span class='line'>&#9;if (ret)   
</span><span class='line'>&#9;&#9;goto err_uninit;   
</span><span class='line'>&#9;// 设置注册状态。   
</span><span class='line'>&#9;dev-&gt;reg_state = NETREG_REGISTERED;   
</span><span class='line'>  
</span><span class='line'>&#9;/*  
</span><span class='line'>&#9; *  Default initial state at registry is that the  
</span><span class='line'>&#9; *  device is present.  
</span><span class='line'>&#9; */  
</span><span class='line'>  
</span><span class='line'>&#9;// 设置排队策略状态。   
</span><span class='line'>&#9;set_bit(__LINK_STATE_PRESENT, &dev-&gt;state);   
</span><span class='line'>&#9;// 初始化排队规则   
</span><span class='line'>&#9;dev_init_scheduler(dev);   
</span><span class='line'>&#9;dev_hold(dev);   
</span><span class='line'>&#9;// 将相应的链表插入到全局的链表中。紧接着会介绍这个函数   
</span><span class='line'>&#9;list_netdevice(dev);   
</span><span class='line'>  
</span><span class='line'>&#9;/* Notify protocols, that a new device appeared. */  
</span><span class='line'>&#9;// 调用netdev_chain通知内核其他子系统。   
</span><span class='line'>&#9;ret = call_netdevice_notifiers(NETDEV_REGISTER, dev);   
</span><span class='line'>&#9;ret = notifier_to_errno(ret);   
</span><span class='line'>&#9;if (ret) {   
</span><span class='line'>&#9;&#9;rollback_registered(dev);   
</span><span class='line'>&#9;&#9;dev-&gt;reg_state = NETREG_UNREGISTERED;   
</span><span class='line'>&#9;}   
</span><span class='line'>  
</span><span class='line'>out:   
</span><span class='line'>&#9;return ret;   
</span><span class='line'>  
</span><span class='line'>err_uninit:   
</span><span class='line'>&#9;if (dev-&gt;uninit)   
</span><span class='line'>&#9;&#9;dev-&gt;uninit(dev);   
</span><span class='line'>&#9;goto out;   
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<p>这里要注意有一个全局的struct net init_net;变量，这个变量保存了全局的name,index  hlist以及全局的网络设备链表。</p>

<p>net结构我们这里所需要的也就三个链表：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 设备链表   
</span><span class='line'>struct list_head    dev_base_head;   
</span><span class='line'>// 名字为索引的hlist   
</span><span class='line'>struct hlist_head   *dev_name_head;   
</span><span class='line'>// index为索引的hlist   
</span><span class='line'>struct hlist_head   *dev_index_head;  </span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int list_netdevice(struct net_device *dev)   
</span><span class='line'>{   
</span><span class='line'>&#9;struct net *net = dev_net(dev);   
</span><span class='line'>  
</span><span class='line'>&#9;ASSERT_RTNL();   
</span><span class='line'>  
</span><span class='line'>&#9;write_lock_bh(&dev_base_lock);   
</span><span class='line'>&#9;// 插入全局的list   
</span><span class='line'>&#9;list_add_tail(&dev-&gt;dev_list, &net-&gt;dev_base_head);   
</span><span class='line'>&#9;// 插入全局的name_list以及index_hlist   
</span><span class='line'>&#9;hlist_add_head(&dev-&gt;name_hlist, dev_name_hash(net, dev-&gt;name));   
</span><span class='line'>&#9;hlist_add_head(&dev-&gt;index_hlist, dev_index_hash(net, dev-&gt;ifindex));   
</span><span class='line'>&#9;write_unlock_bh(&dev_base_lock);   
</span><span class='line'>&#9;return 0;   
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<p>最终执行完之后，注册函数将会执行rtnl_unlock函数，而此函数则会执行netdev_run_todo方法。也就是完成最终的注册。(要注意，当取消注册这个设备时也会调用这个函数来完成最终的取消注册)</p>

<p>这里有一个全局的net_todo_list的链表：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static LIST_HEAD(net_todo_list);  </span></code></pre></td></tr></table></div></figure>


<p>而在取消注册的函数中会调用这个函数：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static void net_set_todo(struct net_device *dev)   
</span><span class='line'>{   
</span><span class='line'>&#9;list_add_tail(&dev-&gt;todo_list, &net_todo_list);   
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<p>也就是把当前将要取消注册的函数加入到todo_list链表中。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void netdev_run_todo(void)   
</span><span class='line'>{   
</span><span class='line'>&#9;struct list_head list;   
</span><span class='line'>  
</span><span class='line'>&#9;/* Snapshot list, allow later requests */  
</span><span class='line'>&#9;// replace掉net_todo_list用list代替。   
</span><span class='line'>&#9;list_replace_init(&net_todo_list, &list);   
</span><span class='line'>  
</span><span class='line'>&#9;__rtnl_unlock();   
</span><span class='line'>&#9;// 当注册设备时没有调用net_set_todo函数来设置net_todo_list，因此list为空，所以就会直接跳过。   
</span><span class='line'>&#9;while (!list_empty(&list)) {   
</span><span class='line'>&#9;&#9;// 通过todo_list得到当前的device对象。   
</span><span class='line'>&#9;&#9;struct net_device *dev   
</span><span class='line'>&#9;&#9;&#9;= list_entry(list.next, struct net_device, todo_list);   
</span><span class='line'>&#9;&#9;// 删除此todo_list;   
</span><span class='line'>&#9;&#9;list_del(&dev-&gt;todo_list);   
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>&#9;&#9;if (unlikely(dev-&gt;reg_state != NETREG_UNREGISTERING)) {   
</span><span class='line'>&#9;&#9;&#9;printk(KERN_ERR "network todo '%s' but state %d/n",   
</span><span class='line'>&#9;&#9;&#9;&#9;   dev-&gt;name, dev-&gt;reg_state);   
</span><span class='line'>&#9;&#9;&#9;dump_stack();   
</span><span class='line'>&#9;&#9;&#9;continue;   
</span><span class='line'>&#9;&#9;}   
</span><span class='line'>&#9;&#9;// 设置注册状态为NETREG_UNREGISTERED.   
</span><span class='line'>&#9;&#9;dev-&gt;reg_state = NETREG_UNREGISTERED;   
</span><span class='line'>&#9;&#9;// 在每个cpu上调用刷新函数。   
</span><span class='line'>&#9;&#9;on_each_cpu(flush_backlog, dev, 1);   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;// 等待引用此设备的所有系统释放资源，也就是引用计数清0.   
</span><span class='line'>&#9;&#9;netdev_wait_allrefs(dev);   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;/* paranoia */  
</span><span class='line'>&#9;&#9;BUG_ON(atomic_read(&dev-&gt;refcnt));   
</span><span class='line'>&#9;&#9;WARN_ON(dev-&gt;ip_ptr);   
</span><span class='line'>&#9;&#9;WARN_ON(dev-&gt;ip6_ptr);   
</span><span class='line'>&#9;&#9;WARN_ON(dev-&gt;dn_ptr);   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;if (dev-&gt;destructor)   
</span><span class='line'>&#9;&#9;&#9;dev-&gt;destructor(dev);   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;/* Free network device */  
</span><span class='line'>&#9;&#9;kobject_put(&dev-&gt;dev.kobj);   
</span><span class='line'>&#9;}   
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<p>下面来看netdev_wait_allrefs函数，我们先看它的调用流程:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static void netdev_wait_allrefs(struct net_device *dev)   
</span><span class='line'>{   
</span><span class='line'>&#9;unsigned long rebroadcast_time, warning_time;   
</span><span class='line'>  
</span><span class='line'>&#9;rebroadcast_time = warning_time = jiffies;   
</span><span class='line'>&#9;while (atomic_read(&dev-&gt;refcnt) != 0) {   
</span><span class='line'>&#9;&#9;if (time_after(jiffies, rebroadcast_time + 1 * HZ)) {   
</span><span class='line'>&#9;&#9;&#9;rtnl_lock();   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;&#9;// 给netdev_chain发送NETDEV_UNREGISTER事件，通知各个子模块释放资源   
</span><span class='line'>&#9;&#9;&#9;/* Rebroadcast unregister notification */  
</span><span class='line'>&#9;&#9;&#9;call_netdevice_notifiers(NETDEV_UNREGISTER, dev);   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;&#9;if (test_bit(__LINK_STATE_LINKWATCH_PENDING,   
</span><span class='line'>&#9;&#9;&#9;&#9;&#9; &dev-&gt;state)) {   
</span><span class='line'>&#9;&#9;&#9;&#9;/* We must not have linkwatch events  
</span><span class='line'>&#9;&#9;&#9;&#9; * pending on unregister. If this  
</span><span class='line'>&#9;&#9;&#9;&#9; * happens, we simply run the queue  
</span><span class='line'>&#9;&#9;&#9;&#9; * unscheduled, resulting in a noop  
</span><span class='line'>&#9;&#9;&#9;&#9; * for this device.  
</span><span class='line'>&#9;&#9;&#9;&#9; */  
</span><span class='line'>&#9;&#9;&#9;&#9;linkwatch_run_queue();   
</span><span class='line'>&#9;&#9;&#9;}   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;&#9;__rtnl_unlock();   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;&#9;rebroadcast_time = jiffies;   
</span><span class='line'>&#9;&#9;}   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;msleep(250);   
</span><span class='line'>  
</span><span class='line'>&#9;&#9;if (time_after(jiffies, warning_time + 10 * HZ)) {   
</span><span class='line'>&#9;&#9;&#9;printk(KERN_EMERG "unregister_netdevice: "  
</span><span class='line'>&#9;&#9;&#9;&#9;   "waiting for %s to become free. Usage "  
</span><span class='line'>&#9;&#9;&#9;&#9;   "count = %d/n",   
</span><span class='line'>&#9;&#9;&#9;&#9;   dev-&gt;name, atomic_read(&dev-&gt;refcnt));   
</span><span class='line'>&#9;&#9;&#9;warning_time = jiffies;   
</span><span class='line'>&#9;&#9;}   
</span><span class='line'>&#9;}   
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>



</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">kk</span></span>

      




<time class='entry-date' datetime='2015-03-27T17:56:00+08:00'><span class='date'>2015-03-27</span> <span class='time'>17:56:00</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/cats/kernel/'>kernel</a>, <a class='category' href='/blog/cats/kernel~net/'>net</a>
  
</span>


    </p>
    
      
    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/03/27/kernel-net-tso3/" title="Previous Post: TCP的TSO/GSO处理（二）">&laquo; TCP的TSO/GSO处理（二）</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/04/01/kernel-net-skb_mem/" title="Next Post: skb 申请释放">skb 申请释放 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>
<aside class="sidebar" id='load_sidebar'>
</aside>
<script type="text/javascript">
  $('#load_sidebar').load('/sidebar.html');
</script>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - kk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <a title="Top" href="#" id="scroll2top" style="position: fixed; height: 50px; bottom: 30px; right: 25px; cursor: pointer; z-index: 9999; display: block; opacity: 1;"><img src="/images/scrollup.png"></a>
  <script src="/javascripts/scroll2top.js"></script>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253604690'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1253604690' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  





</body>
</html>
