
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Linux网络编程：原始套接字 SOCK_RAW - kk Blog —— 通用基础</title>

  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="kk Blog —— 通用基础" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/category.js" type="text/javascript"></script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kk Blog —— 通用基础</a></h1>
  
    <h2>cp -rf * .</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
<li>
<form action="/search" method="get">
    <input class="search" name="query" id="query" type="text" placeholder="search...">
    <input id="btnSubmit" value="search" type="submit">
</form>
<script type="text/javascript">
var query = GetRequest("query");
if (query != null) {
	document.getElementById("query").value = query;
}
</script>
</li>
  <li><a href="/atom.xml" rel="subscribe-rss">RSS</a></li>
  
</ul>
  
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/download">Download</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h2 class="entry-title">Linux网络编程：原始套接字 SOCK_RAW</h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-14T21:27:00+08:00'><span class='date'>2015-04-14</span> <span class='time'>21:27:00</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="http://blog.chinaunix.net/uid-23069658-id-3280895.html">http://blog.chinaunix.net/uid-23069658-id-3280895.html</a></p>

<h4>一、修改iphdr+tcphdr</h4>

<p>对于TCP或UDP的程序开发，焦点在Data字段，我们没法直接对TCP或UDP头部字段进行赤裸裸的修改，当然还有IP头。换句话说，我们对它们头部操作的空间非常受限，只能使用它们已经开放给我们的诸如源、目的IP，源、目的端口等等。</p>

<p>原始套接字的创建方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>socket(AF_INET, SOCK_RAW, protocol);</span></code></pre></td></tr></table></div></figure>


<p>  重点在protocol字段，这里就不能简单的将其值为0了。在头文件netinet/in.h中定义了系统中该字段目前能取的值，注意：有些系统中不一定实现了netinet/in.h中的所有协议。源代码的linux/in.h中和netinet/in.h中的内容一样。我们常见的有IPPROTO_TCP，IPPROTO_UDP和IPPROTO_ICMP。</p>

<p>用这种方式我就可以得到原始的IP包了，然后就可以自定义IP所承载的具体协议类型，如TCP，UDP或ICMP，并手动对每种承载在IP协议之上的报文进行填充。</p>

<p>先简单复习一下TCP报文的格式</p>

<p><img src="/images/kernel/2015-04-14-1.jpg" alt="" /></p>

<p><img src="/images/kernel/2015-04-14-2.jpg" alt="" /></p>

<p>原始套接字还提供了一个非常有用的参数IP_HDRINCL：</p>

<p>1、当开启该参数时：我们可以从IP报文首部第一个字节开始依次构造整个IP报文的所有选项，但是IP报文头部中的标识字段(设置为0时)和IP首部校验和字段总是由内核自己维护的，不需要我们关心。</p>

<p>2、如果不开启该参数：我们所构造的报文是从IP首部之后的第一个字节开始，IP首部由内核自己维护，首部中的协议字段被设置成调用socket()函数时我们所传递给它的第三个参数。</p>

<p> 开启IP_HDRINCL特性的模板代码一般为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>const int on =1;
</span><span class='line'>if (setsockopt (sockfd, IPPROTO_IP, IP_HDRINCL, &on, sizeof(on)) &lt; 0) {
</span><span class='line'>&#9;printf("setsockopt error!\n");
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>所以，我们还得复习一下IP报文的首部格式：</p>

<p><img src="/images/kernel/2015-04-14-3.jpg" alt="" /></p>

<p>同样，我们重点关注IP首部中的着色部分区段的填充情况。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;errno.h&gt;
</span><span class='line'>#include &lt;string.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;netdb.h&gt;
</span><span class='line'>#include &lt;sys/socket.h&gt;
</span><span class='line'>#include &lt;sys/types.h&gt;
</span><span class='line'>#include &lt;netinet/in.h&gt;
</span><span class='line'>#include &lt;netinet/ip.h&gt;
</span><span class='line'>#include &lt;arpa/inet.h&gt;
</span><span class='line'>#include &lt;linux/tcp.h&gt;
</span><span class='line'>
</span><span class='line'>#include &lt;linux/if_ether.h&gt;
</span><span class='line'>#include &lt;linux/if_arp.h&gt;
</span><span class='line'>#include &lt;linux/sockios.h&gt;
</span><span class='line'>
</span><span class='line'>unsigned csum_tcpudp_nofold(unsigned saddr, unsigned daddr,
</span><span class='line'>&#9;&#9;&#9;unsigned len, unsigned proto, unsigned sum)
</span><span class='line'>{
</span><span class='line'>&#9;unsigned long long s = (unsigned)sum;
</span><span class='line'>&#9;s += (unsigned)saddr;
</span><span class='line'>&#9;s += (unsigned)daddr;
</span><span class='line'>&#9;s += (proto + len) &lt;&lt; 8;
</span><span class='line'>&#9;s += (s &gt;&gt; 32);
</span><span class='line'>&#9;return (unsigned)s;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>unsigned short check_sum(unsigned short *addr, int len, unsigned sum)
</span><span class='line'>{
</span><span class='line'>&#9;int nleft = len;
</span><span class='line'>&#9;unsigned short *w = addr;
</span><span class='line'>&#9;unsigned short ret = 0;
</span><span class='line'>&#9;while (nleft &gt; 1) {
</span><span class='line'>&#9;&#9;sum += *w++;
</span><span class='line'>&#9;&#9;nleft -= 2;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (nleft == 1) {
</span><span class='line'>&#9;&#9;*(unsigned char *)(&ret) = *(unsigned char *)w;
</span><span class='line'>&#9;&#9;sum += ret;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;sum = (sum&gt;&gt;16) + (sum&0xffff);
</span><span class='line'>&#9;sum += (sum&gt;&gt;16);
</span><span class='line'>&#9;ret = ~sum;
</span><span class='line'>&#9;return ret;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>//在该函数中构造整个IP报文，最后调用sendto函数将报文发送出去
</span><span class='line'>void attack(int skfd, struct sockaddr_in *target, unsigned short srcport)
</span><span class='line'>{
</span><span class='line'>&#9;char buf[256] = {0};
</span><span class='line'>&#9;struct ip *ip;
</span><span class='line'>&#9;struct tcphdr *tcp;
</span><span class='line'>&#9;int ip_len;
</span><span class='line'>&#9;int op_len = 12;
</span><span class='line'>
</span><span class='line'>&#9;//在我们TCP的报文中Data没有字段，所以整个IP报文的长度
</span><span class='line'>&#9;ip_len = sizeof(struct ip) + sizeof(struct tcphdr) + op_len;
</span><span class='line'>
</span><span class='line'>&#9;//开始填充IP首部
</span><span class='line'>&#9;ip=(struct ip*)buf;
</span><span class='line'>&#9;ip-&gt;ip_v = IPVERSION;
</span><span class='line'>&#9;ip-&gt;ip_hl = sizeof(struct ip)&gt;&gt;2;
</span><span class='line'>&#9;ip-&gt;ip_tos = 0;
</span><span class='line'>&#9;ip-&gt;ip_len = htons(ip_len);
</span><span class='line'>&#9;ip-&gt;ip_id = 0;
</span><span class='line'>&#9;ip-&gt;ip_off = 0;
</span><span class='line'>&#9;ip-&gt;ip_ttl = MAXTTL;
</span><span class='line'>&#9;ip-&gt;ip_p = IPPROTO_TCP;
</span><span class='line'>&#9;ip-&gt;ip_sum = 0;
</span><span class='line'>&#9;ip-&gt;ip_dst = target-&gt;sin_addr;
</span><span class='line'>
</span><span class='line'>&#9;//开始填充TCP首部
</span><span class='line'>&#9;tcp = (struct tcphdr*)(buf+sizeof(struct ip));
</span><span class='line'>&#9;tcp-&gt;source = htons(srcport);
</span><span class='line'>&#9;tcp-&gt;dest = target-&gt;sin_port;
</span><span class='line'>&#9;srand(time(NULL));
</span><span class='line'>&#9;tcp-&gt;doff = (sizeof(struct tcphdr) + op_len) &gt;&gt; 2; // tcphdr + option
</span><span class='line'>&#9;tcp-&gt;syn = 1;
</span><span class='line'>&#9;tcp-&gt;check = 0;
</span><span class='line'>&#9;tcp-&gt;window = ntohs(14600);
</span><span class='line'>
</span><span class='line'>&#9;int i = ip_len - op_len;
</span><span class='line'>&#9;// mss = 1460
</span><span class='line'>&#9;buf[i++] = 0x02;
</span><span class='line'>&#9;buf[i++] = 0x04;
</span><span class='line'>&#9;buf[i++] = 0x05;
</span><span class='line'>&#9;buf[i++] = 0xb4;
</span><span class='line'>&#9;// sack
</span><span class='line'>&#9;buf[i++] = 0x01;
</span><span class='line'>&#9;buf[i++] = 0x01;
</span><span class='line'>&#9;buf[i++] = 0x04;
</span><span class='line'>&#9;buf[i++] = 0x02;
</span><span class='line'>&#9;// wsscale = 7
</span><span class='line'>&#9;buf[i++] = 0x01;
</span><span class='line'>&#9;buf[i++] = 0x03;
</span><span class='line'>&#9;buf[i++] = 0x03;
</span><span class='line'>&#9;buf[i++] = 0x07;
</span><span class='line'>
</span><span class='line'>&#9;int T = 1;
</span><span class='line'>&#9;while(1) {
</span><span class='line'>&#9;&#9;if (T == 0) break;
</span><span class='line'>&#9;&#9;T--;
</span><span class='line'>&#9;&#9;tcp-&gt;seq = random();
</span><span class='line'>&#9;&#9;//源地址伪造，我们随便任意生成个地址，让服务器一直等待下去
</span><span class='line'>&#9;&#9;//ip-&gt;ip_src.s_addr = random();
</span><span class='line'>&#9;&#9;//自定义源地址192.168.204.136 = 0xc0a8cc88; 反转赋值
</span><span class='line'>&#9;&#9;ip-&gt;ip_src.s_addr = 0x88cca8c0;
</span><span class='line'>&#9;&#9;unsigned sum = csum_tcpudp_nofold(ip-&gt;ip_src.s_addr, ip-&gt;ip_dst.s_addr, sizeof(struct tcphdr)+op_len, IPPROTO_TCP, 0);
</span><span class='line'>&#9;&#9;tcp-&gt;check = check_sum((unsigned short*)tcp, sizeof(struct tcphdr)+op_len, sum);
</span><span class='line'>//        ip-&gt;ip_sum = check_sum((unsigned short*)ip, sizeof(struct ip), 0);
</span><span class='line'>&#9;&#9;sendto(skfd, buf, ip_len, 0, (struct sockaddr*)target, sizeof(struct sockaddr_in));
</span><span class='line'>&#9;}
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int main(int argc, char** argv)
</span><span class='line'>{
</span><span class='line'>&#9;int skfd;
</span><span class='line'>&#9;struct sockaddr_in target;
</span><span class='line'>&#9;struct hostent *host;
</span><span class='line'>&#9;const int on = 1;
</span><span class='line'>&#9;unsigned short srcport;
</span><span class='line'>
</span><span class='line'>&#9;if (argc != 4) {
</span><span class='line'>&#9;&#9;printf("Usage:%s dstip dstport srcport\n", argv[0]);
</span><span class='line'>&#9;&#9;exit(1);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;bzero(&target, sizeof(struct sockaddr_in));
</span><span class='line'>&#9;target.sin_family = AF_INET;
</span><span class='line'>&#9;target.sin_port = htons(atoi(argv[2]));
</span><span class='line'>
</span><span class='line'>&#9;if (inet_aton(argv[1], &target.sin_addr) == 0) {
</span><span class='line'>&#9;&#9;host = gethostbyname(argv[1]);
</span><span class='line'>&#9;&#9;if(host == NULL) {
</span><span class='line'>&#9;&#9;&#9;printf("TargetName Error:%s\n", hstrerror(h_errno));
</span><span class='line'>&#9;&#9;&#9;exit(1);
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;target.sin_addr = *(struct in_addr *)(host-&gt;h_addr_list[0]);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;//将协议字段置为IPPROTO_TCP，来创建一个TCP的原始套接字
</span><span class='line'>&#9;if (0 &gt; (skfd = socket(AF_INET, SOCK_RAW, IPPROTO_TCP))) {
</span><span class='line'>&#9;&#9;perror("Create Error");
</span><span class='line'>&#9;&#9;exit(1);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;//用模板代码来开启IP_HDRINCL特性，我们完全自己手动构造IP报文
</span><span class='line'>&#9;if (0 &gt; setsockopt(skfd, IPPROTO_IP, IP_HDRINCL, &on, sizeof(on))) {
</span><span class='line'>&#9;&#9;perror("IP_HDRINCL failed");
</span><span class='line'>&#9;&#9;exit(1);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;//因为只有root用户才可以play with raw socket :)
</span><span class='line'>&#9;setuid(getpid());
</span><span class='line'>&#9;srcport = atoi(argv[3]);
</span><span class='line'>&#9;attack(skfd, &target, srcport);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>原始套接字上也可以调用connet、bind之类的函数</li>
</ul>


<hr />

<h4>修改mac+iphdr+tcphdr</h4>

<p>blog.chinaunix.net/uid-23069658-id-3283534.html</p>

<p>在Linux系统中要从链路层(MAC)直接收发数帧，比较普遍的做法就是用libpcap和libnet两个动态库来实现。但今天我们就要用原始套接字来实现这个功能。</p>

<p><img src="/images/kernel/2015-04-14-4.jpg" alt="" /></p>

<p>这里的2字节帧类型用来指示该数据帧所承载的上层协议是IP、ARP或其他。</p>

<p>为了实现直接从链路层收发数据帧，我们要用到原始套接字的如下形式：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>socket(PF_PACKET, type, protocol)</span></code></pre></td></tr></table></div></figure>


<p>1、其中type字段可取SOCK_RAW或SOCK_DGRAM。它们两个都使用一种与设备无关的标准物理层地址结构struct sockaddr_ll{}，但具体操作的报文格式不同：</p>

<p>SOCK_RAW：直接向网络硬件驱动程序发送(或从网络硬件驱动程序接收)没有任何处理的完整数据报文(包括物理帧的帧头)，这就要求我们必须了解对应设备的物理帧帧头结构，才能正确地装载和分析报文。也就是说我们用这种套接字从网卡驱动上收上来的报文包含了MAC头部，如果我们要用这种形式的套接字直接向网卡发送数据帧，那么我们必须自己组装我们MAC头部。这正符合我们的需求。</p>

<p>SOCK_DGRAM：这种类型的套接字对于收到的数据报文的物理帧帧头会被系统自动去掉，然后再将其往协议栈上层传递；同样地，在发送时数据时，系统将会根据sockaddr_ll结构中的目的地址信息为数据报文添加一个合适的MAC帧头。</p>

<p>2、protocol字段，常见的，一般情况下该字段取ETH_P_IP，ETH_P_ARP，ETH_P_RARP或ETH_P_ALL，当然链路层协议很多，肯定不止我们说的这几个，但我们一般只关心这几个就够我们用了。这里简单提一下网络数据收发的一点基础。协议栈在组织数据收发流程时需要处理好两个方面的问题：“从上倒下”，即数据发送的任务；“从下到上”，即数据接收的任务。数据发送相对接收来说要容易些，因为对于数据接收而言，网卡驱动还要明确什么样的数据该接收、什么样的不该接收等问题。protocol字段可选的四个值及其意义如下：</p>

<p>protocol        值        作用<br/>
ETH_P_IP      0X0800   只接收发往目的MAC是本机的IP类型的数据帧<br/>
ETH_P_ARP     0X0806   只接收发往目的MAC是本机的ARP类型的数据帧<br/>
ETH_P_RARP    0X8035   只接受发往目的MAC是本机的RARP类型的数据帧<br/>
ETH_P_ALL     0X0003   接收发往目的MAC是本机的所有类型(ip,arp,rarp)的数据帧，同时还可以接收从本机发出去的所有数据帧。在混杂模式打开的情况下，还会接收到发往目的MAC为非本地硬件地址的数据帧。</p>

<p>protocol字段可取的所有协议参见/usr/include/linux/if_ether.h头文件里的定义。</p>

<p>最后，格外需要留心一点的就是，发送数据的时候需要自己组织整个以太网数据帧。和地址相关的结构体就不能再用前面的struct sockaddr_in{}了，而是struct sockaddr_ll{}，如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct sockaddr_ll{
</span><span class='line'>&#9;unsigned short sll_family; /* 总是 AF_PACKET */
</span><span class='line'>&#9;unsigned short sll_protocol; /* 物理层的协议 */
</span><span class='line'>&#9;int sll_ifindex; /* 接口号 */
</span><span class='line'>&#9;unsigned short sll_hatype; /* 报头类型 */
</span><span class='line'>&#9;unsigned char sll_pkttype; /* 分组类型 */
</span><span class='line'>&#9;unsigned char sll_halen; /* 地址长度 */
</span><span class='line'>&#9;unsigned char sll_addr[8]; /* 物理层地址 */
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>  sll_protocoll：取值在linux/if_ether.h中，可以指定我们所感兴趣的二层协议；</p>

<p>  sll_ifindex：置为0表示处理所有接口，对于单网卡的机器就不存在“所有”的概念了。如果你有多网卡，该字段的值一般通过ioctl来搞定，模板代码如下，如果我们要获取eth0接口的序号，可以使用如下代码来获取：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct  sockaddr_ll  sll;
</span><span class='line'>struct ifreq ifr;
</span><span class='line'>
</span><span class='line'>strcpy(ifr.ifr_name, "eth0");
</span><span class='line'>ioctl(sockfd, SIOCGIFINDEX, &ifr);
</span><span class='line'>sll.sll_ifindex = ifr.ifr_ifindex;</span></code></pre></td></tr></table></div></figure>


<p>  sll_hatype：ARP硬件地址类型，定义在 linux/if_arp.h 中。 取ARPHRD_ETHER时表示为以太网。</p>

<p>  sll_pkttype：包含分组类型。目前，有效的分组类型有：目标地址是本地主机的分组用的 PACKET_HOST，物理层广播分组用的 PACKET_BROADCAST ，发送到一个物理层多路广播地址的分组用的 PACKET_MULTICAST，在混杂(promiscuous)模式下的设备驱动器发向其他主机的分组用的 PACKET_OTHERHOST，源于本地主机的分组被环回到分组套接口用的 PACKET_OUTGOING。这些类型只对接收到的分组有意义。</p>

<p>  sll_addr和sll_halen指示物理层(如以太网，802.3，802.4或802.5等)地址及其长度，严格依赖于具体的硬件设备。类似于获取接口索引sll_ifindex，要获取接口的物理地址，可以采用如下代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct ifreq ifr;
</span><span class='line'>
</span><span class='line'>strcpy(ifr.ifr_name, "eth0");
</span><span class='line'>ioctl(sockfd, SIOCGIFHWADDR, &ifr);</span></code></pre></td></tr></table></div></figure>


<p> 缺省情况下，从任何接口收到的符合指定协议的所有数据报文都会被传送到原始PACKET套接字口，而使用bind系统调用并以一个sochddr_ll结构体对象将PACKET套接字与某个网络接口相绑定，就可使我们的PACKET原始套接字只接收指定接口的数据报文。</p>

<p> 接下来我们简单介绍一下网卡是怎么收报的，如果你对这部分已经很了解可以跳过这部分内容。网卡从线路上收到信号流，网卡的驱动程序会去检查数据帧开始的前6个字节，即目的主机的MAC地址，如果和自己的网卡地址一致它才会接收这个帧，不符合的一般都是直接无视。然后该数据帧会被网络驱动程序分解，IP报文将通过网络协议栈，最后传送到应用程序那里。往上层传递的过程就是一个校验和“剥头”的过程，由协议栈各层去实现。</p>

<p>接下来我们来写个简单的抓包程序，将那些发给本机的IPv4报文全打印出来：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;errno.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;sys/socket.h&gt;
</span><span class='line'>#include &lt;sys/types.h&gt;
</span><span class='line'>#include &lt;netinet/in.h&gt;
</span><span class='line'>#include &lt;netinet/ip.h&gt;
</span><span class='line'>#include &lt;netinet/if_ether.h&gt;
</span><span class='line'>
</span><span class='line'>int main(int argc, char **argv)
</span><span class='line'>{
</span><span class='line'>&#9;int sock, n;
</span><span class='line'>&#9;char buffer[2048];
</span><span class='line'>&#9;struct ethhdr *eth;
</span><span class='line'>&#9;struct iphdr *iph;
</span><span class='line'>
</span><span class='line'>&#9;if (0 &gt; (sock = socket(PF_PACKET, SOCK_RAW, htons(ETH_P_IP)))) {
</span><span class='line'>&#9;&#9;perror("socket");
</span><span class='line'>&#9;&#9;exit(1);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;while (1) {
</span><span class='line'>&#9;&#9;printf("=====================================\n");
</span><span class='line'>&#9;&#9;//注意：在这之前我没有调用bind函数，原因是什么呢？
</span><span class='line'>&#9;&#9;n = recvfrom(sock, buffer, 2048, 0, NULL, NULL);
</span><span class='line'>&#9;&#9;printf("%d bytes read\n", n);
</span><span class='line'>
</span><span class='line'>&#9;&#9;//接收到的数据帧头6字节是目的MAC地址，紧接着6字节是源MAC地址。
</span><span class='line'>&#9;&#9;eth = (struct ethhdr*)buffer;
</span><span class='line'>&#9;&#9;printf("Dest MAC addr:%02x:%02x:%02x:%02x:%02x:%02x\n",eth-&gt;h_dest[0],eth-&gt;h_dest[1],eth-&gt;h_dest[2],eth-&gt;h_dest[3],eth-&gt;h_dest[4],eth-&gt;h_dest[5]);
</span><span class='line'>&#9;&#9;printf("Source MAC addr:%02x:%02x:%02x:%02x:%02x:%02x\n",eth-&gt;h_source[0],eth-&gt;h_source[1],eth-&gt;h_source[2],eth-&gt;h_source[3],eth-&gt;h_source[4],eth-&gt;h_source[5]);
</span><span class='line'>
</span><span class='line'>&#9;&#9;iph = (struct iphdr*)(buffer + sizeof(struct ethhdr));
</span><span class='line'>&#9;&#9;//我们只对IPV4且没有选项字段的IPv4报文感兴趣
</span><span class='line'>&#9;&#9;if(iph-&gt;version == 4 && iph-&gt;ihl == 5){
</span><span class='line'>&#9;&#9;&#9;unsigned char *sd, *dd;
</span><span class='line'>&#9;&#9;&#9;sd = (unsigned char*)&iph-&gt;saddr;
</span><span class='line'>&#9;&#9;&#9;dd = (unsigned char*)&iph-&gt;daddr;
</span><span class='line'>&#9;&#9;&#9;printf("Source Host: %d.%d.%d.%d Dest host: %d.%d.%d.%d\n", sd[0], sd[1], sd[2], sd[3], dd[0], dd[1], dd[2], dd[3]);
</span><span class='line'>&#9;&#9;//    printf("Source host:%s\n", inet_ntoa(iph-&gt;saddr));
</span><span class='line'>&#9;&#9;//    printf("Dest host:%s\n", inet_ntoa(iph-&gt;daddr));
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>构造mac源地址包，注意目标mac地址要正确，可以本机先抓包看看是什么</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;errno.h&gt;
</span><span class='line'>#include &lt;string.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;netdb.h&gt;
</span><span class='line'>#include &lt;sys/socket.h&gt;
</span><span class='line'>#include &lt;sys/types.h&gt;
</span><span class='line'>#include &lt;netinet/in.h&gt;
</span><span class='line'>#include &lt;netinet/ip.h&gt;
</span><span class='line'>#include &lt;arpa/inet.h&gt;
</span><span class='line'>#include &lt;linux/tcp.h&gt;
</span><span class='line'>
</span><span class='line'>#include &lt;linux/if_ether.h&gt;
</span><span class='line'>#include &lt;linux/if_arp.h&gt;
</span><span class='line'>#include &lt;linux/sockios.h&gt;
</span><span class='line'>
</span><span class='line'>unsigned csum_tcpudp_nofold(unsigned saddr, unsigned daddr,
</span><span class='line'>&#9;&#9;&#9;unsigned len, unsigned proto, unsigned sum)
</span><span class='line'>{
</span><span class='line'>&#9;unsigned long long s = (unsigned)sum;
</span><span class='line'>&#9;s += (unsigned)saddr;
</span><span class='line'>&#9;s += (unsigned)daddr;
</span><span class='line'>&#9;s += (proto + len) &lt;&lt; 8;
</span><span class='line'>&#9;s += (s &gt;&gt; 32);
</span><span class='line'>&#9;return (unsigned)s;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>unsigned short check_sum(unsigned short *addr, int len, unsigned sum)
</span><span class='line'>{
</span><span class='line'>&#9;int nleft = len;
</span><span class='line'>&#9;unsigned short *w = addr;
</span><span class='line'>&#9;unsigned short ret = 0;
</span><span class='line'>&#9;while (nleft &gt; 1) {
</span><span class='line'>&#9;&#9;sum += *w++;
</span><span class='line'>&#9;&#9;nleft -= 2;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (nleft == 1) {
</span><span class='line'>&#9;&#9;*(unsigned char *)(&ret) = *(unsigned char *)w;
</span><span class='line'>&#9;&#9;sum += ret;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;sum = (sum&gt;&gt;16) + (sum&0xffff);
</span><span class='line'>&#9;sum += (sum&gt;&gt;16);
</span><span class='line'>&#9;ret = ~sum;
</span><span class='line'>&#9;return ret;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int change(char c)
</span><span class='line'>{
</span><span class='line'>&#9;if (c &gt;= 'a') return c-'a'+10;
</span><span class='line'>&#9;if (c &gt;= 'A') return c-'A'+10;
</span><span class='line'>&#9;return c-'0';
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>//在该函数中构造整个IP报文，最后调用sendto函数将报文发送出去
</span><span class='line'>void attack(int skfd, struct sockaddr_ll *target, char **argv)
</span><span class='line'>{
</span><span class='line'>&#9;char buf[512]={0};
</span><span class='line'>&#9;struct ethhdr *eth;
</span><span class='line'>&#9;struct ip *ip;
</span><span class='line'>&#9;struct tcphdr *tcp;
</span><span class='line'>&#9;int pks_len;
</span><span class='line'>&#9;int i;
</span><span class='line'>&#9;int op_len = 12;
</span><span class='line'>&#9;unsigned short dstport;
</span><span class='line'>&#9;dstport = atoi(argv[3]);
</span><span class='line'>
</span><span class='line'>&#9;//在我们TCP的报文中Data没有字段，所以整个IP报文的长度
</span><span class='line'>&#9;pks_len = sizeof(struct ethhdr) + sizeof(struct ip) + sizeof(struct tcphdr) + op_len;
</span><span class='line'>&#9;eth = (struct ethhdr *) buf;
</span><span class='line'>&#9;/*
</span><span class='line'>&#9;eth-&gt;h_dest[0] = 0x00;
</span><span class='line'>&#9;eth-&gt;h_dest[1] = 0x50;
</span><span class='line'>&#9;eth-&gt;h_dest[2] = 0x56;
</span><span class='line'>&#9;eth-&gt;h_dest[3] = 0xee;
</span><span class='line'>&#9;eth-&gt;h_dest[4] = 0x14;
</span><span class='line'>&#9;eth-&gt;h_dest[5] = 0xa6;
</span><span class='line'>&#9;*/
</span><span class='line'>
</span><span class='line'>&#9;for (i=0;i&lt;6;i++)
</span><span class='line'>&#9;&#9;eth-&gt;h_dest[i] = change(argv[1][i*3])*16 + change(argv[1][i*3+1]);
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9;eth-&gt;h_source[0] = 0x00;
</span><span class='line'>&#9;eth-&gt;h_source[1] = 0x0b;
</span><span class='line'>&#9;eth-&gt;h_source[2] = 0x28;
</span><span class='line'>&#9;eth-&gt;h_source[3] = 0xd7;
</span><span class='line'>&#9;eth-&gt;h_source[4] = 0x26;
</span><span class='line'>&#9;eth-&gt;h_source[5] = 0xa6;
</span><span class='line'>&#9;*/
</span><span class='line'>&#9;eth-&gt;h_proto = ntohs(ETH_P_IP);
</span><span class='line'>
</span><span class='line'>&#9;//开始填充IP首部
</span><span class='line'>&#9;ip=(struct ip*)(buf + sizeof(struct ethhdr));
</span><span class='line'>&#9;ip-&gt;ip_v = IPVERSION;
</span><span class='line'>&#9;ip-&gt;ip_hl = sizeof(struct ip) &gt;&gt; 2;
</span><span class='line'>&#9;ip-&gt;ip_tos = 0;
</span><span class='line'>&#9;ip-&gt;ip_len = htons(pks_len - sizeof(struct ethhdr));
</span><span class='line'>&#9;ip-&gt;ip_id = 0;
</span><span class='line'>&#9;ip-&gt;ip_off = 0;
</span><span class='line'>&#9;ip-&gt;ip_ttl = MAXTTL;
</span><span class='line'>&#9;ip-&gt;ip_p = IPPROTO_TCP;
</span><span class='line'>&#9;ip-&gt;ip_sum = 0;
</span><span class='line'>&#9;ip-&gt;ip_dst.s_addr = inet_addr(argv[2]);
</span><span class='line'>
</span><span class='line'>&#9;//开始填充TCP首部
</span><span class='line'>&#9;srand(time(NULL));
</span><span class='line'>&#9;tcp = (struct tcphdr*)(buf + sizeof(struct ethhdr) + sizeof(struct ip));
</span><span class='line'>&#9;tcp-&gt;source = random()%50000+10000;
</span><span class='line'>&#9;tcp-&gt;dest = ntohs(dstport);
</span><span class='line'>&#9;tcp-&gt;seq = random();
</span><span class='line'>&#9;tcp-&gt;doff = (sizeof(struct tcphdr) + op_len) &gt;&gt; 2;
</span><span class='line'>&#9;tcp-&gt;syn = 1;
</span><span class='line'>&#9;tcp-&gt;check = 0;
</span><span class='line'>&#9;tcp-&gt;window = ntohs(14600);
</span><span class='line'>
</span><span class='line'>&#9;i = pks_len - op_len;
</span><span class='line'>&#9;// mss = 1460
</span><span class='line'>&#9;buf[i++] = 0x02;
</span><span class='line'>&#9;buf[i++] = 0x04;
</span><span class='line'>&#9;buf[i++] = 0x05;
</span><span class='line'>&#9;buf[i++] = 0xb4;
</span><span class='line'>&#9;// sack
</span><span class='line'>&#9;buf[i++] = 0x01;
</span><span class='line'>&#9;buf[i++] = 0x01;
</span><span class='line'>&#9;buf[i++] = 0x04;
</span><span class='line'>&#9;buf[i++] = 0x02;
</span><span class='line'>&#9;// wsscale = 7
</span><span class='line'>&#9;buf[i++] = 0x01;
</span><span class='line'>&#9;buf[i++] = 0x03;
</span><span class='line'>&#9;buf[i++] = 0x03;
</span><span class='line'>&#9;buf[i++] = 0x07;
</span><span class='line'>
</span><span class='line'>&#9;int T = 1;
</span><span class='line'>&#9;while(1) {
</span><span class='line'>&#9;&#9;if (T == 0) break;
</span><span class='line'>&#9;&#9;T--;
</span><span class='line'>&#9;&#9;//源地址伪造，我们随便任意生成个地址，让服务器一直等待下去
</span><span class='line'>&#9;&#9;ip-&gt;ip_src.s_addr = random();
</span><span class='line'>&#9;&#9;//自定义源地址192.168.204.136 =&gt; 0xc0a8cc88
</span><span class='line'>&#9;&#9;//ip-&gt;ip_src.s_addr = 0x8fcca8c0;
</span><span class='line'>&#9;&#9;unsigned sum = csum_tcpudp_nofold(ip-&gt;ip_src.s_addr, ip-&gt;ip_dst.s_addr, sizeof(struct tcphdr)+op_len, IPPROTO_TCP, 0);
</span><span class='line'>&#9;&#9;tcp-&gt;check = check_sum((unsigned short*)tcp, sizeof(struct tcphdr)+op_len, sum);
</span><span class='line'>&#9;&#9;ip-&gt;ip_sum = check_sum((unsigned short*)ip, sizeof(struct ip), 0);
</span><span class='line'>&#9;&#9;sendto(skfd, buf, pks_len, 0, (struct sockaddr*)target, sizeof(struct sockaddr_ll));
</span><span class='line'>&#9;}
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int main(int argc, char** argv)
</span><span class='line'>{
</span><span class='line'>&#9;int skfd;
</span><span class='line'>&#9;struct sockaddr_ll target;
</span><span class='line'>&#9;struct hostent *host;
</span><span class='line'>&#9;const int on=1;
</span><span class='line'>
</span><span class='line'>&#9;if (argc != 4) {
</span><span class='line'>&#9;&#9;printf("Usage:%s dstmac dstip dstport\n", argv[0]);
</span><span class='line'>&#9;&#9;exit(1);
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (strlen(argv[1]) != 17) {
</span><span class='line'>&#9;&#9;printf("Usage: dstmac must be xx:xx:xx:xx:xx:xx\n");
</span><span class='line'>&#9;&#9;exit(1);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;//将协议字段置为IPPROTO_TCP，来创建一个TCP的原始套接字
</span><span class='line'>&#9;if (0 &gt; (skfd = socket(PF_PACKET, SOCK_RAW, htons(ETH_P_IP)))) {
</span><span class='line'>&#9;&#9;perror("Create Error");
</span><span class='line'>&#9;&#9;exit(1);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;// mac
</span><span class='line'>&#9;bzero(&target, sizeof(struct sockaddr_ll));
</span><span class='line'>
</span><span class='line'>&#9;struct ifreq ifr;
</span><span class='line'>&#9;strncpy(ifr.ifr_name, "eth0", IFNAMSIZ);
</span><span class='line'>&#9;ioctl(skfd, SIOCGIFINDEX, &ifr);
</span><span class='line'>&#9;target.sll_ifindex = ifr.ifr_ifindex;
</span><span class='line'>&#9;/*
</span><span class='line'>&#9;target.sll_family = AF_PACKET;
</span><span class='line'>&#9;target.sll_protocol = ntohs(80);
</span><span class='line'>&#9;target.sll_hatype = ARPHRD_ETHER;
</span><span class='line'>&#9;target.sll_pkttype = PACKET_OTHERHOST;
</span><span class='line'>&#9;target.sll_halen = ETH_ALEN;
</span><span class='line'>&#9;memset(target.sll_addr,0,8);
</span><span class='line'>&#9;target.sll_addr[0] = 0x00;
</span><span class='line'>&#9;target.sll_addr[1] = 0x0C;
</span><span class='line'>&#9;target.sll_addr[2] = 0x29;
</span><span class='line'>&#9;target.sll_addr[3] = 0x61;
</span><span class='line'>&#9;target.sll_addr[4] = 0xB6;
</span><span class='line'>&#9;target.sll_addr[5] = 0x43;
</span><span class='line'>&#9;*/
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9;//http://blog.chinaunix.net/uid-305141-id-2133781.html
</span><span class='line'>&#9;struct sockaddr_ll sll;
</span><span class='line'>&#9;struct ifreq ifstruct;
</span><span class='line'>&#9;memset (&sll, 0, sizeof (sll));
</span><span class='line'>&#9;sll.sll_family = PF_PACKET;
</span><span class='line'>&#9;sll.sll_protocol = htons (ETH_P_IP);
</span><span class='line'>
</span><span class='line'>&#9;strcpy (ifstruct.ifr_name, "eth0");
</span><span class='line'>&#9;ioctl (skfd, SIOCGIFINDEX, &ifstruct);
</span><span class='line'>&#9;sll.sll_ifindex = ifstruct.ifr_ifindex;
</span><span class='line'>
</span><span class='line'>&#9;strcpy (ifstruct.ifr_name, "eth0");
</span><span class='line'>&#9;ioctl (skfd, SIOCGIFHWADDR, &ifstruct);
</span><span class='line'>&#9;memcpy (sll.sll_addr, ifstruct.ifr_ifru.ifru_hwaddr.sa_data, ETH_ALEN);
</span><span class='line'>&#9;sll.sll_halen = ETH_ALEN;
</span><span class='line'>
</span><span class='line'>&#9;if (bind (skfd, (struct sockaddr *) &sll, sizeof (sll)) == -1) {
</span><span class='line'>&#9;&#9;printf ("bind:   ERROR\n");
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;memset(&ifstruct, 0, sizeof(ifstruct));
</span><span class='line'>&#9;strcpy (ifstruct.ifr_name, "eth0");
</span><span class='line'>&#9;if (ioctl (skfd, SIOCGIFFLAGS, &ifstruct) == -1) {
</span><span class='line'>&#9;&#9;perror ("iotcl()\n");
</span><span class='line'>&#9;&#9;printf ("Fun:%s Line:%d\n", __func__, __LINE__);
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;ifstruct.ifr_flags |= IFF_PROMISC;
</span><span class='line'>
</span><span class='line'>&#9;if(ioctl(skfd, SIOCSIFFLAGS, &ifstruct) == -1) {
</span><span class='line'>&#9;&#9;perror("iotcl()\n");
</span><span class='line'>&#9;&#9;printf ("Fun:%s Line:%d\n", __func__, __LINE__);
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;} 
</span><span class='line'>*/
</span><span class='line'>&#9;//因为只有root用户才可以play with raw socket :)
</span><span class='line'>&#9;setuid(getpid());
</span><span class='line'>//    attack(skfd, &sll, srcport);
</span><span class='line'>&#9;attack(skfd, &target, argv);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>



</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">kk</span></span>

      




<time class='entry-date' datetime='2015-04-14T21:27:00+08:00'><span class='date'>2015-04-14</span> <span class='time'>21:27:00</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/cats/kernel/'>kernel</a>, <a class='category' href='/blog/cats/kernel~net/'>net</a>
  
</span>


    </p>
    
      
    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/04/10/kernel-net-skbuff/" title="Previous Post: sk_buff详解">&laquo; sk_buff详解</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/04/15/kernel-net-sum/" title="Next Post: TCP校验和的原理和实现">TCP校验和的原理和实现 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>
<aside class="sidebar" id='load_sidebar'>
</aside>
<script type="text/javascript">
  $('#load_sidebar').load('/sidebar.html');
</script>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - kk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <a title="Top" href="#" id="scroll2top" style="position: fixed; height: 50px; bottom: 30px; right: 25px; cursor: pointer; z-index: 9999; display: block; opacity: 1;"><img src="/images/scrollup.png"></a>
  <script src="/javascripts/scroll2top.js"></script>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253604690'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1253604690' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  





</body>
</html>
