
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>kk Blog —— 通用基础</title>

  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="kk Blog —— 通用基础" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/category.js" type="text/javascript"></script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kk Blog —— 通用基础</a></h1>
  
    <h2>cp -rf * .</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
<li>
<form action="/search" method="get">
    <input class="search" name="query" id="query" type="text" placeholder="search...">
    <input id="btnSubmit" value="search" type="submit">
</form>
<script type="text/javascript">
var query = GetRequest("query");
if (query != null) {
	document.getElementById("query").value = query;
}
</script>
</li>
  <li><a href="/atom.xml" rel="subscribe-rss">RSS</a></li>
  
</ul>
  
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/download">Download</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/09/18/kernel-mm-swap/">Linux swap实现</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-09-18T11:16:00+08:00'><span class='date'>2015-09-18</span> <span class='time'>11:16:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.csdn.net/freas_1990/article/details/9090601">http://blog.csdn.net/freas_1990/article/details/9090601</a></p>

<p>swap是现代Unix操作系统一个非常重要的特性。尤其在大型数据库服务器上，swap往往是性能首要查看指标。</p>

<p>通俗的说法，在Unix里，将开辟一个磁盘分区，用作swap，这块磁盘将作为内存的的替代品，在内存不够用的时候，把一部分内存空间交换到磁盘上去。</p>

<p>而Unix的swap功能也成为了Unixer们认为Unix由于windows的一个论据（？）。在Unix里，swap一般被认为设置为内存的2倍大小。这个2倍大小的指标出自哪里，到目前为止我也没有找到（？如果你找到了可以留言或发私信）。</p>

<p>不过，在内存不断掉价的今天，swap的功效已经越来越弱化了——在2013年6月13日23:01，如果一个OLTP系统的swap使用超过了2G以上，基本上可以对这个系统的性能产生怀疑了。swap并不是一种优化机制，而是一种不得已而为之的手段，防止在内存紧张的时刻，操作系统性能骤降以至瞬间崩溃。swap的价值主要体现在可以把这个崩溃的时间提升至几小时到几十个小时不等。</p>

<p>本文主要关注CPU访问一个内存page时，发现该page不在内存中的情况。废话不多说了，先把swap的核心函数调用栈贴一下。</p>

<p><img src="/images/kernel/2015-09-18-11.png" alt="" /></p>

<p>当CPU检查一个页目录项/页表项的Present标志位时，如果发现该标志位为0，则表示相应的物理页面不在内存。此时，CPU会被激发“页面异常”（中断中的fault），而去执行一段代码。</p>

<p>至于到底是这个内存页面需要重新构建、还是页面的内容是存储到磁盘上去了，CPU本身是不关心的，CPU只知道中断条件发生了，要根据中断描述符跳转到另外一段代码去执行，而真正的swap或者是真的缺页的智能判断是在这段中断服务程序里做的——真正的技术是在这段中断服务程序里。（所以我在《中断——一鞭一条痕（下）》里说，作为一个初学者，不必深究中断（interrupt）、异常（exception）、陷阱（trap）这三个概念）</p>

<p>pte_present()函数会检查当前页面的描述entry的present标志位，查看该page是否在内存中。如果不在内存中，调用pte_none()判断是否建立了页目录、页表映射。如果连映射都没建立，说明是“真没在内存中”，需要从头建立映射关系。如果建立了映射关系，说明此时，该页面被暂时存储到磁盘上去了，应该到磁盘上去把该page取回来放到内存里。</p>

<p>如何去取呢？</p>

<p>如何到磁盘取一个page的数据到内存中去，这是一个多么熟悉的概念！思考一下Oracle的内存管理，一个block如何读入到SGA的buffer cache里去吧。其实这几十年来，核心的本源技术无论是在操作系统内核还是在数据库内核里，都是通用的，都是用来极大限度提升CPU任务管理能力、内存管理效率的，所有的理念、技术都是通用的——如果你站在一个系统程序猿的角度来思考，一定能明白的——不要把自己局限在一个产品里，无论这个产品是数据库、CPU、还是操作系统，这些看似绚烂神秘的技术在30年以前，已经被人反复的讨论和意淫过了。</p>

<p>接下来就到了核心部分了——do_swap_page()函数。</p>

<p>源代码如下（linux/mm/memory.c line 2022~1060）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int do_swap_page(struct mm_struct * mm,
</span><span class='line'>&#9;struct vm_area_struct * vma, unsigned long address,
</span><span class='line'>&#9;pte_t * page_table, swp_entry_t entry, int write_access)
</span><span class='line'>{ 
</span><span class='line'>&#9;struct page *page = lookup_swap_cache(entry);
</span><span class='line'>&#9;pte_t pte;
</span><span class='line'>
</span><span class='line'>&#9;if (!page) {
</span><span class='line'>&#9;&#9;lock_kernel();
</span><span class='line'>&#9;&#9;swapin_readahead(entry);
</span><span class='line'>&#9;&#9;page = read_swap_cache(entry);
</span><span class='line'>&#9;&#9;unlock_kernel();
</span><span class='line'>&#9;&#9;if (!page)
</span><span class='line'>&#9;&#9;&#9;return -1;
</span><span class='line'>
</span><span class='line'>&#9;&#9;flush_page_to_ram(page);
</span><span class='line'>&#9;&#9;flush_icache_page(vma, page);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;mm-&gt;rss++;
</span><span class='line'>
</span><span class='line'>&#9;pte = mk_pte(page, vma-&gt;vm_page_prot);
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * Freeze the "shared"ness of the page, ie page_count + swap_count.
</span><span class='line'>&#9; * Must lock page before transferring our swap count to already
</span><span class='line'>&#9; * obtained page count.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;lock_page(page);
</span><span class='line'>&#9;swap_free(entry);
</span><span class='line'>&#9;if (write_access && !is_page_shared(page))
</span><span class='line'>&#9;&#9;pte = pte_mkwrite(pte_mkdirty(pte));
</span><span class='line'>&#9;UnlockPage(page);
</span><span class='line'>
</span><span class='line'>&#9;set_pte(page_table, pte);
</span><span class='line'>&#9;/* No need to invalidate - it was non-present before */
</span><span class='line'>&#9;update_mmu_cache(vma, address, pte);
</span><span class='line'>&#9;return 1;   /* Minor fault */
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>这里有2个参数需要重点关注，一个是<code>(pte_t *)page_table</code>，另外一个是<code>(swp_entry_t*)entry</code>。</p>

<p>当一个page在内存中，不需要swap in时，描述该page的entry是pte_t类型的；反之，是swp_entry_t类型。</p>

<p>swap_entry_t(include/linux/shmem_fs.h)定义如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>typedef struct {
</span><span class='line'>&#9;unsigned long val;
</span><span class='line'>} swp_entry_t;</span></code></pre></td></tr></table></div></figure>


<p>问题出来了，既然都进入do_swap_page()函数了，说明是需要swap in了，为什么还会传入一个pte_t类型的变量呢？</p>

<p>答案是，当在do_swap_page()之前，page是在磁盘上的，描述类型是swp_entry_t，而do_swap_page()之后，页面已经从磁盘交换到内存了，这个时候描述类型就是pte_t了。</p>

<p>至于lookup_swap_cache、swapin_readahead（预读——read ahead）等函数就不一一分析了，从名字就可以看出其技巧了。都是些在数据库server上的常用技巧。如果你是行家，一眼就能看出来。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/09/18/kernel-mm-cache-base/">Linux Cache 机制探究</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-09-18T10:57:00+08:00'><span class='date'>2015-09-18</span> <span class='time'>10:57:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.penglixun.com/tech/system/linux_cache_discovery.html">http://www.penglixun.com/tech/system/linux_cache_discovery.html</a></p>

<p>相关源码主要在：<br/>
./fs/fscache/cache.c    Cache实现的代码<br/>
./mm/slab.c             SLAB管理器代码<br/>
./mm/swap.c             缓存替换算法代码<br/>
./mm/mmap.c             内存管理器代码<br/>
./mm/mempool.c          内存池实现代码</p>

<h4>0. 预备：Linux内存管理基础</h4>

<p>创建进程fork()、程序载入execve()、映射文件mmap()、动态内存分配malloc()/brk()等进程相关操作都需要分配内存给进程。不过这时进程申请和获得的还不是实际内存，而是虚拟内存，准确的说是“内存区域”。Linux除了内核以外，App都不能直接使用内存，因为Linux采用Memory Map的管理方式，App拿到的全部是内核映射自物理内存的一块虚拟内存。malloc分配很少会失败，因为malloc只是通知内存App需要内存，在没有正式使用之前，这段内存其实只在真正开始使用的时候才分配，所以malloc成功了并不代表使用的时候就真的可以拿到这么多内存。据说Google的tcmalloc改进了这一点。</p>

<p>进程对内存区域的分配最终多会归结到do_mmap()函数上来（brk调用被单独以系统调用实现，不用do_mmap()）。内核使用do_mmap()函数创建一个新的线性地址区间，如果创建的地址区间和一个已经存在的地址区间相邻，并且它们具有相同的访问权限的话，那么两个区间将合并为一个。如果不能合并，那么就确实需要创建一个新的VMA了。但无论哪种情况， do_mmap()函数都会将一个地址区间加入到进程的地址空间中，无论是扩展已存在的内存区域还是创建一个新的区域。同样释放一个内存区域使用函数do_ummap()，它会销毁对应的内存区域。</p>

<p>另一个重要的部分是SLAB分配器。在Linux中以页为最小单位分配内存对于内核管理系统物理内存来说是比较方便的，但内核自身最常使用的内存却往往是很小（远远小于一页）的内存块，因为大都是一些描述符。一个整页中可以聚集多个这种这些小块内存，如果一样按页分配，那么会被频繁的创建/销毁，开始是非常大的。</p>

<p>为了满足内核对这种小内存块的需要，Linux系统采用了SLAB分配器。Slab分配器的实现相当复杂，但原理不难，其核心思想就是Memory Pool。内存片段（小块内存）被看作对象，当被使用完后，并不直接释放而是被缓存到Memory Pool里，留做下次使用，这就避免了频繁创建与销毁对象所带来的额外负载。</p>

<p>Slab技术不但避免了内存内部分片带来的不便，而且可以很好利用硬件缓存提高访问速度。但Slab仍然是建立在页面基础之上，Slab将页面分成众多小内存块以供分配，Slab中的对象分配和销毁使用kmem_cache_alloc与kmem_cache_free。</p>

<p>关于SALB分配器有一份资料：<a href="http://lsec.cc.ac.cn/~tengfei/doc/ldd3/ch08s02.html">http://lsec.cc.ac.cn/~tengfei/doc/ldd3/ch08s02.html</a></p>

<p>关于内存管理的两份资料：<a href="http://lsec.cc.ac.cn/~tengfei/doc/ldd3/ch15.html">http://lsec.cc.ac.cn/~tengfei/doc/ldd3/ch15.html</a></p>

<p><a href="http://memorymyann.javaeye.com/blog/193061">http://memorymyann.javaeye.com/blog/193061</a></p>

<h4>1. Linux Cache的体系</h4>

<p>在 Linux 中，当App需要读取Disk文件中的数据时，Linux先分配一些内存，将数据从Disk读入到这些内存中，然后再将数据传给App。当需要往文件中写数据时，Linux先分配内存接收用户数据，然后再将数据从内存写到Disk上。Linux Cache 管理指的就是对这些由Linux分配，并用来存储文件数据的内存的管理。</p>

<p>下图描述了 Linux 中文件 Cache 管理与内存管理以及文件系统的关系。从图中可以看到，在 Linux 中，具体的文件系统，如 ext2/ext3/ext4 等，负责在文件 Cache和存储设备之间交换数据，位于具体文件系统之上的虚拟文件系统VFS负责在应用程序和文件 Cache 之间通过 read/write 等接口交换数据，而内存管理系统负责文件 Cache 的分配和回收，同时虚拟内存管理系统(VMM)则允许应用程序和文件 Cache 之间通过 memory map的方式交换数据，FS Cache底层通过SLAB管理器来管理内存。</p>

<p><img src="/images/kernel/2015-09-18-1.jpg" alt="" /></p>

<p>下图则非常清晰的描述了Cache所在的位置，磁盘与VFS之间的纽带。</p>

<p><img src="/images/kernel/2015-09-18-2.jpg" alt="" /></p>

<h4>2. Linux Cache的结构</h4>

<p>在 Linux 中，文件 Cache 分为两层，一是 Page Cache，另一个 Buffer Cache，每一个 Page Cache 包含若干 Buffer Cache。内存管理系统和 VFS 只与 Page Cache 交互，内存管理系统负责维护每项 Page Cache 的分配和回收，同时在使用 memory map 方式访问时负责建立映射；VFS 负责 Page Cache 与用户空间的数据交换。而具体文件系统则一般只与 Buffer Cache 交互，它们负责在外围存储设备和 Buffer Cache 之间交换数据。读缓存以Page Cache为单位，每次读取若干个Page Cache，回写磁盘以Buffer Cache为单位，每次回写若干个Buffer Cache。
Page Cache、Buffer Cache、文件以及磁盘之间的关系如下图所示。</p>

<p><img src="/images/kernel/2015-09-18-3.jpg" alt="" /></p>

<p>Page 结构和 buffer_head 数据结构的关系如下图所示。Page指向一组Buffer的头指针，Buffer的头指针指向磁盘块。在这两个图中，假定了 Page 的大小是 4K，磁盘块的大小是 1K。</p>

<p><img src="/images/kernel/2015-09-18-4.jpg" alt="" /></p>

<p>在 Linux 内核中，文件的每个数据块最多只能对应一个 Page Cache 项，它通过两个数据结构来管理这些 Cache 项，一个是 Radix Tree，另一个是双向链表。Radix Tree 是一种搜索树，Linux 内核利用这个数据结构来通过文件内偏移快速定位 Cache 项，图 4 是 radix tree的一个示意图，该 radix tree 的分叉为4(22)，树高为4，用来快速定位8位文件内偏移。Linux(2.6.7) 内核中的分叉为 64(26)，树高为 6(64位系统)或者 11(32位系统)，用来快速定位 32 位或者 64 位偏移，Radix tree 中的每一个到叶子节点的路径上的Key所拼接起来的字串都是一个地址，指向文件内相应偏移所对应的Cache项。</p>

<p><img src="/images/kernel/2015-09-18-5.gif" alt="" /></p>

<p>查看Page Cache的核心数据结构struct address_space就可以看到上述结构（略去了无关结构）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct address_space  {
</span><span class='line'>&#9;struct inode             *host;              /* owner: inode, block_device */
</span><span class='line'>&#9;struct radix_tree_root      page_tree;         /* radix tree of all pages */
</span><span class='line'>&#9;unsigned long           nrpages;  /* number of total pages */
</span><span class='line'>&#9;struct address_space       *assoc_mapping;      /* ditto */
</span><span class='line'>&#9;......
</span><span class='line'>} __attribute__((aligned(sizeof(long))));</span></code></pre></td></tr></table></div></figure>


<p>下面是一个Radix Tree实例：</p>

<p><img src="/images/kernel/2015-09-18-6.jpg" alt="" /></p>

<p>另一个数据结构是双向链表，Linux内核为每一片物理内存区域(zone) 维护active_list和inactive_list两个双向链表，这两个list主要用来实现物理内存的回收。这两个链表上除了文件Cache之 外，还包括其它匿名(Anonymous)内存，如进程堆栈等。</p>

<p><img src="/images/kernel/2015-09-18-7.png" alt="" /></p>

<p>相关数据结构如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>truct page{
</span><span class='line'>&#9;struct list_head list;   //通过使用它进入下面的数据结构free_area_struct结构中的双向链队列
</span><span class='line'>&#9;struct address_space * mapping;   //用于内存交换的数据结构
</span><span class='line'>&#9;unsigned long index;//当页面进入交换文件后
</span><span class='line'>&#9;struct page *next_hash; //自身的指针，这样就可以链接成一个链表
</span><span class='line'>&#9;atomic t count; //用于页面交换的计数,若页面为空闲则为0，分配就赋值1，没建立或恢复一次映射就加1，断开映射就减一
</span><span class='line'>&#9;unsigned long flags;//反应页面各种状态，例如活跃，不活跃脏，不活跃干净，空闲
</span><span class='line'>&#9;struct list_head lru;
</span><span class='line'>&#9;unsigned long age; //表示页面寿命
</span><span class='line'>&#9;wait_queue_head_t wait;
</span><span class='line'>&#9;struct page ** pprev_hash;
</span><span class='line'>&#9;struct buffer_head * buffers;
</span><span class='line'>&#9;void * virtual
</span><span class='line'>&#9;struct zone_struct * zone; //指向所属的管理区
</span><span class='line'>}
</span><span class='line'>typedef struct free_area_struct {
</span><span class='line'>&#9;struct list_head free_list;   //linux 中通用的双向链队列
</span><span class='line'>&#9;unsigned int * map;
</span><span class='line'>} free_area_t;
</span><span class='line'>typedef struct zone_struct{
</span><span class='line'>&#9;spinlock_t        lock;
</span><span class='line'>&#9;unsigned long offset;  //表示该管理区在mem-map数组中，起始的页号
</span><span class='line'>&#9;unsigned long free pages;
</span><span class='line'>&#9;unsigned long inactive_clean_pages;
</span><span class='line'>&#9;unsigned long inactive_dirty_pages;
</span><span class='line'>&#9;unsigned pages_min, pages_low, pages_high;
</span><span class='line'>&#9;struct list_head inactive_clean_list;   //用于页面交换的队列，基于linux页面交换的机制。这里存贮的是不活动“干净”页面
</span><span class='line'>&#9;free_area_t free_area[MAX_ORDER]; //一组“空闲区间”队列，free_area_t定义在上面，其中空闲下标表示的是页面大小，例如：数组第一个元素0号，表示所有区间大小为2的 0次方的页面链接成的双向队列，1号表示所有2的1次方页面链接链接成的双向队列，2号表示所有2的2次方页面链接成的队列，其中要求是这些页面地址连续
</span><span class='line'>&#9;char * name;
</span><span class='line'>&#9;unsigned long size;
</span><span class='line'>&#9;struct pglist_data * zone_pgdat;   //用于指向它所属的存贮节点，及下面的数据结构
</span><span class='line'>&#9;unsigned  long  zone_start_paddr;
</span><span class='line'>&#9;unsigned  long    zone_start_mapnr;
</span><span class='line'>&#9;struct page * zone_mem_map;
</span><span class='line'>} zone_t;</span></code></pre></td></tr></table></div></figure>


<h4>3. Cache预读与换出</h4>

<p>Linux 内核中文件预读算法的具体过程是这样的：
对于每个文件的第一个读请求，系统读入所请求的页面并读入紧随其后的少数几个页面(不少于一个页面，通常是三个页 面)，这时的预读称为同步预读。对于第二次读请求，如果所读页面不在Cache中，即不在前次预读的group中，则表明文件访问不是顺序访问，系统继续 采用同步预读；如果所读页面在Cache中，则表明前次预读命中，操作系统把预读group扩大一倍，并让底层文件系统读入group中剩下尚不在 Cache中的文件数据块，这时的预读称为异步预读。无论第二次读请求是否命中，系统都要更新当前预读group的大小。</p>

<p>此外，系统中定义了一个 window，它包括前一次预读的group和本次预读的group。任何接下来的读请求都会处于两种情况之一：</p>

<p>第一种情况是所请求的页面处于预读 window中，这时继续进行异步预读并更新相应的window和group；</p>

<p>第二种情况是所请求的页面处于预读window之外，这时系统就要进行同步 预读并重置相应的window和group。</p>

<p>下图是Linux内核预读机制的一个示意图，其中a是某次读操作之前的情况，b是读操作所请求页面不在 window中的情况，而c是读操作所请求页面在window中的情况。</p>

<p><img src="/images/kernel/2015-09-18-8.gif" alt="" /></p>

<p>Linux内核中文件Cache替换的具体过程是这样的：刚刚分配的Cache项链入到inactive_list头部，并将其状态设置为active，当内存不够需要回收Cache时，系统首先从尾部开始反向扫描 active_list并将状态不是referenced的项链入到inactive_list的头部，然后系统反向扫描inactive_list，如果所扫描的项的处于合适的状态就回收该项，直到回收了足够数目的Cache项。其中Active_list的含义是热访问数据，及多次被访问的，inactive_list是冷访问数据，表示尚未被访问的。如果数据被访问了，Page会被打上一个Refrence标记，如果Page没有被访问过，则打上Unrefrence标记。这些处理在swap.c中可以找到。
下图也描述了这个过程。</p>

<p><img src="/images/kernel/2015-09-18-7.png" alt="" /></p>

<p>下面的代码描述了一个Page被访问它的标记为变化：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/*
</span><span class='line'> * Mark a page as having seen activity.
</span><span class='line'> *
</span><span class='line'> * inactive,unreferenced        -&gt;      inactive,referenced
</span><span class='line'> * inactive,referenced          -&gt;      active,unreferenced
</span><span class='line'> * active,unreferenced          -&gt;      active,referenced
</span><span class='line'> */
</span><span class='line'>void mark_page_accessed(struct page *page)
</span><span class='line'>{
</span><span class='line'>&#9;if (!PageActive(page) &amp;&amp; !PageUnevictable(page) &amp;&amp;
</span><span class='line'>&#9;&#9;&#9;PageReferenced(page) &amp;&amp; PageLRU(page)) {
</span><span class='line'>&#9;&#9;activate_page(page);
</span><span class='line'>&#9;&#9;ClearPageReferenced(page);
</span><span class='line'>&#9;} else if (!PageReferenced(page)) {
</span><span class='line'>&#9;&#9;SetPageReferenced(page);
</span><span class='line'>&#9;}
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>参考文章：</h4>

<p><a href="http://lsec.cc.ac.cn/~tengfei/doc/ldd3/">http://lsec.cc.ac.cn/~tengfei/doc/ldd3/</a></p>

<p><a href="http://memorymyann.javaeye.com/blog/193061">http://memorymyann.javaeye.com/blog/193061</a></p>

<p><a href="http://www.cublog.cn/u/20047/showart.php?id=121850">http://www.cublog.cn/u/20047/showart.php?id=121850</a></p>

<p><a href="http://blog.chinaunix.net/u2/74194/showart_1089736.html">http://blog.chinaunix.net/u2/74194/showart_1089736.html</a></p>

<p>关于内存管理，Linux有一个网页：<a href="http://linux-mm.org/">http://linux-mm.org/</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/09/11/kernel-mm-mmap/">linux mmap 详解</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-09-11T16:46:00+08:00'><span class='date'>2015-09-11</span> <span class='time'>16:46:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.chinaunix.net/uid-20321537-id-3483405.html">http://blog.chinaunix.net/uid-20321537-id-3483405.html</a></p>

<h3>一.前言</h3>

<p>mmap的具体实现以前在学习内核时学习过，但是对于其中的很多函数是一知半解的，有些只能根据其函数名来猜测其具体的功能，在本文中，一起来重新深入理解其具体的实现。</p>

<h3>二.mmap的用户层应用</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void *mmap(void *start,size_t length,int prot,int flags,int fd,off_t offsize);</span></code></pre></td></tr></table></div></figure>


<p>具体参数含义</p>

<p>start ：  指向欲映射的内存起始地址，通常设为 NULL，代表让系统自动选定地址，映射成功后返回该地址。<br/>
length：  代表将文件中多大的部分映射到内存。<br/>
prot  ：  映射区域的保护方式。可以为以下几种方式的组合：<br/>
        PROT_EXEC 映射区域可被执行<br/>
        PROT_READ 映射区域可被读取<br/>
        PROT_WRITE 映射区域可被写入<br/>
        PROT_NONE 映射区域不能存取<br/>
flags ：  影响映射区域的各种特性。在调用mmap()时必须要指定MAP_SHARED 或MAP_PRIVATE。<br/>
        MAP_FIXED 如果参数start所指的地址无法成功建立映射时，则放弃映射，不对地址做修正。通常不鼓励用此旗标。<br/>
        MAP_SHARED 对映射区域的写入数据会复制回文件内，而且允许其他映射该文件的进程共享。<br/>
        MAP_PRIVATE 对映射区域的写入操作会产生一个映射文件的复制，即私人的“写入时复制”（copy on write）对此区域作的任何修改都不会写回原来的文件内容。<br/>
        MAP_ANONYMOUS建立匿名映射。此时会忽略参数fd，不涉及文件，而且映射区域无法和其他进程共享。<br/>
        MAP_DENYWRITE只允许对映射区域的写入操作，其他对文件直接写入的操作将会被拒绝。<br/>
        MAP_LOCKED 将映射区域锁定住，这表示该区域不会被置换（swap）。<br/>
fd    ：  要映射到内存中的文件描述符。如果使用匿名内存映射时，即flags中设置了MAP_ANONYMOUS，fd设为-1。有些系统不支持匿名内存映射，则可以使用fopen打开/dev/zero文件，<br/>
    然后对该文件进行映射，可以同样达到匿名内存映射的效果。<br/>
offset：文件映射的偏移量，通常设置为0，代表从文件最前方开始对应，offset必须是PAGE_SIZE的整数倍。</p>

<p>返回值：<br/>
    若映射成功则返回映射区的内存起始地址，否则返回MAP_FAILED(－1)，错误原因存于errno 中。</p>

<p>错误代码：<br/>
    EBADF  参数fd 不是有效的文件描述词<br/>
    EACCES 存取权限有误。如果是MAP_PRIVATE 情况下文件必须可读，使用MAP_SHARED则要有PROT_WRITE以及该文件要能写入。<br/>
    EINVAL 参数start、length 或offset有一个不合法。<br/>
    EAGAIN 文件被锁住，或是有太多内存被锁住。<br/>
    ENOMEM 内存不足。</p>

<p>用户层的调用很简单，其具体功能就是直接将物理内存直接映射到用户虚拟内存，使用户空间可以直接对物理空间操作。但是对于内核层而言，其具体实现比较复杂。</p>

<h3>三.mmap的内核实现</h3>

<p>对于mmap的内核有了解的都会知道用户层的mmap到内核层的mmap其中多了一个参数vma_struct这个结构体，在开始时对于这个参数很疑惑就是这个参数的值是哪儿来的，在这里我们会一一来讲述。</p>

<p>mmap() &mdash;> sys_mmap_pgoff() 内核系统调用函数</p>

<p>munmap() &mdash;>sys_munmap() 内核系统调用函数，其最终调用unmap_region()来解除映射关系,不需要对应的file_operation有unmap操作项.</p>

<p>还是从do_mmap开始吧。</p>

<h4>3.1 do_mmap</h4>

<p>参数说明：<br/>
file  :就是用户层想要映射的file<br/>
addr  :欲映射的起始地址，即用户层的start<br/>
prot  :用户层传入的port<br/>
flag  :同上<br/>
offset:同上</p>

<p>从这里可以知道，这里面的参数几乎均是用户层传入的参数。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static inline unsigned long do_mmap(struct file *file, unsigned long addr,unsigned long len, unsigned long prot,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;unsigned long flag, unsigned long offset)
</span><span class='line'>{
</span><span class='line'>&#9;unsigned long ret = -EINVAL;
</span><span class='line'>&#9;if ((offset + PAGE_ALIGN(len)) &lt; offset)  --页对齐len，检测传入参数是否有误。
</span><span class='line'>&#9;&#9;goto out;
</span><span class='line'>&#9;if (!(offset & ~PAGE_MASK))           --检测offset是否页对齐。映射时只能映射页对齐的长度。
</span><span class='line'>&#9;&#9;ret = do_mmap_pgoff(file, addr, len, prot, flag, offset &gt;&gt; PAGE_SHIFT);
</span><span class='line'>out:
</span><span class='line'>&#9;return ret;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>3.2 do_mmap_pgoff</h4>

<p>这个函数是巨大的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>unsigned long do_mmap_pgoff(struct file * file, unsigned long addr,unsigned long len, unsigned long prot,unsigned long flags, unsigned long pgoff)
</span><span class='line'>{
</span><span class='line'>&#9;struct mm_struct * mm = current-&gt;mm;      --当前用户进程的mm
</span><span class='line'>&#9;struct inode *inode;
</span><span class='line'>&#9;unsigned int vm_flags;
</span><span class='line'>&#9;int error;
</span><span class='line'>&#9;int accountable = 1;
</span><span class='line'>&#9;unsigned long reqprot = prot;
</span><span class='line'>
</span><span class='line'>&#9;if ((prot & PROT_READ) && (current-&gt;personality & READ_IMPLIES_EXEC))   --是否隐藏了可执行属性。
</span><span class='line'>&#9;&#9;if (!(file && (file-&gt;f_path.mnt-&gt;mnt_flags & MNT_NOEXEC)))
</span><span class='line'>&#9;&#9;&#9;prot |= PROT_EXEC;
</span><span class='line'>
</span><span class='line'>&#9;if (!len)
</span><span class='line'>&#9;&#9;return -EINVAL;
</span><span class='line'>
</span><span class='line'>&#9;if (!(flags & MAP_FIXED))              -
</span><span class='line'>&#9;&#9;addr = round_hint_to_min(addr);    --判断输入的欲映射的起始地址是否小于最小映射地址，如果小于，将addr修改为最小地址，不过前提是MAP_FIXED旗标没有设置。
</span><span class='line'>
</span><span class='line'>&#9;error = arch_mmap_check(addr, len, flags);   --不同平台对于mmap参数的不同检测。这里之间返回0
</span><span class='line'>&#9;if (error)
</span><span class='line'>&#9;&#9;return error;
</span><span class='line'>
</span><span class='line'>&#9;len = PAGE_ALIGN(len);        --检测len是否越界，len的范围在0~TASK_SIZE之间。
</span><span class='line'>&#9;if (!len || len &gt; TASK_SIZE)
</span><span class='line'>&#9;&#9;return -ENOMEM;             --错误值为nomem
</span><span class='line'>
</span><span class='line'>&#9;if ((pgoff + (len &gt;&gt; PAGE_SHIFT)) &lt; pgoff)  --再次检测是否越界。我们这里不得不小心哪个晕头了传入一个莫名其妙的值
</span><span class='line'>&#9;return -EOVERFLOW;
</span><span class='line'>
</span><span class='line'>&#9;if (mm-&gt;map_count &gt; sysctl_max_map_count)   --在一个进程中对于mmap个数是有限制的。超出了还是nomem的错误。
</span><span class='line'>&#9;&#9;return -ENOMEM;
</span><span class='line'>
</span><span class='line'>&#9;addr = get_unmapped_area(file, addr, len, pgoff, flags);  --获取没有映射的地址，这个是查询mm中空闲的内存地址，这个在下面理解。
</span><span class='line'>&#9;if (addr & ~PAGE_MASK)
</span><span class='line'>&#9;&#9;return addr;
</span><span class='line'>
</span><span class='line'>&#9;vm_flags = calc_vm_prot_bits(prot) | calc_vm_flag_bits(flags) | mm-&gt;def_flags |
</span><span class='line'>&#9;&#9;&#9;   VM_MAYREAD | VM_MAYWRITE | VM_MAYEXEC;      --设置vm_flags，根据传入的port和flags以及mm本身自有的旗标来设置。
</span><span class='line'>
</span><span class='line'>&#9;if (flags & MAP_LOCKED) {
</span><span class='line'>&#9;&#9;if (!can_do_mlock())
</span><span class='line'>&#9;&#9;&#9;return -EPERM;
</span><span class='line'>&#9;&#9;vm_flags |= VM_LOCKED;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;if (vm_flags & VM_LOCKED) {
</span><span class='line'>&#9;&#9;unsigned long locked, lock_limit;
</span><span class='line'>&#9;&#9;locked = len &gt;&gt; PAGE_SHIFT;
</span><span class='line'>&#9;&#9;locked += mm-&gt;locked_vm;
</span><span class='line'>&#9;&#9;lock_limit = current-&gt;signal-&gt;rlim[RLIMIT_MEMLOCK].rlim_cur;
</span><span class='line'>&#9;&#9;lock_limit &gt;&gt;= PAGE_SHIFT;
</span><span class='line'>&#9;&#9;if (locked &gt; lock_limit && !capable(CAP_IPC_LOCK))
</span><span class='line'>&#9;&#9;&#9;return -EAGAIN;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;--关于锁定的内存区在以后学习中再看，这里就不细看。
</span><span class='line'>&#9;inode = file ? file-&gt;f_path.dentry-&gt;d_inode : NULL;  --判断是否匿名映射，如果不是则赋值inode
</span><span class='line'>
</span><span class='line'>&#9;if (file) {
</span><span class='line'>&#9;&#9;switch (flags & MAP_TYPE) {   --MAP_TYPE = 0x0F type的掩码
</span><span class='line'>&#9;&#9;case MAP_SHARED:
</span><span class='line'>&#9;&#9;&#9;if ((prot&PROT_WRITE) && !(file-&gt;f_mode&FMODE_WRITE))   --file应该被打开并允许写入。
</span><span class='line'>&#9;&#9;&#9;&#9;return -EACCES;
</span><span class='line'>&#9;&#9;&#9;if (IS_APPEND(inode) && (file-&gt;f_mode & FMODE_WRITE))  --不能写入一个只允许写追加的文件
</span><span class='line'>&#9;&#9;&#9;&#9;return -EACCES;
</span><span class='line'>&#9;&#9;&#9;if (locks_verify_locked(inode))      --确保文件没有被强制锁定。
</span><span class='line'>&#9;&#9;&#9;&#9;return -EAGAIN;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;vm_flags |= VM_SHARED | VM_MAYSHARE;  --尝试允许其他进程共享。
</span><span class='line'>&#9;&#9;&#9;if (!(file-&gt;f_mode & FMODE_WRITE))    --如果file不允许写就算了，共享也没有用啊，因为file就一直固定死了，共享也没有意义。
</span><span class='line'>&#9;&#9;&#9;&#9;vm_flags &= ~(VM_MAYWRITE | VM_SHARED);
</span><span class='line'>&#9;&#9;case MAP_PRIVATE:
</span><span class='line'>&#9;&#9;&#9;if (!(file-&gt;f_mode & FMODE_READ))
</span><span class='line'>&#9;&#9;&#9;&#9;return -EACCES;
</span><span class='line'>&#9;&#9;&#9;if (file-&gt;f_path.mnt-&gt;mnt_flags & MNT_NOEXEC) {
</span><span class='line'>&#9;&#9;&#9;&#9;if (vm_flags & VM_EXEC)
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;return -EPERM;
</span><span class='line'>&#9;&#9;&#9;&#9;vm_flags &= ~VM_MAYEXEC;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;if (is_file_hugepages(file))
</span><span class='line'>&#9;&#9;&#9;&#9;accountable = 0;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;if (!file-&gt;f_op || !file-&gt;f_op-&gt;mmap)
</span><span class='line'>&#9;&#9;&#9;&#9;return -ENODEV;
</span><span class='line'>&#9;&#9;&#9;break;
</span><span class='line'>
</span><span class='line'>&#9;&#9;default:
</span><span class='line'>&#9;&#9;&#9;return -EINVAL;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;} else {
</span><span class='line'>&#9;&#9;switch (flags & MAP_TYPE) {
</span><span class='line'>&#9;&#9;case MAP_SHARED:
</span><span class='line'>&#9;&#9;&#9;pgoff = 0;
</span><span class='line'>&#9;&#9;&#9;vm_flags |= VM_SHARED | VM_MAYSHARE;
</span><span class='line'>&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;case MAP_PRIVATE:
</span><span class='line'>&#9;&#9;&#9;pgoff = addr &gt;&gt; PAGE_SHIFT;
</span><span class='line'>&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;default:
</span><span class='line'>&#9;&#9;&#9;return -EINVAL;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;--上面就是对一些旗标进行检测，防止出现旗标冲突，比如我欲映射的文件不允许写，而我映射的旗标却设定是可写并可以共享的，这个就冲突了。
</span><span class='line'>&#9;error = security_file_mmap(file, reqprot, prot, flags, addr, 0);   --这个函数就忽略了。
</span><span class='line'>&#9;if (error)
</span><span class='line'>&#9;&#9;return error;
</span><span class='line'>
</span><span class='line'>&#9;return mmap_region(file, addr, len, flags, vm_flags, pgoff,accountable);  --最后一个参数为是否为大页，如果是的就为0.其余的参数都好理解。
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>3.3 get_unmapped_area</h4>

<p>这个是获取没有被映射的内存区</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>unsigned long get_unmapped_area(struct file *file, unsigned long addr, unsigned long len,unsigned long pgoff, unsigned long flags)
</span><span class='line'>{
</span><span class='line'>&#9;unsigned long (*get_area)(struct file *, unsigned long,unsigned long, unsigned long, unsigned long);
</span><span class='line'>&#9;get_area = current-&gt;mm-&gt;get_unmapped_area;
</span><span class='line'>&#9;if (file && file-&gt;f_op && file-&gt;f_op-&gt;get_unmapped_area)
</span><span class='line'>&#9;&#9;get_area = file-&gt;f_op-&gt;get_unmapped_area;
</span><span class='line'>&#9;addr = get_area(file, addr, len, pgoff, flags);
</span><span class='line'>&#9;if (IS_ERR_VALUE(addr))
</span><span class='line'>&#9;&#9;return addr;
</span><span class='line'>
</span><span class='line'>&#9;if (addr &gt; TASK_SIZE - len)
</span><span class='line'>&#9;&#9;return -ENOMEM;
</span><span class='line'>&#9;if (addr & ~PAGE_MASK)
</span><span class='line'>&#9;&#9;return -EINVAL;
</span><span class='line'>
</span><span class='line'>&#9;return arch_rebalance_pgtables(addr, len);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>对于get_area函数我们以arch_get_unmapped_area为例来看如何查找一个空闲的mmap area</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>unsigned long arch_get_unmapped_area(struct file *filp, unsigned long addr,unsigned long len, unsigned long pgoff, unsigned long flags)
</span><span class='line'>{
</span><span class='line'>&#9;struct mm_struct *mm = current-&gt;mm;
</span><span class='line'>&#9;struct vm_area_struct *vma;
</span><span class='line'>&#9;unsigned long start_addr;
</span><span class='line'>
</span><span class='line'>&#9;if (len &gt; TASK_SIZE)
</span><span class='line'>&#9;&#9;return -ENOMEM;
</span><span class='line'>
</span><span class='line'>&#9;if (flags & MAP_FIXED)    --还记否这个MAP_FIXED是什么含义不？
</span><span class='line'>&#9;&#9;return addr;
</span><span class='line'>
</span><span class='line'>&#9;if (addr) {
</span><span class='line'>&#9;&#9;addr = PAGE_ALIGN(addr);
</span><span class='line'>&#9;&#9;vma = find_vma(mm, addr); --vma为NULL即addr的地址不在任一个VMA(vma-&gt;vm_start~vma-&gt;vm_end) addr的地址没有被映射，
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;而且空洞足够我们这次的映射，那么返回addr以准备这次的映射
</span><span class='line'>&#9;&#9;if (TASK_SIZE - len &gt;= addr &&(!vma || addr + len &lt;= vma-&gt;vm_start))
</span><span class='line'>&#9;&#9;&#9;return addr;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (len &gt; mm-&gt;cached_hole_size) { --如果所需的长度大于当前vma之间的空洞长度
</span><span class='line'>&#9;&#9;&#9;start_addr = addr = mm-&gt;free_area_cache;
</span><span class='line'>&#9;} else {
</span><span class='line'>&#9;&#9;&#9;start_addr = addr = TASK_UNMAPPED_BASE;  --需要的长度小于当前空洞，为了不至于时间浪费，那么从0开始搜寻，
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;这里的搜寻基地址TASK_UNMAPPED_BASE很重要，用户mmap的地址的基地址必须在TASK_UNMAPPED_BASE之上，
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;但是一定这样严格 吗？看上面的if (addr)判断，如果用户给了一个地址在TASK_UNMAPPED_BASE之下，
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;映射实际上还是会发生的。
</span><span class='line'>&#9;&#9;&#9;mm-&gt;cached_hole_size = 0;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>full_search:
</span><span class='line'>&#9;for (vma = find_vma(mm, addr); ; vma = vma-&gt;vm_next) {
</span><span class='line'>&#9;&#9;if (TASK_SIZE - len &lt; addr) {
</span><span class='line'>&#9;&#9;&#9;if (start_addr != TASK_UNMAPPED_BASE) {
</span><span class='line'>&#9;&#9;&#9;&#9;addr = TASK_UNMAPPED_BASE;
</span><span class='line'>&#9;&#9;&#9;  start_addr = addr;
</span><span class='line'>&#9;&#9;&#9;&#9;mm-&gt;cached_hole_size = 0;
</span><span class='line'>&#9;&#9;&#9;&#9;goto full_search;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;return -ENOMEM;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;
</span><span class='line'>&#9;&#9;if (!vma || addr + len &lt;= vma-&gt;vm_start) {        --如果第一次find_vma返回值即为NULL ，vma没有被映射并且空洞足够映射
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;!vma的条件只有可能在循环的第一次满足，在其后不可能满足，在其后的判断条件即为
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;vma-&gt;vma_end~vma-&gt;vma_next-&gt;vma_start之间的空洞大小大于所需要映射的长度即可，
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;下面判断条件中的addr为vma-&gt;vma_end,而vma-&gt;vm_start为 vma-&gt;vma_next-&gt;vma_start
</span><span class='line'>&#9;&#9;&#9;mm-&gt;free_area_cache = addr + len;
</span><span class='line'>&#9;&#9;&#9;return addr;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;if (addr + mm-&gt;cached_hole_size &lt; vma-&gt;vm_start)  --在循环的第一次如果vma不为NULL，不会满足下面的条件，在以后循环中mm-&gt;cached_hole_size
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;则为该次vma-&gt;vm_start 与上一次的vma-&gt;vm_end之间的差值
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;&#9;mm-&gt;cached_hole_size = vma-&gt;vm_start - addr;
</span><span class='line'>&#9;&#9;addr = vma-&gt;vm_end;
</span><span class='line'>&#9;}
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>还记否以前看的红黑树，这里就现实的用了红黑树的算法。关于这个我们就不看了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct vm_area_struct * find_vma(struct mm_struct * mm, unsigned long addr)
</span><span class='line'>{
</span><span class='line'>&#9;struct vm_area_struct *vma = NULL;
</span><span class='line'>
</span><span class='line'>&#9;if (mm) {
</span><span class='line'>&#9;&#9;vma = mm-&gt;mmap_cache;
</span><span class='line'>&#9;&#9;if (!(vma && vma-&gt;vm_end &gt; addr && vma-&gt;vm_start &lt;= addr)) {
</span><span class='line'>&#9;&#9;&#9;struct rb_node * rb_node;
</span><span class='line'>&#9;&#9;&#9;rb_node = mm-&gt;mm_rb.rb_node;
</span><span class='line'>&#9;&#9;&#9;vma = NULL;
</span><span class='line'>&#9;&#9;&#9;while (rb_node) {
</span><span class='line'>&#9;&#9;&#9;&#9;struct vm_area_struct * vma_tmp;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;&#9;vma_tmp = rb_entry(rb_node,struct vm_area_struct, vm_rb);
</span><span class='line'>&#9;&#9;&#9;&#9;if (vma_tmp-&gt;vm_end &gt; addr) {
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;vma = vma_tmp;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;if (vma_tmp-&gt;vm_start &lt;= addr)
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;rb_node = rb_node-&gt;rb_left;
</span><span class='line'>&#9;&#9;&#9;&#9;} else
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;rb_node = rb_node-&gt;rb_right;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;if (vma)
</span><span class='line'>&#9;&#9;&#9;&#9;mm-&gt;mmap_cache = vma;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;return vma;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>3.4 mmap_region</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>unsigned long mmap_region(struct file *file, unsigned long addr,unsigned long len, unsigned long flags,
</span><span class='line'>&#9;&#9;&#9;&#9;unsigned int vm_flags, unsigned long pgoff,int accountable)
</span><span class='line'>{
</span><span class='line'>&#9;struct mm_struct *mm = current-&gt;mm;
</span><span class='line'>&#9;struct vm_area_struct *vma, *prev;
</span><span class='line'>&#9;struct vm_area_struct *merged_vma;
</span><span class='line'>&#9;int correct_wcount = 0;
</span><span class='line'>&#9;int error;
</span><span class='line'>&#9;struct rb_node **rb_link, *rb_parent;
</span><span class='line'>&#9;unsigned long charged = 0;
</span><span class='line'>&#9;struct inode *inode =  file ? file-&gt;f_path.dentry-&gt;d_inode : NULL;
</span><span class='line'>
</span><span class='line'>&#9;/* Clear old maps */
</span><span class='line'>&#9;error = -ENOMEM;
</span><span class='line'>munmap_back:
</span><span class='line'>&#9;vma = find_vma_prepare(mm, addr, &prev, &rb_link, &rb_parent); --函数find_vma_prepare()与find_vma()基本相同，它扫描当前进程地址空间的vm_area_struct
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;结构所形成的红黑树，试图找到结束地址高于addr的第一个区间；如果找到了一个虚拟区，
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;说明addr所在的虚拟区已经在使用，也就是已经有映射存在，因此要调用do_munmap()
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;把这个老的虚拟区从进程地址空间中撤销，如果撤销不成功，就返回一个负数；
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;如果撤销成功，就继续查找，直到在红黑树中找不到addr所在的虚拟区
</span><span class='line'>&#9;if (vma && vma-&gt;vm_start &lt; addr + len) {
</span><span class='line'>&#9;&#9;if (do_munmap(mm, addr, len))
</span><span class='line'>&#9;&#9;&#9;return -ENOMEM;
</span><span class='line'>&#9;&#9;goto munmap_back;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (!may_expand_vm(mm, len &gt;&gt; PAGE_SHIFT))                   -- 页数和超过限定值返回 0 ，不超过返回1
</span><span class='line'>&#9;&#9;return -ENOMEM;
</span><span class='line'>
</span><span class='line'>&#9;if (flags & MAP_NORESERVE)              -- 如果flags参数中没有设置MAP_NORESERVE标志，新的虚拟区含有私有的可写页，空闲页面数小于要映射的虚拟区
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;的大小；则函数终止并返回一个负数；其中函数security_vm_enough_memory()用来检查一个
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;进程的地址空间中是否有足够的内存来进行一个新的映射
</span><span class='line'>&#9;&#9;vm_flags |= VM_NORESERVE;
</span><span class='line'>
</span><span class='line'>&#9;if (accountable && (!(flags & MAP_NORESERVE) ||
</span><span class='line'>&#9;&#9;&#9;&#9;sysctl_overcommit_memory == OVERCOMMIT_NEVER)) {
</span><span class='line'>&#9;&#9;if (vm_flags & VM_SHARED) {
</span><span class='line'>&#9;&#9;&#9;/* Check memory availability in shmem_file_setup? */
</span><span class='line'>&#9;&#9;&#9;vm_flags |= VM_ACCOUNT;
</span><span class='line'>&#9;&#9;} else if (vm_flags & VM_WRITE) {
</span><span class='line'>&#9;&#9;&#9;charged = len &gt;&gt; PAGE_SHIFT;
</span><span class='line'>&#9;&#9;&#9;if (security_vm_enough_memory(charged))
</span><span class='line'>&#9;&#9;&#9;&#9;return -ENOMEM;
</span><span class='line'>&#9;&#9;&#9;vm_flags |= VM_ACCOUNT;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (!file && !(vm_flags & VM_SHARED)) { --如果是匿名映射（file为空），并且这个虚拟区是非共享的，则可以把这个虚拟区和与它紧挨的前一个虚拟区进行合并；
</span><span class='line'>&#9;&#9;虚拟区的合并是由vma_merge()函数实现的。如果合并成功，则转out处，请看后面out处的代码。
</span><span class='line'>&#9;&#9;vma = vma_merge(mm, prev, addr, addr + len, vm_flags,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;NULL, NULL, pgoff, NULL);
</span><span class='line'>&#9;&#9;if (vma)
</span><span class='line'>&#9;&#9;&#9;goto out;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;vma = kmem_cache_zalloc(vm_area_cachep, GFP_KERNEL);
</span><span class='line'>&#9;if (!vma) {
</span><span class='line'>&#9;&#9;error = -ENOMEM;
</span><span class='line'>&#9;&#9;goto unacct_error;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;vma-&gt;vm_mm = mm;
</span><span class='line'>&#9;vma-&gt;vm_start = addr;
</span><span class='line'>&#9;vma-&gt;vm_end = addr + len;
</span><span class='line'>&#9;vma-&gt;vm_flags = vm_flags;
</span><span class='line'>&#9;vma-&gt;vm_page_prot = vm_get_page_prot(vm_flags);
</span><span class='line'>&#9;vma-&gt;vm_pgoff = pgoff;
</span><span class='line'>
</span><span class='line'>&#9;if (file) {
</span><span class='line'>&#9;&#9;error = -EINVAL;
</span><span class='line'>&#9;&#9;if (vm_flags & (VM_GROWSDOWN|VM_GROWSUP))
</span><span class='line'>&#9;&#9;&#9;goto free_vma;
</span><span class='line'>&#9;&#9;if (vm_flags & VM_DENYWRITE) {
</span><span class='line'>&#9;&#9;&#9;error = deny_write_access(file);
</span><span class='line'>&#9;&#9;&#9;if (error)
</span><span class='line'>&#9;&#9;&#9;&#9;goto free_vma;
</span><span class='line'>&#9;&#9;&#9;correct_wcount = 1;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;vma-&gt;vm_file = file;
</span><span class='line'>&#9;&#9;get_file(file);
</span><span class='line'>&#9;&#9;error = file-&gt;f_op-&gt;mmap(file, vma);    -- (⊙o⊙)哦 ，终于可以调用设备文件中真正的mmap
</span><span class='line'>&#9;&#9;if (error)
</span><span class='line'>&#9;&#9;&#9;goto unmap_and_free_vma;
</span><span class='line'>&#9;&#9;if (vm_flags & VM_EXECUTABLE)
</span><span class='line'>&#9;&#9;&#9;added_exe_file_vma(mm);
</span><span class='line'>&#9;} else if (vm_flags & VM_SHARED) {
</span><span class='line'>&#9;&#9;error = shmem_zero_setup(vma);// it will call shmem_file_setup(), the same way as called in ashmem.c
</span><span class='line'>&#9;&#9;if (error)
</span><span class='line'>&#9;&#9;&#9;goto free_vma;
</span><span class='line'>&#9;}</span></code></pre></td></tr></table></div></figure>


<p>如果建立的是从文件到虚存区间的映射，则：</p>

<p>1.当参数flags中的VM_GROWSDOWN或VM_GROWSUP标志位为1时，说明这个区间可以向低地址或高地址扩展，但从文件映射的区间不能进行扩展，因此转到free_vma，释放给vm_area_struct分配的Slab，并返回一个错误；</p>

<p>2.当flags中的VM_DENYWRITE标志位为1时，就表示不允许通过常规的文件操作访问该文件，所以要调用deny_write_access（）排斥常规的文件操作（参见第八章）。</p>

<p>3.get_file（）函数的主要作用是递增file结构中的共享计数；</p>

<p>4.每个文件系统都有个fiel_operation数据结构，其中的函数指针mmap提供了用来建立从该类文件到虚存区间进行映射的操作，这是最具有实质意义的函数；对于大部分文件系统，这个函数为generic_file_mmap( )函数实现的，该函数执行以下操作：</p>

<p>  (1)初始化vm_area_struct结构中的vm_ops域。如果VM_SHARED标志为1，就把该域设置成file_shared_mmap， 否则就把该域设置成file_private_mmap。从某种意义上说，这个步骤所做的事情类似于打开一个文件并初始化文件对象的方法。</p>

<p>  (2)从索引节点的i_mode域（参见第八章）检查要映射的文件是否是一个常规文件。如果是其他类型的文件（例如目录或套接字），就返回一个错误代码。</p>

<p>  (3)从索引节点的i_op域中检查是否定义了readpage( )的索引节点操作。如果没有定义，就返回一个错误代码。</p>

<p>  (4)调用update_atime( )函数把当前时间存放在该文件索引节点的i_atime域中，并将这个索引节点标记成脏。</p>

<p>5.如果flags参数中的MAP_SHARED标志位为1，则调用shmem_zero_setup（）进行共享内存的映射。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&#9;if ((vm_flags & (VM_SHARED|VM_ACCOUNT)) == (VM_SHARED|VM_ACCOUNT))
</span><span class='line'>&#9;&#9;vma-&gt;vm_flags &= ~VM_ACCOUNT;
</span><span class='line'>
</span><span class='line'>&#9;addr = vma-&gt;vm_start;
</span><span class='line'>&#9;pgoff = vma-&gt;vm_pgoff;
</span><span class='line'>&#9;vm_flags = vma-&gt;vm_flags;
</span><span class='line'>
</span><span class='line'>&#9;if (vma_wants_writenotify(vma))
</span><span class='line'>&#9;&#9;vma-&gt;vm_page_prot = vm_get_page_prot(vm_flags & ~VM_SHARED);
</span><span class='line'>
</span><span class='line'>&#9;merged_vma = NULL;
</span><span class='line'>&#9;if (file)
</span><span class='line'>&#9;&#9;merged_vma = vma_merge(mm, prev, addr, vma-&gt;vm_end,
</span><span class='line'>&#9;&#9;&#9;vma-&gt;vm_flags, NULL, file, pgoff, vma_policy(vma));
</span><span class='line'>&#9;if (merged_vma) {
</span><span class='line'>&#9;&#9;mpol_put(vma_policy(vma));
</span><span class='line'>&#9;&#9;kmem_cache_free(vm_area_cachep, vma);
</span><span class='line'>&#9;&#9;fput(file);
</span><span class='line'>&#9;&#9;if (vm_flags & VM_EXECUTABLE)
</span><span class='line'>&#9;&#9;&#9;removed_exe_file_vma(mm);
</span><span class='line'>&#9;&#9;vma = merged_vma;
</span><span class='line'>&#9;} else {
</span><span class='line'>&#9;&#9;vma_link(mm, vma, prev, rb_link, rb_parent);
</span><span class='line'>&#9;&#9;file = vma-&gt;vm_file;
</span><span class='line'>&#9;}</span></code></pre></td></tr></table></div></figure>


<p>此时，把新建的虚拟区插入到进程的地址空间，这是由函数vma_link（）完成的，该函数具有三方面的功能：<br/>
（1）把vma 插入到虚拟区链表中<br/>
（2）把vma插入到虚拟区形成的红黑树中<br/>
（3）把vam插入到索引节点（inode）共享链表中</p>

<p>函数atomic_inc（x）给*x加1，这是一个原子操作。在内核代码中，有很多地方调用了以atomic为前缀的函数。原子操作，在操作过程中不会被中断。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&#9;if (correct_wcount)
</span><span class='line'>&#9;&#9;atomic_inc(&inode-&gt;i_writecount);
</span><span class='line'>out:
</span><span class='line'>&#9;mm-&gt;total_vm += len &gt;&gt; PAGE_SHIFT;
</span><span class='line'>&#9;vm_stat_account(mm, vm_flags, file, len &gt;&gt; PAGE_SHIFT);
</span><span class='line'>&#9;if (vm_flags & VM_LOCKED) {
</span><span class='line'>&#9;&#9;long nr_pages = mlock_vma_pages_range(vma, addr, addr + len);
</span><span class='line'>&#9;&#9;if (nr_pages &lt; 0)
</span><span class='line'>&#9;&#9;&#9;return nr_pages;    /* vma gone! */
</span><span class='line'>&#9;&#9;mm-&gt;locked_vm += (len &gt;&gt; PAGE_SHIFT) - nr_pages;
</span><span class='line'>&#9;} else if ((flags & MAP_POPULATE) && !(flags & MAP_NONBLOCK))
</span><span class='line'>&#9;&#9;make_pages_present(addr, addr + len);
</span><span class='line'>&#9;return addr;
</span><span class='line'>
</span><span class='line'>unmap_and_free_vma:
</span><span class='line'>&#9;if (correct_wcount)
</span><span class='line'>&#9;&#9;atomic_inc(&inode-&gt;i_writecount);
</span><span class='line'>&#9;vma-&gt;vm_file = NULL;
</span><span class='line'>&#9;fput(file);
</span><span class='line'>
</span><span class='line'>&#9;unmap_region(mm, vma, prev, vma-&gt;vm_start, vma-&gt;vm_end);
</span><span class='line'>&#9;charged = 0;
</span><span class='line'>free_vma:
</span><span class='line'>&#9;kmem_cache_free(vm_area_cachep, vma);
</span><span class='line'>unacct_error:
</span><span class='line'>&#9;if (charged)
</span><span class='line'>&#9;&#9;vm_unacct_memory(charged);
</span><span class='line'>&#9;return error;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ok！到此mmap的内核核心就可以了，关于具体的mmap的实现，以后再看。</p>

<h3>四.总结</h3>

<p>mmap的实质是什么，其实就是从每一个进程中的用户空间分配一段空间用于映射。 这里面的机关重重，需要好好理解，不过谨记一点，进程的vma_struct是采用了红黑树来管理的。对于每一段的内存区都会有一个vma_struct 来描述，比如数据区，code区等等，以及mmap所需要的一段内存区。</p>

<h3>五.其它</h3>

<h4>1、特点：</h4>

<p>① 进程相关的<br/>
② 与XSI共享内存一样，需要与同步原语一起使用<br/>
③ 只能是有共同祖先的进程才能使用</p>

<h4>2、使用</h4>

<p>系统调用mmap()用于共享内存的两种方式：<br/>
（1）使用普通文件提供的内存映射：<br/>
   适用于任何进程之间。此时，需要打开或创建一个文件，然后再调用mmap()</p>

<p>典型调用代码如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>fd=open(name, flag, mode); if(fd&lt;0) ...
</span><span class='line'>ptr=mmap(NULL, len , PROT_READ|PROT_WRITE, MAP_SHARED , fd , 0);</span></code></pre></td></tr></table></div></figure>


<p> 通过mmap()实现共享内存的通信方式有许多特点和要注意的地方，可以参看UNIX网络编程第二卷。【3】</p>

<p>（2）使用特殊文件提供匿名内存映射：<br/>
  适用于具有亲缘关系的进程之间。由于父子进程特殊的亲缘关系，在父进程中先调用mmap()，然后调用fork()。那么在调用fork()之后，子进程 继承父进程匿名映射后的地址空间，同样也继承mmap()返回的地址，这样，父子进程就可以通过映射区域进行通信了。一般来说，子进程单独维护从父进程继 承下来的一些变量。而mmap()返回的地址，却由父子进程共同维护。对于具有亲缘关系的进程实现共享内存最好的方式应该是采用匿名内存映射的方式。此时，不必指定具体的文件，只要设置相应的标志即可。</p>

<h4>3、说明</h4>

<h5>(1)</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void *mmap(void *addr, size_t len, int prot, int flag, int fd, off_t offset );</span></code></pre></td></tr></table></div></figure>


<p>把文件或设备映射或解除映射到内存中</p>

<p>0）flag：必须有MAP_SHARED 标志<br/>
MAP_SHARED对映射区域的写入数据会复制回文件内，而且允许其他映射该文件的进程共享。<br/>
MAP_PRIVATE 对映射区域的写入操作会产生一个映射文件的复制，即私人的“写入时复制”（copy on write）对此区域作的任何修改都不会写回原来的文件内容。<br/>
MAP_ANONYMOUS建立匿名共享。此时会忽略参数fd(fd可以指定为-1)，不涉及文件，而且映射区域无法和其他进程共享(只能用于具有亲缘关系的进程间通信)。<br/>
  映射/dev/zero可为调用程序提供零填充的虚拟内存块。</p>

<p>1）start：指向欲映射的内存起始地址，通常设为 NULL，代表让系统自动选定地址，映射成功后返回该地址。</p>

<p>2）length：代表将文件中多大的部分映射到内存。</p>

<p>3）offset 必须是页面大小的整数倍。页面大小由 getpagesize(2)得到。</p>

<p>4）被映射的文件大小应是页面大小的整数倍。如一个文件大小不是页面大小的整数倍，映射时多出来的区域将被赋为0，对这些区域的写不会被写回到文件中。</p>

<p>5)munmap()系统调用将删除指定地址范围内的映射区域。随后对这个范围内区域的引用将产生非法的内存引用。当这个进程终止后，这个区域也会被删除。另一方面，关闭文件描述符并不会删除映射区域。</p>

<p>6）fd：要映射到内存中的文件描述符。如果使用匿名内存映射时，即flags中设置了MAP_ANONYMOUS，fd设为-1。有些系统不支持匿名内存映射，则可以使用fopen打开/dev/zero文件，然后对该文件进行映射，可以同样达到匿名内存映射的效果。</p>

<p>7）若映射成功则返回映射区的内存起始地址，否则返回MAP_FAILED(－1)。</p>

<h5>(2) munmap</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int munmap( void * addr, size_t len )</span></code></pre></td></tr></table></div></figure>


<p>在进程地址空间中解除一个映射关系，当映射关系解除后，对原来映射地址的访问将导致段错误发生。</p>

<p>void * addr ：调用mmap()时返回的地址<br/>
size_t len ：映射区的大小</p>

<h5>(3)</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int msync ( void * addr , size_t len, int flags)</span></code></pre></td></tr></table></div></figure>


<p>一般说来，进程在映射空间的对共享内容的改变并不直接写回到磁盘文件中，往往在调用munmap()后才执行该操作。可以调用msync()实现磁盘上文件与共享内存区的内容一致。</p>

<p>void * addr ：调用mmap()时返回的地址<br/>
size_t len ：映射区的大小<br/>
int flags ：MS_ASYN: 异步写，MS_SYN : 同步写，MS_INVALIDAT : 无效的cache 数据。</p>

<h4>5、其他</h4>

<p>1）进程调用mmap()时，只是在进程空间内新增了一块相应大小的缓冲区，并设置了相应的访问标识，但并没有建立进程空间到物理页面的映射。因此，第一次访问该空间时，会引发一个缺页异常。</p>

<p>2）一个共享内存区域可以看作是特殊文件系统shm中的一个文件，shm的安装点在交换区上。</p>

<p>3）mmap()系统调用使得进程之间通过映射同一个普通文件实现共享内存。普通文件被映射到进程地址空间后，进程可以向访问普通内存一样对文件进行访问，不必再调用read()，write()等操作。</p>

<p>4）最终被映射文件的内容的长度不会超过文件本身的初始大小，即映射不能改变文件的大小。文件被映射部分而不是整个文件决定了进程能够访问的空间大小，另外，如果指定文件的偏移部分，一定要注意为页面大小的整数倍。</p>

<p><img src="/images/kernel/2015-09-11-11.png" alt="" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/09/11/kernel-mm-vma-base/">linux进程地址空间--vma的基本操作</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-09-11T16:39:00+08:00'><span class='date'>2015-09-11</span> <span class='time'>16:39:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.csdn.net/vanbreaker/article/details/7855007">http://blog.csdn.net/vanbreaker/article/details/7855007</a></p>

<p>在32位的系统上，线性地址空间可达到4GB，这4GB一般按照3:1的比例进行分配，也就是说用户进程享有前3GB线性地址空间，而内核独享最后1GB线性地址空间。由于虚拟内存的引入，每个进程都可拥有3GB的虚拟内存，并且用户进程之间的地址空间是互不可见、互不影响的，也就是说即使两个进程对同一个地址进行操作，也不会产生问题。在前面介绍的一些分配内存的途径中，无论是伙伴系统中分配页的函数，还是slab分配器中分配对象的函数，它们都会尽量快速地响应内核的分配请求，将相应的内存提交给内核使用，而内核对待用户空间显然不能如此。用户空间动态申请内存时往往只是获得一块线性地址的使用权，而并没有将这块线性地址区域与实际的物理内存对应上，只有当用户空间真正操作申请的内存时，才会触发一次缺页异常，这时内核才会分配实际的物理内存给用户空间。</p>

<p>用户进程的虚拟地址空间包含了若干区域，这些区域的分布方式是特定于体系结构的，不过所有的方式都包含下列成分：</p>

<p>  可执行文件的二进制代码，也就是程序的代码段<br/>
  存储全局变量的数据段<br/>
  用于保存局部变量和实现函数调用的栈<br/>
  环境变量和命令行参数<br/>
  程序使用的动态库的代码<br/>
  用于映射文件内容的区域</p>

<p>由此可以看到进程的虚拟内存空间会被分成不同的若干区域，每个区域都有其相关的属性和用途，一个合法的地址总是落在某个区域当中的，这些区域也不会重叠。在linux内核中，这样的区域被称之为虚拟内存区域(virtual memory areas),简称vma。一个vma就是一块连续的线性地址空间的抽象，它拥有自身的权限(可读，可写，可执行等等) ，每一个虚拟内存区域都由一个相关的struct vm_area_struct结构来描述</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct vm_area_struct {
</span><span class='line'>&#9;struct mm_struct * vm_mm;   /* 所属的内存描述符 */
</span><span class='line'>&#9;unsigned long vm_start;    /* vma的起始地址 */
</span><span class='line'>&#9;unsigned long vm_end;       /* vma的结束地址 */
</span><span class='line'>
</span><span class='line'>&#9;/* 该vma的在一个进程的vma链表中的前驱vma和后驱vma指针，链表中的vma都是按地址来排序的*/
</span><span class='line'>&#9;struct vm_area_struct *vm_next, *vm_prev;
</span><span class='line'>
</span><span class='line'>&#9;pgprot_t vm_page_prot;      /* vma的访问权限 */
</span><span class='line'>&#9;unsigned long vm_flags;    /* 标识集 */
</span><span class='line'>
</span><span class='line'>&#9;struct rb_node vm_rb;      /* 红黑树中对应的节点 */
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * For areas with an address space and backing store,
</span><span class='line'>&#9; * linkage into the address_space-&gt;i_mmap prio tree, or
</span><span class='line'>&#9; * linkage to the list of like vmas hanging off its node, or
</span><span class='line'>&#9; * linkage of vma in the address_space-&gt;i_mmap_nonlinear list.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;/* shared联合体用于和address space关联 */
</span><span class='line'>&#9;union {
</span><span class='line'>&#9;&#9;struct {
</span><span class='line'>&#9;&#9;&#9;struct list_head list;/* 用于链入非线性映射的链表 */
</span><span class='line'>&#9;&#9;&#9;void *parent;   /* aligns with prio_tree_node parent */
</span><span class='line'>&#9;&#9;&#9;struct vm_area_struct *head;
</span><span class='line'>&#9;&#9;} vm_set;
</span><span class='line'>
</span><span class='line'>&#9;&#9;struct raw_prio_tree_node prio_tree_node;/*线性映射则链入i_mmap优先树*/
</span><span class='line'>&#9;} shared;
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * A file's MAP_PRIVATE vma can be in both i_mmap tree and anon_vma
</span><span class='line'>&#9; * list, after a COW of one of the file pages.  A MAP_SHARED vma
</span><span class='line'>&#9; * can only be in the i_mmap tree.  An anonymous MAP_PRIVATE, stack
</span><span class='line'>&#9; * or brk vma (with NULL file) can only be in an anon_vma list.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;/*anno_vma_node和annon_vma用于管理源自匿名映射的共享页*/
</span><span class='line'>&#9;struct list_head anon_vma_node; /* Serialized by anon_vma-&gt;lock */
</span><span class='line'>&#9;struct anon_vma *anon_vma;  /* Serialized by page_table_lock */
</span><span class='line'>
</span><span class='line'>&#9;/* Function pointers to deal with this struct. */
</span><span class='line'>&#9;/*该vma上的各种标准操作函数指针集*/
</span><span class='line'>&#9;const struct vm_operations_struct *vm_ops;
</span><span class='line'>
</span><span class='line'>&#9;/* Information about our backing store: */
</span><span class='line'>&#9;unsigned long vm_pgoff;     /* 映射文件的偏移量，以PAGE_SIZE为单位 */
</span><span class='line'>&#9;struct file * vm_file;          /* 映射的文件，没有则为NULL */
</span><span class='line'>&#9;void * vm_private_data;     /* was vm_pte (shared mem) */
</span><span class='line'>&#9;unsigned long vm_truncate_count;/* truncate_count or restart_addr */
</span><span class='line'>
</span><span class='line'>#ifndef CONFIG_MMU
</span><span class='line'>&#9;struct vm_region *vm_region;    /* NOMMU mapping region */
</span><span class='line'>#endif
</span><span class='line'>#ifdef CONFIG_NUMA
</span><span class='line'>&#9;struct mempolicy *vm_policy;    /* NUMA policy for the VMA */
</span><span class='line'>#endif
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>进程的若干个vma区域都得按一定的形式组织在一起，这些vma都包含在进程的内存描述符中，也就是struct mm_struct中，这些vma在mm_struct以两种方式进行组织，一种是链表方式，对应于mm_struct中的mmap链表头，一种是红黑树方式，对应于mm_struct中的mm_rb根节点，和内核其他地方一样，链表用于遍历，红黑树用于查找。</p>

<p>下面以文件映射为例，来阐述文件的address_space和与其建立映射关系的vma是如何联系上的。首先来看看struct address_space中与vma相关的变量</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct address_space {
</span><span class='line'>&#9;struct inode        *host;      /* owner: inode, block_device */
</span><span class='line'>&#9;...
</span><span class='line'>&#9;struct prio_tree_root   i_mmap;     /* tree of private and shared mappings */
</span><span class='line'>&#9;struct list_head    i_mmap_nonlinear;          /*list VM_NONLINEAR mappings */
</span><span class='line'>&#9;...
</span><span class='line'>} __attr</span></code></pre></td></tr></table></div></figure>


<p>与此同时，struct file和struct inode中都包含有一个struct address_space的指针，分别为f_mapping和i_mapping。struct file是一个特定于进程的数据结构，而struct inode则是一个特定于文件的数据结构。每当进程打开一个文件时，都会将file->f_mapping设置到inode->i_mapping,下图则给出了文件和与其建立映射关系的vma的联系</p>

<p><img src="/images/kernel/2015-09-11-1.png" alt="" /></p>

<p>下面来看几个vma的基本操作函数，这些函数都是后面实现具体功能的基础</p>

<p>find_vma()用来寻找一个针对于指定地址的vma，该vma要么包含了指定的地址，要么位于该地址之后并且离该地址最近，或者说寻找第一个满足addr&lt;vma_end的vma</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct vm_area_struct *find_vma(struct mm_struct *mm, unsigned long addr)
</span><span class='line'>{
</span><span class='line'>&#9;struct vm_area_struct *vma = NULL;
</span><span class='line'>
</span><span class='line'>&#9;if (mm) {
</span><span class='line'>&#9;&#9;/* Check the cache first. */
</span><span class='line'>&#9;&#9;/* (Cache hit rate is typically around 35%.) */
</span><span class='line'>&#9;&#9;vma = mm-&gt;mmap_cache; //首先尝试mmap_cache中缓存的vma
</span><span class='line'>&#9;&#9;/*如果不满足下列条件中的任意一个则从红黑树中查找合适的vma
</span><span class='line'>&#9;&#9;  1.缓存vma不存在
</span><span class='line'>&#9;&#9;  2.缓存vma的结束地址小于给定的地址
</span><span class='line'>&#9;&#9;  3.缓存vma的起始地址大于给定的地址*/
</span><span class='line'>&#9;&#9;if (!(vma && vma-&gt;vm_end &gt; addr && vma-&gt;vm_start &lt;= addr)) {
</span><span class='line'>&#9;&#9;&#9;struct rb_node * rb_node;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;rb_node = mm-&gt;mm_rb.rb_node;//获取红黑树根节点
</span><span class='line'>&#9;&#9;&#9;vma = NULL;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;while (rb_node) {
</span><span class='line'>&#9;&#9;&#9;&#9;struct vm_area_struct * vma_tmp;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;&#9;vma_tmp = rb_entry(rb_node,   //获取节点对应的vma
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;struct vm_area_struct, vm_rb);
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;&#9;/*首先确定vma的结束地址是否大于给定地址，如果是的话，再确定
</span><span class='line'>&#9;&#9;&#9;&#9;  vma的起始地址是否小于给定地址，也就是优先保证给定的地址是
</span><span class='line'>&#9;&#9;&#9;&#9;  处于vma的范围之内的，如果无法保证这点，则只能找到一个距离
</span><span class='line'>&#9;&#9;&#9;&#9;  给定地址最近的vma并且该vma的结束地址要大于给定地址*/
</span><span class='line'>&#9;&#9;&#9;&#9;if (vma_tmp-&gt;vm_end &gt; addr) {
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;vma = vma_tmp;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;if (vma_tmp-&gt;vm_start &lt;= addr)
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;rb_node = rb_node-&gt;rb_left;
</span><span class='line'>&#9;&#9;&#9;&#9;} else
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;rb_node = rb_node-&gt;rb_right;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;if (vma)
</span><span class='line'>&#9;&#9;&#9;&#9;mm-&gt;mmap_cache = vma;//将结果保存在缓存中
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;return vma;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>当一个新区域被加到进程的地址空间时，内核会检查它是否可以与一个或多个现存区域合并，vma_merge()函数在可能的情况下，将一个新区域与周边区域进行合并。参数：</p>

<p>mm:新区域所属的进程地址空间<br/>
prev:在地址上紧接着新区域的前面一个vma<br/>
addr:新区域的起始地址<br/>
end:新区域的结束地址<br/>
vm_flags:新区域的标识集<br/>
anon_vma:新区域所属的匿名映射<br/>
file:新区域映射的文件<br/>
pgoff:新区域映射文件的偏移<br/>
policy:和NUMA相关</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct vm_area_struct *vma_merge(struct mm_struct *mm,
</span><span class='line'>&#9;&#9;&#9;struct vm_area_struct *prev, unsigned long addr,
</span><span class='line'>&#9;&#9;&#9;unsigned long end, unsigned long vm_flags,
</span><span class='line'>&#9;&#9;&#9;struct anon_vma *anon_vma, struct file *file,
</span><span class='line'>&#9;&#9;&#9;pgoff_t pgoff, struct mempolicy *policy)
</span><span class='line'>{
</span><span class='line'>&#9;pgoff_t pglen = (end - addr) &gt;&gt; PAGE_SHIFT;
</span><span class='line'>&#9;struct vm_area_struct *area, *next;
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * We later require that vma-&gt;vm_flags == vm_flags,
</span><span class='line'>&#9; * so this tests vma-&gt;vm_flags & VM_SPECIAL, too.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;if (vm_flags & VM_SPECIAL)
</span><span class='line'>&#9;&#9;return NULL;
</span><span class='line'>
</span><span class='line'>&#9;if (prev)//指定了先驱vma，则获取先驱vma的后驱vma
</span><span class='line'>&#9;&#9;next = prev-&gt;vm_next;
</span><span class='line'>&#9;else     //否则指定mm的vma链表中的第一个元素为后驱vma
</span><span class='line'>&#9;&#9;next = mm-&gt;mmap;
</span><span class='line'>&#9;area = next;
</span><span class='line'>
</span><span class='line'>&#9;/*后驱节点存在，并且后驱vma的结束地址和给定区域的结束地址相同，
</span><span class='line'>&#9;  也就是说两者有重叠，那么调整后驱vma*/
</span><span class='line'>&#9;if (next && next-&gt;vm_end == end)     /* cases 6, 7, 8 */
</span><span class='line'>&#9;&#9;next = next-&gt;vm_next;
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * 先判断给定的区域能否和前驱vma进行合并，需要判断如下的几个方面:
</span><span class='line'>&#9;   1.前驱vma必须存在
</span><span class='line'>&#9;   2.前驱vma的结束地址正好等于给定区域的起始地址
</span><span class='line'>&#9;   3.两者的struct mempolicy中的相关属性要相同，这项检查只对NUMA架构有意义
</span><span class='line'>&#9;   4.其他相关项必须匹配，包括两者的vm_flags，是否映射同一个文件等等
</span><span class='line'>&#9; */
</span><span class='line'>&#9;if (prev && prev-&gt;vm_end == addr &&
</span><span class='line'>&#9;&#9;&#9;mpol_equal(vma_policy(prev), policy) &&
</span><span class='line'>&#9;&#9;&#9;can_vma_merge_after(prev, vm_flags,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;anon_vma, file, pgoff)) {
</span><span class='line'>&#9;&#9;/*
</span><span class='line'>&#9;&#9; *确定可以和前驱vma合并后再判断是否能和后驱vma合并，判断方式和前面一样，
</span><span class='line'>&#9;&#9;  不过这里多了一项检查，在给定区域能和前驱、后驱vma合并的情况下还要检查
</span><span class='line'>&#9;&#9;  前驱、后驱vma的匿名映射可以合并
</span><span class='line'>&#9;&#9; */
</span><span class='line'>&#9;&#9;if (next && end == next-&gt;vm_start &&
</span><span class='line'>&#9;&#9;&#9;&#9;mpol_equal(policy, vma_policy(next)) &&
</span><span class='line'>&#9;&#9;&#9;&#9;can_vma_merge_before(next, vm_flags,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;anon_vma, file, pgoff+pglen) &&
</span><span class='line'>&#9;&#9;&#9;&#9;is_mergeable_anon_vma(prev-&gt;anon_vma,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;  next-&gt;anon_vma)) {
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;/* cases 1, 6 */
</span><span class='line'>&#9;&#9;&#9;vma_adjust(prev, prev-&gt;vm_start,
</span><span class='line'>&#9;&#9;&#9;&#9;next-&gt;vm_end, prev-&gt;vm_pgoff, NULL);
</span><span class='line'>&#9;&#9;} else                  /* cases 2, 5, 7 */
</span><span class='line'>&#9;&#9;&#9;vma_adjust(prev, prev-&gt;vm_start,
</span><span class='line'>&#9;&#9;&#9;&#9;end, prev-&gt;vm_pgoff, NULL);
</span><span class='line'>&#9;&#9;return prev;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * Can this new request be merged in front of next?
</span><span class='line'>&#9; */
</span><span class='line'>&#9; /*如果前面的步骤失败，那么则从后驱vma开始进行和上面类似的步骤*/
</span><span class='line'>&#9;if (next && end == next-&gt;vm_start &&
</span><span class='line'>&#9;&#9;&#9;mpol_equal(policy, vma_policy(next)) &&
</span><span class='line'>&#9;&#9;&#9;can_vma_merge_before(next, vm_flags,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;anon_vma, file, pgoff+pglen)) {
</span><span class='line'>&#9;&#9;if (prev && addr &lt; prev-&gt;vm_end)  /* case 4 */
</span><span class='line'>&#9;&#9;&#9;vma_adjust(prev, prev-&gt;vm_start,
</span><span class='line'>&#9;&#9;&#9;&#9;addr, prev-&gt;vm_pgoff, NULL);
</span><span class='line'>&#9;&#9;else                    /* cases 3, 8 */
</span><span class='line'>&#9;&#9;&#9;vma_adjust(area, addr, next-&gt;vm_end,
</span><span class='line'>&#9;&#9;&#9;&#9;next-&gt;vm_pgoff - pglen, NULL);
</span><span class='line'>&#9;&#9;return area;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;return NULL;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>vma_adjust会执行具体的合并调整操作</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void vma_adjust(struct vm_area_struct *vma, unsigned long start,
</span><span class='line'>&#9;unsigned long end, pgoff_t pgoff, struct vm_area_struct *insert)
</span><span class='line'>{
</span><span class='line'>&#9;struct mm_struct *mm = vma-&gt;vm_mm;
</span><span class='line'>&#9;struct vm_area_struct *next = vma-&gt;vm_next;
</span><span class='line'>&#9;struct vm_area_struct *importer = NULL;
</span><span class='line'>&#9;struct address_space *mapping = NULL;
</span><span class='line'>&#9;struct prio_tree_root *root = NULL;
</span><span class='line'>&#9;struct file *file = vma-&gt;vm_file;
</span><span class='line'>&#9;struct anon_vma *anon_vma = NULL;
</span><span class='line'>&#9;long adjust_next = 0;
</span><span class='line'>&#9;int remove_next = 0;
</span><span class='line'>
</span><span class='line'>&#9;if (next && !insert) {
</span><span class='line'>&#9;&#9;/*指定的范围已经跨越了整个后驱vma，并且有可能超过后驱vma*/
</span><span class='line'>&#9;&#9;if (end &gt;= next-&gt;vm_end) {
</span><span class='line'>&#9;&#9;&#9;/*
</span><span class='line'>&#9;&#9;&#9; * vma expands, overlapping all the next, and
</span><span class='line'>&#9;&#9;&#9; * perhaps the one after too (mprotect case 6).
</span><span class='line'>&#9;&#9;&#9; */
</span><span class='line'>again:          remove_next = 1 + (end &gt; next-&gt;vm_end);//确定是否超过了后驱vma
</span><span class='line'>&#9;&#9;&#9;end = next-&gt;vm_end;
</span><span class='line'>&#9;&#9;&#9;anon_vma = next-&gt;anon_vma;
</span><span class='line'>&#9;&#9;&#9;importer = vma;
</span><span class='line'>&#9;&#9;} else if (end &gt; next-&gt;vm_start) {/*指定的区域和后驱vma部分重合*/
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;/*
</span><span class='line'>&#9;&#9;&#9; * vma expands, overlapping part of the next:
</span><span class='line'>&#9;&#9;&#9; * mprotect case 5 shifting the boundary up.
</span><span class='line'>&#9;&#9;&#9; */
</span><span class='line'>&#9;&#9;&#9;adjust_next = (end - next-&gt;vm_start) &gt;&gt; PAGE_SHIFT;
</span><span class='line'>&#9;&#9;&#9;anon_vma = next-&gt;anon_vma;
</span><span class='line'>&#9;&#9;&#9;importer = vma;
</span><span class='line'>&#9;&#9;} else if (end &lt; vma-&gt;vm_end) {/*指定的区域没到达后驱vma的结束处*/
</span><span class='line'>&#9;&#9;&#9;/*
</span><span class='line'>&#9;&#9;&#9; * vma shrinks, and !insert tells it's not
</span><span class='line'>&#9;&#9;&#9; * split_vma inserting another: so it must be
</span><span class='line'>&#9;&#9;&#9; * mprotect case 4 shifting the boundary down.
</span><span class='line'>&#9;&#9;&#9; */
</span><span class='line'>&#9;&#9;&#9;adjust_next = - ((vma-&gt;vm_end - end) &gt;&gt; PAGE_SHIFT);
</span><span class='line'>&#9;&#9;&#9;anon_vma = next-&gt;anon_vma;
</span><span class='line'>&#9;&#9;&#9;importer = next;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;if (file) {//如果有映射文件
</span><span class='line'>&#9;&#9;mapping = file-&gt;f_mapping;//获取文件对应的address_space
</span><span class='line'>&#9;&#9;if (!(vma-&gt;vm_flags & VM_NONLINEAR))
</span><span class='line'>&#9;&#9;&#9;root = &mapping-&gt;i_mmap;
</span><span class='line'>&#9;&#9;spin_lock(&mapping-&gt;i_mmap_lock);
</span><span class='line'>&#9;&#9;if (importer &&
</span><span class='line'>&#9;&#9;&#9;vma-&gt;vm_truncate_count != next-&gt;vm_truncate_count) {
</span><span class='line'>&#9;&#9;&#9;/*
</span><span class='line'>&#9;&#9;&#9; * unmap_mapping_range might be in progress:
</span><span class='line'>&#9;&#9;&#9; * ensure that the expanding vma is rescanned.
</span><span class='line'>&#9;&#9;&#9; */
</span><span class='line'>&#9;&#9;&#9;importer-&gt;vm_truncate_count = 0;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;/*如果指定了待插入的vma，则根据vma是否以非线性的方式映射文件来选择是将
</span><span class='line'>&#9;&#9;vma插入file对应的address_space的优先树(对应线性映射)还是双向链表(非线性映射)*/
</span><span class='line'>&#9;&#9;if (insert) {
</span><span class='line'>&#9;&#9;&#9;insert-&gt;vm_truncate_count = vma-&gt;vm_truncate_count;
</span><span class='line'>&#9;&#9;&#9;/*
</span><span class='line'>&#9;&#9;&#9; * Put into prio_tree now, so instantiated pages
</span><span class='line'>&#9;&#9;&#9; * are visible to arm/parisc __flush_dcache_page
</span><span class='line'>&#9;&#9;&#9; * throughout; but we cannot insert into address
</span><span class='line'>&#9;&#9;&#9; * space until vma start or end is updated.
</span><span class='line'>&#9;&#9;&#9; */
</span><span class='line'>&#9;&#9;&#9;__vma_link_file(insert);
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * When changing only vma-&gt;vm_end, we don't really need
</span><span class='line'>&#9; * anon_vma lock.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;if (vma-&gt;anon_vma && (insert || importer || start != vma-&gt;vm_start))
</span><span class='line'>&#9;&#9;anon_vma = vma-&gt;anon_vma;
</span><span class='line'>&#9;if (anon_vma) {
</span><span class='line'>&#9;&#9;spin_lock(&anon_vma-&gt;lock);
</span><span class='line'>&#9;&#9;/*
</span><span class='line'>&#9;&#9; * Easily overlooked: when mprotect shifts the boundary,
</span><span class='line'>&#9;&#9; * make sure the expanding vma has anon_vma set if the
</span><span class='line'>&#9;&#9; * shrinking vma had, to cover any anon pages imported.
</span><span class='line'>&#9;&#9; */
</span><span class='line'>&#9;&#9;if (importer && !importer-&gt;anon_vma) {
</span><span class='line'>&#9;&#9;&#9;importer-&gt;anon_vma = anon_vma;
</span><span class='line'>&#9;&#9;&#9;__anon_vma_link(importer);//将importer插入importer的anon_vma匿名映射链表中
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;if (root) {
</span><span class='line'>&#9;&#9;flush_dcache_mmap_lock(mapping);
</span><span class='line'>&#9;&#9;vma_prio_tree_remove(vma, root);
</span><span class='line'>&#9;&#9;if (adjust_next)
</span><span class='line'>&#9;&#9;&#9;vma_prio_tree_remove(next, root);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;/*调整vma的相关量*/
</span><span class='line'>&#9;vma-&gt;vm_start = start;
</span><span class='line'>&#9;vma-&gt;vm_end = end;
</span><span class='line'>&#9;vma-&gt;vm_pgoff = pgoff;
</span><span class='line'>&#9;if (adjust_next) {//调整后驱vma的相关量
</span><span class='line'>&#9;&#9;next-&gt;vm_start += adjust_next &lt;&lt; PAGE_SHIFT;
</span><span class='line'>&#9;&#9;next-&gt;vm_pgoff += adjust_next;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;if (root) {
</span><span class='line'>&#9;&#9;if (adjust_next)//如果后驱vma被调整了，则重新插入到优先树中
</span><span class='line'>&#9;&#9;&#9;vma_prio_tree_insert(next, root);
</span><span class='line'>&#9;&#9;vma_prio_tree_insert(vma, root);//将vma插入到优先树中
</span><span class='line'>&#9;&#9;flush_dcache_mmap_unlock(mapping);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;if (remove_next) {//给定区域与后驱vma有重合
</span><span class='line'>&#9;&#9;/*
</span><span class='line'>&#9;&#9; * vma_merge has merged next into vma, and needs
</span><span class='line'>&#9;&#9; * us to remove next before dropping the locks.
</span><span class='line'>&#9;&#9; */
</span><span class='line'>&#9;&#9;__vma_unlink(mm, next, vma);//将后驱vma从红黑树中删除
</span><span class='line'>&#9;&#9;if (file)//将后驱vma从文件对应的address space中删除
</span><span class='line'>&#9;&#9;&#9;__remove_shared_vm_struct(next, file, mapping);
</span><span class='line'>&#9;&#9;if (next-&gt;anon_vma)//将后驱vma从匿名映射链表中删除
</span><span class='line'>&#9;&#9;&#9;__anon_vma_merge(vma, next);
</span><span class='line'>&#9;} else if (insert) {
</span><span class='line'>&#9;&#9;/*
</span><span class='line'>&#9;&#9; * split_vma has split insert from vma, and needs
</span><span class='line'>&#9;&#9; * us to insert it before dropping the locks
</span><span class='line'>&#9;&#9; * (it may either follow vma or precede it).
</span><span class='line'>&#9;&#9; */
</span><span class='line'>&#9;&#9;__insert_vm_struct(mm, insert);//将待插入的vma插入mm的红黑树，双向链表以及
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;//匿名映射链表
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;if (anon_vma)
</span><span class='line'>&#9;&#9;spin_unlock(&anon_vma-&gt;lock);
</span><span class='line'>&#9;if (mapping)
</span><span class='line'>&#9;&#9;spin_unlock(&mapping-&gt;i_mmap_lock);
</span><span class='line'>
</span><span class='line'>&#9;if (remove_next) {
</span><span class='line'>&#9;&#9;if (file) {
</span><span class='line'>&#9;&#9;&#9;fput(file);
</span><span class='line'>&#9;&#9;&#9;if (next-&gt;vm_flags & VM_EXECUTABLE)
</span><span class='line'>&#9;&#9;&#9;&#9;removed_exe_file_vma(mm);
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;mm-&gt;map_count--;
</span><span class='line'>&#9;&#9;mpol_put(vma_policy(next));
</span><span class='line'>&#9;&#9;kmem_cache_free(vm_area_cachep, next);
</span><span class='line'>&#9;&#9;/*
</span><span class='line'>&#9;&#9; * In mprotect's case 6 (see comments on vma_merge),
</span><span class='line'>&#9;&#9; * we must remove another next too. It would clutter
</span><span class='line'>&#9;&#9; * up the code too much to do both in one go.
</span><span class='line'>&#9;&#9; */
</span><span class='line'>&#9;&#9;if (remove_next == 2) {//还有待删除的区域
</span><span class='line'>&#9;&#9;&#9;next = vma-&gt;vm_next;
</span><span class='line'>&#9;&#9;&#9;goto again;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;validate_mm(mm);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>insert_vm_struct()函数用于插入一块新区域</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int insert_vm_struct(struct mm_struct * mm, struct vm_area_struct * vma)
</span><span class='line'>{
</span><span class='line'>&#9;struct vm_area_struct * __vma, * prev;
</span><span class='line'>&#9;struct rb_node ** rb_link, * rb_parent;
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * The vm_pgoff of a purely anonymous vma should be irrelevant
</span><span class='line'>&#9; * until its first write fault, when page's anon_vma and index
</span><span class='line'>&#9; * are set.  But now set the vm_pgoff it will almost certainly
</span><span class='line'>&#9; * end up with (unless mremap moves it elsewhere before that
</span><span class='line'>&#9; * first wfault), so /proc/pid/maps tells a consistent story.
</span><span class='line'>&#9; *
</span><span class='line'>&#9; * By setting it to reflect the virtual start address of the
</span><span class='line'>&#9; * vma, merges and splits can happen in a seamless way, just
</span><span class='line'>&#9; * using the existing file pgoff checks and manipulations.
</span><span class='line'>&#9; * Similarly in do_mmap_pgoff and in do_brk.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;if (!vma-&gt;vm_file) {
</span><span class='line'>&#9;&#9;BUG_ON(vma-&gt;anon_vma);
</span><span class='line'>&#9;&#9;vma-&gt;vm_pgoff = vma-&gt;vm_start &gt;&gt; PAGE_SHIFT;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;/*__vma用来保存和vma-&gt;start对应的vma(与find_vma()一样)，同时获取以下信息:
</span><span class='line'>&#9;  1.prev用来保存对应的前驱vma
</span><span class='line'>&#9;  2.rb_link保存该vma区域插入对应的红黑树节点
</span><span class='line'>&#9;  3.rb_parent保存该vma区域对应的父节点*/
</span><span class='line'>&#9;__vma = find_vma_prepare(mm,vma-&gt;vm_start,&prev,&rb_link,&rb_parent);
</span><span class='line'>&#9;if (__vma && __vma-&gt;vm_start &lt; vma-&gt;vm_end)
</span><span class='line'>&#9;&#9;return -ENOMEM;
</span><span class='line'>&#9;if ((vma-&gt;vm_flags & VM_ACCOUNT) &&
</span><span class='line'>&#9;&#9; security_vm_enough_memory_mm(mm, vma_pages(vma)))
</span><span class='line'>&#9;&#9;return -ENOMEM;
</span><span class='line'>&#9;vma_link(mm, vma, prev, rb_link, rb_parent);//将vma关联到所有的数据结构中
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static void vma_link(struct mm_struct *mm, struct vm_area_struct *vma,
</span><span class='line'>&#9;&#9;&#9;struct vm_area_struct *prev, struct rb_node **rb_link,
</span><span class='line'>&#9;&#9;&#9;struct rb_node *rb_parent)
</span><span class='line'>{
</span><span class='line'>&#9;struct address_space *mapping = NULL;
</span><span class='line'>
</span><span class='line'>&#9;if (vma-&gt;vm_file)//如果存在文件映射则获取文件对应的地址空间
</span><span class='line'>&#9;&#9;mapping = vma-&gt;vm_file-&gt;f_mapping;
</span><span class='line'>
</span><span class='line'>&#9;if (mapping) {
</span><span class='line'>&#9;&#9;spin_lock(&mapping-&gt;i_mmap_lock);
</span><span class='line'>&#9;&#9;vma-&gt;vm_truncate_count = mapping-&gt;truncate_count;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;anon_vma_lock(vma);
</span><span class='line'>
</span><span class='line'>&#9;/*将vma插入到相应的数据结构中--双向链表，红黑树和匿名映射链表*/
</span><span class='line'>&#9;__vma_link(mm, vma, prev, rb_link, rb_parent);
</span><span class='line'>&#9;__vma_link_file(vma);//将vma插入到文件地址空间的相应数据结构中
</span><span class='line'>
</span><span class='line'>&#9;anon_vma_unlock(vma);
</span><span class='line'>&#9;if (mapping)
</span><span class='line'>&#9;&#9;spin_unlock(&mapping-&gt;i_mmap_lock);
</span><span class='line'>
</span><span class='line'>&#9;mm-&gt;map_count++;
</span><span class='line'>&#9;validate_mm(mm);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>在创建新的vma区域之前先要寻找一块足够大小的空闲区域，该项工作由get_unmapped_area()函数完成，而实际的工作将会由mm_struct中定义的辅助函数来完成。根据进程虚拟地址空间的布局，会选择使用不同的映射函数，在这里考虑大多数系统上采用的标准函数arch_get_unmapped_area();</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>unsigned long
</span><span class='line'>arch_get_unmapped_area(struct file *filp, unsigned long addr,
</span><span class='line'>&#9;&#9;unsigned long len, unsigned long pgoff, unsigned long flags)
</span><span class='line'>{
</span><span class='line'>&#9;struct mm_struct *mm = current-&gt;mm;
</span><span class='line'>&#9;struct vm_area_struct *vma;
</span><span class='line'>&#9;unsigned long start_addr;
</span><span class='line'>
</span><span class='line'>&#9;if (len &gt; TASK_SIZE)
</span><span class='line'>&#9;&#9;return -ENOMEM;
</span><span class='line'>
</span><span class='line'>&#9;if (flags & MAP_FIXED)
</span><span class='line'>&#9;&#9;return addr;
</span><span class='line'>
</span><span class='line'>&#9;if (addr) {
</span><span class='line'>&#9;&#9;addr = PAGE_ALIGN(addr);//将地址按页对齐
</span><span class='line'>&#9;&#9;vma = find_vma(mm, addr);//获取一个vma，该vma可能包含了addr也可能在addr后面并且离addr最近
</span><span class='line'>&#9;&#9;/*这里确定是否有一块适合的空闲区域，先要保证addr+len不会
</span><span class='line'>&#9;&#9;  超过进程地址空间的最大允许范围，然后如果前面vma获取成功的话则要保证
</span><span class='line'>&#9;&#9;  vma位于addr的后面并且addr+len不会延伸到该vma的区域*/
</span><span class='line'>&#9;&#9;if (TASK_SIZE - len &gt;= addr &&
</span><span class='line'>&#9;&#9;&#9;(!vma || addr + len &lt;= vma-&gt;vm_start))
</span><span class='line'>&#9;&#9;&#9;return addr;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;/*前面获取不成功的话则要调整起始地址了，根据情况选择缓存的空闲区域地址
</span><span class='line'>&#9;  或者TASK_UNMAPPED_BASE=TASK_SIZE/3*/
</span><span class='line'>&#9;if (len &gt; mm-&gt;cached_hole_size) {
</span><span class='line'>&#9;&#9;&#9;start_addr = addr = mm-&gt;free_area_cache;
</span><span class='line'>&#9;} else {
</span><span class='line'>&#9;&#9;&#9;start_addr = addr = TASK_UNMAPPED_BASE;
</span><span class='line'>&#9;&#9;&#9;mm-&gt;cached_hole_size = 0;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>full_search:
</span><span class='line'>&#9;/*从addr开始遍历用户地址空间*/
</span><span class='line'>&#9;for (vma = find_vma(mm, addr); ; vma = vma-&gt;vm_next) {
</span><span class='line'>&#9;&#9;/* At this point:  (!vma || addr &lt; vma-&gt;vm_end). */
</span><span class='line'>&#9;&#9;if (TASK_SIZE - len &lt; addr) {//这里判断是否已经遍历到了用户地址空间的末端
</span><span class='line'>&#9;&#9;&#9;/*
</span><span class='line'>&#9;&#9;&#9; * Start a new search - just in case we missed
</span><span class='line'>&#9;&#9;&#9; * some holes.
</span><span class='line'>&#9;&#9;&#9; */
</span><span class='line'>&#9;&#9;&#9; //如果上次不是从TAKS_UNMAPPED_BASE开始遍历的，则尝试从TASK_UNMAPPED_BASE开始遍历
</span><span class='line'>&#9;&#9;&#9;if (start_addr != TASK_UNMAPPED_BASE) {
</span><span class='line'>&#9;&#9;&#9;&#9;addr = TASK_UNMAPPED_BASE;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;start_addr = addr;
</span><span class='line'>&#9;&#9;&#9;&#9;mm-&gt;cached_hole_size = 0;
</span><span class='line'>&#9;&#9;&#9;&#9;goto full_search;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;return -ENOMEM;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;if (!vma || addr + len &lt;= vma-&gt;vm_start) {//判断是否有空闲区域
</span><span class='line'>&#9;&#9;&#9;/*
</span><span class='line'>&#9;&#9;&#9; *找到空闲区域的话则记住我们搜索的结束处，以便下次搜索
</span><span class='line'>&#9;&#9;&#9; */
</span><span class='line'>&#9;&#9;&#9;mm-&gt;free_area_cache = addr + len;
</span><span class='line'>&#9;&#9;&#9;return addr;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;/*该空闲区域不符合大小要求，但是如果这个空闲区域大于之前保存的最大值的话
</span><span class='line'>&#9;&#9;  则将这个空闲区域保存，这样便于前面确定从哪里开始搜索*/
</span><span class='line'>&#9;&#9;if (addr + mm-&gt;cached_hole_size &lt; vma-&gt;vm_start)
</span><span class='line'>&#9;&#9;&#9;&#9;mm-&gt;cached_hole_size = vma-&gt;vm_start - addr;
</span><span class='line'>&#9;&#9;addr = vma-&gt;vm_end;
</span><span class='line'>&#9;}
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/09/09/kernel-mm-find-page/">查看某进程内存</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-09-09T17:54:00+08:00'><span class='date'>2015-09-09</span> <span class='time'>17:54:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>test.c</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include&lt;sys/mman.h&gt;
</span><span class='line'>#include&lt;sys/types.h&gt;
</span><span class='line'>#include&lt;fcntl.h&gt;
</span><span class='line'>#include&lt;stdio.h&gt;
</span><span class='line'>#include&lt;unistd.h&gt;
</span><span class='line'>
</span><span class='line'>#include &lt;time.h&gt;
</span><span class='line'>#include &lt;string.h&gt;
</span><span class='line'>
</span><span class='line'>int main()
</span><span class='line'>{   
</span><span class='line'>&#9;int i,j,k,l;
</span><span class='line'>&#9;char *mp;
</span><span class='line'>&#9;mp = (char*)mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0); 
</span><span class='line'>&#9;strcpy(mp, "ABCDEFGHIJKL1234567890!@#$%^&*()KKKKKKKKKKKKKKKKKKK");
</span><span class='line'>&#9;strcpy(mp+4096, "AAAAAAAAAAAAAAAAAAABBBBBBBBBBBBCCCCCCCCCCC");
</span><span class='line'>&#9;sleep(10000000);
</span><span class='line'>&#9;munmap(mp, 8192);
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># strace ./test
</span><span class='line'>execve("./test", ["./test"], [/* 23 vars */]) = 0
</span><span class='line'>brk(0)                                  = 0x1bdf000
</span><span class='line'>mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f133f166000
</span><span class='line'>mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f133f165000
</span><span class='line'>access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
</span><span class='line'>open("/etc/ld.so.cache", O_RDONLY)      = 3
</span><span class='line'>fstat(3, {st_mode=S_IFREG|0644, st_size=72203, ...}) = 0
</span><span class='line'>mmap(NULL, 72203, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f133f153000
</span><span class='line'>close(3)                                = 0
</span><span class='line'>open("/lib64/libc.so.6", O_RDONLY)      = 3
</span><span class='line'>read(3, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360\332a\2217\0\0\0"..., 832) = 832
</span><span class='line'>fstat(3, {st_mode=S_IFREG|0755, st_size=1726296, ...}) = 0
</span><span class='line'>mmap(0x3791600000, 3506520, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x3791600000
</span><span class='line'>mprotect(0x379174f000, 2097152, PROT_NONE) = 0
</span><span class='line'>mmap(0x379194f000, 20480, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x14f000) = 0x379194f000
</span><span class='line'>mmap(0x3791954000, 16728, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x3791954000
</span><span class='line'>close(3)                                = 0
</span><span class='line'>mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f133f152000
</span><span class='line'>mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f133f151000
</span><span class='line'>arch_prctl(ARCH_SET_FS, 0x7f133f1516e0) = 0
</span><span class='line'>mprotect(0x379194f000, 16384, PROT_READ) = 0
</span><span class='line'>mprotect(0x379141c000, 4096, PROT_READ) = 0
</span><span class='line'>munmap(0x7f133f153000, 72203)           = 0
</span><span class='line'>mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f133f163000
</span><span class='line'>rt_sigprocmask(SIG_BLOCK, [CHLD], [], 8) = 0
</span><span class='line'>rt_sigaction(SIGCHLD, NULL, {SIG_DFL, [], 0}, 8) = 0
</span><span class='line'>rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0
</span><span class='line'>nanosleep({10000000, 0},</span></code></pre></td></tr></table></div></figure>


<p>基本确定最后一个mmap就是我们申请的，它的起始虚拟地址是0x7f133f163000，所以要在对应tast的mm中找到相应的vma。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>crash&gt; ps
</span><span class='line'>...
</span><span class='line'>  58674  58673   0  ffff88003d388ae0  IN   0.0    3672    316  test
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>crash_7.0.8&gt; task_struct ffff88003d388ae0
</span><span class='line'>struct task_struct {
</span><span class='line'>...
</span><span class='line'>mm = 0xffff88003d80ba00,
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>crash_7.0.8&gt; mm_struct 0xffff88003d80ba00
</span><span class='line'>struct mm_struct {
</span><span class='line'>  mmap = 0xffff88002a4d5ed0,
</span><span class='line'>  mm_rb = {
</span><span class='line'>&#9;rb_node = 0xffff88003c2fad38
</span><span class='line'>  },
</span><span class='line'>  mmap_cache = 0xffff880029332788,
</span><span class='line'>  get_unmapped_area = 0xffffffff81010410 &lt;arch_get_unmapped_area_topdown&gt;,
</span><span class='line'>  get_unmapped_exec_area = 0x0,
</span><span class='line'>  unmap_area = 0xffffffff8113aed0 &lt;arch_unmap_area_topdown&gt;,
</span><span class='line'>  mmap_base = 139720639541248,
</span><span class='line'>  task_size = 140737488351232,
</span><span class='line'>  cached_hole_size = 0,   
</span><span class='line'>  free_area_cache = 139720639524864,
</span><span class='line'>  pgd = 0xffff88000c952000,
</span><span class='line'>  ...</span></code></pre></td></tr></table></div></figure>


<p>先看mmap，mmap_cache是不是，不是的话从mm_rb.rb_node开始找，这个是平衡二叉树的根。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define rb_entry(ptr, type, member) container_of(ptr, type, member)
</span><span class='line'>
</span><span class='line'>vma_tmp = rb_entry(rb_node, struct vm_area_struct, vm_rb);</span></code></pre></td></tr></table></div></figure>


<p>所以rb_node的地址减去vm_rb在struct vm_area_struct的偏移就是对应struct vm_area_struct的地址（2.6.32-358是0x38）</p>

<p>所以rb_node = 0xffff88003c2fad38 => struct vm_area_struct = 0xffff88003c2fad00</p>

<p>根据find_vma函数方法，直到找到</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* Look up the first VMA which satisfies  addr &lt; vm_end,  NULL if none. */
</span><span class='line'>struct vm_area_struct *find_vma(struct mm_struct *mm, unsigned long addr)
</span><span class='line'>{
</span><span class='line'>&#9;struct vm_area_struct *vma = NULL;
</span><span class='line'>
</span><span class='line'>&#9;if (mm) {
</span><span class='line'>&#9;&#9;/* Check the cache first. */
</span><span class='line'>&#9;&#9;/* (Cache hit rate is typically around 35%.) */
</span><span class='line'>&#9;&#9;vma = mm-&gt;mmap_cache;
</span><span class='line'>&#9;&#9;if (!(vma && vma-&gt;vm_end &gt; addr && vma-&gt;vm_start &lt;= addr)) {
</span><span class='line'>&#9;&#9;&#9;struct rb_node * rb_node;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;rb_node = mm-&gt;mm_rb.rb_node;
</span><span class='line'>&#9;&#9;&#9;vma = NULL;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;while (rb_node) {
</span><span class='line'>&#9;&#9;&#9;&#9;struct vm_area_struct * vma_tmp;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;&#9;vma_tmp = rb_entry(rb_node,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;struct vm_area_struct, vm_rb);
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;&#9;if (vma_tmp-&gt;vm_end &gt; addr) {
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;vma = vma_tmp;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;if (vma_tmp-&gt;vm_start &lt;= addr)
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;rb_node = rb_node-&gt;rb_left;
</span><span class='line'>&#9;&#9;&#9;&#9;} else 
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;rb_node = rb_node-&gt;rb_right;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;if (vma)
</span><span class='line'>&#9;&#9;&#9;&#9;mm-&gt;mmap_cache = vma; 
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;return vma; 
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>crash_7.0.8&gt; vm_area_struct 0xffff88002d29c5f8
</span><span class='line'>struct vm_area_struct {
</span><span class='line'>  vm_mm = 0xffff88003d80ba00,
</span><span class='line'>  vm_start = 139720639524864,
</span><span class='line'>  vm_end = 139720639541248,
</span><span class='line'>  vm_next = 0xffff880029332788,
</span><span class='line'>  vm_prev = 0xffff88003c2fa918,
</span><span class='line'>  vm_page_prot = {
</span><span class='line'>&#9;pgprot = 9223372036854775845
</span><span class='line'>  },
</span><span class='line'>  vm_flags = 1048691,
</span><span class='line'>  vm_rb = {
</span><span class='line'>&#9;rb_parent_color = 18446612133323974193,
</span><span class='line'>&#9;rb_right = 0xffff8800293327c0,
</span><span class='line'>&#9;rb_left = 0xffff88003c2fa950
</span><span class='line'>  },
</span><span class='line'>  ...
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>crash_7.0.8&gt; p/x 139720639524864
</span><span class='line'>$4 = 0x7f133f163000</span></code></pre></td></tr></table></div></figure>


<p>所以对应的vma就是0xffff88002d29c5f8，用内核函数follow_page找到对应page</p>

<p>follow_page.c</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;linux/module.h&gt;
</span><span class='line'>#include &lt;linux/kernel.h&gt;
</span><span class='line'>#include &lt;linux/init.h&gt;
</span><span class='line'>#include &lt;linux/types.h&gt;
</span><span class='line'>
</span><span class='line'>#include &lt;linux/sysctl.h&gt;
</span><span class='line'>#include &lt;linux/timer.h&gt;
</span><span class='line'>#include &lt;linux/hardirq.h&gt;
</span><span class='line'>#include &lt;linux/bottom_half.h&gt;
</span><span class='line'>#include &lt;linux/preempt.h&gt;
</span><span class='line'>
</span><span class='line'>#include &lt;linux/types.h&gt;
</span><span class='line'>#include &lt;linux/proc_fs.h&gt;
</span><span class='line'>#include &lt;linux/file.h&gt;
</span><span class='line'>
</span><span class='line'>#include &lt;linux/kprobes.h&gt;
</span><span class='line'>
</span><span class='line'>#include &lt;linux/mm.h&gt;
</span><span class='line'>#include &lt;linux/mm_types.h&gt;
</span><span class='line'>
</span><span class='line'>static int __init test_init(void)
</span><span class='line'>{
</span><span class='line'>&#9;int i;
</span><span class='line'>&#9;struct page *(*follow_page_p)(struct vm_area_struct *vma, unsigned long address, unsigned int flags)
</span><span class='line'>&#9;&#9;= (struct page *(*)(struct vm_area_struct *vma, unsigned long address, unsigned int flags))0xffffffff81133ab0;
</span><span class='line'>&#9;struct vm_area_struct *vma = (struct vm_area_struct *)0xffff88002d29c5f8;
</span><span class='line'>&#9;unsigned long address = 139720639524864UL;
</span><span class='line'>&#9;struct page *pa;  
</span><span class='line'>&#9;char ch[4096+10]; 
</span><span class='line'>&#9;pa = follow_page_p(vma, address, 0);
</span><span class='line'>&#9;memcpy(ch, page_address(pa), 4096); 
</span><span class='line'>&#9;printk("page = %p\n", pa);
</span><span class='line'>&#9;printk("%s\n", ch);   
</span><span class='line'>&#9;return 0;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>static void __exit test_exit(void)
</span><span class='line'>{
</span><span class='line'>&#9;printk("test exit\n");
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>module_init(test_init);
</span><span class='line'>module_exit(test_exit);
</span><span class='line'>
</span><span class='line'>MODULE_LICENSE("GPL");</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>obj-m := follow_page.o
</span><span class='line'>KDIR:=/lib/modules/$(shell uname -r)/build/
</span><span class='line'>PWD=$(shell pwd)
</span><span class='line'>
</span><span class='line'>all:
</span><span class='line'>&#9;make -C $(KDIR) M=$(PWD) modules
</span><span class='line'>clean:
</span><span class='line'>&#9;make -C $(KDIR) M=$(PWD) clean</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># insmod ./follow_page.ko
</span><span class='line'># rmmod follow_page
</span><span class='line'># dmesg
</span><span class='line'>page = ffffea000077a1a8
</span><span class='line'>ABCDEFGHIJKL1234567890!@#$%^&*()KKKKKKKKKKKKKKKKKKK
</span><span class='line'>test exit</span></code></pre></td></tr></table></div></figure>


<hr />

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;linux/module.h&gt; 
</span><span class='line'>#include &lt;linux/kernel.h&gt; 
</span><span class='line'>#include &lt;linux/init.h&gt;   
</span><span class='line'>#include &lt;linux/types.h&gt;  
</span><span class='line'>
</span><span class='line'>#include &lt;linux/sysctl.h&gt; 
</span><span class='line'>#include &lt;linux/timer.h&gt;  
</span><span class='line'>#include &lt;linux/hardirq.h&gt;
</span><span class='line'>#include &lt;linux/bottom_half.h&gt;
</span><span class='line'>#include &lt;linux/preempt.h&gt;
</span><span class='line'>
</span><span class='line'>#include &lt;linux/types.h&gt;  
</span><span class='line'>#include &lt;linux/proc_fs.h&gt;
</span><span class='line'>#include &lt;linux/file.h&gt;   
</span><span class='line'>
</span><span class='line'>#include &lt;linux/kprobes.h&gt;
</span><span class='line'>
</span><span class='line'>#include &lt;linux/mm.h&gt;
</span><span class='line'>#include &lt;linux/mm_types.h&gt;
</span><span class='line'>
</span><span class='line'>static int __init test_init(void)
</span><span class='line'>{
</span><span class='line'>&#9;struct page *(*follow_page_p)(struct vm_area_struct *vma, unsigned long address, unsigned int flags)
</span><span class='line'>&#9;&#9;= (struct page *(*)(struct vm_area_struct *vma, unsigned long address, unsigned int flags))0xffffffff81133ab0;
</span><span class='line'>&#9;struct vm_area_struct *vma = (struct vm_area_struct *)0xffff88002d29c5f8;
</span><span class='line'>&#9;unsigned long address = 139720639524864UL;
</span><span class='line'>&#9;struct page *pa;  
</span><span class='line'>&#9;char ch[4096+10]; 
</span><span class='line'>&#9;pa = follow_page_p(vma, address, 0);
</span><span class='line'>&#9;memcpy(ch, page_address(pa), 4096);
</span><span class='line'>&#9;{
</span><span class='line'>&#9;&#9;pgd_t *pgd;
</span><span class='line'>&#9;&#9;pud_t *pud;
</span><span class='line'>&#9;&#9;pmd_t *pmd;
</span><span class='line'>&#9;&#9;pte_t *pte;
</span><span class='line'>&#9;&#9;unsigned long pfn;
</span><span class='line'>
</span><span class='line'>&#9;&#9;pgd = pgd_offset(vma-&gt;vm_mm, address);
</span><span class='line'>&#9;&#9;pud = pud_offset(pgd, address);
</span><span class='line'>&#9;&#9;pmd = pmd_offset(pud, address);
</span><span class='line'>&#9;&#9;pte = pte_offset_map(pmd, address);
</span><span class='line'>&#9;&#9;pfn = pte_pfn(*pte);
</span><span class='line'>
</span><span class='line'>&#9;&#9;printk("follow_page=%p\n\n", pa);
</span><span class='line'>
</span><span class='line'>&#9;&#9;printk("PTE_PFN_MASK=0x%lx PAGE_OFFSET=%lx __va(x)=x+PAGE_OFFSET\n\n", PTE_PFN_MASK, PAGE_OFFSET);
</span><span class='line'>
</span><span class='line'>&#9;&#9;printk("mm-&gt;pgd=%p\n", vma-&gt;vm_mm-&gt;pgd);
</span><span class='line'>&#9;&#9;printk("PGDIR_SHIFT=%u PTRS_PER_PGD=%u pgd_index*8=0x%lx mm-&gt;pgd+index==pgd=%p\n\n", PGDIR_SHIFT, PTRS_PER_PGD, pgd_index(address)*8, pgd);
</span><span class='line'>
</span><span class='line'>&#9;&#9;printk("*pgd=0x%lx *pgd&MASK=0x%lx __va=%p\n", (*pgd).pgd, ((*pgd).pgd)&PTE_PFN_MASK, __va(((*pgd).pgd)&PTE_PFN_MASK));
</span><span class='line'>&#9;&#9;printk("PUD_SHIFT=%u PTRS_PER_PUD=%u pud_index*8=0x%lx __va+index==pud=%p\n\n", PUD_SHIFT, PTRS_PER_PUD, pud_index(address)*8, pud);
</span><span class='line'>
</span><span class='line'>&#9;&#9;printk("*pud=0x%lx *pud&MASK=0x%lx __va=%p\n", (*pud).pud, ((*pud).pud)&PTE_PFN_MASK, __va(((*pud).pud)&PTE_PFN_MASK));
</span><span class='line'>&#9;&#9;printk("PMD_SHIFT=%d PTRS_PER_PMD=%d pmd_index*8=0x%lx __va+index==pmd=%p\n\n", PMD_SHIFT, PTRS_PER_PMD, pmd_index(address)*8, pmd);
</span><span class='line'>
</span><span class='line'>&#9;&#9;printk("*pmd=0x%lx *pmd&MASK=0x%lx __va=%p\n", (*pmd).pmd, ((*pmd).pmd)&PTE_PFN_MASK, __va(((*pmd).pmd)&PTE_PFN_MASK));
</span><span class='line'>&#9;&#9;printk("PAGE_SHIFT=%d PTRS_PER_PTE=%d pte_index*8=0x%lx __va+index==pte=%p\n\n", PAGE_SHIFT, PTRS_PER_PTE, pte_index(address)*8, pte);
</span><span class='line'>
</span><span class='line'>&#9;&#9;printk("*pte=0x%lx *pte&MASK=0x%lx pte_pfn=%lx pfn=%lx\n", (*pte).pte, ((*pte).pte)&PTE_PFN_MASK, (((*pte).pte)&PTE_PFN_MASK)&gt;&gt;PAGE_SHIFT, pfn);
</span><span class='line'>&#9;&#9;printk("vmemmap=%p pfn*sizeof(page)=0x%lx cal_page=%p==follow_page\n\n", vmemmap, pfn*sizeof(struct page), vmemmap+pfn);
</span><span class='line'>&#9;}
</span><span class='line'>&#9;printk("%s\n", ch);
</span><span class='line'>&#9;return 0;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>static void __exit test_exit(void)
</span><span class='line'>{
</span><span class='line'>&#9;printk("test exit\n");
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>module_init(test_init);   
</span><span class='line'>module_exit(test_exit);   
</span><span class='line'>
</span><span class='line'>MODULE_LICENSE("GPL");</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># dmesg
</span><span class='line'>follow_page=ffffea000077a1a8
</span><span class='line'>
</span><span class='line'>PTE_PFN_MASK=0x3ffffffff000 PAGE_OFFSET=ffff880000000000 __va(x)=x+PAGE_OFFSET
</span><span class='line'>
</span><span class='line'>mm-&gt;pgd=ffff88000c952000
</span><span class='line'>PGDIR_SHIFT=39 PTRS_PER_PGD=512 pgd_index*8=0x7f0 mm-&gt;pgd+index==pgd=ffff88000c9527f0
</span><span class='line'>
</span><span class='line'>*pgd=0x30bee067 *pgd&MASK=0x30bee000 __va=ffff880030bee000
</span><span class='line'>PUD_SHIFT=30 PTRS_PER_PUD=512 pud_index*8=0x260 __va+index==pud=ffff880030bee260
</span><span class='line'>
</span><span class='line'>*pud=0x323b1067 *pud&MASK=0x323b1000 __va=ffff8800323b1000
</span><span class='line'>PMD_SHIFT=21 PTRS_PER_PMD=512 pmd_index*8=0xfc0 __va+index==pmd=ffff8800323b1fc0
</span><span class='line'>
</span><span class='line'>*pmd=0xc934067 *pmd&MASK=0xc934000 __va=ffff88000c934000
</span><span class='line'>PAGE_SHIFT=12 PTRS_PER_PTE=512 pte_index*8=0xb18 __va+index==pte=ffff88000c934b18
</span><span class='line'>
</span><span class='line'>*pte=0x80000000222e3047 *pte&MASK=0x222e3000 pte_pfn=222e3 pfn=222e3
</span><span class='line'>vmemmap=ffffea0000000000 pfn*sizeof(page)=0x77a1a8 cal_page=ffffea000077a1a8==follow_page
</span><span class='line'>
</span><span class='line'>ABCDEFGHIJKL1234567890!@#$%^&*()KKKKKKKKKKKKKKKKKKK
</span><span class='line'>test exit</span></code></pre></td></tr></table></div></figure>


<hr />

<h4>dfs all vma, 虚拟地址连续，物理地址不连续</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>...
</span><span class='line'>mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f90fd1e3000
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;linux/module.h&gt;
</span><span class='line'>#include &lt;linux/kernel.h&gt;
</span><span class='line'>#include &lt;linux/init.h&gt; 
</span><span class='line'>#include &lt;linux/types.h&gt;
</span><span class='line'>
</span><span class='line'>#include &lt;linux/sysctl.h&gt;
</span><span class='line'>#include &lt;linux/timer.h&gt;
</span><span class='line'>#include &lt;linux/hardirq.h&gt;
</span><span class='line'>#include &lt;linux/bottom_half.h&gt;
</span><span class='line'>#include &lt;linux/preempt.h&gt;
</span><span class='line'>
</span><span class='line'>#include &lt;linux/types.h&gt;
</span><span class='line'>#include &lt;linux/proc_fs.h&gt;
</span><span class='line'>#include &lt;linux/file.h&gt; 
</span><span class='line'>
</span><span class='line'>#include &lt;linux/kprobes.h&gt;
</span><span class='line'>
</span><span class='line'>#include &lt;linux/mm.h&gt;   
</span><span class='line'>#include &lt;linux/mm_types.h&gt;
</span><span class='line'>
</span><span class='line'>#define N 10000000
</span><span class='line'>char ch[N];
</span><span class='line'>
</span><span class='line'>void dfs(struct rb_node *rb)
</span><span class='line'>{
</span><span class='line'>&#9;struct page *(*follow_page_p)(struct vm_area_struct *vma, unsigned long address, unsigned int flags)
</span><span class='line'>&#9;&#9;= (struct page *(*)(struct vm_area_struct *vma, unsigned long address, unsigned int flags))0xffffffff81133ab0;
</span><span class='line'>&#9;struct vm_area_struct *vma;
</span><span class='line'>&#9;unsigned long start, end, addr = 0x7f90fd1e3000;
</span><span class='line'>&#9;struct page *pa;
</span><span class='line'>&#9;if (!rb)
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>&#9;vma = rb_entry(rb, struct vm_area_struct, vm_rb);
</span><span class='line'>&#9;start = vma-&gt;vm_start;
</span><span class='line'>&#9;end = vma-&gt;vm_end;
</span><span class='line'>&#9;if (addr &gt;= start && addr &lt; end && end-start &lt;= N) {
</span><span class='line'>&#9;&#9;pa = follow_page_p(vma, addr, 0);
</span><span class='line'>&#9;&#9;if (pa) {
</span><span class='line'>&#9;&#9;&#9;memcpy(ch, page_address(pa), 4096);
</span><span class='line'>&#9;&#9;&#9;printk("page=%p ch=%s\n", pa, ch);
</span><span class='line'>&#9;&#9;}
</span><span class='line'>
</span><span class='line'>&#9;&#9;pa = follow_page_p(vma, addr+4096, 0);
</span><span class='line'>&#9;&#9;if (pa) {
</span><span class='line'>&#9;&#9;&#9;memcpy(ch, page_address(pa), 4096);
</span><span class='line'>&#9;&#9;&#9;printk("page=%p ch=%s\n", pa, ch);
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;dfs(rb-&gt;rb_left);
</span><span class='line'>&#9;dfs(rb-&gt;rb_right);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>static int __init test_init(void)
</span><span class='line'>{
</span><span class='line'>&#9;struct mm_struct *mm = (struct mm_struct*)0xffff8800303a3880;
</span><span class='line'>&#9;printk("test start task-&gt;mm=%p\n", mm-&gt;mm_rb.rb_node);
</span><span class='line'>&#9;dfs(mm-&gt;mm_rb.rb_node);
</span><span class='line'>&#9;return 0;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>static void __exit test_exit(void)
</span><span class='line'>{
</span><span class='line'>&#9;printk("test exit\n");
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>module_init(test_init);
</span><span class='line'>module_exit(test_exit);
</span><span class='line'>
</span><span class='line'>MODULE_LICENSE("GPL");</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>test start task-&gt;mm=ffff88002cc05e40
</span><span class='line'>page=ffffea000066e618 ch=ABCDEFGHIJKL1234567890!@#$%^&*()KKKKKKKKKKKKKKKKKKK
</span><span class='line'>page=ffffea000062bec0 ch=AAAAAAAAAAAAAAAAAAABBBBBBBBBBBBCCCCCCCCCCC
</span><span class='line'>test exit</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/4">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/2">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
<h1>Categories</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/language/'>language</a><a href='##' onmousedown=showDiv('language') id='aexp_language'><span class='exp_style' id='exp_language'>[+]</span></a><span class='right_span'>(39)</span></li>
<div id='language' class='catsub'><li><a href='/blog/cats/language~c/?opendiv=language'>c</a><a href='##' onmousedown=showDiv('language~c') id='aexp_language~c'><span class='exp_style' id='exp_language~c'>[+]</span></a><span class='right_span'>22</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~c')) document.getElementById('aexp_language~c').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~java/?opendiv=language'>java</a><a href='##' onmousedown=showDiv('language~java') id='aexp_language~java'><span class='exp_style' id='exp_language~java'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~java')) document.getElementById('aexp_language~java').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~web/?opendiv=language'>web</a><a href='##' onmousedown=showDiv('language~web') id='aexp_language~web'><span class='exp_style' id='exp_language~web'>[+]</span></a><span class='right_span'>6</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('language')) document.getElementById('aexp_language').style.visibility = 'hidden';
if (!document.getElementById('language~web')) document.getElementById('aexp_language~web').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/compiler/'>compiler</a><a href='##' onmousedown=showDiv('compiler') id='aexp_compiler'><span class='exp_style' id='exp_compiler'>[+]</span></a><span class='right_span'>(14)</span></li>
<div id='compiler' class='catsub'><li><a href='/blog/cats/compiler~base/?opendiv=compiler'>base</a><a href='##' onmousedown=showDiv('compiler~base') id='aexp_compiler~base'><span class='exp_style' id='exp_compiler~base'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler~base')) document.getElementById('aexp_compiler~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/compiler~make/?opendiv=compiler'>make</a><a href='##' onmousedown=showDiv('compiler~make') id='aexp_compiler~make'><span class='exp_style' id='exp_compiler~make'>[+]</span></a><span class='right_span'>4</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler')) document.getElementById('aexp_compiler').style.visibility = 'hidden';
if (!document.getElementById('compiler~make')) document.getElementById('aexp_compiler~make').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/assembly/'>assembly</a><a href='##' onmousedown=showDiv('assembly') id='aexp_assembly'><span class='exp_style' id='exp_assembly'>[+]</span></a><span class='right_span'>(15)</span></li>
<div id='assembly' class='catsub'><li><a href='/blog/cats/assembly~arm/?opendiv=assembly'>arm</a><a href='##' onmousedown=showDiv('assembly~arm') id='aexp_assembly~arm'><span class='exp_style' id='exp_assembly~arm'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly~arm')) document.getElementById('aexp_assembly~arm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/assembly~base/?opendiv=assembly'>base</a><a href='##' onmousedown=showDiv('assembly~base') id='aexp_assembly~base'><span class='exp_style' id='exp_assembly~base'>[+]</span></a><span class='right_span'>13</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly')) document.getElementById('aexp_assembly').style.visibility = 'hidden';
if (!document.getElementById('assembly~base')) document.getElementById('aexp_assembly~base').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/tools/'>tools</a><a href='##' onmousedown=showDiv('tools') id='aexp_tools'><span class='exp_style' id='exp_tools'>[+]</span></a><span class='right_span'>(50)</span></li>
<div id='tools' class='catsub'><li><a href='/blog/cats/tools~base/?opendiv=tools'>base</a><a href='##' onmousedown=showDiv('tools~base') id='aexp_tools~base'><span class='exp_style' id='exp_tools~base'>[+]</span></a><span class='right_span'>14</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~base')) document.getElementById('aexp_tools~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ci/?opendiv=tools'>ci</a><a href='##' onmousedown=showDiv('tools~ci') id='aexp_tools~ci'><span class='exp_style' id='exp_tools~ci'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~ci')) document.getElementById('aexp_tools~ci').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~command/?opendiv=tools'>command</a><a href='##' onmousedown=showDiv('tools~command') id='aexp_tools~command'><span class='exp_style' id='exp_tools~command'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~command')) document.getElementById('aexp_tools~command').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~git/?opendiv=tools'>git</a><a href='##' onmousedown=showDiv('tools~git') id='aexp_tools~git'><span class='exp_style' id='exp_tools~git'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~git')) document.getElementById('aexp_tools~git').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~haproxy/?opendiv=tools'>haproxy</a><a href='##' onmousedown=showDiv('tools~haproxy') id='aexp_tools~haproxy'><span class='exp_style' id='exp_tools~haproxy'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~haproxy')) document.getElementById('aexp_tools~haproxy').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~mysql/?opendiv=tools'>mysql</a><a href='##' onmousedown=showDiv('tools~mysql') id='aexp_tools~mysql'><span class='exp_style' id='exp_tools~mysql'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~mysql')) document.getElementById('aexp_tools~mysql').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ssh/?opendiv=tools'>ssh</a><a href='##' onmousedown=showDiv('tools~ssh') id='aexp_tools~ssh'><span class='exp_style' id='exp_tools~ssh'>[+]</span></a><span class='right_span'>3</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('tools')) document.getElementById('aexp_tools').style.visibility = 'hidden';
if (!document.getElementById('tools~ssh')) document.getElementById('aexp_tools~ssh').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/system/'>system</a><a href='##' onmousedown=showDiv('system') id='aexp_system'><span class='exp_style' id='exp_system'>[+]</span></a><span class='right_span'>(51)</span></li>
<div id='system' class='catsub'><li><a href='/blog/cats/system~base/?opendiv=system'>base</a><a href='##' onmousedown=showDiv('system~base') id='aexp_system~base'><span class='exp_style' id='exp_system~base'>[+]</span></a><span class='right_span'>14</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~base')) document.getElementById('aexp_system~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~centos/?opendiv=system'>centos</a><a href='##' onmousedown=showDiv('system~centos') id='aexp_system~centos'><span class='exp_style' id='exp_system~centos'>[+]</span></a><span class='right_span'>8</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~centos')) document.getElementById('aexp_system~centos').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~cgroup/?opendiv=system'>cgroup</a><a href='##' onmousedown=showDiv('system~cgroup') id='aexp_system~cgroup'><span class='exp_style' id='exp_system~cgroup'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~cgroup')) document.getElementById('aexp_system~cgroup').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~kvm/?opendiv=system'>kvm</a><a href='##' onmousedown=showDiv('system~kvm') id='aexp_system~kvm'><span class='exp_style' id='exp_system~kvm'>[+]</span></a><span class='right_span'>7</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~kvm')) document.getElementById('aexp_system~kvm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~namespace/?opendiv=system'>namespace</a><a href='##' onmousedown=showDiv('system~namespace') id='aexp_system~namespace'><span class='exp_style' id='exp_system~namespace'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~namespace')) document.getElementById('aexp_system~namespace').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~ubuntu/?opendiv=system'>ubuntu</a><a href='##' onmousedown=showDiv('system~ubuntu') id='aexp_system~ubuntu'><span class='exp_style' id='exp_system~ubuntu'>[+]</span></a><span class='right_span'>9</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('system')) document.getElementById('aexp_system').style.visibility = 'hidden';
if (!document.getElementById('system~ubuntu')) document.getElementById('aexp_system~ubuntu').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/kernel/'>kernel</a><a href='##' onmousedown=showDiv('kernel') id='aexp_kernel'><span class='exp_style' id='exp_kernel'>[+]</span></a><span class='right_span'>(151)</span></li>
<div id='kernel' class='catsub'><li><a href='/blog/cats/kernel~base/?opendiv=kernel'>base</a><a href='##' onmousedown=showDiv('kernel~base') id='aexp_kernel~base'><span class='exp_style' id='exp_kernel~base'>[+]</span></a><span class='right_span'>18</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~base')) document.getElementById('aexp_kernel~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~fs/?opendiv=kernel'>fs</a><a href='##' onmousedown=showDiv('kernel~fs') id='aexp_kernel~fs'><span class='exp_style' id='exp_kernel~fs'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~fs')) document.getElementById('aexp_kernel~fs').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~irq/?opendiv=kernel'>irq</a><a href='##' onmousedown=showDiv('kernel~irq') id='aexp_kernel~irq'><span class='exp_style' id='exp_kernel~irq'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~irq')) document.getElementById('aexp_kernel~irq').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~kexec/?opendiv=kernel'>kexec</a><a href='##' onmousedown=showDiv('kernel~kexec') id='aexp_kernel~kexec'><span class='exp_style' id='exp_kernel~kexec'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~kexec')) document.getElementById('aexp_kernel~kexec').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~mm/?opendiv=kernel'>mm</a><a href='##' onmousedown=showDiv('kernel~mm') id='aexp_kernel~mm'><span class='exp_style' id='exp_kernel~mm'>[+]</span></a><span class='right_span'>33</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~mm')) document.getElementById('aexp_kernel~mm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~net/?opendiv=kernel'>net</a><a href='##' onmousedown=showDiv('kernel~net') id='aexp_kernel~net'><span class='exp_style' id='exp_kernel~net'>[+]</span></a><span class='right_span'>69</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~net')) document.getElementById('aexp_kernel~net').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~sched/?opendiv=kernel'>sched</a><a href='##' onmousedown=showDiv('kernel~sched') id='aexp_kernel~sched'><span class='exp_style' id='exp_kernel~sched'>[+]</span></a><span class='right_span'>19</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel')) document.getElementById('aexp_kernel').style.visibility = 'hidden';
if (!document.getElementById('kernel~sched')) document.getElementById('aexp_kernel~sched').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/android/'>android</a><a href='##' onmousedown=showDiv('android') id='aexp_android'><span class='exp_style' id='exp_android'>[+]</span></a><span class='right_span'>(20)</span></li>
<div id='android' class='catsub'><li><a href='/blog/cats/android~base/?opendiv=android'>base</a><a href='##' onmousedown=showDiv('android~base') id='aexp_android~base'><span class='exp_style' id='exp_android~base'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~base')) document.getElementById('aexp_android~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~i9507v/?opendiv=android'>i9507v</a><a href='##' onmousedown=showDiv('android~i9507v') id='aexp_android~i9507v'><span class='exp_style' id='exp_android~i9507v'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~i9507v')) document.getElementById('aexp_android~i9507v').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~me722/?opendiv=android'>me722</a><a href='##' onmousedown=showDiv('android~me722') id='aexp_android~me722'><span class='exp_style' id='exp_android~me722'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~me722')) document.getElementById('aexp_android~me722').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~nx403a/?opendiv=android'>nx403a</a><a href='##' onmousedown=showDiv('android~nx403a') id='aexp_android~nx403a'><span class='exp_style' id='exp_android~nx403a'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~nx403a')) document.getElementById('aexp_android~nx403a').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~s5830/?opendiv=android'>s5830</a><a href='##' onmousedown=showDiv('android~s5830') id='aexp_android~s5830'><span class='exp_style' id='exp_android~s5830'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('android')) document.getElementById('aexp_android').style.visibility = 'hidden';
if (!document.getElementById('android~s5830')) document.getElementById('aexp_android~s5830').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/debug/'>debug</a><a href='##' onmousedown=showDiv('debug') id='aexp_debug'><span class='exp_style' id='exp_debug'>[+]</span></a><span class='right_span'>(66)</span></li>
<div id='debug' class='catsub'><li><a href='/blog/cats/debug~base/?opendiv=debug'>base</a><a href='##' onmousedown=showDiv('debug~base') id='aexp_debug~base'><span class='exp_style' id='exp_debug~base'>[+]</span></a><span class='right_span'>16</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~base')) document.getElementById('aexp_debug~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~dwarf/?opendiv=debug'>dwarf</a><a href='##' onmousedown=showDiv('debug~dwarf') id='aexp_debug~dwarf'><span class='exp_style' id='exp_debug~dwarf'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~dwarf')) document.getElementById('aexp_debug~dwarf').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~gdb/?opendiv=debug'>gdb</a><a href='##' onmousedown=showDiv('debug~gdb') id='aexp_debug~gdb'><span class='exp_style' id='exp_debug~gdb'>[+]</span></a><span class='right_span'>8</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~gdb')) document.getElementById('aexp_debug~gdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kdump,-crash/?opendiv=debug'>kdump、crash</a><a href='##' onmousedown=showDiv('debug~kdump、crash') id='aexp_debug~kdump、crash'><span class='exp_style' id='exp_debug~kdump、crash'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kdump、crash')) document.getElementById('aexp_debug~kdump、crash').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kgdb/?opendiv=debug'>kgdb</a><a href='##' onmousedown=showDiv('debug~kgdb') id='aexp_debug~kgdb'><span class='exp_style' id='exp_debug~kgdb'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kgdb')) document.getElementById('aexp_debug~kgdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kprobe/?opendiv=debug'>kprobe</a><a href='##' onmousedown=showDiv('debug~kprobe') id='aexp_debug~kprobe'><span class='exp_style' id='exp_debug~kprobe'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kprobe')) document.getElementById('aexp_debug~kprobe').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~mark/?opendiv=debug'>mark</a><a href='##' onmousedown=showDiv('debug~mark') id='aexp_debug~mark'><span class='exp_style' id='exp_debug~mark'>[+]</span></a><span class='right_span'>16</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~mark')) document.getElementById('aexp_debug~mark').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~perf/?opendiv=debug'>perf</a><a href='##' onmousedown=showDiv('debug~perf') id='aexp_debug~perf'><span class='exp_style' id='exp_debug~perf'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~perf')) document.getElementById('aexp_debug~perf').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~systemtap/?opendiv=debug'>systemtap</a><a href='##' onmousedown=showDiv('debug~systemtap') id='aexp_debug~systemtap'><span class='exp_style' id='exp_debug~systemtap'>[+]</span></a><span class='right_span'>5</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('debug')) document.getElementById('aexp_debug').style.visibility = 'hidden';
if (!document.getElementById('debug~systemtap')) document.getElementById('aexp_debug~systemtap').style.visibility = 'hidden';
</script>
<li><div style="background:#DDD; height:0.3em;"></div></li><li class='catclass'><a href='/blog/cats/algorithm/'>algorithm</a><a href='##' onmousedown=showDiv('algorithm') id='aexp_algorithm'><span class='exp_style' id='exp_algorithm'>[+]</span></a><span class='right_span'>(26)</span></li>
<div id='algorithm' class='catsub'><li><a href='/blog/cats/algorithm~base/?opendiv=algorithm'>base</a><a href='##' onmousedown=showDiv('algorithm~base') id='aexp_algorithm~base'><span class='exp_style' id='exp_algorithm~base'>[+]</span></a><span class='right_span'>19</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~base')) document.getElementById('aexp_algorithm~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~dp/?opendiv=algorithm'>dp</a><a href='##' onmousedown=showDiv('algorithm~dp') id='aexp_algorithm~dp'><span class='exp_style' id='exp_algorithm~dp'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~dp')) document.getElementById('aexp_algorithm~dp').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~ds/?opendiv=algorithm'>ds</a><a href='##' onmousedown=showDiv('algorithm~ds') id='aexp_algorithm~ds'><span class='exp_style' id='exp_algorithm~ds'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~ds')) document.getElementById('aexp_algorithm~ds').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~tc/?opendiv=algorithm'>tc</a><a href='##' onmousedown=showDiv('algorithm~tc') id='aexp_algorithm~tc'><span class='exp_style' id='exp_algorithm~tc'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm')) document.getElementById('aexp_algorithm').style.visibility = 'hidden';
if (!document.getElementById('algorithm~tc')) document.getElementById('aexp_algorithm~tc').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/blog/'>blog</a><a href='##' onmousedown=showDiv('blog') id='aexp_blog'><span class='exp_style' id='exp_blog'>[+]</span></a><span class='right_span'>(11)</span></li>
<div id='blog' class='catsub'><li><a href='/blog/cats/blog~hello/?opendiv=blog'>hello</a><a href='##' onmousedown=showDiv('blog~hello') id='aexp_blog~hello'><span class='exp_style' id='exp_blog~hello'>[+]</span></a><span class='right_span'>1</span></li>
<div id='blog~hello' class='catsub2'><li><a href='/blog/cats/blog~hello~hi/?opendiv=blog~hello'>hi</a><span class='right_span'>1</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~hello')) document.getElementById('aexp_blog~hello').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~jekyll/?opendiv=blog'>jekyll</a><a href='##' onmousedown=showDiv('blog~jekyll') id='aexp_blog~jekyll'><span class='exp_style' id='exp_blog~jekyll'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~jekyll')) document.getElementById('aexp_blog~jekyll').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~markdown/?opendiv=blog'>markdown</a><a href='##' onmousedown=showDiv('blog~markdown') id='aexp_blog~markdown'><span class='exp_style' id='exp_blog~markdown'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~markdown')) document.getElementById('aexp_blog~markdown').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~octopress/?opendiv=blog'>octopress</a><a href='##' onmousedown=showDiv('blog~octopress') id='aexp_blog~octopress'><span class='exp_style' id='exp_blog~octopress'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~octopress')) document.getElementById('aexp_blog~octopress').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~ruby/?opendiv=blog'>ruby</a><a href='##' onmousedown=showDiv('blog~ruby') id='aexp_blog~ruby'><span class='exp_style' id='exp_blog~ruby'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog')) document.getElementById('aexp_blog').style.visibility = 'hidden';
if (!document.getElementById('blog~ruby')) document.getElementById('aexp_blog~ruby').style.visibility = 'hidden';
</script>

</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Date Categories</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/2015/'>2015</a><a href='##' onmousedown=showDiv('2015')><span class='exp_style' id='exp_2015'>[+]</span></a><span class='right_span'>(192)</span></li>
<div id='2015' class='catsub'><li><a href='/blog/cats/2015~09/?opendiv=2015'>2015-09</a><span class='right_span'>18</span></li>
<li><a href='/blog/cats/2015~08/?opendiv=2015'>2015-08</a><span class='right_span'>25</span></li>
<li><a href='/blog/cats/2015~07/?opendiv=2015'>2015-07</a><span class='right_span'>31</span></li>
<li><a href='/blog/cats/2015~06/?opendiv=2015'>2015-06</a><span class='right_span'>24</span></li>
<li><a href='/blog/cats/2015~05/?opendiv=2015'>2015-05</a><span class='right_span'>22</span></li>
<li><a href='/blog/cats/2015~04/?opendiv=2015'>2015-04</a><span class='right_span'>23</span></li>
<li><a href='/blog/cats/2015~03/?opendiv=2015'>2015-03</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2015~02/?opendiv=2015'>2015-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2015~01/?opendiv=2015'>2015-01</a><span class='right_span'>19</span></li>
</div><li class='catclass'><a href='/blog/cats/2014/'>2014</a><a href='##' onmousedown=showDiv('2014')><span class='exp_style' id='exp_2014'>[+]</span></a><span class='right_span'>(112)</span></li>
<div id='2014' class='catsub'><li><a href='/blog/cats/2014~12/?opendiv=2014'>2014-12</a><span class='right_span'>21</span></li>
<li><a href='/blog/cats/2014~11/?opendiv=2014'>2014-11</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2014~10/?opendiv=2014'>2014-10</a><span class='right_span'>13</span></li>
<li><a href='/blog/cats/2014~09/?opendiv=2014'>2014-09</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~08/?opendiv=2014'>2014-08</a><span class='right_span'>15</span></li>
<li><a href='/blog/cats/2014~07/?opendiv=2014'>2014-07</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~06/?opendiv=2014'>2014-06</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2014~05/?opendiv=2014'>2014-05</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~04/?opendiv=2014'>2014-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2014~03/?opendiv=2014'>2014-03</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~02/?opendiv=2014'>2014-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2014~01/?opendiv=2014'>2014-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2013/'>2013</a><a href='##' onmousedown=showDiv('2013')><span class='exp_style' id='exp_2013'>[+]</span></a><span class='right_span'>(60)</span></li>
<div id='2013' class='catsub'><li><a href='/blog/cats/2013~12/?opendiv=2013'>2013-12</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~11/?opendiv=2013'>2013-11</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~10/?opendiv=2013'>2013-10</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~09/?opendiv=2013'>2013-09</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~08/?opendiv=2013'>2013-08</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~07/?opendiv=2013'>2013-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2013~06/?opendiv=2013'>2013-06</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2013~05/?opendiv=2013'>2013-05</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~03/?opendiv=2013'>2013-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2013~02/?opendiv=2013'>2013-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2013~01/?opendiv=2013'>2013-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2012/'>2012</a><a href='##' onmousedown=showDiv('2012')><span class='exp_style' id='exp_2012'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2012' class='catsub'><li><a href='/blog/cats/2012~12/?opendiv=2012'>2012-12</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~11/?opendiv=2012'>2012-11</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~10/?opendiv=2012'>2012-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~08/?opendiv=2012'>2012-08</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2012~05/?opendiv=2012'>2012-05</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~04/?opendiv=2012'>2012-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2012~03/?opendiv=2012'>2012-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2012~02/?opendiv=2012'>2012-02</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2012~01/?opendiv=2012'>2012-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2011/'>2011</a><a href='##' onmousedown=showDiv('2011')><span class='exp_style' id='exp_2011'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2011' class='catsub'><li><a href='/blog/cats/2011~12/?opendiv=2011'>2011-12</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2011~11/?opendiv=2011'>2011-11</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2011~08/?opendiv=2011'>2011-08</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~07/?opendiv=2011'>2011-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~06/?opendiv=2011'>2011-06</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~05/?opendiv=2011'>2011-05</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~04/?opendiv=2011'>2011-04</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~03/?opendiv=2011'>2011-03</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2011~02/?opendiv=2011'>2011-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2011~01/?opendiv=2011'>2011-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2010/'>2010</a><a href='##' onmousedown=showDiv('2010')><span class='exp_style' id='exp_2010'>[+]</span></a><span class='right_span'>(1)</span></li>
<div id='2010' class='catsub'><li><a href='/blog/cats/2010~07/?opendiv=2010'>2010-07</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2009/'>2009</a><a href='##' onmousedown=showDiv('2009')><span class='exp_style' id='exp_2009'>[+]</span></a><span class='right_span'>(8)</span></li>
<div id='2009' class='catsub'><li><a href='/blog/cats/2009~12/?opendiv=2009'>2009-12</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2009~10/?opendiv=2009'>2009-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2009~09/?opendiv=2009'>2009-09</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2009~07/?opendiv=2009'>2009-07</a><span class='right_span'>1</span></li>
</div>
</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Tags</h1>
<ul class="tag-cloud">
<a style="font-size: 131%" href="/tags/gdb/">gdb(6)</a>
<a style="font-size: 100%" href="/tags/hello/">hello(1)</a>
<a style="font-size: 150%" href="/tags/koj/">koj(18)</a>
<a style="font-size: 112%" href="/tags/nvidia/">nvidia(2)</a>
<a style="font-size: 100%" href="/tags/patch/">patch(1)</a>
<a style="font-size: 100%" href="/tags/reg-exp/">reg_exp(1)</a>

</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/09/30/kernel-mm-oom/">kernel 3.10内核源码分析--Out of Memory(OOM)处理流程</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/30/kernel-mm-init/">kernel 3.10内核源码分析--内核页表创建</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/30/kernel-net-keepalive/">TCP的定时器系列 — 保活定时器</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/30/debug-loop_ack/">ack loop</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/30/lang-c-libcurl/">linux c libcurl的简单使用</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub</h1>
  
  <a href="https://github.com/abcdxyzk">abcdxyzk on GitHub</a>
  
</section>

<section>
<h1>Links</h1>
<ul>
	<li>
		<a href=http://hi.baidu.com/abcdxyzk target=_blank>My blog</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/zhangskd target=_blank>zhangsk</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/justlinux2010 target=_blank>justlinux2010</a>
	</li>
	<li>
		<a href=http://simohayha.iteye.com/ target=_blank>simohayha</a>
	</li>
	<li>
		<a href=http://linux.chinaunix.net/techdoc/net/ target=_blank>技术文档</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/cybertan target=_blank>cybertan</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/newnewman80 target=_blank>newnewman80</a>
	</li>
	<li>
		<a href=http://www.cppblog.com/fwxjj/ target=_blank>fwxjj</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/ustc_dylan target=_blank>ustc_dylan</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/nkguohao target=_blank>nkguohao</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/yusiguyuan target=_blank>yusiguyuan</a>
	</li>
	<li>
		<a href=http://www.oenhan.com/ target=_blank>oenhan</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/bullbat target=_blank>bullbat</a>
	</li>
	<li>
		<a href=http://www.wowotech.net/ target=_blank>wowotech</a>
	</li>
	<li>
		<a href=http://www.lenky.info/ target=_blank>lenky</a>
	</li>
	<li>
		<a href=http://smilejay.com/ target=_blank>smilejay</a>
	</li>
	<li>
		<a href=http://blog.chinaunix.net/uid/10167808.html target=_blank>godbach</a>
	</li>
</ul>
</section>

  
<section id="comment_sidebar">
<h1>Recent Comments</h1>

<script type="text/javascript" src="http://abcdxyzk.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=32&excerpt_length=20"></script><a href="http://disqus.com/">Powered by Disqus</a>

</section>


</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - kk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <a title="Top" href="#" id="scroll2top" style="position: fixed; height: 50px; bottom: 30px; right: 25px; cursor: pointer; z-index: 9999; display: block; opacity: 1;"><img src="/images/scrollup.png"></a>
  <script src="/javascripts/scroll2top.js"></script>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253604690'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1253604690' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'abcdxyzk';
      
</script>





</body>
</html>
