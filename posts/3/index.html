
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>kk Blog —— 通用基础</title>

  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="kk Blog —— 通用基础" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/category.js" type="text/javascript"></script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kk Blog —— 通用基础</a></h1>
  
    <h2>cp -rf * .</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
<li>
<form action="/search" method="get">
    <input class="search" name="query" id="query" type="text" placeholder="search...">
    <input id="btnSubmit" value="search" type="submit">
</form>
<script type="text/javascript">
var query = GetRequest("query");
if (query != null) {
	document.getElementById("query").value = query;
}
</script>
</li>
  <li><a href="/atom.xml" rel="subscribe-rss">RSS</a></li>
  
</ul>
  
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/download">Download</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/07/06/centos-vnc/">vnc远程连接，远程登录服务器或者虚拟机</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-06T18:06:00+08:00'><span class='date'>2015-07-06</span> <span class='time'>18:06:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.csdn.net/gg296231363/article/details/6899655">http://blog.csdn.net/gg296231363/article/details/6899655</a></p>

<h3>服务器端</h3>

<p>1 安装</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum install vnc* tigervnc tigervnc-server pixman pixman-devel libXfont</span></code></pre></td></tr></table></div></figure>


<p>2</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vi /etc/sysconfig/vncservers</span></code></pre></td></tr></table></div></figure>


<p>  修改成</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>VNCSERVERS="2:root"
</span><span class='line'>VNCSERVERARGS[2]="-geometry 800x600"</span></code></pre></td></tr></table></div></figure>


<p>3 设置登录密码</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vncpasswd</span></code></pre></td></tr></table></div></figure>


<p>4</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>service vncserver start
</span><span class='line'>service iptables stop</span></code></pre></td></tr></table></div></figure>


<h3>客户机端</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vncviewer IP:PORT</span></code></pre></td></tr></table></div></figure>


<p>centos5 有可能出现的错误</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vncviewer 127.0.0.1:5900
</span><span class='line'>
</span><span class='line'>VNC Viewer Free Edition 4.1.2 for X - built Apr 20 2011 12:04:25
</span><span class='line'>Copyright (C) 2002-2005 RealVNC Ltd.
</span><span class='line'>See http://www.realvnc.com for information on VNC.
</span><span class='line'>
</span><span class='line'>Mon Jul  6 14:16:43 2015
</span><span class='line'> CConn:       connected to host 127.0.0.1 port 5900
</span><span class='line'> CConnection: Server supports RFB protocol version 3.8 
</span><span class='line'> CConnection: Using RFB protocol version 3.8 
</span><span class='line'> TXImage:     Using default colormap and visual, TrueColor, depth 24. 
</span><span class='line'> CConn:       Using pixel format depth 6 (8bpp) rgb222
</span><span class='line'> CConn:       Using ZRLE encoding
</span><span class='line'>
</span><span class='line'>Mon Jul  6 14:16:44 2015
</span><span class='line'> CConn:       Throughput 20000 kbit/s - changing to hextile encoding
</span><span class='line'> CConn:       Throughput 20000 kbit/s - changing to full colour
</span><span class='line'> CConn:       Using pixel format depth 24 (32bpp) little-endian rgb888
</span><span class='line'> CConn:       Using hextile encoding
</span><span class='line'>unknown message type 98
</span><span class='line'> main:        unknown message type</span></code></pre></td></tr></table></div></figure>


<p>加上 -FullColor 选项就好</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vncviewer -FullColor 127.0.0.1:5900</span></code></pre></td></tr></table></div></figure>


<hr />

<h4>不是必需</h4>

<p>5</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vi ~/.vnc/xstartup
</span><span class='line'>gnome-session &   //添加gnome，使用gnome图形界面登录
</span><span class='line'>#twm &            //注销默认的窗口管理器 简陋而且很多图形显示不了
</span><span class='line'>
</span><span class='line'>service vncserver restart</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/07/02/debug-crash-kmem/">crash kmem</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-02T10:29:00+08:00'><span class='date'>2015-07-02</span> <span class='time'>10:29:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>一、kmem -s 查看slab</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>crash&gt; kmem -s
</span><span class='line'>CACHE            NAME                 OBJSIZE  ALLOCATED     TOTAL  SLABS  SSIZE
</span><span class='line'>...
</span><span class='line'>ffff8808132d1ac0 request_sock_TCP         128          2        30      1     4k
</span><span class='line'>ffff8808135e1400 sock_inode_cache         704        298       470     94     4k
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h4>二、kmem -S 查看slab中详细内容</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>crash&gt; kmem -S request_sock_TCP
</span><span class='line'>CACHE            NAME                 OBJSIZE  ALLOCATED     TOTAL  SLABS  SSIZE
</span><span class='line'>ffff8808132d1ac0 request_sock_TCP         128          2        30      1     4k
</span><span class='line'>SLAB              MEMORY            TOTAL  ALLOCATED  FREE
</span><span class='line'>ffff88078b9c6000  ffff88078b9c60c0     30          2    28
</span><span class='line'>FREE / [ALLOCATED]
</span><span class='line'>   ffff88078b9c60c0
</span><span class='line'>   ffff88078b9c6140
</span><span class='line'>   ffff88078b9c61c0
</span><span class='line'>   ffff88078b9c6240
</span><span class='line'>   ffff88078b9c62c0
</span><span class='line'>   ffff88078b9c6340
</span><span class='line'>   ffff88078b9c63c0
</span><span class='line'>   ffff88078b9c6440
</span><span class='line'>   ffff88078b9c64c0
</span><span class='line'>   ffff88078b9c6540
</span><span class='line'>   ffff88078b9c65c0
</span><span class='line'>   ffff88078b9c6640
</span><span class='line'>   ffff88078b9c66c0
</span><span class='line'>  [ffff88078b9c6740]
</span><span class='line'>  [ffff88078b9c67c0]
</span><span class='line'>   ffff88078b9c6840
</span><span class='line'>   ffff88078b9c68c0
</span><span class='line'>   ffff88078b9c6940
</span><span class='line'>   ffff88078b9c69c0
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>request_sock_TCP 是 struct request_sock 类型，所以对于已分配的地址可以直接查看</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>crash&gt; struct request_sock 0xffff88078b9c6740
</span><span class='line'>struct request_sock {
</span><span class='line'>  dl_next = 0x0, 
</span><span class='line'>  mss = 1460, 
</span><span class='line'>  retrans = 0 '\000', 
</span><span class='line'>  cookie_ts = 0 '\000', 
</span><span class='line'>  window_clamp = 8388480, 
</span><span class='line'>  rcv_wnd = 14600, 
</span><span class='line'>  ts_recent = 0, 
</span><span class='line'>  expires = 4302901768, 
</span><span class='line'>  rsk_ops = 0xffffffff81c0e840 &lt;tcp_request_sock_ops&gt;, 
</span><span class='line'>  sk = 0xffff880771dad800, 
</span><span class='line'>  secid = 3039208612, 
</span><span class='line'>  peer_secid = 3672081930
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><a href="http://blog.csdn.net/u011279649/article/details/17529315">http://blog.csdn.net/u011279649/article/details/17529315</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/07/02/kernel-net-info/">查看所有tcp连接</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-02T10:06:00+08:00'><span class='date'>2015-07-02</span> <span class='time'>10:06:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://roclinux.cn/?p=2418">http://roclinux.cn/?p=2418</a></p>

<p><a href="http://blog.csdn.net/justlinux2010/article/details/21028797">http://blog.csdn.net/justlinux2010/article/details/21028797</a></p>

<h4>一、查看连接</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>netstat -an</span></code></pre></td></tr></table></div></figure>


<p>或</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ss</span></code></pre></td></tr></table></div></figure>


<h4>二、查看连接详细信息</h4>

<p>上面的命令也是从<code>/proc/net/tcp</code>和<code>/proc/net/tcp6</code>中读取的</p>

<p>/proc/net/tcp中的内容由tcp4_seq_show()函数打印，该函数中有三种打印形式，我们这里这只列出状态是TCP_SEQ_STATE_LISTENING或TCP_SEQ_STATE_ESTABLISHED的情况，如下所示：</p>

<p><img src="/images/kernel/2015-07-02.png" alt="" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/06/18/android-bootloader/">Android系统典型bootloader分析</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-18T11:23:00+08:00'><span class='date'>2015-06-18</span> <span class='time'>11:23:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://security.tencent.com/index.php/blog/msg/38">http://security.tencent.com/index.php/blog/msg/38</a></p>

<h4>1、bootloader是什么？</h4>

<p>  简单地说，bootloader 就是在操作系统内核运行之前运行的一段小程序。通过这段小程序，我们可以初始化硬件设备、建立内存空间的映射图，从而将系统的软硬件环境带到一个合适的状态，以便为最终调用操作系统内核准备好正确的环境。</p>

<p>  Android系统基于Linux，所以bootloader部分也是与传统的嵌入式设备上运行的Linux没有什么区别。由于除Google外的大部分Android厂商都没有提供bootloader的源代码，所以分析手机设备的bootloader需要使用逆向工程的手段，当然由于有了Google官方的开源bootloader代码做参考，能让分析工作轻松不少。本文中使用的分析工具为IDA 6.5，针对的手机设备为N9006，固件版本为N9006ZCUDMK2。</p>

<h4>2、bootloader典型结构</h4>

<p>  这部分会以高通MSM8960为例子介绍下Bootloader的典型结构。</p>

<p>  高通MSM8960中包含多个运算单元，分别负责引导过程中的不同功能，sbl1的代码负责加载sbl2，sbl2加载tz和sbl3，sbl3加载apppsbl，appsbl加载HLOS。</p>

<p><img src="/images/android/2015-06-18-1.png" alt="" /><br/>
图1 SecureBoot 3.0 的Code Flow</p>

<p><img src="/images/android/2015-06-18-2.png" alt="" /><br/>
图2 MSM8960引导过程简化流程图</p>

<h4>3、Note3的bootloader结构分析</h4>

<p>  国行版Note3（N9006）使用的CPU是MSM8974，它的bootloader结构与典型的MSM8960差不多，最大的区别就是把sbl1,sbl2,sbl3整合进了一个文件sbl1中，TrustZone和APPSBL都由sbl1进行验证和加载，以下为几个主要功能的加载代码分析。</p>

<p>  sbl1的功能是对硬件进行初始化并加载其他模块，需要加载的模块信息按顺序保存在sbl1中，对应每个模块的数据是一段大小为0x64字节的模块信息数据内，sbl1中有一个循环负责验证和加载所有需要的其他模块（tz，rpm，wdt，appsbl），加载代码会根据模块信息内的数据调用不同的加载器加载和验证的代码，具体代码如下图。</p>

<p><img src="/images/android/2015-06-18-3.jpg" alt="" /><br/>
图3 sbl1中循环加载全部模块的代码</p>

<p><img src="/images/android/2015-06-18-4.jpg" alt="" /><br/>
图4 sbl1中对待加载模块进行验证</p>

<p><img src="/images/android/2015-06-18-5.jpg" alt="" /><br/>
图5 TZ模块信息数据</p>

<p><img src="/images/android/2015-06-18-6.jpg" alt="" /><br/>
图6 APPSBL模块信息数据</p>

<p>  固件包里的tz.mbn是加载在TrustZone中的模块，模块格式为elf，这个模块中的代码和系统其他模块代码运行在互相隔离的区域内，权限也比其他模块更高，三星KNOX的很多底层安全特性也是在这部分中实现，关于TrustZone的更多资料可以参考arm官方的说明。</p>

<p>  固件包里的aboot.mbn就是APPSBL模块，模块格式为bin，文件最前面的0x28字节的头部描述了bin的加载地址等信息，后面的数据就是实际加载到内存中的映像，整个bootloader中这个模块的代码量最大（很大一部分是openssl的代码），linux内核的验证和加载（正常启动和Recovery模式），ODIN模式等等代码都包含在这个模块内。</p>

<p><img src="/images/android/2015-06-18-7.jpg" alt="" /><br/>
图7 aboot.mbn文件头</p>

<p><img src="/images/android/2015-06-18-8.jpg" alt="" /><br/>
图8 根据按键和共享内存中的数据确定引导模式</p>

<p><img src="/images/android/2015-06-18-9.jpg" alt="" /><br/>
图9 三星特有的ODIN刷机模式代码</p>

<h4>4、Note3的bootloader中KNOX系统的底层代码初步分析</h4>

<p>  Note3提供了一个企业安全套装KNOX，这个系统包含了底层的Customizable Secure Boot和TrustZone-based Integrity Measurement Architecture(TIMA，目前为2.0版本)，系统层的SecurityEnhancements for Android（SE-Android）和应用层的Samsung KNOX Container，Encrypted File System（EFS），Virtual Private Network（VPN），其中Customizable Secure Boot和TIMA的代码包含在Bootloader的aboot.mbn，tz.mbn，NON-HLOS.bin中，功能为保障加载的内核在加载时和运行期的完整性。</p>

<p>  通过前面的分析，我们已经知道了tz.mbn和aboot.mbn在加载时已经由sbl1验证过完整性，tz.mbn加载后会在CPU的安全环境下运行，从高权限的隔离区域内对系统的完整性进行监控，而负责加载android内核的aboot.mbn中包含对内核的完整性检测，三星在bootloader每一部分的结尾都会加上自己的签名，加载前会对签名进行验证，以保障系统未被修改过。</p>

<p><img src="/images/android/2015-06-18-10.jpg" alt="" /><br/>
图10  tz.mbn中初始化TIMA系统的的代码</p>

<p><img src="/images/android/2015-06-18-11.jpg" alt="" /><br/>
图11 aboot.mbn中对内核是否使用SEANDROID进行验证</p>

<p>  当任何一部分检测代码发现系统异常状况后，就会调用SMC指令通知TrustZone中运行的TIMA系统设置fuse为系统完整性被破坏，此fuse数据一旦被设置后没有办法被重置，系统也无法再次进入KNOX系统。</p>

<p><img src="/images/android/2015-06-18-12.jpg" alt="" /><br/>
图12 加载内核前对内核签名和TIMA的测点进行验证</p>

<p><img src="/images/android/2015-06-18-13.jpg" alt="" /><br/>
图13 系统完整性检测失败后设置fuse值</p>

<p>  当以上所有检测都通过后，bootloader会把内核复制到指定的内存地址并跳到内核的入口继续执行，到此，就进入了系统内核代码的范畴，bootloader的使命也就完成了，跳到linux内核入口的代码见图14。</p>

<p><img src="/images/android/2015-06-18-14.jpg" alt="" /><br/>
图14 内核加载和校验完成后跳到内核的入口点继续执行</p>

<p>  另外，除了这两个模块外Modem固件相关的NON-HLOS.bin中也有大量TIMA系统相关的文件，由于TIMA系统包含大量硬件相关代码（使用三星猎户座CPU的N900中TIMA系统的实现与高通CPU的N9006差别很大），如果需要进行进一步的分析TIMA在modem中的行为，需要对TrustZone，modem工作方式等有更多了解。</p>

<p><img src="/images/android/2015-06-18-15.jpg" alt="" /><br/>
图15 NON-HLOS.bin中包含的大量TIMA相关文件</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/06/18/kernel-net-ipv6-code/">IPV6 实现</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-18T10:44:00+08:00'><span class='date'>2015-06-18</span> <span class='time'>10:44:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.cnblogs.com/super-king/p/ipv6_implement.html">http://www.cnblogs.com/super-king/p/ipv6_implement.html</a></p>

<p>code extract from 2.6.24.
在文件 net/ipv6/af_inet6.c 中包含了ipv6协议初始化的主函数。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int __init inet6_init(void)
</span><span class='line'>{
</span><span class='line'>    struct sk_buff *dummy_skb;
</span><span class='line'>    struct list_head *r;
</span><span class='line'>    int err;
</span><span class='line'>    //inet6_skb_parm必须小于等于skb中的cb
</span><span class='line'>    BUILD_BUG_ON(sizeof(struct inet6_skb_parm) &gt; sizeof(dummy_skb-&gt;cb));
</span><span class='line'>
</span><span class='line'>    //初始化tcpv6_prot结构中的一些与slab相关的字段，然后添加到 proto_list 全局连表
</span><span class='line'>    err = proto_register(&tcpv6_prot, 1);
</span><span class='line'>    if (err)
</span><span class='line'>        goto out;
</span><span class='line'>    //udp协议同上
</span><span class='line'>    err = proto_register(&udpv6_prot, 1);
</span><span class='line'>    if (err)
</span><span class='line'>        goto out_unregister_tcp_proto;
</span><span class='line'>    //udp-lite传输协议，主要用于多媒体传输，参考kernel中的 Documentation/networking/udplite.txt
</span><span class='line'>    err = proto_register(&udplitev6_prot, 1);
</span><span class='line'>    if (err)
</span><span class='line'>        goto out_unregister_udp_proto;
</span><span class='line'>    //原始套接字同上
</span><span class='line'>    err = proto_register(&rawv6_prot, 1);
</span><span class='line'>    if (err)
</span><span class='line'>        goto out_unregister_udplite_proto;
</span><span class='line'>
</span><span class='line'>    /* Register the socket-side information for inet6_create.  */
</span><span class='line'>    for(r = &inetsw6[0]; r &lt; &inetsw6[SOCK_MAX]; ++r) //初始化一个协议连表数组
</span><span class='line'>        INIT_LIST_HEAD(r);
</span><span class='line'>    /* We MUST register RAW sockets before we create the ICMP6, IGMP6, or NDISC control sockets. */
</span><span class='line'>    //根据参数数据结构中标识的协议类型，把这数据结构添加到上面的协议连表数组中
</span><span class='line'>    inet6_register_protosw(&rawv6_protosw);
</span><span class='line'>
</span><span class='line'>    /* Register the family here so that the init calls below will be able to create sockets. (?? is this dangerous ??) */
</span><span class='line'>    //注册ipv6协议族，主要是注册socket创建函数
</span><span class='line'>    err = sock_register(&inet6_family_ops);
</span><span class='line'>    if (err)
</span><span class='line'>        goto out_unregister_raw_proto;
</span><span class='line'>
</span><span class='line'>    /* Initialise ipv6 mibs */
</span><span class='line'>    err = init_ipv6_mibs(); //所有ipv6相关的统计信息
</span><span class='line'>    if (err)
</span><span class='line'>        goto out_unregister_sock;
</span><span class='line'>    /* ipngwg API draft makes clear that the correct semantics for TCP and UDP is to consider one TCP and UDP instance 
</span><span class='line'>     * in a host availiable by both INET and INET6 APIs and able to communicate via both network protocols.
</span><span class='line'>     */
</span><span class='line'>#ifdef CONFIG_SYSCTL
</span><span class='line'>    ipv6_sysctl_register(); // ipv6协议proc条件项初始化
</span><span class='line'>#endif
</span><span class='line'>    //icmp协议注册
</span><span class='line'>    err = icmpv6_init(&inet6_family_ops);
</span><span class='line'>    if (err)
</span><span class='line'>        goto icmp_fail;
</span><span class='line'>    //邻居协议（arp）初始化       
</span><span class='line'>    err = ndisc_init(&inet6_family_ops);
</span><span class='line'>    if (err)
</span><span class='line'>        goto ndisc_fail;
</span><span class='line'>    //igmp协议初始化       
</span><span class='line'>    err = igmp6_init(&inet6_family_ops);
</span><span class='line'>    if (err)
</span><span class='line'>        goto igmp_fail;
</span><span class='line'>    //ipv6协议相关的 netfilter 初始化     
</span><span class='line'>    err = ipv6_netfilter_init();
</span><span class='line'>    if (err)
</span><span class='line'>        goto netfilter_fail;
</span><span class='line'>
</span><span class='line'>    /* Create /proc/foo6 entries. */
</span><span class='line'>#ifdef CONFIG_PROC_FS //注册/proc/中协议统计输出项
</span><span class='line'>    err = -ENOMEM;
</span><span class='line'>    if (raw6_proc_init())
</span><span class='line'>        goto proc_raw6_fail;
</span><span class='line'>    if (tcp6_proc_init())
</span><span class='line'>        goto proc_tcp6_fail;
</span><span class='line'>    if (udp6_proc_init())
</span><span class='line'>        goto proc_udp6_fail;
</span><span class='line'>    if (udplite6_proc_init())
</span><span class='line'>        goto proc_udplite6_fail;
</span><span class='line'>    if (ipv6_misc_proc_init())
</span><span class='line'>        goto proc_misc6_fail;
</span><span class='line'>    if (ac6_proc_init())
</span><span class='line'>        goto proc_anycast6_fail;
</span><span class='line'>    if (if6_proc_init())
</span><span class='line'>        goto proc_if6_fail;
</span><span class='line'>#endif
</span><span class='line'>    ip6_route_init(); //ipv6 路由初始化
</span><span class='line'>    ip6_flowlabel_init();//ipv6 中流标记，注册了输出流标记的 proc
</span><span class='line'>
</span><span class='line'>    //rtnetlink相关部分和路由模板中一些字段和其他一些功能的初始化
</span><span class='line'>    err = addrconf_init();
</span><span class='line'>    if (err)
</span><span class='line'>        goto addrconf_fail;
</span><span class='line'>    /* Init v6 extension headers. */
</span><span class='line'>    //ipv6 新添加的扩展头初始化，参考ipv6介绍
</span><span class='line'>    ipv6_rthdr_init();
</span><span class='line'>    ipv6_frag_init();
</span><span class='line'>    ipv6_nodata_init();
</span><span class='line'>    ipv6_destopt_init();
</span><span class='line'>
</span><span class='line'>    /* Init v6 transport protocols. */
</span><span class='line'>    //最主要的传输层协议初始化
</span><span class='line'>    udpv6_init();
</span><span class='line'>    udplitev6_init();
</span><span class='line'>    tcpv6_init();
</span><span class='line'>
</span><span class='line'>    //最后注册ipv6协议，注册协议处理函数
</span><span class='line'>    ipv6_packet_init();
</span><span class='line'>    err = 0;
</span><span class='line'>out:
</span><span class='line'>    return err;
</span><span class='line'>    ...... //下面就是错误处理的过程
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>下面我们主要看ipv6协议部分流程，其他部分在各自相关文章中介绍。</p>

<p>ipv6扩展头，路由包头注册</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void __init ipv6_rthdr_init(void)
</span><span class='line'>{
</span><span class='line'>    if (inet6_add_protocol(&rthdr_protocol, IPPROTO_ROUTING) &lt; 0)
</span><span class='line'>        printk(KERN_ERR "ipv6_rthdr_init: Could not register protocol\n");
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>ipv6扩展头，分片包头注册</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void __init ipv6_frag_init(void)
</span><span class='line'>{
</span><span class='line'>    if (inet6_add_protocol(&frag_protocol, IPPROTO_FRAGMENT) &lt; 0)
</span><span class='line'>        printk(KERN_ERR "ipv6_frag_init: Could not register protocol\n");
</span><span class='line'>
</span><span class='line'>    ip6_frags.ctl = &ip6_frags_ctl;
</span><span class='line'>    ip6_frags.hashfn = ip6_hashfn;
</span><span class='line'>    ip6_frags.constructor = ip6_frag_init;
</span><span class='line'>    ip6_frags.destructor = NULL;
</span><span class='line'>    ip6_frags.skb_free = NULL;
</span><span class='line'>    ip6_frags.qsize = sizeof(struct frag_queue);
</span><span class='line'>    ip6_frags.match = ip6_frag_match;
</span><span class='line'>    ip6_frags.frag_expire = ip6_frag_expire;
</span><span class='line'>    inet_frags_init(&ip6_frags);
</span><span class='line'>}
</span><span class='line'>void __init ipv6_nodata_init(void)
</span><span class='line'>{
</span><span class='line'>    if (inet6_add_protocol(&nodata_protocol, IPPROTO_NONE) &lt; 0)
</span><span class='line'>        printk(KERN_ERR "ipv6_nodata_init: Could not register protocol\n");
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ipv6扩展头，目的选项包头注册</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void __init ipv6_destopt_init(void)
</span><span class='line'>{
</span><span class='line'>    if (inet6_add_protocol(&destopt_protocol, IPPROTO_DSTOPTS) &lt; 0)
</span><span class='line'>        printk(KERN_ERR "ipv6_destopt_init: Could not register protocol\n");
</span><span class='line'>}
</span><span class='line'>    注册ipv6协议处理函数
</span><span class='line'>void __init ipv6_packet_init(void)
</span><span class='line'>{
</span><span class='line'>    dev_add_pack(&ipv6_packet_type);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>当netif_receive_skb函数向上层递交skb时会根据协议类型调用相关的协议处理函数，那么就会调用到 ipv6_rcv函数了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct packet_type ipv6_packet_type = {
</span><span class='line'>    .type = __constant_htons(ETH_P_IPV6),
</span><span class='line'>    .func = ipv6_rcv,
</span><span class='line'>    .gso_send_check = ipv6_gso_send_check,
</span><span class='line'>    .gso_segment = ipv6_gso_segment,
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>ipv6协议处理函数</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int ipv6_rcv(struct sk_buff *skb, struct net_device *dev, struct packet_type *pt, struct net_device *orig_dev)
</span><span class='line'>{
</span><span class='line'>    struct ipv6hdr *hdr;
</span><span class='line'>    u32             pkt_len;
</span><span class='line'>    struct inet6_dev *idev;
</span><span class='line'>
</span><span class='line'>    if (dev-&gt;nd_net != &init_net) {
</span><span class='line'>        kfree_skb(skb);
</span><span class='line'>        return 0;
</span><span class='line'>    }
</span><span class='line'>    //mac地址是其他主机的包
</span><span class='line'>    if (skb-&gt;pkt_type == PACKET_OTHERHOST) {
</span><span class='line'>        kfree_skb(skb);
</span><span class='line'>        return 0;
</span><span class='line'>    }
</span><span class='line'>    rcu_read_lock();
</span><span class='line'>    //获取ipv6相关的配置结构
</span><span class='line'>    idev = __in6_dev_get(skb-&gt;dev);
</span><span class='line'>
</span><span class='line'>    IP6_INC_STATS_BH(idev, IPSTATS_MIB_INRECEIVES);
</span><span class='line'>    //是否共享，如果是，新clone一个
</span><span class='line'>    if ((skb = skb_share_check(skb, GFP_ATOMIC)) == NULL) {
</span><span class='line'>        IP6_INC_STATS_BH(idev, IPSTATS_MIB_INDISCARDS);
</span><span class='line'>        rcu_read_unlock();
</span><span class='line'>        goto out;
</span><span class='line'>    }
</span><span class='line'>    //清空保存扩展头解析结果的数据结构
</span><span class='line'>    memset(IP6CB(skb), 0, sizeof(struct inet6_skb_parm));
</span><span class='line'>
</span><span class='line'>    //保存接收这个数据包的设备索引
</span><span class='line'>    IP6CB(skb)-&gt;iif = skb-&gt;dst ? ip6_dst_idev(skb-&gt;dst)-&gt;dev-&gt;ifindex : dev-&gt;ifindex;
</span><span class='line'>
</span><span class='line'>    //有足够的头长度，ipv6是40字节
</span><span class='line'>    if (unlikely(!pskb_may_pull(skb, sizeof(*hdr))))
</span><span class='line'>        goto err;
</span><span class='line'>
</span><span class='line'>    hdr = ipv6_hdr(skb); //获取头
</span><span class='line'>
</span><span class='line'>    if (hdr-&gt;version != 6) //验证版本
</span><span class='line'>        goto err;
</span><span class='line'>
</span><span class='line'>    //传输头（扩展头）在网络头后面
</span><span class='line'>    skb-&gt;transport_header = skb-&gt;network_header + sizeof(*hdr);
</span><span class='line'>    //保存下一个扩展头协议在ipv6头结构中的偏移
</span><span class='line'>    IP6CB(skb)-&gt;nhoff = offsetof(struct ipv6hdr, nexthdr);
</span><span class='line'>    pkt_len = ntohs(hdr-&gt;payload_len); //ipv6负载数据长度
</span><span class='line'>
</span><span class='line'>    /* pkt_len may be zero if Jumbo payload option is present */
</span><span class='line'>    if (pkt_len || hdr-&gt;nexthdr != NEXTHDR_HOP) { //没有使用扩展头逐个跳段选项
</span><span class='line'>        if (pkt_len + sizeof(struct ipv6hdr) &gt; skb-&gt;len) { //数据长度不对
</span><span class='line'>            IP6_INC_STATS_BH(idev, IPSTATS_MIB_INTRUNCATEDPKTS);
</span><span class='line'>            goto drop;
</span><span class='line'>        }
</span><span class='line'>        //如果skb-&gt;len &gt; (pkt_len + sizeof(struct ipv6hdr))试着缩小skb-&gt;len的长度
</span><span class='line'>        //相对ipv4来说简单多了，自己看吧
</span><span class='line'>        if (pskb_trim_rcsum(skb, pkt_len + sizeof(struct ipv6hdr))) {
</span><span class='line'>            IP6_INC_STATS_BH(idev, IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>            goto drop;
</span><span class='line'>        }
</span><span class='line'>        hdr = ipv6_hdr(skb); //重新获取ip头
</span><span class='line'>    }
</span><span class='line'>    if (hdr-&gt;nexthdr == NEXTHDR_HOP) { //使用了扩展头逐个跳段选项
</span><span class='line'>        if (ipv6_parse_hopopts(skb) &lt; 0) {//处理这个选项
</span><span class='line'>            IP6_INC_STATS_BH(idev, IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>            rcu_read_unlock();
</span><span class='line'>            return 0;
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    rcu_read_unlock();
</span><span class='line'>    //进入ipv6的netfilter然后调用ip6_rcv_finish
</span><span class='line'>    return NF_HOOK(PF_INET6,NF_IP6_PRE_ROUTING, skb, dev, NULL, ip6_rcv_finish);
</span><span class='line'>err:
</span><span class='line'>    IP6_INC_STATS_BH(idev, IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>drop:
</span><span class='line'>    rcu_read_unlock();
</span><span class='line'>    kfree_skb(skb);
</span><span class='line'>out:
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>解析扩展头逐个跳段中的巨量负载选项</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int ipv6_parse_hopopts(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>    struct inet6_skb_parm *opt = IP6CB(skb); //获取扩展头结果结构
</span><span class='line'>    /* skb_network_header(skb) is equal to skb-&gt;data, and skb_network_header_len(skb) is always equal to
</span><span class='line'>     * sizeof(struct ipv6hdr) by definition of hop-by-hop options.
</span><span class='line'>     */
</span><span class='line'>    //验证数据有足够的长度
</span><span class='line'>    if (!pskb_may_pull(skb, sizeof(struct ipv6hdr) + 8) || !pskb_may_pull(skb, (sizeof(struct ipv6hdr) +
</span><span class='line'>                    //下面的意思是取得扩展首部中的长度
</span><span class='line'>                    ((skb_transport_header(skb)[1] + 1) &lt;&lt; 3)))) {
</span><span class='line'>        kfree_skb(skb);
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>    opt-&gt;hop = sizeof(struct ipv6hdr); //40字节
</span><span class='line'>    if (ip6_parse_tlv(tlvprochopopt_lst, skb)) { //实际的解析工作
</span><span class='line'>        //把传输头移动到扩展首部之后
</span><span class='line'>        skb-&gt;transport_header += (skb_transport_header(skb)[1] + 1) &lt;&lt; 3;
</span><span class='line'>        opt = IP6CB(skb);
</span><span class='line'>        opt-&gt;nhoff = sizeof(struct ipv6hdr); //进行了ipv6扩展头解析，保存下一个扩展头协议字段的偏移
</span><span class='line'>        return 1;
</span><span class='line'>    }
</span><span class='line'>    return -1;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>解析tlv编码的扩展选项头</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int ip6_parse_tlv(struct tlvtype_proc *procs, struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>    struct tlvtype_proc *curr;
</span><span class='line'>    const unsigned char *nh = skb_network_header(skb); //获取网络头
</span><span class='line'>    int off = skb_network_header_len(skb); //获取网络头长度
</span><span class='line'>    int len = (skb_transport_header(skb)[1] + 1) &lt;&lt; 3; //首部扩展头长度
</span><span class='line'>
</span><span class='line'>    if (skb_transport_offset(skb) + len &gt; skb_headlen(skb)) //长度错误
</span><span class='line'>        goto bad;
</span><span class='line'>    off += 2; //跳过下一个首部和首部扩展长度这两个字节
</span><span class='line'>    len -= 2;
</span><span class='line'>
</span><span class='line'>    while (len &gt; 0) {
</span><span class='line'>        int optlen = nh[off + 1] + 2; //获取选项数据长度 + 2 (2是选项类型和选项数据长度两字节)
</span><span class='line'>        switch (nh[off]) { //选项类型
</span><span class='line'>            case IPV6_TLV_PAD0: //Pad1选项
</span><span class='line'>                optlen = 1;
</span><span class='line'>                break;
</span><span class='line'>            case IPV6_TLV_PADN://PadN选项
</span><span class='line'>                break;
</span><span class='line'>            default: //其他选项
</span><span class='line'>                if (optlen &gt; len)
</span><span class='line'>                    goto bad;
</span><span class='line'>
</span><span class='line'>                for (curr = procs; curr-&gt;type &gt;= 0; curr++) {
</span><span class='line'>                    if (curr-&gt;type == nh[off]) { //类型匹配，调用参数函数处理，参考下面ipv6选项处理
</span><span class='line'>                        /* type specific length/alignment checks will be performed in the func(). */
</span><span class='line'>                        if (curr-&gt;func(skb, off) == 0)
</span><span class='line'>                            return 0;
</span><span class='line'>                        break;
</span><span class='line'>                    }
</span><span class='line'>                }
</span><span class='line'>                if (curr-&gt;type &lt; 0) {
</span><span class='line'>                    if (ip6_tlvopt_unknown(skb, off) == 0) //处理未知选项
</span><span class='line'>                        return 0;
</span><span class='line'>                }
</span><span class='line'>                break;
</span><span class='line'>        }
</span><span class='line'>        off += optlen; //偏移增加，这样到下一个选项
</span><span class='line'>        len -= optlen; //长度递减
</span><span class='line'>    }
</span><span class='line'>    if (len == 0)
</span><span class='line'>        return 1; //正确解析完毕
</span><span class='line'>bad:
</span><span class='line'>    kfree_skb(skb);
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>处理未知的选项</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int ip6_tlvopt_unknown(struct sk_buff *skb, int optoff)
</span><span class='line'>{
</span><span class='line'>    //根据选项类型标识符的要求进行处理
</span><span class='line'>    switch ((skb_network_header(skb)[optoff] & 0xC0) &gt;&gt; 6) {
</span><span class='line'>        case 0: /* ignore */
</span><span class='line'>            return 1;
</span><span class='line'>        case 1: /* drop packet */
</span><span class='line'>            break;
</span><span class='line'>        case 3: /* Send ICMP if not a multicast address and drop packet */
</span><span class='line'>            /* Actually, it is redundant check. icmp_send will recheck in any case. */
</span><span class='line'>            if (ipv6_addr_is_multicast(&ipv6_hdr(skb)-&gt;daddr)) //目的是多播地址
</span><span class='line'>                break;
</span><span class='line'>        case 2: /* send ICMP PARM PROB regardless and drop packet */
</span><span class='line'>            //给包的源地址发送一个 ICMP "参数存在问题", 编码 2 的报文, 指针指向无法识别的选项类型
</span><span class='line'>            icmpv6_param_prob(skb, ICMPV6_UNK_OPTION, optoff);
</span><span class='line'>            return 0;
</span><span class='line'>    }
</span><span class='line'>    kfree_skb(skb);
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>到这需要解释一下，上面解析ipv6选项只是解析了第一层的扩展头，在后面可能还有其他扩展头会在后面解析。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>inline int ip6_rcv_finish( struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>    if (skb-&gt;dst == NULL) //没有路由，进行路由查找
</span><span class='line'>        ip6_route_input(skb); //路由部分将在路由实现文章中介绍
</span><span class='line'>
</span><span class='line'>    return dst_input(skb);
</span><span class='line'>}
</span><span class='line'>static inline int dst_input(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>    int err;
</span><span class='line'>    for (;;) {
</span><span class='line'>        err = skb-&gt;dst-&gt;input(skb); //调用路由的输入函数
</span><span class='line'>        if (likely(err == 0))
</span><span class='line'>            return err;
</span><span class='line'>
</span><span class='line'>        /* Oh, Jamal... Seems, I will not forgive you this mess. :-) */
</span><span class='line'>        if (unlikely(err != NET_XMIT_BYPASS))
</span><span class='line'>            return err;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>现在我们假设包是到本地的，那么上面的input函数就是</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int ip6_input(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>    //进入ipv6 netfilter NF_IP6_LOCAL_IN hook 然后调用 ip6_input_finish
</span><span class='line'>    return NF_HOOK(PF_INET6, NF_IP6_LOCAL_IN, skb, skb-&gt;dev, NULL, ip6_input_finish);
</span><span class='line'>}
</span><span class='line'>static int ip6_input_finish(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>    struct inet6_protocol *ipprot;
</span><span class='line'>    struct sock *raw_sk;
</span><span class='line'>    unsigned int nhoff;
</span><span class='line'>    int nexthdr;
</span><span class='line'>    u8 hash;
</span><span class='line'>    struct inet6_dev *idev;
</span><span class='line'>
</span><span class='line'>    /* Parse extension headers */
</span><span class='line'>    rcu_read_lock();
</span><span class='line'>resubmit:
</span><span class='line'>    idev = ip6_dst_idev(skb-&gt;dst);
</span><span class='line'>    //将skb-&gt;data指针移动到传输层头
</span><span class='line'>    if (!pskb_pull(skb, skb_transport_offset(skb)))
</span><span class='line'>        goto discard;
</span><span class='line'>
</span><span class='line'>    nhoff = IP6CB(skb)-&gt;nhoff;
</span><span class='line'>    nexthdr = skb_network_header(skb)[nhoff];//下一个扩展头协议
</span><span class='line'>
</span><span class='line'>    //处理原始sock
</span><span class='line'>    raw_sk = sk_head(&raw_v6_htable[nexthdr & (MAX_INET_PROTOS - 1)]);
</span><span class='line'>    if (raw_sk && !ipv6_raw_deliver(skb, nexthdr))
</span><span class='line'>        raw_sk = NULL;
</span><span class='line'>
</span><span class='line'>    //向上层协议栈递交数据，看初始化时注册的一些协议，主要是tcp，udp等，还包括一些ip扩展头的处理
</span><span class='line'>    hash = nexthdr & (MAX_INET_PROTOS - 1);
</span><span class='line'>    if ((ipprot = rcu_dereference(inet6_protos[hash])) != NULL) {
</span><span class='line'>        int ret;
</span><span class='line'>        if (ipprot-&gt;flags & INET6_PROTO_FINAL) {
</span><span class='line'>            struct ipv6hdr *hdr;
</span><span class='line'>            /* Free reference early: we don't need it any more,                        
</span><span class='line'>               and it may hold ip_conntrack module loaded indefinitely. */
</span><span class='line'>            nf_reset(skb);
</span><span class='line'>
</span><span class='line'>            skb_postpull_rcsum(skb, skb_network_header(skb), skb_network_header_len(skb));
</span><span class='line'>            hdr = ipv6_hdr(skb);
</span><span class='line'>            if (ipv6_addr_is_multicast(&hdr-&gt;daddr) && !ipv6_chk_mcast_addr(skb-&gt;dev, &hdr-&gt;daddr, &hdr-&gt;saddr)
</span><span class='line'>                    && !ipv6_is_mld(skb, nexthdr))
</span><span class='line'>                goto discard;
</span><span class='line'>        }
</span><span class='line'>        //处理 IPSEC v6 的相关部分
</span><span class='line'>        if (!(ipprot-&gt;flags & INET6_PROTO_NOPOLICY) && !xfrm6_policy_check(NULL, XFRM_POLICY_IN, skb))
</span><span class='line'>            goto discard;
</span><span class='line'>
</span><span class='line'>        ret = ipprot-&gt;handler(skb); //上层协议处理，看下面ipv6扩展头处理
</span><span class='line'>        if (ret &gt; 0)
</span><span class='line'>            goto resubmit; //重新处理
</span><span class='line'>        else if (ret == 0)
</span><span class='line'>            IP6_INC_STATS_BH(idev, IPSTATS_MIB_INDELIVERS);
</span><span class='line'>    } else { //没有找到上层处理函数
</span><span class='line'>        if (!raw_sk) {
</span><span class='line'>            if (xfrm6_policy_check(NULL, XFRM_POLICY_IN, skb)) {
</span><span class='line'>                IP6_INC_STATS_BH(idev, IPSTATS_MIB_INUNKNOWNPROTOS);
</span><span class='line'>                icmpv6_send(skb, ICMPV6_PARAMPROB, ICMPV6_UNK_NEXTHDR, nhoff, skb-&gt;dev);
</span><span class='line'>            }
</span><span class='line'>        } else
</span><span class='line'>            IP6_INC_STATS_BH(idev, IPSTATS_MIB_INDELIVERS);
</span><span class='line'>        kfree_skb(skb);
</span><span class='line'>    }
</span><span class='line'>    rcu_read_unlock();
</span><span class='line'>    return 0;
</span><span class='line'>discard:
</span><span class='line'>    IP6_INC_STATS_BH(idev, IPSTATS_MIB_INDISCARDS);
</span><span class='line'>    rcu_read_unlock();
</span><span class='line'>    kfree_skb(skb);
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>ipv6选项处理</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct tlvtype_proc tlvprochopopt_lst[] = {
</span><span class='line'>    {
</span><span class='line'>        .type   = IPV6_TLV_ROUTERALERT,
</span><span class='line'>        .func   = ipv6_hop_ra,
</span><span class='line'>    },
</span><span class='line'>    {
</span><span class='line'>        .type   = IPV6_TLV_JUMBO,
</span><span class='line'>        .func   = ipv6_hop_jumbo,
</span><span class='line'>    },
</span><span class='line'>    { -1, }
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>解析路由警告选项</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int ipv6_hop_ra(struct sk_buff *skb, int optoff)
</span><span class='line'>{
</span><span class='line'>    const unsigned char *nh = skb_network_header(skb); //获取网络头
</span><span class='line'>
</span><span class='line'>    if (nh[optoff + 1] == 2) { //路由警告选项长度必须是2 ? rfc 要求是 4
</span><span class='line'>        IP6CB(skb)-&gt;ra = optoff; //记录警告类型
</span><span class='line'>        return 1;
</span><span class='line'>    }
</span><span class='line'>    LIMIT_NETDEBUG(KERN_DEBUG "ipv6_hop_ra: wrong RA length %d\n", nh[optoff + 1]);
</span><span class='line'>    kfree_skb(skb);
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>解析jumbo frame选项</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int ipv6_hop_jumbo(struct sk_buff *skb, int optoff)
</span><span class='line'>{
</span><span class='line'>    const unsigned char *nh = skb_network_header(skb);
</span><span class='line'>    u32 pkt_len;
</span><span class='line'>    //选项数据长度必须是4，选项类型必须是 0xc2， ＆3 后必须是2
</span><span class='line'>    if (nh[optoff + 1] != 4 || (optoff & 3) != 2) {
</span><span class='line'>        LIMIT_NETDEBUG(KERN_DEBUG "ipv6_hop_jumbo: wrong jumbo opt length/alignment %d\n", nh[optoff+1]);
</span><span class='line'>        IP6_INC_STATS_BH(ipv6_skb_idev(skb), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>        goto drop;
</span><span class='line'>    }
</span><span class='line'>    pkt_len = ntohl(*(__be32 *)(nh + optoff + 2)); //获取整个负载长度
</span><span class='line'>    if (pkt_len &lt;= IPV6_MAXPLEN) { //小于65535 是不对地
</span><span class='line'>        IP6_INC_STATS_BH(ipv6_skb_idev(skb), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>        icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, optoff+2);
</span><span class='line'>        return 0;
</span><span class='line'>    }
</span><span class='line'>    if (ipv6_hdr(skb)-&gt;payload_len) { //原ipv6头中就不应该有负载长度了
</span><span class='line'>        IP6_INC_STATS_BH(ipv6_skb_idev(skb), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>        icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, optoff);
</span><span class='line'>        return 0;
</span><span class='line'>    }
</span><span class='line'>    if (pkt_len &gt; skb-&gt;len - sizeof(struct ipv6hdr)) { //长度超出了 skb 的实际长度
</span><span class='line'>        IP6_INC_STATS_BH(ipv6_skb_idev(skb), IPSTATS_MIB_INTRUNCATEDPKTS);
</span><span class='line'>        goto drop;
</span><span class='line'>    }
</span><span class='line'>    //如果必要试图缩减 skb 的长度
</span><span class='line'>    if (pskb_trim_rcsum(skb, pkt_len + sizeof(struct ipv6hdr)))
</span><span class='line'>        goto drop;
</span><span class='line'>
</span><span class='line'>    return 1;
</span><span class='line'>drop:
</span><span class='line'>    kfree_skb(skb);
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>目的选项处理</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct tlvtype_proc tlvprocdestopt_lst[] = {
</span><span class='line'>#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)
</span><span class='line'>    {
</span><span class='line'>        .type   = IPV6_TLV_HAO,
</span><span class='line'>        .func   = ipv6_dest_hao,
</span><span class='line'>    },
</span><span class='line'>#endif
</span><span class='line'>    {-1,    NULL}
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>解析目的选项</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int ipv6_dest_hao(struct sk_buff *skb, int optoff)
</span><span class='line'>{
</span><span class='line'>    struct ipv6_destopt_hao *hao;
</span><span class='line'>    struct inet6_skb_parm *opt = IP6CB(skb);
</span><span class='line'>    struct ipv6hdr *ipv6h = ipv6_hdr(skb);
</span><span class='line'>    struct in6_addr tmp_addr;
</span><span class='line'>    int ret;
</span><span class='line'>
</span><span class='line'>    if (opt-&gt;dsthao) { //已经处理
</span><span class='line'>        LIMIT_NETDEBUG(KERN_DEBUG "hao duplicated\n");
</span><span class='line'>        goto discard;
</span><span class='line'>    }
</span><span class='line'>    opt-&gt;dsthao = opt-&gt;dst1;
</span><span class='line'>    opt-&gt;dst1 = 0;
</span><span class='line'>
</span><span class='line'>    //获取网络头后面的选项部分
</span><span class='line'>    hao = (struct ipv6_destopt_hao *)(skb_network_header(skb) + optoff);
</span><span class='line'>
</span><span class='line'>    if (hao-&gt;length != 16) { //长度要求
</span><span class='line'>        LIMIT_NETDEBUG(KERN_DEBUG "hao invalid option length = %d\n", hao-&gt;length);
</span><span class='line'>        goto discard;
</span><span class='line'>    }
</span><span class='line'>    if (!(ipv6_addr_type(&hao-&gt;addr) & IPV6_ADDR_UNICAST)) { //地址不是单播
</span><span class='line'>        LIMIT_NETDEBUG(KERN_DEBUG "hao is not an unicast addr: " NIP6_FMT "\n", NIP6(hao-&gt;addr));
</span><span class='line'>        goto discard;
</span><span class='line'>    }
</span><span class='line'>    //IPSEC相关
</span><span class='line'>    ret = xfrm6_input_addr(skb, (xfrm_address_t *)&ipv6h-&gt;daddr, (xfrm_address_t *)&hao-&gt;addr, IPPROTO_DSTOPTS);
</span><span class='line'>    if (unlikely(ret &lt; 0))
</span><span class='line'>        goto discard;
</span><span class='line'>
</span><span class='line'>    if (skb_cloned(skb)) { //如果包是cloned
</span><span class='line'>        //分配新的内存数据
</span><span class='line'>        if (pskb_expand_head(skb, 0, 0, GFP_ATOMIC))
</span><span class='line'>            goto discard;
</span><span class='line'>
</span><span class='line'>        //重新指向各头
</span><span class='line'>        hao = (struct ipv6_destopt_hao *)(skb_network_header(skb) + optoff);
</span><span class='line'>        ipv6h = ipv6_hdr(skb);
</span><span class='line'>    }
</span><span class='line'>    if (skb-&gt;ip_summed == CHECKSUM_COMPLETE)
</span><span class='line'>        skb-&gt;ip_summed = CHECKSUM_NONE;
</span><span class='line'>
</span><span class='line'>    //把ip头中的源地址与选项中的地址交换
</span><span class='line'>    ipv6_addr_copy(&tmp_addr, &ipv6h-&gt;saddr);
</span><span class='line'>    ipv6_addr_copy(&ipv6h-&gt;saddr, &hao-&gt;addr);
</span><span class='line'>    ipv6_addr_copy(&hao-&gt;addr, &tmp_addr);
</span><span class='line'>
</span><span class='line'>    if (skb-&gt;tstamp.tv64 == 0)
</span><span class='line'>        __net_timestamp(skb); //记录时间截
</span><span class='line'>
</span><span class='line'>    return 1;
</span><span class='line'>discard:
</span><span class='line'>    kfree_skb(skb);
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>ipv6扩展头处理</h4>

<p>我们只介绍根ipv6扩展头相关的实现，像其他的扩展头(tcp, udp)等虽然也是叫扩展头但实际是传输层的内容，将在其他文章中介绍。</p>

<p>路由扩展首部</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct ipv6_rt_hdr {
</span><span class='line'>    __u8            nexthdr;
</span><span class='line'>    __u8            hdrlen;
</span><span class='line'>    __u8            type;
</span><span class='line'>    __u8            segments_left;
</span><span class='line'>
</span><span class='line'>    /* type specific data variable length field */
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>路由扩展首部处理结构</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct inet6_protocol rthdr_protocol = {
</span><span class='line'>    .handler        =       ipv6_rthdr_rcv,
</span><span class='line'>    .flags          =       INET6_PROTO_NOPOLICY | INET6_PROTO_GSO_EXTHDR,
</span><span class='line'>};
</span><span class='line'>static int ipv6_rthdr_rcv(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>    struct inet6_skb_parm *opt = IP6CB(skb);
</span><span class='line'>    struct in6_addr *addr = NULL;
</span><span class='line'>    struct in6_addr daddr;
</span><span class='line'>    struct inet6_dev *idev;
</span><span class='line'>    int n, i;
</span><span class='line'>    struct ipv6_rt_hdr *hdr;
</span><span class='line'>    struct rt0_hdr *rthdr;
</span><span class='line'>    int accept_source_route = ipv6_devconf.accept_source_route;
</span><span class='line'>
</span><span class='line'>    idev = in6_dev_get(skb-&gt;dev); //包进入设备
</span><span class='line'>    if (idev) {
</span><span class='line'>        if (accept_source_route &gt; idev-&gt;cnf.accept_source_route) //默认数量大于了手动调节(proc中）的数量
</span><span class='line'>            accept_source_route = idev-&gt;cnf.accept_source_route;
</span><span class='line'>        in6_dev_put(idev);
</span><span class='line'>    }
</span><span class='line'>    //skb长度和内存空间正确
</span><span class='line'>    if (!pskb_may_pull(skb, skb_transport_offset(skb) + 8) || !pskb_may_pull(skb, (skb_transport_offset(skb) +
</span><span class='line'>                    ((skb_transport_header(skb)[1] + 1) &lt;&lt; 3)))) {
</span><span class='line'>        IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>        kfree_skb(skb);
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>    hdr = (struct ipv6_rt_hdr *)skb_transport_header(skb); //路由扩展头
</span><span class='line'>    //是到多播地址或硬件地址不是到本机的地址
</span><span class='line'>    if (ipv6_addr_is_multicast(&ipv6_hdr(skb)-&gt;daddr) || skb-&gt;pkt_type != PACKET_HOST) {
</span><span class='line'>        IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INADDRERRORS);
</span><span class='line'>        kfree_skb(skb);
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>looped_back:
</span><span class='line'>    if (hdr-&gt;segments_left == 0) { //根据rfc要求 分段剩余为0
</span><span class='line'>        switch (hdr-&gt;type) {
</span><span class='line'>#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)
</span><span class='line'>            case IPV6_SRCRT_TYPE_2:
</span><span class='line'>                /* Silently discard type 2 header unless it was processed by own */
</span><span class='line'>                if (!addr) {
</span><span class='line'>                    IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INADDRERRORS);
</span><span class='line'>                    kfree_skb(skb);
</span><span class='line'>                    return -1;
</span><span class='line'>                }
</span><span class='line'>                break;
</span><span class='line'>#endif
</span><span class='line'>            default:
</span><span class='line'>                break;
</span><span class='line'>
</span><span class='line'>        }
</span><span class='line'>        opt-&gt;lastopt = opt-&gt;srcrt = skb_network_header_len(skb);
</span><span class='line'>        skb-&gt;transport_header += (hdr-&gt;hdrlen + 1) &lt;&lt; 3; //下一个传输头的位置
</span><span class='line'>        opt-&gt;dst0 = opt-&gt;dst1;
</span><span class='line'>        opt-&gt;dst1 = 0;
</span><span class='line'>        opt-&gt;nhoff = (&hdr-&gt;nexthdr) - skb_network_header(skb); //记录下一个头数据相对网络头的偏移量
</span><span class='line'>        return 1;
</span><span class='line'>    }
</span><span class='line'>    switch (hdr-&gt;type) {
</span><span class='line'>#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)
</span><span class='line'>        case IPV6_SRCRT_TYPE_2:
</span><span class='line'>            if (accept_source_route &lt; 0)
</span><span class='line'>                goto unknown_rh;
</span><span class='line'>            /* Silently discard invalid RTH type 2 */
</span><span class='line'>            if (hdr-&gt;hdrlen != 2 || hdr-&gt;segments_left != 1) {
</span><span class='line'>                IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>                kfree_skb(skb);
</span><span class='line'>                return -1;
</span><span class='line'>            }
</span><span class='line'>            break;
</span><span class='line'>#endif
</span><span class='line'>        default:
</span><span class='line'>            goto unknown_rh;
</span><span class='line'>    }
</span><span class='line'>    /* This is the routing header forwarding algorithm from RFC 2460, page 16. */
</span><span class='line'>
</span><span class='line'>    n = hdr-&gt;hdrlen &gt;&gt; 1; //计算路由首部中的地址数量
</span><span class='line'>    if (hdr-&gt;segments_left &gt; n) {
</span><span class='line'>        IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>        icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, ((&hdr-&gt;segments_left) - skb_network_header(skb)));
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>    /* We are about to mangle packet header. Be careful!                                       
</span><span class='line'>       Do not damage packets queued somewhere.  */
</span><span class='line'>    if (skb_cloned(skb)) {
</span><span class='line'>        /* the copy is a forwarded packet */
</span><span class='line'>        if (pskb_expand_head(skb, 0, 0, GFP_ATOMIC)) {
</span><span class='line'>            IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_OUTDISCARDS);
</span><span class='line'>            kfree_skb(skb);
</span><span class='line'>            return -1;
</span><span class='line'>        }
</span><span class='line'>        hdr = (struct ipv6_rt_hdr *)skb_transport_header(skb);
</span><span class='line'>    }
</span><span class='line'>    if (skb-&gt;ip_summed == CHECKSUM_COMPLETE)
</span><span class='line'>        skb-&gt;ip_summed = CHECKSUM_NONE;
</span><span class='line'>
</span><span class='line'>    i = n - --hdr-&gt;segments_left; //计算地址向量(地址列表)中要"访问"的下一个地址
</span><span class='line'>
</span><span class='line'>    rthdr = (struct rt0_hdr *) hdr;
</span><span class='line'>    addr = rthdr-&gt;addr; //指向地址列表首部
</span><span class='line'>    addr += i - 1; //移动到下一个地址
</span><span class='line'>
</span><span class='line'>    switch (hdr-&gt;type) {
</span><span class='line'>#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)
</span><span class='line'>        case IPV6_SRCRT_TYPE_2:
</span><span class='line'>            if (xfrm6_input_addr(skb, (xfrm_address_t *)addr, (xfrm_address_t *)&ipv6_hdr(skb)-&gt;saddr, IPPROTO_ROUTING) &lt; 0) {
</span><span class='line'>                IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INADDRERRORS);
</span><span class='line'>                kfree_skb(skb);
</span><span class='line'>                return -1;
</span><span class='line'>            }
</span><span class='line'>            if (!ipv6_chk_home_addr(addr)) {
</span><span class='line'>                IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INADDRERRORS);
</span><span class='line'>                kfree_skb(skb);
</span><span class='line'>                return -1;
</span><span class='line'>            }
</span><span class='line'>            break;
</span><span class='line'>#endif
</span><span class='line'>        default:
</span><span class='line'>            break;
</span><span class='line'>    }
</span><span class='line'>    if (ipv6_addr_is_multicast(addr)) { //这个地址是多播地址
</span><span class='line'>        IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INADDRERRORS);
</span><span class='line'>        kfree_skb(skb);
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>    //交换 IPv6 目的地址和这个地址
</span><span class='line'>    ipv6_addr_copy(&daddr, addr);
</span><span class='line'>    ipv6_addr_copy(addr, &ipv6_hdr(skb)-&gt;daddr);
</span><span class='line'>    ipv6_addr_copy(&ipv6_hdr(skb)-&gt;daddr, &daddr);
</span><span class='line'>    dst_release(xchg(&skb-&gt;dst, NULL));
</span><span class='line'>
</span><span class='line'>    ip6_route_input(skb); //路由查找处理，将在其他文章中介绍
</span><span class='line'>
</span><span class='line'>    if (skb-&gt;dst-&gt;error) {
</span><span class='line'>        skb_push(skb, skb-&gt;data - skb_network_header(skb));
</span><span class='line'>        dst_input(skb);
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    if (skb-&gt;dst-&gt;dev-&gt;flags & IFF_LOOPBACK) { //路由查找后要发送到的目的设备是回环
</span><span class='line'>        if (ipv6_hdr(skb)-&gt;hop_limit &lt;= 1) { //跳数限制小于1
</span><span class='line'>            IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>            //给源地址发送一个 ICMP "超时 – 传输超过跳数限制" 的报文, 并且抛弃此包
</span><span class='line'>            icmpv6_send(skb, ICMPV6_TIME_EXCEED, ICMPV6_EXC_HOPLIMIT, 0, skb-&gt;dev);
</span><span class='line'>            kfree_skb(skb);
</span><span class='line'>            return -1;
</span><span class='line'>        }
</span><span class='line'>        ipv6_hdr(skb)-&gt;hop_limit--;
</span><span class='line'>        goto looped_back;
</span><span class='line'>    }
</span><span class='line'>    //将data之中移动到网络头
</span><span class='line'>    skb_push(skb, skb-&gt;data - skb_network_header(skb));
</span><span class='line'>    dst_input(skb); //这时包应该被转发了
</span><span class='line'>    return -1;
</span><span class='line'>unknown_rh:
</span><span class='line'>    IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>    icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, (&hdr-&gt;type) - skb_network_header(skb));
</span><span class='line'>    return -1;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ipv6分配包扩展首部处理</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct inet6_protocol frag_protocol =
</span><span class='line'>{
</span><span class='line'>    .handler        =       ipv6_frag_rcv,
</span><span class='line'>    .flags          =       INET6_PROTO_NOPOLICY,
</span><span class='line'>};
</span><span class='line'>static int ipv6_frag_rcv(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>    struct frag_hdr *fhdr;
</span><span class='line'>    struct frag_queue *fq;
</span><span class='line'>    struct ipv6hdr *hdr = ipv6_hdr(skb);
</span><span class='line'>
</span><span class='line'>    IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_REASMREQDS);
</span><span class='line'>
</span><span class='line'>    /* Jumbo payload inhibits frag. header */
</span><span class='line'>    if (hdr-&gt;payload_len == 0) { //是Jumbo payload，不是分片包
</span><span class='line'>        IP6_INC_STATS(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>        icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, skb_network_header_len(skb));
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>    //有碎片头空间
</span><span class='line'>    if (!pskb_may_pull(skb, (skb_transport_offset(skb) + sizeof(struct frag_hdr)))) {
</span><span class='line'>        IP6_INC_STATS(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>        icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, skb_network_header_len(skb));
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>    hdr = ipv6_hdr(skb);
</span><span class='line'>    fhdr = (struct frag_hdr *)skb_transport_header(skb); //分片头
</span><span class='line'>
</span><span class='line'>    if (!(fhdr-&gt;frag_off & htons(0xFFF9))) { //没有分片偏移，不是分片包
</span><span class='line'>        /* It is not a fragmented frame */
</span><span class='line'>        skb-&gt;transport_header += sizeof(struct frag_hdr); //传输头向后移动到下一个头
</span><span class='line'>        IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_REASMOKS);
</span><span class='line'>        IP6CB(skb)-&gt;nhoff = (u8 *)fhdr - skb_network_header(skb);
</span><span class='line'>        return 1;
</span><span class='line'>    }
</span><span class='line'>    if (atomic_read(&ip6_frags.mem) &gt; ip6_frags_ctl.high_thresh) //内存使用超过限制
</span><span class='line'>        ip6_evictor(ip6_dst_idev(skb-&gt;dst));
</span><span class='line'>
</span><span class='line'>    //查找或创建分片队列头
</span><span class='line'>    if ((fq = fq_find(fhdr-&gt;identification, &hdr-&gt;saddr, &hdr-&gt;daddr, ip6_dst_idev(skb-&gt;dst))) != NULL) {
</span><span class='line'>        int ret;
</span><span class='line'>        spin_lock(&fq-&gt;q.lock);
</span><span class='line'>        ret = ip6_frag_queue(fq, skb, fhdr, IP6CB(skb)-&gt;nhoff); //入队重组
</span><span class='line'>        spin_unlock(&fq-&gt;q.lock);
</span><span class='line'>        fq_put(fq);
</span><span class='line'>        return ret;
</span><span class='line'>    }
</span><span class='line'>    IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_REASMFAILS);
</span><span class='line'>    kfree_skb(skb);
</span><span class='line'>    return -1;
</span><span class='line'>}
</span><span class='line'>static __inline__ struct frag_queue * fq_find(__be32 id, struct in6_addr *src, struct in6_addr *dst, struct inet6_dev *idev)
</span><span class='line'>{
</span><span class='line'>    struct inet_frag_queue *q;
</span><span class='line'>    struct ip6_create_arg arg;
</span><span class='line'>    unsigned int hash;
</span><span class='line'>
</span><span class='line'>    arg.id = id;
</span><span class='line'>    arg.src = src;
</span><span class='line'>    arg.dst = dst;
</span><span class='line'>    hash = ip6qhashfn(id, src, dst); //id，源，目的进行 hash
</span><span class='line'>
</span><span class='line'>    q = inet_frag_find(&ip6_frags, &arg, hash); //查找或创建
</span><span class='line'>    if (q == NULL)
</span><span class='line'>        goto oom;
</span><span class='line'>
</span><span class='line'>    return container_of(q, struct frag_queue, q); //成功返回
</span><span class='line'>oom: //没内存了
</span><span class='line'>    IP6_INC_STATS_BH(idev, IPSTATS_MIB_REASMFAILS);
</span><span class='line'>    return NULL;
</span><span class='line'>}
</span><span class='line'>struct inet_frag_queue *inet_frag_find(struct inet_frags *f, void *key, unsigned int hash)
</span><span class='line'>{
</span><span class='line'>    struct inet_frag_queue *q;
</span><span class='line'>    struct hlist_node *n;
</span><span class='line'>
</span><span class='line'>    read_lock(&f-&gt;lock);
</span><span class='line'>    hlist_for_each_entry(q, n, &f-&gt;hash[hash], list) { //在hash桶中查找
</span><span class='line'>
</span><span class='line'>        if (f-&gt;match(q, key)) { //调用匹配函数进行匹配，具体函数很简单参考初始化时的ipv6_frag_init函数
</span><span class='line'>            atomic_inc(&q-&gt;refcnt);
</span><span class='line'>            read_unlock(&f-&gt;lock);
</span><span class='line'>            return q;
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    //没有找到就创建一个
</span><span class='line'>    return inet_frag_create(f, key, hash);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>创建分片队列</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct inet_frag_queue *inet_frag_create(struct inet_frags *f, void *arg, unsigned int hash)
</span><span class='line'>{
</span><span class='line'>    struct inet_frag_queue *q;
</span><span class='line'>
</span><span class='line'>    q = inet_frag_alloc(f, arg); //分配一个
</span><span class='line'>    if (q == NULL)
</span><span class='line'>        return NULL;
</span><span class='line'>    //添加到 hash 表
</span><span class='line'>    return inet_frag_intern(q, f, hash, arg);
</span><span class='line'>}
</span><span class='line'>static struct inet_frag_queue *inet_frag_alloc(struct inet_frags *f, void *arg)
</span><span class='line'>{
</span><span class='line'>    struct inet_frag_queue *q;
</span><span class='line'>
</span><span class='line'>    q = kzalloc(f-&gt;qsize, GFP_ATOMIC); //分配一个队列头，大小是 sizeof(struct frag_queue)
</span><span class='line'>    if (q == NULL)
</span><span class='line'>        return NULL;
</span><span class='line'>
</span><span class='line'>    f-&gt;constructor(q, arg); //拷贝地址和 id 到队列头结构中
</span><span class='line'>    atomic_add(f-&gt;qsize, &f-&gt;mem);
</span><span class='line'>    setup_timer(&q-&gt;timer, f-&gt;frag_expire, (unsigned long)q);
</span><span class='line'>    spin_lock_init(&q-&gt;lock);
</span><span class='line'>    atomic_set(&q-&gt;refcnt, 1);
</span><span class='line'>    return q;
</span><span class='line'>}
</span><span class='line'>static struct inet_frag_queue *inet_frag_intern(struct inet_frag_queue *qp_in, struct inet_frags *f, unsigned int hash, void *arg)
</span><span class='line'>{
</span><span class='line'>    struct inet_frag_queue *qp;
</span><span class='line'>#ifdef CONFIG_SMP
</span><span class='line'>    struct hlist_node *n;
</span><span class='line'>#endif
</span><span class='line'>
</span><span class='line'>    write_lock(&f-&gt;lock);
</span><span class='line'>#ifdef CONFIG_SMP
</span><span class='line'>    //其他cpu可能已经创建了一个，所以要再次检查
</span><span class='line'>    hlist_for_each_entry(qp, n, &f-&gt;hash[hash], list) {
</span><span class='line'>        if (f-&gt;match(qp, arg)) { //已经创建
</span><span class='line'>            atomic_inc(&qp-&gt;refcnt);
</span><span class='line'>            write_unlock(&f-&gt;lock);
</span><span class='line'>            qp_in-&gt;last_in |= COMPLETE;
</span><span class='line'>            inet_frag_put(qp_in, f); //释放新分配的
</span><span class='line'>            return qp;
</span><span class='line'>
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>#endif
</span><span class='line'>    qp = qp_in;
</span><span class='line'>    if (!mod_timer(&qp-&gt;timer, jiffies + f-&gt;ctl-&gt;timeout)) //启动定时器
</span><span class='line'>        atomic_inc(&qp-&gt;refcnt);
</span><span class='line'>
</span><span class='line'>    //增加引用计数，然后添加到hash表
</span><span class='line'>    atomic_inc(&qp-&gt;refcnt);
</span><span class='line'>    hlist_add_head(&qp-&gt;list, &f-&gt;hash[hash]);
</span><span class='line'>    list_add_tail(&qp-&gt;lru_list, &f-&gt;lru_list);
</span><span class='line'>    f-&gt;nqueues++;
</span><span class='line'>    write_unlock(&f-&gt;lock);
</span><span class='line'>    return qp;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>入队重组</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int ip6_frag_queue(struct frag_queue *fq, struct sk_buff *skb, struct frag_hdr *fhdr, int nhoff)
</span><span class='line'>{
</span><span class='line'>    struct sk_buff *prev, *next;
</span><span class='line'>    struct net_device *dev;
</span><span class='line'>    int offset, end;
</span><span class='line'>
</span><span class='line'>    if (fq-&gt;q.last_in & COMPLETE) //重组已经完成
</span><span class='line'>        goto err;
</span><span class='line'>
</span><span class='line'>    //分片开始位置
</span><span class='line'>    offset = ntohs(fhdr-&gt;frag_off) & ~0x7;//偏移必须8字节对齐
</span><span class='line'>    //分片在整个包中的结束位置 包负载长度 - 分片头长度
</span><span class='line'>    end = offset + (ntohs(ipv6_hdr(skb)-&gt;payload_len) -  ((u8 *)(fhdr + 1) - (u8 *)(ipv6_hdr(skb) + 1)));
</span><span class='line'>
</span><span class='line'>    //结束位置 &gt; 65535
</span><span class='line'>    if ((unsigned int)end &gt; IPV6_MAXPLEN) {
</span><span class='line'>        IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>        icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, ((u8 *)&fhdr-&gt;frag_off - skb_network_header(skb)));
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>    //校验和已经完成
</span><span class='line'>    if (skb-&gt;ip_summed == CHECKSUM_COMPLETE) {
</span><span class='line'>        const unsigned char *nh = skb_network_header(skb);
</span><span class='line'>        //减去分片包头的校验和
</span><span class='line'>        skb-&gt;csum = csum_sub(skb-&gt;csum, csum_partial(nh, (u8 *)(fhdr + 1) - nh, 0));
</span><span class='line'>    }
</span><span class='line'>    //最后一个碎片包
</span><span class='line'>    if (!(fhdr-&gt;frag_off & htons(IP6_MF))) {
</span><span class='line'>        /* If we already have some bits beyond end or have different end, the segment is corrupted. */
</span><span class='line'>        if (end &lt; fq-&gt;q.len || ((fq-&gt;q.last_in & LAST_IN) && end != fq-&gt;q.len)) //分片出现错误
</span><span class='line'>            goto err;
</span><span class='line'>
</span><span class='line'>        fq-&gt;q.last_in |= LAST_IN; //标识最后一个分片
</span><span class='line'>        fq-&gt;q.len = end; //记录包总长度
</span><span class='line'>    } else {
</span><span class='line'>        /* Check if the fragment is rounded to 8 bytes. Required by the RFC. */
</span><span class='line'>        if (end & 0x7) { //碎片结尾也需要8字节对齐
</span><span class='line'>            /* RFC2460 says always send parameter problem in this case. -DaveM */
</span><span class='line'>            IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), PSTATS_MIB_INHDRERRORS);
</span><span class='line'>            icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, offsetof(struct ipv6hdr, payload_len));
</span><span class='line'>            return -1;
</span><span class='line'>        }
</span><span class='line'>        if (end &gt; fq-&gt;q.len) {
</span><span class='line'>            /* Some bits beyond end -&gt; corruption. */
</span><span class='line'>            if (fq-&gt;q.last_in & LAST_IN)
</span><span class='line'>                goto err;
</span><span class='line'>            fq-&gt;q.len = end; //记录已经得到的碎片的最大长度
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    if (end == offset) //开始 = 结束
</span><span class='line'>        goto err;
</span><span class='line'>
</span><span class='line'>    //skb-&gt;data 指向碎片首部头后数据部分
</span><span class='line'>    if (!pskb_pull(skb, (u8 *) (fhdr + 1) - skb-&gt;data))
</span><span class='line'>        goto err;
</span><span class='line'>    //如果需要缩短skb的内存长度
</span><span class='line'>    if (pskb_trim_rcsum(skb, end - offset))
</span><span class='line'>        goto err;
</span><span class='line'>
</span><span class='line'>    //找出碎片所在位置
</span><span class='line'>    prev = NULL;
</span><span class='line'>    for(next = fq-&gt;q.fragments; next != NULL; next = next-&gt;next) {
</span><span class='line'>        if (FRAG6_CB(next)-&gt;offset &gt;= offset)
</span><span class='line'>            break;  /* bingo! */
</span><span class='line'>        prev = next;
</span><span class='line'>    }
</span><span class='line'>    if (prev) { //有前一个碎片
</span><span class='line'>        //前一个碎片 (开始 + 长度) - 这个碎片的开始. 计算出重叠部分
</span><span class='line'>        int i = (FRAG6_CB(prev)-&gt;offset + prev-&gt;len) - offset;
</span><span class='line'>        if (i &gt; 0) { //有重叠
</span><span class='line'>            offset += i; //调整这个碎片的开始位置
</span><span class='line'>            if (end &lt;= offset) //调整后出错
</span><span class='line'>                goto err;
</span><span class='line'>            if (!pskb_pull(skb, i))//skb-&gt;data += i;
</span><span class='line'>                goto err;
</span><span class='line'>            if (skb-&gt;ip_summed != CHECKSUM_UNNECESSARY)
</span><span class='line'>                skb-&gt;ip_summed = CHECKSUM_NONE;
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    //有下一个碎片，且开始位置 &lt; 这个碎片的结束位置
</span><span class='line'>    while (next && FRAG6_CB(next)-&gt;offset &lt; end) {
</span><span class='line'>        //这个碎片的结束位置  - 下一个碎片的开始位置，计算重叠
</span><span class='line'>        int i = end - FRAG6_CB(next)-&gt;offset; /* overlap is 'i' bytes */
</span><span class='line'>        if (i &lt; next-&gt;len) { //重叠长度 &lt; 下一个碎片的长度
</span><span class='line'>            if (!pskb_pull(next, i)) //next-&gt;data += i;
</span><span class='line'>                goto err;
</span><span class='line'>
</span><span class='line'>            FRAG6_CB(next)-&gt;offset += i;    //下一个碎片开始位置调整
</span><span class='line'>            fq-&gt;q.meat -= i; //总长度减少
</span><span class='line'>            if (next-&gt;ip_summed != CHECKSUM_UNNECESSARY)
</span><span class='line'>                next-&gt;ip_summed = CHECKSUM_NONE;
</span><span class='line'>            break;
</span><span class='line'>
</span><span class='line'>        } else { //这个碎片完全复盖了下一个碎片
</span><span class='line'>            struct sk_buff *free_it = next; //释放这个碎片
</span><span class='line'>            next = next-&gt;next;//调整下一个碎片指针
</span><span class='line'>            //调整队列指针
</span><span class='line'>            if (prev)
</span><span class='line'>                prev-&gt;next = next;
</span><span class='line'>            else
</span><span class='line'>                fq-&gt;q.fragments = next;
</span><span class='line'>
</span><span class='line'>            fq-&gt;q.meat -= free_it-&gt;len;
</span><span class='line'>            frag_kfree_skb(free_it, NULL); //释放被复盖的包
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    FRAG6_CB(skb)-&gt;offset = offset; //这个碎片包记录自己的开始位置
</span><span class='line'>
</span><span class='line'>    //插入这个碎片到队列
</span><span class='line'>    skb-&gt;next = next;
</span><span class='line'>    if (prev)
</span><span class='line'>        prev-&gt;next = skb;
</span><span class='line'>    else
</span><span class='line'>        fq-&gt;q.fragments = skb;
</span><span class='line'>
</span><span class='line'>    dev = skb-&gt;dev;
</span><span class='line'>    if (dev) {
</span><span class='line'>        fq-&gt;iif = dev-&gt;ifindex;
</span><span class='line'>        skb-&gt;dev = NULL;
</span><span class='line'>    }
</span><span class='line'>    fq-&gt;q.stamp = skb-&gt;tstamp;
</span><span class='line'>    fq-&gt;q.meat += skb-&gt;len; //累加总长度
</span><span class='line'>    atomic_add(skb-&gt;truesize, &ip6_frags.mem);
</span><span class='line'>
</span><span class='line'>    if (offset == 0) { //偏移为0
</span><span class='line'>        fq-&gt;nhoffset = nhoff;
</span><span class='line'>        fq-&gt;q.last_in |= FIRST_IN; //标识开始碎片
</span><span class='line'>    }
</span><span class='line'>    //碎片已经聚齐，记录长度 = 包中标识的长度
</span><span class='line'>    if (fq-&gt;q.last_in == (FIRST_IN | LAST_IN) && fq-&gt;q.meat == fq-&gt;q.len)
</span><span class='line'>        return ip6_frag_reasm(fq, prev, dev); //重组
</span><span class='line'>    //没有聚齐，移动队列连表到lru连表尾部
</span><span class='line'>    write_lock(&ip6_frags.lock);
</span><span class='line'>    list_move_tail(&fq-&gt;q.lru_list, &ip6_frags.lru_list);
</span><span class='line'>    write_unlock(&ip6_frags.lock);
</span><span class='line'>    return -1;
</span><span class='line'>err:
</span><span class='line'>    IP6_INC_STATS(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_REASMFAILS);
</span><span class='line'>    kfree_skb(skb);
</span><span class='line'>    return -1;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>重组ip头</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int ip6_frag_reasm(struct frag_queue *fq, struct sk_buff *prev, struct net_device *dev)
</span><span class='line'>{
</span><span class='line'>    struct sk_buff *fp, *head = fq-&gt;q.fragments;
</span><span class='line'>    int    payload_len;
</span><span class='line'>    unsigned int nhoff;
</span><span class='line'>
</span><span class='line'>    fq_kill(fq); //把这个重组队列出队
</span><span class='line'>
</span><span class='line'>    /* Make the one we just received the head. */
</span><span class='line'>    if (prev) {
</span><span class='line'>        //下面是把head指向的skb复制到fp，然后把fp插入到head指向的位置
</span><span class='line'>        head = prev-&gt;next;
</span><span class='line'>        fp = skb_clone(head, GFP_ATOMIC);
</span><span class='line'>
</span><span class='line'>        if (!fp)
</span><span class='line'>            goto out_oom;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        fp-&gt;next = head-&gt;next;
</span><span class='line'>        prev-&gt;next = fp;
</span><span class='line'>        //把真正的头skb复制到head指针的skb
</span><span class='line'>        skb_morph(head, fq-&gt;q.fragments);
</span><span class='line'>        head-&gt;next = fq-&gt;q.fragments-&gt;next;
</span><span class='line'>
</span><span class='line'>        kfree_skb(fq-&gt;q.fragments);//释放原来的头
</span><span class='line'>        fq-&gt;q.fragments = head;
</span><span class='line'>    }
</span><span class='line'>    /* Unfragmented part is taken from the first segment. */
</span><span class='line'>    //计算负载总长度
</span><span class='line'>    payload_len = ((head-&gt;data - skb_network_header(head)) - sizeof(struct ipv6hdr) + fq-&gt;q.len -  sizeof(struct frag_hdr));
</span><span class='line'>    if (payload_len &gt; IPV6_MAXPLEN) //超过65535
</span><span class='line'>        goto out_oversize;
</span><span class='line'>
</span><span class='line'>    /* Head of list must not be cloned. */
</span><span class='line'>    //如果skb被克隆，从新分配他的data
</span><span class='line'>    if (skb_cloned(head) && pskb_expand_head(head, 0, 0, GFP_ATOMIC))
</span><span class='line'>        goto out_oom;
</span><span class='line'>
</span><span class='line'>    /* If the first fragment is fragmented itself, we split it to two chunks: the first with data and paged part
</span><span class='line'>     * and the second, holding only fragments.
</span><span class='line'>     */
</span><span class='line'>    if (skb_shinfo(head)-&gt;frag_list) {//如果头自己已经被分片
</span><span class='line'>        struct sk_buff *clone;
</span><span class='line'>        int i, plen = 0;
</span><span class='line'>
</span><span class='line'>        if ((clone = alloc_skb(0, GFP_ATOMIC)) == NULL)
</span><span class='line'>            goto out_oom;
</span><span class='line'>
</span><span class='line'>        //把这个clone插入到头后               
</span><span class='line'>        clone-&gt;next = head-&gt;next;
</span><span class='line'>        head-&gt;next = clone;
</span><span class='line'>        //把头的分片给这个clone
</span><span class='line'>        skb_shinfo(clone)-&gt;frag_list = skb_shinfo(head)-&gt;frag_list;
</span><span class='line'>        skb_shinfo(head)-&gt;frag_list = NULL;
</span><span class='line'>        //头使用了页面，计算总长度
</span><span class='line'>        for (i = 0; i &lt; skb_shinfo(head)-&gt;nr_frags; i++)
</span><span class='line'>            plen += skb_shinfo(head)-&gt;frags[i].size;
</span><span class='line'>
</span><span class='line'>        clone-&gt;len = clone-&gt;data_len = head-&gt;data_len - plen;
</span><span class='line'>        head-&gt;data_len -= clone-&gt;len;
</span><span class='line'>        head-&gt;len -= clone-&gt;len;
</span><span class='line'>        clone-&gt;csum = 0;
</span><span class='line'>        clone-&gt;ip_summed = head-&gt;ip_summed;
</span><span class='line'>        atomic_add(clone-&gt;truesize, &ip6_frags.mem);
</span><span class='line'>    }
</span><span class='line'>    /* We have to remove fragment header from datagram and to relocate                         
</span><span class='line'>     * header in order to calculate ICV correctly. */
</span><span class='line'>    nhoff = fq-&gt;nhoffset;
</span><span class='line'>    //把传输头（分片头）中的下一个头字段值赋给网络头中的下一个头字段
</span><span class='line'>    skb_network_header(head)[nhoff] = skb_transport_header(head)[0];
</span><span class='line'>    //把分片首部复盖掉
</span><span class='line'>    memmove(head-&gt;head + sizeof(struct frag_hdr), head-&gt;head, (head-&gt;data - head-&gt;head) - sizeof(struct frag_hdr));
</span><span class='line'>    //调整相应的各个层的头位置
</span><span class='line'>    head-&gt;mac_header += sizeof(struct frag_hdr);
</span><span class='line'>    head-&gt;network_header += sizeof(struct frag_hdr);
</span><span class='line'>
</span><span class='line'>    skb_shinfo(head)-&gt;frag_list = head-&gt;next; //保存碎片连表
</span><span class='line'>    skb_reset_transport_header(head);//重新调整网络头，现在指向分片头后的头
</span><span class='line'>    skb_push(head, head-&gt;data - skb_network_header(head));//使head-&gt;data指向网络头
</span><span class='line'>    atomic_sub(head-&gt;truesize, &ip6_frags.mem);
</span><span class='line'>
</span><span class='line'>    for (fp = head-&gt;next; fp; fp = fp-&gt;next) { //统计分片总长度
</span><span class='line'>        head-&gt;data_len += fp-&gt;len;
</span><span class='line'>        head-&gt;len += fp-&gt;len;
</span><span class='line'>        if (head-&gt;ip_summed != fp-&gt;ip_summed)
</span><span class='line'>            head-&gt;ip_summed = CHECKSUM_NONE;
</span><span class='line'>        else if (head-&gt;ip_summed == CHECKSUM_COMPLETE)
</span><span class='line'>            head-&gt;csum = csum_add(head-&gt;csum, fp-&gt;csum); //添加各分片的累加和
</span><span class='line'>
</span><span class='line'>        head-&gt;truesize += fp-&gt;truesize;
</span><span class='line'>        atomic_sub(fp-&gt;truesize, &ip6_frags.mem);
</span><span class='line'>    }
</span><span class='line'>    head-&gt;next = NULL;
</span><span class='line'>    head-&gt;dev = dev;
</span><span class='line'>    head-&gt;tstamp = fq-&gt;q.stamp;
</span><span class='line'>    ipv6_hdr(head)-&gt;payload_len = htons(payload_len); //总长度
</span><span class='line'>    IP6CB(head)-&gt;nhoff = nhoff;
</span><span class='line'>
</span><span class='line'>    /* Yes, and fold redundant checksum back. 8) */
</span><span class='line'>    if (head-&gt;ip_summed == CHECKSUM_COMPLETE) //添加网络头累加和
</span><span class='line'>        head-&gt;csum = csum_partial(skb_network_header(head), skb_network_header_len(head), head-&gt;csum);
</span><span class='line'>
</span><span class='line'>    rcu_read_lock();
</span><span class='line'>    IP6_INC_STATS_BH(__in6_dev_get(dev), IPSTATS_MIB_REASMOKS);
</span><span class='line'>    rcu_read_unlock();
</span><span class='line'>    fq-&gt;q.fragments = NULL;
</span><span class='line'>    return 1;
</span><span class='line'>    ...... //下面是错误处理
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>无数据扩展头</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct inet6_protocol nodata_protocol = {
</span><span class='line'>    .handler        =       ipv6_nodata_rcv,
</span><span class='line'>    .flags          =       INET6_PROTO_NOPOLICY,
</span><span class='line'>};
</span><span class='line'>static int ipv6_nodata_rcv(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>    kfree_skb(skb);
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>目的选项首部处理</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct inet6_protocol destopt_protocol = {
</span><span class='line'>    .handler        =       ipv6_destopt_rcv,
</span><span class='line'>    .flags          =       INET6_PROTO_NOPOLICY | INET6_PROTO_GSO_EXTHDR,
</span><span class='line'>};
</span><span class='line'>static int ipv6_destopt_rcv(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>    struct inet6_skb_parm *opt = IP6CB(skb);
</span><span class='line'>#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)
</span><span class='line'>    __u16 dstbuf;
</span><span class='line'>#endif
</span><span class='line'>    struct dst_entry *dst;
</span><span class='line'>    //长度验证
</span><span class='line'>    if (!pskb_may_pull(skb, skb_transport_offset(skb) + 8) || !pskb_may_pull(skb, (skb_transport_offset(skb) +
</span><span class='line'>                    ((skb_transport_header(skb)[1] + 1) &lt;&lt; 3)))) {
</span><span class='line'>        IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>        kfree_skb(skb);
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>    opt-&gt;lastopt = opt-&gt;dst1 = skb_network_header_len(skb); //网络头长度
</span><span class='line'>#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)
</span><span class='line'>    dstbuf = opt-&gt;dst1;
</span><span class='line'>#endif
</span><span class='line'>    dst = dst_clone(skb-&gt;dst); //增加dst的引用计数
</span><span class='line'>    //解析tlv，上面已经看到过了
</span><span class='line'>    if (ip6_parse_tlv(tlvprocdestopt_lst, skb)) {
</span><span class='line'>        dst_release(dst);
</span><span class='line'>        skb-&gt;transport_header += (skb_transport_header(skb)[1] + 1) &lt;&lt; 3; //调整网络头位置
</span><span class='line'>        opt = IP6CB(skb);
</span><span class='line'>#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)
</span><span class='line'>        opt-&gt;nhoff = dstbuf;
</span><span class='line'>#else
</span><span class='line'>        opt-&gt;nhoff = opt-&gt;dst1;
</span><span class='line'>#endif
</span><span class='line'>        return 1;
</span><span class='line'>    }
</span><span class='line'>    IP6_INC_STATS_BH(ip6_dst_idev(dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>    dst_release(dst);
</span><span class='line'>    return -1;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/4">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/2">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
<h1>Categories</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/language/'>language</a><a href='##' onmousedown=showDiv('language') id='aexp_language'><span class='exp_style' id='exp_language'>[+]</span></a><span class='right_span'>(38)</span></li>
<div id='language' class='catsub'><li><a href='/blog/cats/language~c/?opendiv=language'>c</a><a href='##' onmousedown=showDiv('language~c') id='aexp_language~c'><span class='exp_style' id='exp_language~c'>[+]</span></a><span class='right_span'>21</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~c')) document.getElementById('aexp_language~c').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~java/?opendiv=language'>java</a><a href='##' onmousedown=showDiv('language~java') id='aexp_language~java'><span class='exp_style' id='exp_language~java'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~java')) document.getElementById('aexp_language~java').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~web/?opendiv=language'>web</a><a href='##' onmousedown=showDiv('language~web') id='aexp_language~web'><span class='exp_style' id='exp_language~web'>[+]</span></a><span class='right_span'>6</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('language')) document.getElementById('aexp_language').style.visibility = 'hidden';
if (!document.getElementById('language~web')) document.getElementById('aexp_language~web').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/compiler/'>compiler</a><a href='##' onmousedown=showDiv('compiler') id='aexp_compiler'><span class='exp_style' id='exp_compiler'>[+]</span></a><span class='right_span'>(14)</span></li>
<div id='compiler' class='catsub'><li><a href='/blog/cats/compiler~base/?opendiv=compiler'>base</a><a href='##' onmousedown=showDiv('compiler~base') id='aexp_compiler~base'><span class='exp_style' id='exp_compiler~base'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler~base')) document.getElementById('aexp_compiler~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/compiler~make/?opendiv=compiler'>make</a><a href='##' onmousedown=showDiv('compiler~make') id='aexp_compiler~make'><span class='exp_style' id='exp_compiler~make'>[+]</span></a><span class='right_span'>4</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler')) document.getElementById('aexp_compiler').style.visibility = 'hidden';
if (!document.getElementById('compiler~make')) document.getElementById('aexp_compiler~make').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/assembly/'>assembly</a><a href='##' onmousedown=showDiv('assembly') id='aexp_assembly'><span class='exp_style' id='exp_assembly'>[+]</span></a><span class='right_span'>(15)</span></li>
<div id='assembly' class='catsub'><li><a href='/blog/cats/assembly~arm/?opendiv=assembly'>arm</a><a href='##' onmousedown=showDiv('assembly~arm') id='aexp_assembly~arm'><span class='exp_style' id='exp_assembly~arm'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly~arm')) document.getElementById('aexp_assembly~arm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/assembly~base/?opendiv=assembly'>base</a><a href='##' onmousedown=showDiv('assembly~base') id='aexp_assembly~base'><span class='exp_style' id='exp_assembly~base'>[+]</span></a><span class='right_span'>13</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly')) document.getElementById('aexp_assembly').style.visibility = 'hidden';
if (!document.getElementById('assembly~base')) document.getElementById('aexp_assembly~base').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/tools/'>tools</a><a href='##' onmousedown=showDiv('tools') id='aexp_tools'><span class='exp_style' id='exp_tools'>[+]</span></a><span class='right_span'>(40)</span></li>
<div id='tools' class='catsub'><li><a href='/blog/cats/tools~base/?opendiv=tools'>base</a><a href='##' onmousedown=showDiv('tools~base') id='aexp_tools~base'><span class='exp_style' id='exp_tools~base'>[+]</span></a><span class='right_span'>15</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~base')) document.getElementById('aexp_tools~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ci/?opendiv=tools'>ci</a><a href='##' onmousedown=showDiv('tools~ci') id='aexp_tools~ci'><span class='exp_style' id='exp_tools~ci'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~ci')) document.getElementById('aexp_tools~ci').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~command/?opendiv=tools'>command</a><a href='##' onmousedown=showDiv('tools~command') id='aexp_tools~command'><span class='exp_style' id='exp_tools~command'>[+]</span></a><span class='right_span'>7</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~command')) document.getElementById('aexp_tools~command').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~git/?opendiv=tools'>git</a><a href='##' onmousedown=showDiv('tools~git') id='aexp_tools~git'><span class='exp_style' id='exp_tools~git'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~git')) document.getElementById('aexp_tools~git').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~mysql/?opendiv=tools'>mysql</a><a href='##' onmousedown=showDiv('tools~mysql') id='aexp_tools~mysql'><span class='exp_style' id='exp_tools~mysql'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~mysql')) document.getElementById('aexp_tools~mysql').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ssh/?opendiv=tools'>ssh</a><a href='##' onmousedown=showDiv('tools~ssh') id='aexp_tools~ssh'><span class='exp_style' id='exp_tools~ssh'>[+]</span></a><span class='right_span'>3</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('tools')) document.getElementById('aexp_tools').style.visibility = 'hidden';
if (!document.getElementById('tools~ssh')) document.getElementById('aexp_tools~ssh').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/system/'>system</a><a href='##' onmousedown=showDiv('system') id='aexp_system'><span class='exp_style' id='exp_system'>[+]</span></a><span class='right_span'>(31)</span></li>
<div id='system' class='catsub'><li><a href='/blog/cats/system~base/?opendiv=system'>base</a><a href='##' onmousedown=showDiv('system~base') id='aexp_system~base'><span class='exp_style' id='exp_system~base'>[+]</span></a><span class='right_span'>14</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~base')) document.getElementById('aexp_system~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~centos/?opendiv=system'>centos</a><a href='##' onmousedown=showDiv('system~centos') id='aexp_system~centos'><span class='exp_style' id='exp_system~centos'>[+]</span></a><span class='right_span'>8</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~centos')) document.getElementById('aexp_system~centos').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~ubuntu/?opendiv=system'>ubuntu</a><a href='##' onmousedown=showDiv('system~ubuntu') id='aexp_system~ubuntu'><span class='exp_style' id='exp_system~ubuntu'>[+]</span></a><span class='right_span'>9</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('system')) document.getElementById('aexp_system').style.visibility = 'hidden';
if (!document.getElementById('system~ubuntu')) document.getElementById('aexp_system~ubuntu').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/kernel/'>kernel</a><a href='##' onmousedown=showDiv('kernel') id='aexp_kernel'><span class='exp_style' id='exp_kernel'>[+]</span></a><span class='right_span'>(126)</span></li>
<div id='kernel' class='catsub'><li><a href='/blog/cats/kernel~base/?opendiv=kernel'>base</a><a href='##' onmousedown=showDiv('kernel~base') id='aexp_kernel~base'><span class='exp_style' id='exp_kernel~base'>[+]</span></a><span class='right_span'>16</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~base')) document.getElementById('aexp_kernel~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~irq/?opendiv=kernel'>irq</a><a href='##' onmousedown=showDiv('kernel~irq') id='aexp_kernel~irq'><span class='exp_style' id='exp_kernel~irq'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~irq')) document.getElementById('aexp_kernel~irq').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~kexec/?opendiv=kernel'>kexec</a><a href='##' onmousedown=showDiv('kernel~kexec') id='aexp_kernel~kexec'><span class='exp_style' id='exp_kernel~kexec'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~kexec')) document.getElementById('aexp_kernel~kexec').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~mm/?opendiv=kernel'>mm</a><a href='##' onmousedown=showDiv('kernel~mm') id='aexp_kernel~mm'><span class='exp_style' id='exp_kernel~mm'>[+]</span></a><span class='right_span'>21</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~mm')) document.getElementById('aexp_kernel~mm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~net/?opendiv=kernel'>net</a><a href='##' onmousedown=showDiv('kernel~net') id='aexp_kernel~net'><span class='exp_style' id='exp_kernel~net'>[+]</span></a><span class='right_span'>60</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~net')) document.getElementById('aexp_kernel~net').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~sched/?opendiv=kernel'>sched</a><a href='##' onmousedown=showDiv('kernel~sched') id='aexp_kernel~sched'><span class='exp_style' id='exp_kernel~sched'>[+]</span></a><span class='right_span'>18</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel')) document.getElementById('aexp_kernel').style.visibility = 'hidden';
if (!document.getElementById('kernel~sched')) document.getElementById('aexp_kernel~sched').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/android/'>android</a><a href='##' onmousedown=showDiv('android') id='aexp_android'><span class='exp_style' id='exp_android'>[+]</span></a><span class='right_span'>(19)</span></li>
<div id='android' class='catsub'><li><a href='/blog/cats/android~base/?opendiv=android'>base</a><a href='##' onmousedown=showDiv('android~base') id='aexp_android~base'><span class='exp_style' id='exp_android~base'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~base')) document.getElementById('aexp_android~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~i9507v/?opendiv=android'>i9507v</a><a href='##' onmousedown=showDiv('android~i9507v') id='aexp_android~i9507v'><span class='exp_style' id='exp_android~i9507v'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~i9507v')) document.getElementById('aexp_android~i9507v').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~me722/?opendiv=android'>me722</a><a href='##' onmousedown=showDiv('android~me722') id='aexp_android~me722'><span class='exp_style' id='exp_android~me722'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~me722')) document.getElementById('aexp_android~me722').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~nx403a/?opendiv=android'>nx403a</a><a href='##' onmousedown=showDiv('android~nx403a') id='aexp_android~nx403a'><span class='exp_style' id='exp_android~nx403a'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~nx403a')) document.getElementById('aexp_android~nx403a').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~s5830/?opendiv=android'>s5830</a><a href='##' onmousedown=showDiv('android~s5830') id='aexp_android~s5830'><span class='exp_style' id='exp_android~s5830'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('android')) document.getElementById('aexp_android').style.visibility = 'hidden';
if (!document.getElementById('android~s5830')) document.getElementById('aexp_android~s5830').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/debug/'>debug</a><a href='##' onmousedown=showDiv('debug') id='aexp_debug'><span class='exp_style' id='exp_debug'>[+]</span></a><span class='right_span'>(62)</span></li>
<div id='debug' class='catsub'><li><a href='/blog/cats/debug~base/?opendiv=debug'>base</a><a href='##' onmousedown=showDiv('debug~base') id='aexp_debug~base'><span class='exp_style' id='exp_debug~base'>[+]</span></a><span class='right_span'>16</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~base')) document.getElementById('aexp_debug~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~dwarf/?opendiv=debug'>dwarf</a><a href='##' onmousedown=showDiv('debug~dwarf') id='aexp_debug~dwarf'><span class='exp_style' id='exp_debug~dwarf'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~dwarf')) document.getElementById('aexp_debug~dwarf').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~gdb/?opendiv=debug'>gdb</a><a href='##' onmousedown=showDiv('debug~gdb') id='aexp_debug~gdb'><span class='exp_style' id='exp_debug~gdb'>[+]</span></a><span class='right_span'>8</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~gdb')) document.getElementById('aexp_debug~gdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kdump,-crash/?opendiv=debug'>kdump、crash</a><a href='##' onmousedown=showDiv('debug~kdump、crash') id='aexp_debug~kdump、crash'><span class='exp_style' id='exp_debug~kdump、crash'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kdump、crash')) document.getElementById('aexp_debug~kdump、crash').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kgdb/?opendiv=debug'>kgdb</a><a href='##' onmousedown=showDiv('debug~kgdb') id='aexp_debug~kgdb'><span class='exp_style' id='exp_debug~kgdb'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kgdb')) document.getElementById('aexp_debug~kgdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kprobe/?opendiv=debug'>kprobe</a><a href='##' onmousedown=showDiv('debug~kprobe') id='aexp_debug~kprobe'><span class='exp_style' id='exp_debug~kprobe'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kprobe')) document.getElementById('aexp_debug~kprobe').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~mark/?opendiv=debug'>mark</a><a href='##' onmousedown=showDiv('debug~mark') id='aexp_debug~mark'><span class='exp_style' id='exp_debug~mark'>[+]</span></a><span class='right_span'>13</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~mark')) document.getElementById('aexp_debug~mark').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~systemtap/?opendiv=debug'>systemtap</a><a href='##' onmousedown=showDiv('debug~systemtap') id='aexp_debug~systemtap'><span class='exp_style' id='exp_debug~systemtap'>[+]</span></a><span class='right_span'>5</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('debug')) document.getElementById('aexp_debug').style.visibility = 'hidden';
if (!document.getElementById('debug~systemtap')) document.getElementById('aexp_debug~systemtap').style.visibility = 'hidden';
</script>
<li><div style="background:#DDD; height:0.3em;"></div></li><li class='catclass'><a href='/blog/cats/algorithm/'>algorithm</a><a href='##' onmousedown=showDiv('algorithm') id='aexp_algorithm'><span class='exp_style' id='exp_algorithm'>[+]</span></a><span class='right_span'>(26)</span></li>
<div id='algorithm' class='catsub'><li><a href='/blog/cats/algorithm~base/?opendiv=algorithm'>base</a><a href='##' onmousedown=showDiv('algorithm~base') id='aexp_algorithm~base'><span class='exp_style' id='exp_algorithm~base'>[+]</span></a><span class='right_span'>19</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~base')) document.getElementById('aexp_algorithm~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~dp/?opendiv=algorithm'>dp</a><a href='##' onmousedown=showDiv('algorithm~dp') id='aexp_algorithm~dp'><span class='exp_style' id='exp_algorithm~dp'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~dp')) document.getElementById('aexp_algorithm~dp').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~ds/?opendiv=algorithm'>ds</a><a href='##' onmousedown=showDiv('algorithm~ds') id='aexp_algorithm~ds'><span class='exp_style' id='exp_algorithm~ds'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~ds')) document.getElementById('aexp_algorithm~ds').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~tc/?opendiv=algorithm'>tc</a><a href='##' onmousedown=showDiv('algorithm~tc') id='aexp_algorithm~tc'><span class='exp_style' id='exp_algorithm~tc'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm')) document.getElementById('aexp_algorithm').style.visibility = 'hidden';
if (!document.getElementById('algorithm~tc')) document.getElementById('aexp_algorithm~tc').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/blog/'>blog</a><a href='##' onmousedown=showDiv('blog') id='aexp_blog'><span class='exp_style' id='exp_blog'>[+]</span></a><span class='right_span'>(11)</span></li>
<div id='blog' class='catsub'><li><a href='/blog/cats/blog~hello/?opendiv=blog'>hello</a><a href='##' onmousedown=showDiv('blog~hello') id='aexp_blog~hello'><span class='exp_style' id='exp_blog~hello'>[+]</span></a><span class='right_span'>1</span></li>
<div id='blog~hello' class='catsub2'><li><a href='/blog/cats/blog~hello~hi/?opendiv=blog~hello'>hi</a><span class='right_span'>1</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~hello')) document.getElementById('aexp_blog~hello').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~jekyll/?opendiv=blog'>jekyll</a><a href='##' onmousedown=showDiv('blog~jekyll') id='aexp_blog~jekyll'><span class='exp_style' id='exp_blog~jekyll'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~jekyll')) document.getElementById('aexp_blog~jekyll').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~markdown/?opendiv=blog'>markdown</a><a href='##' onmousedown=showDiv('blog~markdown') id='aexp_blog~markdown'><span class='exp_style' id='exp_blog~markdown'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~markdown')) document.getElementById('aexp_blog~markdown').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~octopress/?opendiv=blog'>octopress</a><a href='##' onmousedown=showDiv('blog~octopress') id='aexp_blog~octopress'><span class='exp_style' id='exp_blog~octopress'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~octopress')) document.getElementById('aexp_blog~octopress').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~ruby/?opendiv=blog'>ruby</a><a href='##' onmousedown=showDiv('blog~ruby') id='aexp_blog~ruby'><span class='exp_style' id='exp_blog~ruby'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog')) document.getElementById('aexp_blog').style.visibility = 'hidden';
if (!document.getElementById('blog~ruby')) document.getElementById('aexp_blog~ruby').style.visibility = 'hidden';
</script>

</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Date Categories</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/2015/'>2015</a><a href='##' onmousedown=showDiv('2015')><span class='exp_style' id='exp_2015'>[+]</span></a><span class='right_span'>(131)</span></li>
<div id='2015' class='catsub'><li><a href='/blog/cats/2015~07/?opendiv=2015'>2015-07</a><span class='right_span'>13</span></li>
<li><a href='/blog/cats/2015~06/?opendiv=2015'>2015-06</a><span class='right_span'>24</span></li>
<li><a href='/blog/cats/2015~05/?opendiv=2015'>2015-05</a><span class='right_span'>22</span></li>
<li><a href='/blog/cats/2015~04/?opendiv=2015'>2015-04</a><span class='right_span'>23</span></li>
<li><a href='/blog/cats/2015~03/?opendiv=2015'>2015-03</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2015~02/?opendiv=2015'>2015-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2015~01/?opendiv=2015'>2015-01</a><span class='right_span'>19</span></li>
</div><li class='catclass'><a href='/blog/cats/2014/'>2014</a><a href='##' onmousedown=showDiv('2014')><span class='exp_style' id='exp_2014'>[+]</span></a><span class='right_span'>(112)</span></li>
<div id='2014' class='catsub'><li><a href='/blog/cats/2014~12/?opendiv=2014'>2014-12</a><span class='right_span'>21</span></li>
<li><a href='/blog/cats/2014~11/?opendiv=2014'>2014-11</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2014~10/?opendiv=2014'>2014-10</a><span class='right_span'>13</span></li>
<li><a href='/blog/cats/2014~09/?opendiv=2014'>2014-09</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~08/?opendiv=2014'>2014-08</a><span class='right_span'>15</span></li>
<li><a href='/blog/cats/2014~07/?opendiv=2014'>2014-07</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~06/?opendiv=2014'>2014-06</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2014~05/?opendiv=2014'>2014-05</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~04/?opendiv=2014'>2014-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2014~03/?opendiv=2014'>2014-03</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~02/?opendiv=2014'>2014-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2014~01/?opendiv=2014'>2014-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2013/'>2013</a><a href='##' onmousedown=showDiv('2013')><span class='exp_style' id='exp_2013'>[+]</span></a><span class='right_span'>(60)</span></li>
<div id='2013' class='catsub'><li><a href='/blog/cats/2013~12/?opendiv=2013'>2013-12</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~11/?opendiv=2013'>2013-11</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~10/?opendiv=2013'>2013-10</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~09/?opendiv=2013'>2013-09</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~08/?opendiv=2013'>2013-08</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~07/?opendiv=2013'>2013-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2013~06/?opendiv=2013'>2013-06</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2013~05/?opendiv=2013'>2013-05</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~03/?opendiv=2013'>2013-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2013~02/?opendiv=2013'>2013-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2013~01/?opendiv=2013'>2013-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2012/'>2012</a><a href='##' onmousedown=showDiv('2012')><span class='exp_style' id='exp_2012'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2012' class='catsub'><li><a href='/blog/cats/2012~12/?opendiv=2012'>2012-12</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~11/?opendiv=2012'>2012-11</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~10/?opendiv=2012'>2012-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~08/?opendiv=2012'>2012-08</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2012~05/?opendiv=2012'>2012-05</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~04/?opendiv=2012'>2012-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2012~03/?opendiv=2012'>2012-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2012~02/?opendiv=2012'>2012-02</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2012~01/?opendiv=2012'>2012-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2011/'>2011</a><a href='##' onmousedown=showDiv('2011')><span class='exp_style' id='exp_2011'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2011' class='catsub'><li><a href='/blog/cats/2011~12/?opendiv=2011'>2011-12</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2011~11/?opendiv=2011'>2011-11</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2011~08/?opendiv=2011'>2011-08</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~07/?opendiv=2011'>2011-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~06/?opendiv=2011'>2011-06</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~05/?opendiv=2011'>2011-05</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~04/?opendiv=2011'>2011-04</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~03/?opendiv=2011'>2011-03</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2011~02/?opendiv=2011'>2011-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2011~01/?opendiv=2011'>2011-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2010/'>2010</a><a href='##' onmousedown=showDiv('2010')><span class='exp_style' id='exp_2010'>[+]</span></a><span class='right_span'>(1)</span></li>
<div id='2010' class='catsub'><li><a href='/blog/cats/2010~07/?opendiv=2010'>2010-07</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2009/'>2009</a><a href='##' onmousedown=showDiv('2009')><span class='exp_style' id='exp_2009'>[+]</span></a><span class='right_span'>(8)</span></li>
<div id='2009' class='catsub'><li><a href='/blog/cats/2009~12/?opendiv=2009'>2009-12</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2009~10/?opendiv=2009'>2009-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2009~09/?opendiv=2009'>2009-09</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2009~07/?opendiv=2009'>2009-07</a><span class='right_span'>1</span></li>
</div>
</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Tags</h1>
<ul class="tag-cloud">
<a style="font-size: 131%" href="/tags/gdb/">gdb(6)</a>
<a style="font-size: 100%" href="/tags/hello/">hello(1)</a>
<a style="font-size: 150%" href="/tags/koj/">koj(18)</a>
<a style="font-size: 112%" href="/tags/nvidia/">nvidia(2)</a>
<a style="font-size: 100%" href="/tags/patch/">patch(1)</a>
<a style="font-size: 100%" href="/tags/reg-exp/">reg_exp(1)</a>

</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/07/23/tools-haproxy/">haproxy安装配置</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/23/tools-squid-muti/">同时运行多个squid</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/21/debug-gdb-break/">gdb break/watch/catch</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/21/debug-gdb-info-set/">gdb 修改寄存器/变量</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/21/assembly-base-test/">test指令</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub</h1>
  
  <a href="https://github.com/abcdxyzk">abcdxyzk on GitHub</a>
  
</section>

<section>
<h1>Links</h1>
<ul>
	<li>
		<a href=http://hi.baidu.com/abcdxyzk target=_blank>My blog</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/zhangskd target=_blank>zhangsk</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/justlinux2010 target=_blank>justlinux2010</a>
	</li>
	<li>
		<a href=http://simohayha.iteye.com/ target=_blank>simohayha</a>
	</li>
	<li>
		<a href=http://linux.chinaunix.net/techdoc/net/ target=_blank>技术文档</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/cybertan target=_blank>cybertan</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/newnewman80 target=_blank>newnewman80</a>
	</li>
	<li>
		<a href=http://www.cppblog.com/fwxjj/ target=_blank>fwxjj</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/ustc_dylan target=_blank>ustc_dylan</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/nkguohao target=_blank>nkguohao</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/yusiguyuan target=_blank>yusiguyuan</a>
	</li>
	<li>
		<a href=http://www.oenhan.com/ target=_blank>oenhan</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/bullbat target=_blank>bullbat</a>
	</li>
	<li>
		<a href=http://www.wowotech.net/ target=_blank>wowotech</a>
	</li>
	<li>
		<a href=http://www.lenky.info/ target=_blank>lenky</a>
	</li>
</ul>
</section>

  
<section id="comment_sidebar">
<h1>Recent Comments</h1>

<script type="text/javascript" src="http://abcdxyzk.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=32&excerpt_length=20"></script><a href="http://disqus.com/">Powered by Disqus</a>

</section>


</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - kk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <a title="Top" href="#" id="scroll2top" style="position: fixed; height: 50px; bottom: 30px; right: 25px; cursor: pointer; z-index: 9999; display: block; opacity: 1;"><img src="/images/scrollup.png"></a>
  <script src="/javascripts/scroll2top.js"></script>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253604690'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1253604690' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'abcdxyzk';
      
</script>





</body>
</html>
