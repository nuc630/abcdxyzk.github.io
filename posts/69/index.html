
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>kk Blog —— 通用基础</title>

  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="kk Blog —— 通用基础" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/category.js" type="text/javascript"></script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kk Blog —— 通用基础</a></h1>
  
    <h2>cp -rf * .</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
<li>
<form action="/search" method="get">
    <input class="search" name="query" id="query" type="text" placeholder="search...">
    <input id="btnSubmit" value="search" type="submit">
</form>
<script type="text/javascript">
var query = GetRequest("query");
if (query != null) {
	document.getElementById("query").value = query;
}
</script>
</li>
  <li><a href="/atom.xml" rel="subscribe-rss">RSS</a></li>
  
</ul>
  
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/download">Download</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2013/05/24/debug-kprobe-base/">Linux内核kprobe机制</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-05-24T10:22:00+08:00'><span class='date'>2013-05-24</span> <span class='time'>10:22:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li>探测点处理函数在运行时是失效抢占的，依赖于特定的架构，探测点处理函数运行时也可能是中断失效的。</li>
<li><p>因此，对于任何探测点处理函数，不要使用导致睡眠或进程调度的任何内核函数（如尝试获得semaphore)。</p>

<p>Kprobe机制是内核提供的一种调试机制，它提供了一种方法，能够在不修改现有代码的基础上，灵活的跟踪内核函数的执行。它的基本工作原理是：用户指定一个探测点，并把一个用户定义的处理函数关联到该探测点，当内核执行到该探测点时，相应的关联函数被执行，然后继续执行正常的代码路径。</p>

<p>Kprobe提供了三种形式的探测点，一种是最基本的kprobe，能够在指定代码执行前、执行后进行探测，但此时不能访问被探测函数内的相关变量信 息；一种是jprobe，用于探测某一函数的入口，并且能够访问对应的函数参数；一种是kretprobe，用于完成指定函数返回值的探测功能。其中最基 本的就是kprobe机制，jprobe以及kretprobe的实现都依赖于kprobe，但其代码的实现都很巧妙，强烈建议每一个内核爱好者阅读。</p></li>
</ul>


<h4>代码：</h4>

<h5>首先是struct kprobe结构，每一个探测点的基本结构。</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>structkprobe {
</span><span class='line'>&#9;/*用于保存kprobe的全局hash表，以被探测的addr为key*/
</span><span class='line'>&#9;structhlist_node hlist;
</span><span class='line'>
</span><span class='line'>&#9;/* list of kprobes for multi-handler support */
</span><span class='line'>&#9;/*当对同一个探测点存在多个探测函数时，所有的函数挂在这条链上*/
</span><span class='line'>&#9;structlist_head list;
</span><span class='line'>
</span><span class='line'>&#9;/*count the number of times this probe was temporarily disarmed */
</span><span class='line'>&#9;unsigned longnmissed;
</span><span class='line'>
</span><span class='line'>&#9;/* location of the probe point */
</span><span class='line'>&#9;/*被探测的目标地址*/
</span><span class='line'>&#9;kprobe_opcode_t *addr;
</span><span class='line'>
</span><span class='line'>&#9;/* Allow user to indicate symbol name of the probe point */
</span><span class='line'>&#9;/*symblo_name的存在，允许用户指定函数名而非确定的地址*/
</span><span class='line'>&#9;constchar*symbol_name;
</span><span class='line'>
</span><span class='line'>&#9;/* Offset into the symbol */
</span><span class='line'>&#9;/*如果被探测点为函数内部某个指令，需要使用addr + offset的方式*/
</span><span class='line'>&#9;unsigned intoffset;
</span><span class='line'>
</span><span class='line'>&#9;/* Called before addr is executed. */
</span><span class='line'>&#9;/*探测函数，在目标探测点执行之前调用*/
</span><span class='line'>&#9;kprobe_pre_handler_t pre_handler;
</span><span class='line'>
</span><span class='line'>&#9;/* Called after addr is executed, unless... */
</span><span class='line'>&#9;/*探测函数，在目标探测点执行之后调用*/
</span><span class='line'>&#9;kprobe_post_handler_t post_handler;
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * ... called if executing addr causes a fault (eg. page fault).
</span><span class='line'>&#9; * Return 1 if it handled fault, otherwise kernel will see it.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;kprobe_fault_handler_t fault_handler;
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * ... called if breakpoint trap occurs in probe handler.
</span><span class='line'>&#9; * Return 1 if it handled break, otherwise kernel will see it.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;kprobe_break_handler_t break_handler;
</span><span class='line'>
</span><span class='line'>&#9;/*opcode 以及 ainsn 用于保存被替换的指令码*/
</span><span class='line'>
</span><span class='line'>&#9;/* Saved opcode (which has been replaced with breakpoint) */
</span><span class='line'>&#9;kprobe_opcode_t opcode;
</span><span class='line'>
</span><span class='line'>&#9;/* copy of the original instruction */
</span><span class='line'>&#9;structarch_specific_insn ainsn;
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * Indicates various status flags.
</span><span class='line'>&#9; * Protected by kprobe_mutex after this kprobe is registered.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;u32 flags;
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>  对于kprobe功能的实现主要利用了内核中的两个功能特性：异常（尤其是int 3），单步执行（EFLAGS中的TF标志）。</p>

<h5>大概的流程：</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> 1）在注册探测点的时候，对被探测函数的指令码进行替换，替换为int 3的指令码；
</span><span class='line'> 2）在执行int 3的异常执行中，通过通知链的方式调用kprobe的异常处理函数；
</span><span class='line'> 3）在kprobe的异常出来函数中，判断是否存在pre_handler钩子，存在则执行；
</span><span class='line'> 4）执行完后，准备进入单步调试，通过设置EFLAGS中的TF标志位，并且把异常返回的地址修改为保存的原指令码；
</span><span class='line'> 5）代码返回，执行原有指令，执行结束后触发单步异常；
</span><span class='line'> 6）在单步异常的处理中，清除单步标志，执行post_handler流程，并最终返回；</span></code></pre></td></tr></table></div></figure>


<p>  下面又进入代码时间，首先看一下kprobe模块的初始化代码，初始化代码主要做了两件事：标记出哪些代码是不能被探测的，这些代码属于kprobe实现的关键代码；注册通知链到die_notifier，用于接收异常通知。</p>

<h5>初始化代码位于kernel/kprobes.c中</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staticint__init init_kprobes(void)
</span><span class='line'>{
</span><span class='line'>&#9;inti,err =0;
</span><span class='line'>&#9;&#9;....
</span><span class='line'>
</span><span class='line'>&#9; /*kprobe_blacklist中保存的是kprobe实现的关键代码路径，这些函数不应该被kprobe探测*/
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * Lookup and populate the kprobe_blacklist.
</span><span class='line'>&#9; *
</span><span class='line'>&#9; * Unlike the kretprobe blacklist, we'll need to determine
</span><span class='line'>&#9; * the range of addresses that belong to the said functions,
</span><span class='line'>&#9; * since a kprobe need not necessarily be at the beginning
</span><span class='line'>&#9; * of a function.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;for(kb =kprobe_blacklist;kb-&gt;name!=NULL;kb++){
</span><span class='line'>&#9;&#9;kprobe_lookup_name(kb-&gt;name,addr);
</span><span class='line'>&#9;&#9;if(!addr)
</span><span class='line'>&#9;&#9;&#9;continue;
</span><span class='line'>
</span><span class='line'>&#9;&#9;kb-&gt;start_addr =(unsigned long)addr;
</span><span class='line'>&#9;&#9;symbol_name =kallsyms_lookup(kb-&gt;start_addr,
</span><span class='line'>&#9;&#9;&#9;&#9;&size,&offset,&modname,namebuf);
</span><span class='line'>&#9;&#9;if(!symbol_name)
</span><span class='line'>&#9;&#9;&#9;kb-&gt;range =0;
</span><span class='line'>&#9;&#9;else
</span><span class='line'>&#9;&#9;&#9;kb-&gt;range =size;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;&#9;....
</span><span class='line'>&#9;if(!err)
</span><span class='line'>&#9;&#9;/*注册通知链到die_notifier，用于接收int 3的异常信息*/
</span><span class='line'>&#9;&#9;err =register_die_notifier(&kprobe_exceptions_nb);
</span><span class='line'>&#9;&#9; ....
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h5>其中的通知链：</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>staticstructnotifier_block kprobe_exceptions_nb ={
</span><span class='line'>&#9;.notifier_call =kprobe_exceptions_notify,
</span><span class='line'>&#9;/*优先级最高，保证最先执行*/
</span><span class='line'>&#9;.priority =0x7fffffff /* we need to be notified first */
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<h6>kprobe的注册流程register_kprobe。</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int__kprobes register_kprobe(structkprobe *p)
</span><span class='line'>{
</span><span class='line'>&#9;intret =0;
</span><span class='line'>&#9;structkprobe *old_p;
</span><span class='line'>&#9;structmodule *probed_mod;
</span><span class='line'>&#9;kprobe_opcode_t *addr;
</span><span class='line'>
</span><span class='line'>&#9;/*获取被探测点的地址，指定了symbol_name，则从kallsyms中获取；指定了offset，则返回addr + offset*/
</span><span class='line'>&#9;addr =kprobe_addr(p);
</span><span class='line'>&#9;if(!addr)
</span><span class='line'>&#9;&#9;return-EINVAL;
</span><span class='line'>&#9;p-&gt;addr =addr;
</span><span class='line'>
</span><span class='line'>&#9;/*判断同一个kprobe是否被重复注册*/
</span><span class='line'>&#9;ret =check_kprobe_rereg(p);
</span><span class='line'>&#9;if(ret)
</span><span class='line'>&#9;&#9;returnret;
</span><span class='line'>
</span><span class='line'>&#9;jump_label_lock();
</span><span class='line'>&#9;preempt_disable();
</span><span class='line'>&#9;/*判断被注册的函数是否位于内核的代码段内，或位于不能探测的kprobe实现路径中*/
</span><span class='line'>&#9;if(!kernel_text_address((unsigned long)p-&gt;addr)||
</span><span class='line'>&#9;&#9;in_kprobes_functions((unsigned long)p-&gt;addr)||
</span><span class='line'>&#9;&#9;ftrace_text_reserved(p-&gt;addr,p-&gt;addr)||
</span><span class='line'>&#9;&#9;jump_label_text_reserved(p-&gt;addr,p-&gt;addr))
</span><span class='line'>&#9;&#9;gotofail_with_jump_label;
</span><span class='line'>
</span><span class='line'>&#9;/* User can pass only KPROBE_FLAG_DISABLED to register_kprobe */
</span><span class='line'>&#9;p-&gt;flags&=KPROBE_FLAG_DISABLED;
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * Check if are we probing a module.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;/*判断被探测的地址是否属于某一个模块，并且位于模块的text section内*/
</span><span class='line'>&#9;probed_mod =__module_text_address((unsigned long)p-&gt;addr);
</span><span class='line'>&#9;if(probed_mod){
</span><span class='line'>&#9;&#9;/*如果被探测的为模块地址，首先要增加模块的引用计数*/
</span><span class='line'>&#9;&#9;/*
</span><span class='line'>&#9;&#9; * We must hold a refcount of the probed module while updating
</span><span class='line'>&#9;&#9; * its code to prohibit unexpected unloading.
</span><span class='line'>&#9;&#9; */
</span><span class='line'>&#9;&#9;if(unlikely(!try_module_get(probed_mod)))
</span><span class='line'>&#9;&#9;&#9;gotofail_with_jump_label;
</span><span class='line'>
</span><span class='line'>&#9;&#9;/*
</span><span class='line'>&#9;&#9; * If the module freed .init.text, we couldn't insert
</span><span class='line'>&#9;&#9; * kprobes in there.
</span><span class='line'>&#9;&#9; */
</span><span class='line'>&#9;&#9;/*如果被探测的地址位于模块的init地址段内，但该段代码区间已被释放，则直接退出*/
</span><span class='line'>&#9;&#9;if(within_module_init((unsigned long)p-&gt;addr,probed_mod)&&
</span><span class='line'>&#9;&#9;&#9;probed_mod-&gt;state!=MODULE_STATE_COMING){
</span><span class='line'>&#9;&#9;&#9;module_put(probed_mod);
</span><span class='line'>&#9;&#9;&#9;gotofail_with_jump_label;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;preempt_enable();
</span><span class='line'>&#9;jump_label_unlock();
</span><span class='line'>
</span><span class='line'>&#9;p-&gt;nmissed =0;
</span><span class='line'>&#9;INIT_LIST_HEAD(&p-&gt;list);
</span><span class='line'>&#9;mutex_lock(&kprobe_mutex);
</span><span class='line'>
</span><span class='line'>&#9;jump_label_lock();/* needed to call jump_label_text_reserved() */
</span><span class='line'>
</span><span class='line'>&#9;get_online_cpus();    /* For avoiding text_mutex deadlock. */
</span><span class='line'>&#9;mutex_lock(&text_mutex);
</span><span class='line'>
</span><span class='line'>&#9;/*判断在同一个探测点是否已经注册了其他的探测函数*/
</span><span class='line'>&#9;old_p =get_kprobe(p-&gt;addr);
</span><span class='line'>&#9;if(old_p){
</span><span class='line'>&#9;&#9;/* Since this may unoptimize old_p, locking text_mutex. */
</span><span class='line'>&#9;&#9;/*如果已经存在注册过的kprobe，则将探测点的函数修改为aggr_pre_handler，并将所有的handler挂载到其链表上，由其负责所有handler函数的执行*/
</span><span class='line'>&#9;&#9;ret =register_aggr_kprobe(old_p,p);
</span><span class='line'>&#9;&#9;gotoout;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;/* 分配特定的内存地址用于保存原有的指令
</span><span class='line'>&#9; * 按照内核注释，被分配的地址必须must be on special executable page on x86.
</span><span class='line'>&#9; * 该地址被保存在kprobe-&gt;ainsn.insn
</span><span class='line'>&#9; */
</span><span class='line'>&#9;ret =arch_prepare_kprobe(p);
</span><span class='line'>&#9;if(ret)
</span><span class='line'>&#9;&#9;gotoout;
</span><span class='line'>
</span><span class='line'>&#9;/*将kprobe加入到相应的hash表内*/
</span><span class='line'>&#9;INIT_HLIST_NODE(&p-&gt;hlist);
</span><span class='line'>&#9;hlist_add_head_rcu(&p-&gt;hlist,
</span><span class='line'>&#9;&#9;&#9;   &kprobe_table[hash_ptr(p-&gt;addr,KPROBE_HASH_BITS)]);
</span><span class='line'>
</span><span class='line'>&#9;if(!kprobes_all_disarmed &&!kprobe_disabled(p))
</span><span class='line'>/*将探测点的指令码修改为int 3指令*/
</span><span class='line'>&#9;&#9;__arm_kprobe(p);
</span><span class='line'>
</span><span class='line'>&#9;/* Try to optimize kprobe */
</span><span class='line'>&#9;try_to_optimize_kprobe(p);
</span><span class='line'>
</span><span class='line'>out:
</span><span class='line'>&#9;mutex_unlock(&text_mutex);
</span><span class='line'>&#9;put_online_cpus();
</span><span class='line'>&#9;jump_label_unlock();
</span><span class='line'>&#9;mutex_unlock(&kprobe_mutex);
</span><span class='line'>
</span><span class='line'>&#9;if(probed_mod)
</span><span class='line'>&#9;&#9;module_put(probed_mod);
</span><span class='line'>
</span><span class='line'>&#9;returnret;
</span><span class='line'>
</span><span class='line'>fail_with_jump_label:
</span><span class='line'>&#9;preempt_enable();
</span><span class='line'>&#9;jump_label_unlock();
</span><span class='line'>&#9;return-EINVAL;</span></code></pre></td></tr></table></div></figure>


<h5>注册完毕，就开始kprobe的执行流程了。对于该探测点，由于其起始指令已经被修改为int3，因此在执行到该地址时，必然会触发3号中断向量的处理流程do_int3.</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* May run on IST stack. */
</span><span class='line'>dotraplinkage void__kprobes do_int3(structpt_regs *regs,longerror_code)
</span><span class='line'>{
</span><span class='line'>#ifdef CONFIG_KGDB_LOW_LEVEL_TRAP
</span><span class='line'>&#9;if(kgdb_ll_trap(DIE_INT3,"int3",regs,error_code,3,SIGTRAP)
</span><span class='line'>&#9;&#9;&#9;==NOTIFY_STOP)
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>#endif /* CONFIG_KGDB_LOW_LEVEL_TRAP */
</span><span class='line'>#ifdef CONFIG_KPROBES
</span><span class='line'>&#9;/*在这里以DIE_INT3，通知kprobe注册的通知链*/
</span><span class='line'>&#9;if(notify_die(DIE_INT3,"int3",regs,error_code,3,SIGTRAP)
</span><span class='line'>&#9;&#9;&#9;==NOTIFY_STOP)
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>#else
</span><span class='line'>&#9;if(notify_die(DIE_TRAP,"int3",regs,error_code,3,SIGTRAP)
</span><span class='line'>&#9;&#9;&#9;==NOTIFY_STOP)
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>#endif
</span><span class='line'>
</span><span class='line'>&#9;preempt_conditional_sti(regs);
</span><span class='line'>&#9;do_trap(3,SIGTRAP,"int3",regs,error_code,NULL);
</span><span class='line'>&#9;preempt_conditional_cli(regs);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h5>在do_int3中触发kprobe注册的通知链函数，kprobe_exceptions_notify。由于kprobe以及jprobe等机制的处 理核心都在此函数内，这里只针对kprobe的流程进行分析：进入函数的原因是DIE_INT3,并且是第一次进入该函数。</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int__kprobes kprobe_exceptions_notify(structnotifier_block *self,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;   unsigned longval,void*data)
</span><span class='line'>{
</span><span class='line'>&#9;structdie_args *args =data;
</span><span class='line'>&#9;intret =NOTIFY_DONE;
</span><span class='line'>
</span><span class='line'>&#9;if(args-&gt;regs &&user_mode_vm(args-&gt;regs))
</span><span class='line'>&#9;&#9;returnret;
</span><span class='line'>
</span><span class='line'>&#9;switch(val){
</span><span class='line'>&#9;caseDIE_INT3:
</span><span class='line'>/*对于kprobe，进入kprobe_handle*/
</span><span class='line'>&#9;&#9;if(kprobe_handler(args-&gt;regs))
</span><span class='line'>&#9;&#9;&#9;ret =NOTIFY_STOP;
</span><span class='line'>&#9;&#9;break;
</span><span class='line'>&#9;caseDIE_DEBUG:
</span><span class='line'>&#9;&#9;if(post_kprobe_handler(args-&gt;regs)){
</span><span class='line'>&#9;&#9;&#9;/*
</span><span class='line'>&#9;&#9;&#9; * Reset the BS bit in dr6 (pointed by args-&gt;err) to
</span><span class='line'>&#9;&#9;&#9; * denote completion of processing
</span><span class='line'>&#9;&#9;&#9; */
</span><span class='line'>&#9;&#9;&#9;(*(unsigned long*)ERR_PTR(args-&gt;err))&=~DR_STEP;
</span><span class='line'>&#9;&#9;&#9;ret =NOTIFY_STOP;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;break;
</span><span class='line'>&#9;caseDIE_GPF:
</span><span class='line'>&#9;&#9;/*
</span><span class='line'>&#9;&#9; * To be potentially processing a kprobe fault and to
</span><span class='line'>&#9;&#9; * trust the result from kprobe_running(), we have
</span><span class='line'>&#9;&#9; * be non-preemptible.
</span><span class='line'>&#9;&#9; */
</span><span class='line'>&#9;&#9;if(!preemptible()&&kprobe_running()&&
</span><span class='line'>&#9;&#9;&#9;kprobe_fault_handler(args-&gt;regs,args-&gt;trapnr))
</span><span class='line'>&#9;&#9;&#9;ret =NOTIFY_STOP;
</span><span class='line'>&#9;&#9;break;
</span><span class='line'>&#9;default:
</span><span class='line'>&#9;&#9;break;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;returnret;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>staticint__kprobes kprobe_handler(structpt_regs *regs)
</span><span class='line'>{
</span><span class='line'>&#9;kprobe_opcode_t *addr;
</span><span class='line'>&#9;structkprobe *p;
</span><span class='line'>&#9;structkprobe_ctlblk *kcb;
</span><span class='line'>
</span><span class='line'>&#9;/*对于int 3中断，其被Intel定义为Trap，那么异常发生时EIP寄存器内指向的为异常指令的后一条指令*/
</span><span class='line'>&#9;addr =(kprobe_opcode_t *)(regs-&gt;ip -sizeof(kprobe_opcode_t));
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * We don't want to be preempted for the entire
</span><span class='line'>&#9; * duration of kprobe processing. We conditionally
</span><span class='line'>&#9; * re-enable preemption at the end of this function,
</span><span class='line'>&#9; * and also in reenter_kprobe() and setup_singlestep().
</span><span class='line'>&#9; */
</span><span class='line'>&#9;preempt_disable();
</span><span class='line'>
</span><span class='line'>&#9;kcb =get_kprobe_ctlblk();
</span><span class='line'>&#9;/*获取addr对应的kprobe*/
</span><span class='line'>&#9;p =get_kprobe(addr);
</span><span class='line'>
</span><span class='line'>&#9;if(p){
</span><span class='line'>/*如果异常的进入是由kprobe导致，则进入reenter_kprobe(jprobe需要，到时候分析)*/
</span><span class='line'>&#9;&#9;if(kprobe_running()){
</span><span class='line'>&#9;&#9;&#9;if(reenter_kprobe(p,regs,kcb))
</span><span class='line'>&#9;&#9;&#9;&#9;return1;
</span><span class='line'>&#9;&#9;}else{
</span><span class='line'>&#9;&#9;&#9;set_current_kprobe(p,regs,kcb);
</span><span class='line'>&#9;&#9;&#9;kcb-&gt;kprobe_status =KPROBE_HIT_ACTIVE;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;/*
</span><span class='line'>&#9;&#9;&#9; * If we have no pre-handler or it returned 0, we
</span><span class='line'>&#9;&#9;&#9; * continue with normal processing.  If we have a
</span><span class='line'>&#9;&#9;&#9; * pre-handler and it returned non-zero, it prepped
</span><span class='line'>&#9;&#9;&#9; * for calling the break_handler below on re-entry
</span><span class='line'>&#9;&#9;&#9; * for jprobe processing, so get out doing nothing
</span><span class='line'>&#9;&#9;&#9; * more here.
</span><span class='line'>&#9;&#9;&#9; */
</span><span class='line'>&#9;/*执行在此地址上挂载的pre_handle函数*/
</span><span class='line'>&#9;&#9;&#9;if(!p-&gt;pre_handler ||!p-&gt;pre_handler(p,regs))
</span><span class='line'>/*设置单步调试模式，为post_handle函数的执行做准备*/
</span><span class='line'>&#9;&#9;&#9;&#9;setup_singlestep(p,regs,kcb,0);
</span><span class='line'>&#9;&#9;&#9;return1;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}elseif(*addr !=BREAKPOINT_INSTRUCTION){
</span><span class='line'>&#9;&#9;/*
</span><span class='line'>&#9;&#9; * The breakpoint instruction was removed right
</span><span class='line'>&#9;&#9; * after we hit it.  Another cpu has removed
</span><span class='line'>&#9;&#9; * either a probepoint or a debugger breakpoint
</span><span class='line'>&#9;&#9; * at this address.  In either case, no further
</span><span class='line'>&#9;&#9; * handling of this interrupt is appropriate.
</span><span class='line'>&#9;&#9; * Back up over the (now missing) int3 and run
</span><span class='line'>&#9;&#9; * the original instruction.
</span><span class='line'>&#9;&#9; */
</span><span class='line'>&#9;&#9;regs-&gt;ip =(unsigned long)addr;
</span><span class='line'>&#9;&#9;preempt_enable_no_resched();
</span><span class='line'>&#9;&#9;return1;
</span><span class='line'>&#9;}elseif(kprobe_running()){
</span><span class='line'>&#9;&#9;p =__this_cpu_read(current_kprobe);
</span><span class='line'>&#9;&#9;if(p-&gt;break_handler &&p-&gt;break_handler(p,regs)){
</span><span class='line'>&#9;&#9;&#9;setup_singlestep(p,regs,kcb,0);
</span><span class='line'>&#9;&#9;&#9;return1;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}/* else: not a kprobe fault; let the kernel handle it */
</span><span class='line'>
</span><span class='line'>&#9;preempt_enable_no_resched();
</span><span class='line'>&#9;return0;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>staticvoid__kprobes setup_singlestep(structkprobe *p,structpt_regs *regs,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;   structkprobe_ctlblk *kcb,intreenter)
</span><span class='line'>{
</span><span class='line'>&#9;if(setup_detour_execution(p,regs,reenter))
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>
</span><span class='line'>#if!defined(CONFIG_PREEMPT)
</span><span class='line'>&#9;if(p-&gt;ainsn.boostable ==1 &&!p-&gt;post_handler){
</span><span class='line'>&#9;&#9;/* Boost up -- we can execute copied instructions directly */
</span><span class='line'>&#9;&#9;if(!reenter)
</span><span class='line'>&#9;&#9;&#9;reset_current_kprobe();
</span><span class='line'>&#9;&#9;/*
</span><span class='line'>&#9;&#9; * Reentering boosted probe doesn't reset current_kprobe,
</span><span class='line'>&#9;&#9; * nor set current_kprobe, because it doesn't use single
</span><span class='line'>&#9;&#9; * stepping.
</span><span class='line'>&#9;&#9; */
</span><span class='line'>&#9;&#9;regs-&gt;ip =(unsigned long)p-&gt;ainsn.insn;
</span><span class='line'>&#9;&#9;preempt_enable_no_resched();
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>&#9;}
</span><span class='line'>#endif
</span><span class='line'>&#9;/*jprobe*/
</span><span class='line'>&#9;if(reenter){
</span><span class='line'>&#9;&#9;save_previous_kprobe(kcb);
</span><span class='line'>&#9;&#9;set_current_kprobe(p,regs,kcb);
</span><span class='line'>&#9;&#9;kcb-&gt;kprobe_status =KPROBE_REENTER;
</span><span class='line'>&#9;}else
</span><span class='line'>&#9;&#9;kcb-&gt;kprobe_status =KPROBE_HIT_SS;
</span><span class='line'>&#9;/* Prepare real single stepping */
</span><span class='line'>&#9;/*准备单步模式，设置EFLAGS的TF标志位，清楚IF标志位(禁止中断)*/
</span><span class='line'>&#9;clear_btf();
</span><span class='line'>&#9;regs-&gt;flags|=X86_EFLAGS_TF;
</span><span class='line'>&#9;regs-&gt;flags&=~X86_EFLAGS_IF;
</span><span class='line'>&#9;/* single step inline if the instruction is an int3 */
</span><span class='line'>&#9;if(p-&gt;opcode ==BREAKPOINT_INSTRUCTION)
</span><span class='line'>&#9;&#9;regs-&gt;ip =(unsigned long)p-&gt;addr;
</span><span class='line'>&#9;else
</span><span class='line'>/*设置异常返回的指令为保存的被探测点的指令*/
</span><span class='line'>&#9;&#9;regs-&gt;ip =(unsigned long)p-&gt;ainsn.insn;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h5>对应kprobe,pre_handle的执行就结束了，按照代码，程序开始执行保存的被探测点的指令，由于开启了单步调试模式，执行完指令后会继续触发异常，这次的是do_debug异常处理流程。</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dotraplinkage void__kprobes do_debug(structpt_regs *regs,longerror_code)
</span><span class='line'>{
</span><span class='line'>&#9;....
</span><span class='line'>
</span><span class='line'>&#9;/*在do_debug中，以DIE_DEBUG再一次触发kprobe的通知链*/
</span><span class='line'>&#9;if(notify_die(DIE_DEBUG,"debug",regs,PTR_ERR(&dr6),error_code,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;SIGTRAP)==NOTIFY_STOP)
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>   
</span><span class='line'>&#9;....
</span><span class='line'>&#9;return;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>/*对于kprobe_exceptions_notify，其DIE_DEBUG处理流程*/
</span><span class='line'>caseDIE_DEBUG:
</span><span class='line'>&#9;&#9;if(post_kprobe_handler(args-&gt;regs)){
</span><span class='line'>&#9;&#9;&#9;/*
</span><span class='line'>&#9;&#9;&#9; * Reset the BS bit in dr6 (pointed by args-&gt;err) to
</span><span class='line'>&#9;&#9;&#9; * denote completion of processing
</span><span class='line'>&#9;&#9;&#9; */
</span><span class='line'>&#9;&#9;&#9;(*(unsigned long*)ERR_PTR(args-&gt;err))&=~DR_STEP;
</span><span class='line'>&#9;&#9;&#9;ret =NOTIFY_STOP;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;break;
</span><span class='line'>
</span><span class='line'>staticint__kprobes post_kprobe_handler(structpt_regs *regs)
</span><span class='line'>{
</span><span class='line'>&#9;structkprobe *cur =kprobe_running();
</span><span class='line'>&#9;structkprobe_ctlblk *kcb =get_kprobe_ctlblk();
</span><span class='line'>
</span><span class='line'>&#9;if(!cur)
</span><span class='line'>&#9;&#9;return0;
</span><span class='line'>
</span><span class='line'>&#9;/*设置异常返回的EIP为下一条需要执行的指令*/
</span><span class='line'>&#9;resume_execution(cur,regs,kcb);
</span><span class='line'>&#9;/*恢复异常执行前的EFLAGS*/
</span><span class='line'>&#9;regs-&gt;flags|=kcb-&gt;kprobe_saved_flags;
</span><span class='line'>
</span><span class='line'>&#9;/*执行post_handler函数*/
</span><span class='line'>&#9;if((kcb-&gt;kprobe_status !=KPROBE_REENTER)&&cur-&gt;post_handler){
</span><span class='line'>&#9;&#9;kcb-&gt;kprobe_status =KPROBE_HIT_SSDONE;
</span><span class='line'>&#9;&#9;cur-&gt;post_handler(cur,regs,0);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;/* Restore back the original saved kprobes variables and continue. */
</span><span class='line'>&#9;if(kcb-&gt;kprobe_status ==KPROBE_REENTER){
</span><span class='line'>&#9;&#9;restore_previous_kprobe(kcb);
</span><span class='line'>&#9;&#9;gotoout;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;reset_current_kprobe();
</span><span class='line'>out:
</span><span class='line'>&#9;preempt_enable_no_resched();
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9; * if somebody else is singlestepping across a probe point, flags
</span><span class='line'>&#9; * will have TF set, in which case, continue the remaining processing
</span><span class='line'>&#9; * of do_debug, as if this is not a probe hit.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;if(regs-&gt;flags&X86_EFLAGS_TF)
</span><span class='line'>&#9;&#9;return0;
</span><span class='line'>
</span><span class='line'>&#9;return1;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>至此，一个典型的kprobe的流程已经执行完毕了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2013/05/23/command-addr2line/">addr2line命令</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-05-23T18:14:00+08:00'><span class='date'>2013-05-23</span> <span class='time'>18:14:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这是一个示例程序，func函数返回参数a除以参数b的结果。这里使用0作为除数，结果就是程序因为除以0导致错误，直接中断了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>int func(int a, int b)
</span><span class='line'>{
</span><span class='line'>&#9;return a / b;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int main()
</span><span class='line'>{
</span><span class='line'>&#9;int x = 10;
</span><span class='line'>&#9;int y = 0;
</span><span class='line'>&#9;printf("%d / %d = %d\n", x, y, func(x, y));
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gcc -o test1 -g test1.c  </span></code></pre></td></tr></table></div></figure>


<p>编译程序，test1.c是程序文件名。执行程序，结果程序异常中断。查看系统dmesg信息，发现系统日志的错误信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[54106.016179] test1[8352] trap divide error ip:400506 sp:7fff2add87e0 error:0 in test1[400000+1000]</span></code></pre></td></tr></table></div></figure>


<p>这条信息里的ip字段后面的数字就是test1程序出错时所程序执行的位置。使用addr2line就可以将400506转换成出错程序的位置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ addr2line -e test1 400506  
</span><span class='line'>/home/hanfoo/code/test/addr2line/test1.c:5</span></code></pre></td></tr></table></div></figure>


<p>这里的test1.c:5指的就是test1.c的第5行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>return a / b;  </span></code></pre></td></tr></table></div></figure>


<p>也正是这里出现的错误。addr2line帮助我们解决了问题。</p>

<p>  addr2line如何找到的这一行呢。在可执行程序中都包含有调试信息， 其中很重要的一份数据就是程序源程序的行号和编译后的机器代码之间的对应关系Line Number Table。DWARF格式的Line  Number Table是一种高度压缩的数据，存储的是表格前后两行的差值，在解析调试信息时，需要按照规则在内存里重建Line Number  Table才能使用。</p>

<p>Line Number Table存储在可执行程序的.debug_line域，使用命令</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ readelf -w test1</span></code></pre></td></tr></table></div></figure>


<p>可以输出DWARF的调试信息，其中有两行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Special opcode 146: advance Address by 10 to 0x4004fe and Line by 1 to 5  
</span><span class='line'>Special opcode 160: advance Address by 11 to 0x400509 and Line by 1 to 6  </span></code></pre></td></tr></table></div></figure>


<p>这里说明机器二进制编码的0x4004fe位置开始，对应于源码中的第5行，0x400509开始就对应与源码的第6行了，所以400506这个地址对应的是源码第5行位置。</p>

<p>addr2line通过分析调试信息中的Line Number Table自动就能把源码中的出错位置找出来.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2013/05/13/command-tcpdump/">抓包命令tcpdump</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-05-13T09:47:00+08:00'><span class='date'>2013-05-13</span> <span class='time'>09:47:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>例:tcpdump host 172.16.29.40 and port 4600 -X -s 500</p>

<p>tcpdump采用命令行方式，它的命令格式为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  tcpdump [ -adeflnNOpqStvx ] [ -c 数量 ] [ -F 文件名 ]
</span><span class='line'>　　　　　　[ -i 网络接口 ] [ -r 文件名] [ -s snaplen ]
</span><span class='line'>　　　　　　[ -T 类型 ] [ -w 文件名 ] [表达式 ]</span></code></pre></td></tr></table></div></figure>


<h4>1. tcpdump的选项介绍</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&#9;-a       将网络地址和广播地址转变成名字；
</span><span class='line'>&#9;-d        将匹配信息包的代码以人们能够理解的汇编格式给出；
</span><span class='line'>&#9;-dd       将匹配信息包的代码以c语言程序段的格式给出；
</span><span class='line'>&#9;-ddd  将匹配信息包的代码以十进制的形式给出；
</span><span class='line'>&#9;-e        在输出行打印出数据链路层的头部信息；
</span><span class='line'>&#9;-f        将外部的Internet地址以数字的形式打印出来；
</span><span class='line'>&#9;-l        使标准输出变为缓冲行形式；
</span><span class='line'>&#9;-n        不把网络地址转换成名字；
</span><span class='line'>&#9;-t        在输出的每一行不打印时间戳；
</span><span class='line'>&#9;-v        输出一个稍微详细的信息，例如在ip包中可以包括ttl和服务类型的信息；
</span><span class='line'>&#9;-vv       输出详细的报文信息；
</span><span class='line'>&#9;-c        在收到指定的包的数目后，tcpdump就会停止；
</span><span class='line'>&#9;-F        从指定的文件中读取表达式,忽略其它的表达式；
</span><span class='line'>&#9;-i        指定监听的网络接口；
</span><span class='line'>&#9;-r        从指定的文件中读取包(这些包一般通过-w选项产生)；
</span><span class='line'>&#9;-w        直接将包写入文件中，并不分析和打印出来；
</span><span class='line'>&#9;-T        将监听到的包直接解释为指定的类型的报文，常见的类型有rpc （远程过程调用）和snmp（简单网络管理协议）</span></code></pre></td></tr></table></div></figure>


<h4>2. tcpdump的表达式介绍</h4>

<p>  表达式是一个正则表达式，tcpdump利用它作为过滤报文的条件，如果一个报文满足表
达式的条件，则这个报文将会被捕获。如果没有给出任何条件，则网络上所有的信息包将会
被截获。</p>

<p>  在表达式中一般如下几种类型的关键字，一种是关于类型的关键字，主要包括host，
net，port, 例如 host 210.27.48.2，指明 210.27.48.2是一台主机，net 202.0.0.0 指明
202.0.0.0是一个网络地址，port 23 指明端口号是23。如果没有指定类型，缺省的类型是
host.</p>

<p>  第二种是确定传输方向的关键字，主要包括src , dst ,dst or src, dst and src ,
这些关键字指明了传输的方向。举例说明，src 210.27.48.2 ,指明ip包中源地址是210.27.
48.2 , dst net 202.0.0.0 指明目的网络地址是202.0.0.0 。如果没有指明方向关键字，则
缺省是src or dst关键字。</p>

<p>  第三种是协议的关键字，主要包括fddi,ip ,arp,rarp,tcp,udp等类型。Fddi指明是在
FDDI(分布式光纤数据接口网络)上的特定的网络协议，实际上它是"ether"的别名，fddi和e
ther具有类似的源地址和目的地址，所以可以将fddi协议包当作ether的包进行处理和分析。
其他的几个关键字就是指明了监听的包的协议内容。如果没有指定任何协议，则tcpdump将会
监听所有协议的信息包。</p>

<p>  除了这三种类型的关键字之外，其他重要的关键字如下：gateway, broadcast,less,
greater,还有三种逻辑运算，取非运算是 &lsquo;not &rsquo; &lsquo;! &rsquo;, 与运算是'and',&lsquo;&amp;&amp;&rsquo;;或运算 是'o
r' ,&lsquo;||'；</p>

<p>  这些关键字可以组合起来构成强大的组合条件来满足人们的需要，下面举几个例子来
说明。<br/>
   (1)想要截获所有210.27.48.1 的主机收到的和发出的所有的数据包:<br/>
　　　　#tcpdump host 210.27.48.1 <br/>
   (2) 想要截获主机210.27.48.1 和主机210.27.48.2 或210.27.48.3的通信:<br/>
　　　　#tcpdump host 210.27.48.1 and ( 210.27.48.2 or 210.27.48.3 ) <br/>
   (3) 如果想要获取主机210.27.48.1除了和主机210.27.48.2之外所有主机通信的ip包:<br/>
　　　　#tcpdump ip host 210.27.48.1 and ! 210.27.48.2<br/>
   (4)如果想要获取主机210.27.48.1接收或发出的telnet包，使用如下命令：<br/>
　　　　#tcpdump tcp port 23 host 210.27.48.1</p>

<h4>3. tcpdump 的输出结果介绍</h4>

<p>下面我们介绍几种典型的tcpdump命令的输出信息</p>

<h5>(1) 数据链路层头信息</h5>

<p> 使用命令#tcpdump &ndash;e host ice<br/>
  ice 是一台装有linux的主机，她的MAC地址是0：90：27：58：AF：1A
  H219是一台装有SOLARIC的SUN工作站，它的MAC地址是8：0：20：79：5B：46；上一条<br/>
命令的输出结果如下所示：<br/>
21:50:12.847509 eth0 &lt; 8:0:20:79:5b:46 0:90:27:58:af:1a ip 60: h219.33357 > ice.<br/>
telne<br/>
t 0:0(0) ack 22535 win 8760 (DF)<br/>
 分析：21：50：12是显示的时间， 847509是ID号，eth0 &lt;表示从网络接口eth0 接受该<br/>
数据包，eth0 >表示从网络接口设备发送数据包, 8:0:20:79:5b:46是主机H219的MAC地址,它<br/>
表明是从源地址H219发来的数据包. 0:90:27:58:af:1a是主机ICE的MAC地址,表示该数据包的<br/>
目的地址是ICE . ip 是表明该数据包是IP数据包,60 是数据包的长度, h219.33357 > ice.<br/>
telnet 表明该数据包是从主机H219的33357端口发往主机ICE的TELNET(23)端口. ack 22535<br/>
表明对序列号是222535的包进行响应. win 8760表明发送窗口的大小是8760.</p>

<h5>(2) ARP包的TCPDUMP输出信息</h5>

<p> 使用命令#tcpdump arp
得到的输出结果是：<br/>
22:32:42.802509 eth0 > arp who-has route tell ice (0:90:27:58:af:1a)<br/>
　　22:32:42.802902 eth0 &lt; arp reply route is-at 0:90:27:12:10:66 (0:90:27:58:af:1a)<br/>
 分析: 22:32:42是时间戳, 802509是ID号, eth0 >表明从主机发出该数据包, arp表明是<br/>
ARP请求包, who-has route tell ice表明是主机ICE请求主机ROUTE的MAC地址。 0:90:27:58:af:1a是主机ICE的MAC地址。</p>

<h5>(3) TCP包的输出信息</h5>

<p> 用TCPDUMP捕获的TCP包的一般输出信息是：
src > dst: flags data-seqno ack window urgent options<br/>
src > dst:表明从源地址到目的地址, flags是TCP包中的标志信息,S 是SYN标志, F (FIN), P (PUSH) , R (RST) &ldquo;.&rdquo; (没有标记); data-seqno是数据包中的数据的顺序号, ack是下次期望的顺序号, window是接收缓存的窗口大小, urgent表明数据包中是否有紧急指针. Options是选项.</p>

<h5>(4) UDP包的输出信息</h5>

<p> 用TCPDUMP捕获的UDP包的一般输出信息是：<br/>
route.port1 > ice.port2: udp lenth<br/>
UDP十分简单，上面的输出行表明从主机ROUTE的port1端口发出的一个UDP数据包到主机ICE的port2端口，类型是UDP， 包的长度是lenth</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2013/05/07/kernel-symbol/">获取Linux内核未导出符号</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-05-07T18:16:00+08:00'><span class='date'>2013-05-07</span> <span class='time'>18:16:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>  从Linux内核的2.6某个版本开始，内核引入了导出符号的机制。只有在内核中使用EXPORT_SYMBOL或EXPORT_SYMBOL_GPL导出的符号才能在内核模块中直接使用。</p>

<p>然而，内核并没有导出所有的符号。例如，在3.8.0的内核中，do_page_fault就没有被导出。</p>

<p>而我的内核模块中需要使用do_page_fault，那么有那些方法呢？这些方法分别有什么优劣呢？</p>

<p>下面以do_page_fault为例，一一进行分析：<br/>
  修改内核，添加EXPORT_SYMBOL(do_page_fault)或EXPORT_SYMBOL_GPL(do_page_fault)。<br/>
  这种方法适用于可以修改内核的情形。在可以修改内核的情况下，这是最简单的方式。</p>

<h5>使用kallsyms_lookup_name读取</h5>

<p>  kallsyms_lookup_name本身也是一个内核符号，如果这个符号被导出了，那么就可以在内核模块中调用kallsyms_lookup_name(&ldquo;do_page_fault&rdquo;)来获得do_page_fault的符号地址。<br/>
  这种方法的局限性在于kallsyms_lookup_name本身不一定被导出。</p>

<h5>读取/boot/System.map-<kernel-version>，再使用内核模块参数传入内核模块</h5>

<p>  System.map-<kernel- version>是编译内核时产生的，它里面记录了编译时内核符号的地址。如果能够保证当前使用的内核与 System.map-<kernel-version>是一一对应的，那么从System.map-<kernel- version>中读出的符号地址就是正确的。其中，kernel-version可以通过'uname -r'获得。<br/>
  但是这种方法也有局限性，在模块运行的时候，System.map-<kernel-version>文件不一定存在，即使存在也不能保证与当前内核是正确对应的。</p>

<h5>读取/proc/kallsyms，再使用内核模块参数传入内核模块</h5>

<p>  /proc/kallsyms是一个特殊的文件，它并不是存储在磁盘上的文件。这个文件只有被读取的时候，才会由内核产生内容。因为这些内容是内核动态生成的，所以 可以保证其中读到的地址是正确的，不会有System.map-<kernel-version>的问题。<br/>
  需要注意的是，从内核 2.6.37开始，普通用户是没有办法从/proc/kallsyms中读到正确的值(需要内核指针的禁用/proc/sys/kernel/kptr_restrict设置为0)。在某些版本中，该文件为空，在较新的版本中，该文件中所有符号的地 址均为0。但是root用户是可以从/proc/kallsyms中读到正确的值的。好在加载模块也需要root权限，可以在加载模块时用脚本获取符号的 地址。命令：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#cat /proc/kallsyms | grep "\&lt;do_page_fault\&gt;" | awk '{print $1}'</span></code></pre></td></tr></table></div></figure>


<hr />

<p>内核符号表中，第一列为函数或变量的在内核中的地址，第二列为符号的类型，第三列为符号名，第四列为符号所属的模块。若第四列为空，则表示该符号属于内核代码。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>符号属性    含义
</span><span class='line'>b    符号在未初始化数据区（BSS）
</span><span class='line'>c    普通符号，是未初始化区域
</span><span class='line'>d    符号在初始化数据区
</span><span class='line'>g    符号针对小object，在初始化数据区
</span><span class='line'>i    非直接引用其他符号的符号
</span><span class='line'>n    调试符号
</span><span class='line'>r    符号在只读数据区
</span><span class='line'>s    符号针对小object，在未初始化数据区
</span><span class='line'>t    符号在代码段
</span><span class='line'>u    符号未定义</span></code></pre></td></tr></table></div></figure>


<p>若符号在内核中是全局性的，则属性为大写字母，如T、U等。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2013/05/07/lang-c-flush-out/">C语言输出缓冲区函数说明</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-05-07T18:15:00+08:00'><span class='date'>2013-05-07</span> <span class='time'>18:15:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>
</span><span class='line'>int main(void)
</span><span class='line'>{
</span><span class='line'>&#9;int i = 0;
</span><span class='line'>&#9;while(1) {
</span><span class='line'>&#9;&#9;printf("sleeping %d", i++); //(1)
</span><span class='line'>&#9;&#9;fflush(stdout);
</span><span class='line'>&#9;&#9;sleep(1);
</span><span class='line'>&#9;}
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>1</h4>

<p>printf将"sleeping %d"输出到标准输出文件的缓冲区中(缓冲区在内存上)，fflush(stdout)将缓冲区中的内容强制刷新到，并将其中的内容输出到显示器上(&ldquo;\n"回车换行 == fflush(stdout)+换行)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>fflush()
</span><span class='line'>buffer(In memroy) -----------&gt; hard disk/monitor</span></code></pre></td></tr></table></div></figure>


<h4>2</h4>

<p>有三个流(stream)是自动打开的， 相应的FILE结构指针为stdin、stdout、stderr，与之对应的文件描述符是：STDIN_FILENO、STDOUT_FILENO、STDERR_FILENO。</p>

<h4>流缓冲的属性：</h4>

<p>缓冲区类型有：全缓冲(大部分缓冲都是这类型)、行缓冲(例如stdio,stdout)、无缓冲(例如stderr)。<br/>
关于全缓冲，例如普通的文件操作，进行fputs、fprintf操作后，数据并没有立即写入磁盘文件中，当fflush或fclose文件时，数据才真正写入。<br/>
可以用以下函数设置流的缓冲类型：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void setvbuf()  
</span><span class='line'>void setbuf()  
</span><span class='line'>void setbuffer()  
</span><span class='line'>void setlinebuf()</span></code></pre></td></tr></table></div></figure>


<h4>3</h4>

<p>fflush() 是把 FILE *里的缓冲区(位于用户态进程空间)刷新到内核中<br/>
fsync() -是把内核中对应的缓冲(是在 vfs 层的缓冲)刷新到硬盘中</p>

<h4>4</h4>

<p>在Linux的标准函数库中，有一套称作“高级I/O”的函数，我们熟知的printf()、fopen()、fread()、fwrite()都在此 列，它们也被称作“缓冲I/O（buffered I/O）”，每次写文件的时候，也仅仅是写入内存中的缓冲区，等满足了一定的条件（达到一定数量，或遇到特定字符，如换行符\n和文件结束符EOF），再 将缓冲区中的内容一次性写入文件，这样就大大增加了文件读写的速度。</p>

<hr />

<p>  The three types of buffering available are unbuffered, block buffered, and line buffered. When an output stream is unbuffered, information appears on the destination file or terminal as soon as written; when it is block buffered many characters are saved up and written as a block; when it is line buffered characters are saved up until a newline is output or input is read from any stream attached to a terminal device (typically stdin). The function fflush(3) may be used to force the block out early. (See fclose(3).) Normally all files are block buffered. When the first I/O operation occurs on a file, malloc(3) is called, and a buffer is obtained. If a stream refers to a terminal (as stdout normally does) it is line buffered. The standard error
stream stderr is always unbuffered by default.</p>

<p>  一般来说，block buffered的效率高些，将多次的操作合并成一次操作。先在标准库里缓存一部分，直到该缓冲区满了，或者程序显示的调用fflush时，将进行更新操作。而setbuf 则可以设置该缓冲区的大小。</p>

<h5>setbuf()</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>void setbuf(FILE *stream, char *buf);</span></code></pre></td></tr></table></div></figure>


<p>这个函数应该必须在如何输出被写到该文件之前调用。一般放在main里靠前面的语句！但是setbuf有个经典的错误，man手册上也提到了，c陷阱和缺陷上也提到了
You must make sure that both buf and the space it points to still exist by the time stream is closed, which also happens at program termination. For example, the following is illegal:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>int main()
</span><span class='line'>{
</span><span class='line'>&#9;char buf[BUFSIZ];
</span><span class='line'>&#9;setbuf(stdin, buf);
</span><span class='line'>&#9;printf("Hello, world!\n");
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>这个程序是错误的。buf缓冲区最后一次清空应该在main函数结束之后，程序交回控制给操作系统之前C运行库所必须进行的清理工作的一部分，但是此时 buf字符数组已经释放。修改的方法是将buf设置为static，或者全局变量； 或者调用malloc来动态申请内存。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>char * malloc();
</span><span class='line'>setbuf(stdout,malloc(BUFSIZE));</span></code></pre></td></tr></table></div></figure>


<p>这里不需要判断malloc的返回值，如果malloc调用失败，将返回一个null指针，setbuf的第二个参数可以是null,此时不进行缓冲！</p>

<h5>fflush()</h5>

<p>fflush函数则刷新缓冲区，将缓冲区上的内容更新到文件里。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>int fflush(FILE *stream);</span></code></pre></td></tr></table></div></figure>


<p>  The function fflush forces a write of all user-space buffered data for the given output or update stream via the stream underlying write function. The open status of the stream is unaffected. If the stream argument is NULL, fflush flushes all open output streams.</p>

<p>但是fflush仅仅刷新C库里的缓冲。其他的一些数据的刷新需要调用fsync或者sync!</p>

<p>  Note that fflush() only flushes the user space buffers provided by the C library. To ensure that the data is physically stored on disk the kernel buffers must be flushed too, e.g. with sync(2) or fsync(2).</p>

<h5>fsync()和sync()</h5>

<p>  fsync和sync最终将缓冲的数据更新到文件里。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>int fsync(int fd);</span></code></pre></td></tr></table></div></figure>


<p>  fsync copies all in-core parts of a file to disk, and waits until the device reports that all parts are on stable storage. It also updates metadata stat information. It does not necessarily ensure that the entry in the directory containing the file has also reached disk. For that an explicit fsync on the file descriptor of the directory is also needed.</p>

<p>  同步命令sync就直接调用了sync函数来更新磁盘上的缓冲！</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/70">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/68">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
<h1>Categories</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/language/'>language</a><a href='##' onmousedown=showDiv('language') id='aexp_language'><span class='exp_style' id='exp_language'>[+]</span></a><span class='right_span'>(38)</span></li>
<div id='language' class='catsub'><li><a href='/blog/cats/language~c/?opendiv=language'>c</a><a href='##' onmousedown=showDiv('language~c') id='aexp_language~c'><span class='exp_style' id='exp_language~c'>[+]</span></a><span class='right_span'>21</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~c')) document.getElementById('aexp_language~c').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~java/?opendiv=language'>java</a><a href='##' onmousedown=showDiv('language~java') id='aexp_language~java'><span class='exp_style' id='exp_language~java'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~java')) document.getElementById('aexp_language~java').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~web/?opendiv=language'>web</a><a href='##' onmousedown=showDiv('language~web') id='aexp_language~web'><span class='exp_style' id='exp_language~web'>[+]</span></a><span class='right_span'>6</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('language')) document.getElementById('aexp_language').style.visibility = 'hidden';
if (!document.getElementById('language~web')) document.getElementById('aexp_language~web').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/compiler/'>compiler</a><a href='##' onmousedown=showDiv('compiler') id='aexp_compiler'><span class='exp_style' id='exp_compiler'>[+]</span></a><span class='right_span'>(14)</span></li>
<div id='compiler' class='catsub'><li><a href='/blog/cats/compiler~base/?opendiv=compiler'>base</a><a href='##' onmousedown=showDiv('compiler~base') id='aexp_compiler~base'><span class='exp_style' id='exp_compiler~base'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler~base')) document.getElementById('aexp_compiler~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/compiler~make/?opendiv=compiler'>make</a><a href='##' onmousedown=showDiv('compiler~make') id='aexp_compiler~make'><span class='exp_style' id='exp_compiler~make'>[+]</span></a><span class='right_span'>4</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler')) document.getElementById('aexp_compiler').style.visibility = 'hidden';
if (!document.getElementById('compiler~make')) document.getElementById('aexp_compiler~make').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/assembly/'>assembly</a><a href='##' onmousedown=showDiv('assembly') id='aexp_assembly'><span class='exp_style' id='exp_assembly'>[+]</span></a><span class='right_span'>(15)</span></li>
<div id='assembly' class='catsub'><li><a href='/blog/cats/assembly~arm/?opendiv=assembly'>arm</a><a href='##' onmousedown=showDiv('assembly~arm') id='aexp_assembly~arm'><span class='exp_style' id='exp_assembly~arm'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly~arm')) document.getElementById('aexp_assembly~arm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/assembly~base/?opendiv=assembly'>base</a><a href='##' onmousedown=showDiv('assembly~base') id='aexp_assembly~base'><span class='exp_style' id='exp_assembly~base'>[+]</span></a><span class='right_span'>13</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly')) document.getElementById('aexp_assembly').style.visibility = 'hidden';
if (!document.getElementById('assembly~base')) document.getElementById('aexp_assembly~base').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/tools/'>tools</a><a href='##' onmousedown=showDiv('tools') id='aexp_tools'><span class='exp_style' id='exp_tools'>[+]</span></a><span class='right_span'>(50)</span></li>
<div id='tools' class='catsub'><li><a href='/blog/cats/tools~base/?opendiv=tools'>base</a><a href='##' onmousedown=showDiv('tools~base') id='aexp_tools~base'><span class='exp_style' id='exp_tools~base'>[+]</span></a><span class='right_span'>14</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~base')) document.getElementById('aexp_tools~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ci/?opendiv=tools'>ci</a><a href='##' onmousedown=showDiv('tools~ci') id='aexp_tools~ci'><span class='exp_style' id='exp_tools~ci'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~ci')) document.getElementById('aexp_tools~ci').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~command/?opendiv=tools'>command</a><a href='##' onmousedown=showDiv('tools~command') id='aexp_tools~command'><span class='exp_style' id='exp_tools~command'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~command')) document.getElementById('aexp_tools~command').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~git/?opendiv=tools'>git</a><a href='##' onmousedown=showDiv('tools~git') id='aexp_tools~git'><span class='exp_style' id='exp_tools~git'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~git')) document.getElementById('aexp_tools~git').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~haproxy/?opendiv=tools'>haproxy</a><a href='##' onmousedown=showDiv('tools~haproxy') id='aexp_tools~haproxy'><span class='exp_style' id='exp_tools~haproxy'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~haproxy')) document.getElementById('aexp_tools~haproxy').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~mysql/?opendiv=tools'>mysql</a><a href='##' onmousedown=showDiv('tools~mysql') id='aexp_tools~mysql'><span class='exp_style' id='exp_tools~mysql'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~mysql')) document.getElementById('aexp_tools~mysql').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ssh/?opendiv=tools'>ssh</a><a href='##' onmousedown=showDiv('tools~ssh') id='aexp_tools~ssh'><span class='exp_style' id='exp_tools~ssh'>[+]</span></a><span class='right_span'>3</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('tools')) document.getElementById('aexp_tools').style.visibility = 'hidden';
if (!document.getElementById('tools~ssh')) document.getElementById('aexp_tools~ssh').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/system/'>system</a><a href='##' onmousedown=showDiv('system') id='aexp_system'><span class='exp_style' id='exp_system'>[+]</span></a><span class='right_span'>(51)</span></li>
<div id='system' class='catsub'><li><a href='/blog/cats/system~base/?opendiv=system'>base</a><a href='##' onmousedown=showDiv('system~base') id='aexp_system~base'><span class='exp_style' id='exp_system~base'>[+]</span></a><span class='right_span'>14</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~base')) document.getElementById('aexp_system~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~centos/?opendiv=system'>centos</a><a href='##' onmousedown=showDiv('system~centos') id='aexp_system~centos'><span class='exp_style' id='exp_system~centos'>[+]</span></a><span class='right_span'>8</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~centos')) document.getElementById('aexp_system~centos').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~cgroup/?opendiv=system'>cgroup</a><a href='##' onmousedown=showDiv('system~cgroup') id='aexp_system~cgroup'><span class='exp_style' id='exp_system~cgroup'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~cgroup')) document.getElementById('aexp_system~cgroup').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~kvm/?opendiv=system'>kvm</a><a href='##' onmousedown=showDiv('system~kvm') id='aexp_system~kvm'><span class='exp_style' id='exp_system~kvm'>[+]</span></a><span class='right_span'>7</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~kvm')) document.getElementById('aexp_system~kvm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~namespace/?opendiv=system'>namespace</a><a href='##' onmousedown=showDiv('system~namespace') id='aexp_system~namespace'><span class='exp_style' id='exp_system~namespace'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~namespace')) document.getElementById('aexp_system~namespace').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~ubuntu/?opendiv=system'>ubuntu</a><a href='##' onmousedown=showDiv('system~ubuntu') id='aexp_system~ubuntu'><span class='exp_style' id='exp_system~ubuntu'>[+]</span></a><span class='right_span'>9</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('system')) document.getElementById('aexp_system').style.visibility = 'hidden';
if (!document.getElementById('system~ubuntu')) document.getElementById('aexp_system~ubuntu').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/kernel/'>kernel</a><a href='##' onmousedown=showDiv('kernel') id='aexp_kernel'><span class='exp_style' id='exp_kernel'>[+]</span></a><span class='right_span'>(144)</span></li>
<div id='kernel' class='catsub'><li><a href='/blog/cats/kernel~base/?opendiv=kernel'>base</a><a href='##' onmousedown=showDiv('kernel~base') id='aexp_kernel~base'><span class='exp_style' id='exp_kernel~base'>[+]</span></a><span class='right_span'>18</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~base')) document.getElementById('aexp_kernel~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~irq/?opendiv=kernel'>irq</a><a href='##' onmousedown=showDiv('kernel~irq') id='aexp_kernel~irq'><span class='exp_style' id='exp_kernel~irq'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~irq')) document.getElementById('aexp_kernel~irq').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~kexec/?opendiv=kernel'>kexec</a><a href='##' onmousedown=showDiv('kernel~kexec') id='aexp_kernel~kexec'><span class='exp_style' id='exp_kernel~kexec'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~kexec')) document.getElementById('aexp_kernel~kexec').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~mm/?opendiv=kernel'>mm</a><a href='##' onmousedown=showDiv('kernel~mm') id='aexp_kernel~mm'><span class='exp_style' id='exp_kernel~mm'>[+]</span></a><span class='right_span'>30</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~mm')) document.getElementById('aexp_kernel~mm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~net/?opendiv=kernel'>net</a><a href='##' onmousedown=showDiv('kernel~net') id='aexp_kernel~net'><span class='exp_style' id='exp_kernel~net'>[+]</span></a><span class='right_span'>66</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~net')) document.getElementById('aexp_kernel~net').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~sched/?opendiv=kernel'>sched</a><a href='##' onmousedown=showDiv('kernel~sched') id='aexp_kernel~sched'><span class='exp_style' id='exp_kernel~sched'>[+]</span></a><span class='right_span'>19</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel')) document.getElementById('aexp_kernel').style.visibility = 'hidden';
if (!document.getElementById('kernel~sched')) document.getElementById('aexp_kernel~sched').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/android/'>android</a><a href='##' onmousedown=showDiv('android') id='aexp_android'><span class='exp_style' id='exp_android'>[+]</span></a><span class='right_span'>(20)</span></li>
<div id='android' class='catsub'><li><a href='/blog/cats/android~base/?opendiv=android'>base</a><a href='##' onmousedown=showDiv('android~base') id='aexp_android~base'><span class='exp_style' id='exp_android~base'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~base')) document.getElementById('aexp_android~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~i9507v/?opendiv=android'>i9507v</a><a href='##' onmousedown=showDiv('android~i9507v') id='aexp_android~i9507v'><span class='exp_style' id='exp_android~i9507v'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~i9507v')) document.getElementById('aexp_android~i9507v').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~me722/?opendiv=android'>me722</a><a href='##' onmousedown=showDiv('android~me722') id='aexp_android~me722'><span class='exp_style' id='exp_android~me722'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~me722')) document.getElementById('aexp_android~me722').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~nx403a/?opendiv=android'>nx403a</a><a href='##' onmousedown=showDiv('android~nx403a') id='aexp_android~nx403a'><span class='exp_style' id='exp_android~nx403a'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~nx403a')) document.getElementById('aexp_android~nx403a').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~s5830/?opendiv=android'>s5830</a><a href='##' onmousedown=showDiv('android~s5830') id='aexp_android~s5830'><span class='exp_style' id='exp_android~s5830'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('android')) document.getElementById('aexp_android').style.visibility = 'hidden';
if (!document.getElementById('android~s5830')) document.getElementById('aexp_android~s5830').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/debug/'>debug</a><a href='##' onmousedown=showDiv('debug') id='aexp_debug'><span class='exp_style' id='exp_debug'>[+]</span></a><span class='right_span'>(65)</span></li>
<div id='debug' class='catsub'><li><a href='/blog/cats/debug~base/?opendiv=debug'>base</a><a href='##' onmousedown=showDiv('debug~base') id='aexp_debug~base'><span class='exp_style' id='exp_debug~base'>[+]</span></a><span class='right_span'>16</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~base')) document.getElementById('aexp_debug~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~dwarf/?opendiv=debug'>dwarf</a><a href='##' onmousedown=showDiv('debug~dwarf') id='aexp_debug~dwarf'><span class='exp_style' id='exp_debug~dwarf'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~dwarf')) document.getElementById('aexp_debug~dwarf').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~gdb/?opendiv=debug'>gdb</a><a href='##' onmousedown=showDiv('debug~gdb') id='aexp_debug~gdb'><span class='exp_style' id='exp_debug~gdb'>[+]</span></a><span class='right_span'>8</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~gdb')) document.getElementById('aexp_debug~gdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kdump,-crash/?opendiv=debug'>kdump、crash</a><a href='##' onmousedown=showDiv('debug~kdump、crash') id='aexp_debug~kdump、crash'><span class='exp_style' id='exp_debug~kdump、crash'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kdump、crash')) document.getElementById('aexp_debug~kdump、crash').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kgdb/?opendiv=debug'>kgdb</a><a href='##' onmousedown=showDiv('debug~kgdb') id='aexp_debug~kgdb'><span class='exp_style' id='exp_debug~kgdb'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kgdb')) document.getElementById('aexp_debug~kgdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kprobe/?opendiv=debug'>kprobe</a><a href='##' onmousedown=showDiv('debug~kprobe') id='aexp_debug~kprobe'><span class='exp_style' id='exp_debug~kprobe'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kprobe')) document.getElementById('aexp_debug~kprobe').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~mark/?opendiv=debug'>mark</a><a href='##' onmousedown=showDiv('debug~mark') id='aexp_debug~mark'><span class='exp_style' id='exp_debug~mark'>[+]</span></a><span class='right_span'>15</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~mark')) document.getElementById('aexp_debug~mark').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~perf/?opendiv=debug'>perf</a><a href='##' onmousedown=showDiv('debug~perf') id='aexp_debug~perf'><span class='exp_style' id='exp_debug~perf'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~perf')) document.getElementById('aexp_debug~perf').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~systemtap/?opendiv=debug'>systemtap</a><a href='##' onmousedown=showDiv('debug~systemtap') id='aexp_debug~systemtap'><span class='exp_style' id='exp_debug~systemtap'>[+]</span></a><span class='right_span'>5</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('debug')) document.getElementById('aexp_debug').style.visibility = 'hidden';
if (!document.getElementById('debug~systemtap')) document.getElementById('aexp_debug~systemtap').style.visibility = 'hidden';
</script>
<li><div style="background:#DDD; height:0.3em;"></div></li><li class='catclass'><a href='/blog/cats/algorithm/'>algorithm</a><a href='##' onmousedown=showDiv('algorithm') id='aexp_algorithm'><span class='exp_style' id='exp_algorithm'>[+]</span></a><span class='right_span'>(26)</span></li>
<div id='algorithm' class='catsub'><li><a href='/blog/cats/algorithm~base/?opendiv=algorithm'>base</a><a href='##' onmousedown=showDiv('algorithm~base') id='aexp_algorithm~base'><span class='exp_style' id='exp_algorithm~base'>[+]</span></a><span class='right_span'>19</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~base')) document.getElementById('aexp_algorithm~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~dp/?opendiv=algorithm'>dp</a><a href='##' onmousedown=showDiv('algorithm~dp') id='aexp_algorithm~dp'><span class='exp_style' id='exp_algorithm~dp'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~dp')) document.getElementById('aexp_algorithm~dp').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~ds/?opendiv=algorithm'>ds</a><a href='##' onmousedown=showDiv('algorithm~ds') id='aexp_algorithm~ds'><span class='exp_style' id='exp_algorithm~ds'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~ds')) document.getElementById('aexp_algorithm~ds').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~tc/?opendiv=algorithm'>tc</a><a href='##' onmousedown=showDiv('algorithm~tc') id='aexp_algorithm~tc'><span class='exp_style' id='exp_algorithm~tc'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm')) document.getElementById('aexp_algorithm').style.visibility = 'hidden';
if (!document.getElementById('algorithm~tc')) document.getElementById('aexp_algorithm~tc').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/blog/'>blog</a><a href='##' onmousedown=showDiv('blog') id='aexp_blog'><span class='exp_style' id='exp_blog'>[+]</span></a><span class='right_span'>(11)</span></li>
<div id='blog' class='catsub'><li><a href='/blog/cats/blog~hello/?opendiv=blog'>hello</a><a href='##' onmousedown=showDiv('blog~hello') id='aexp_blog~hello'><span class='exp_style' id='exp_blog~hello'>[+]</span></a><span class='right_span'>1</span></li>
<div id='blog~hello' class='catsub2'><li><a href='/blog/cats/blog~hello~hi/?opendiv=blog~hello'>hi</a><span class='right_span'>1</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~hello')) document.getElementById('aexp_blog~hello').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~jekyll/?opendiv=blog'>jekyll</a><a href='##' onmousedown=showDiv('blog~jekyll') id='aexp_blog~jekyll'><span class='exp_style' id='exp_blog~jekyll'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~jekyll')) document.getElementById('aexp_blog~jekyll').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~markdown/?opendiv=blog'>markdown</a><a href='##' onmousedown=showDiv('blog~markdown') id='aexp_blog~markdown'><span class='exp_style' id='exp_blog~markdown'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~markdown')) document.getElementById('aexp_blog~markdown').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~octopress/?opendiv=blog'>octopress</a><a href='##' onmousedown=showDiv('blog~octopress') id='aexp_blog~octopress'><span class='exp_style' id='exp_blog~octopress'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~octopress')) document.getElementById('aexp_blog~octopress').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~ruby/?opendiv=blog'>ruby</a><a href='##' onmousedown=showDiv('blog~ruby') id='aexp_blog~ruby'><span class='exp_style' id='exp_blog~ruby'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog')) document.getElementById('aexp_blog').style.visibility = 'hidden';
if (!document.getElementById('blog~ruby')) document.getElementById('aexp_blog~ruby').style.visibility = 'hidden';
</script>

</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Date Categories</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/2015/'>2015</a><a href='##' onmousedown=showDiv('2015')><span class='exp_style' id='exp_2015'>[+]</span></a><span class='right_span'>(183)</span></li>
<div id='2015' class='catsub'><li><a href='/blog/cats/2015~09/?opendiv=2015'>2015-09</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2015~08/?opendiv=2015'>2015-08</a><span class='right_span'>25</span></li>
<li><a href='/blog/cats/2015~07/?opendiv=2015'>2015-07</a><span class='right_span'>31</span></li>
<li><a href='/blog/cats/2015~06/?opendiv=2015'>2015-06</a><span class='right_span'>24</span></li>
<li><a href='/blog/cats/2015~05/?opendiv=2015'>2015-05</a><span class='right_span'>22</span></li>
<li><a href='/blog/cats/2015~04/?opendiv=2015'>2015-04</a><span class='right_span'>23</span></li>
<li><a href='/blog/cats/2015~03/?opendiv=2015'>2015-03</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2015~02/?opendiv=2015'>2015-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2015~01/?opendiv=2015'>2015-01</a><span class='right_span'>19</span></li>
</div><li class='catclass'><a href='/blog/cats/2014/'>2014</a><a href='##' onmousedown=showDiv('2014')><span class='exp_style' id='exp_2014'>[+]</span></a><span class='right_span'>(112)</span></li>
<div id='2014' class='catsub'><li><a href='/blog/cats/2014~12/?opendiv=2014'>2014-12</a><span class='right_span'>21</span></li>
<li><a href='/blog/cats/2014~11/?opendiv=2014'>2014-11</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2014~10/?opendiv=2014'>2014-10</a><span class='right_span'>13</span></li>
<li><a href='/blog/cats/2014~09/?opendiv=2014'>2014-09</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~08/?opendiv=2014'>2014-08</a><span class='right_span'>15</span></li>
<li><a href='/blog/cats/2014~07/?opendiv=2014'>2014-07</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~06/?opendiv=2014'>2014-06</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2014~05/?opendiv=2014'>2014-05</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~04/?opendiv=2014'>2014-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2014~03/?opendiv=2014'>2014-03</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~02/?opendiv=2014'>2014-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2014~01/?opendiv=2014'>2014-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2013/'>2013</a><a href='##' onmousedown=showDiv('2013')><span class='exp_style' id='exp_2013'>[+]</span></a><span class='right_span'>(60)</span></li>
<div id='2013' class='catsub'><li><a href='/blog/cats/2013~12/?opendiv=2013'>2013-12</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~11/?opendiv=2013'>2013-11</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~10/?opendiv=2013'>2013-10</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~09/?opendiv=2013'>2013-09</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~08/?opendiv=2013'>2013-08</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~07/?opendiv=2013'>2013-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2013~06/?opendiv=2013'>2013-06</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2013~05/?opendiv=2013'>2013-05</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~03/?opendiv=2013'>2013-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2013~02/?opendiv=2013'>2013-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2013~01/?opendiv=2013'>2013-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2012/'>2012</a><a href='##' onmousedown=showDiv('2012')><span class='exp_style' id='exp_2012'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2012' class='catsub'><li><a href='/blog/cats/2012~12/?opendiv=2012'>2012-12</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~11/?opendiv=2012'>2012-11</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~10/?opendiv=2012'>2012-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~08/?opendiv=2012'>2012-08</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2012~05/?opendiv=2012'>2012-05</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~04/?opendiv=2012'>2012-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2012~03/?opendiv=2012'>2012-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2012~02/?opendiv=2012'>2012-02</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2012~01/?opendiv=2012'>2012-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2011/'>2011</a><a href='##' onmousedown=showDiv('2011')><span class='exp_style' id='exp_2011'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2011' class='catsub'><li><a href='/blog/cats/2011~12/?opendiv=2011'>2011-12</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2011~11/?opendiv=2011'>2011-11</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2011~08/?opendiv=2011'>2011-08</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~07/?opendiv=2011'>2011-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~06/?opendiv=2011'>2011-06</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~05/?opendiv=2011'>2011-05</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~04/?opendiv=2011'>2011-04</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~03/?opendiv=2011'>2011-03</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2011~02/?opendiv=2011'>2011-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2011~01/?opendiv=2011'>2011-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2010/'>2010</a><a href='##' onmousedown=showDiv('2010')><span class='exp_style' id='exp_2010'>[+]</span></a><span class='right_span'>(1)</span></li>
<div id='2010' class='catsub'><li><a href='/blog/cats/2010~07/?opendiv=2010'>2010-07</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2009/'>2009</a><a href='##' onmousedown=showDiv('2009')><span class='exp_style' id='exp_2009'>[+]</span></a><span class='right_span'>(8)</span></li>
<div id='2009' class='catsub'><li><a href='/blog/cats/2009~12/?opendiv=2009'>2009-12</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2009~10/?opendiv=2009'>2009-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2009~09/?opendiv=2009'>2009-09</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2009~07/?opendiv=2009'>2009-07</a><span class='right_span'>1</span></li>
</div>
</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Tags</h1>
<ul class="tag-cloud">
<a style="font-size: 131%" href="/tags/gdb/">gdb(6)</a>
<a style="font-size: 100%" href="/tags/hello/">hello(1)</a>
<a style="font-size: 150%" href="/tags/koj/">koj(18)</a>
<a style="font-size: 112%" href="/tags/nvidia/">nvidia(2)</a>
<a style="font-size: 100%" href="/tags/patch/">patch(1)</a>
<a style="font-size: 100%" href="/tags/reg-exp/">reg_exp(1)</a>

</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/09/18/kernel-mm-swappiness/">Linux内核页回收 swappiness参数</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/18/kernel-mm-swap/">Linux swap实现</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/18/kernel-mm-cache-base/">Linux Cache 机制探究</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/11/kernel-mm-mmap/">linux mmap 详解</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/11/kernel-mm-vma-base/">linux进程地址空间--vma的基本操作</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub</h1>
  
  <a href="https://github.com/abcdxyzk">abcdxyzk on GitHub</a>
  
</section>

<section>
<h1>Links</h1>
<ul>
	<li>
		<a href=http://hi.baidu.com/abcdxyzk target=_blank>My blog</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/zhangskd target=_blank>zhangsk</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/justlinux2010 target=_blank>justlinux2010</a>
	</li>
	<li>
		<a href=http://simohayha.iteye.com/ target=_blank>simohayha</a>
	</li>
	<li>
		<a href=http://linux.chinaunix.net/techdoc/net/ target=_blank>技术文档</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/cybertan target=_blank>cybertan</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/newnewman80 target=_blank>newnewman80</a>
	</li>
	<li>
		<a href=http://www.cppblog.com/fwxjj/ target=_blank>fwxjj</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/ustc_dylan target=_blank>ustc_dylan</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/nkguohao target=_blank>nkguohao</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/yusiguyuan target=_blank>yusiguyuan</a>
	</li>
	<li>
		<a href=http://www.oenhan.com/ target=_blank>oenhan</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/bullbat target=_blank>bullbat</a>
	</li>
	<li>
		<a href=http://www.wowotech.net/ target=_blank>wowotech</a>
	</li>
	<li>
		<a href=http://www.lenky.info/ target=_blank>lenky</a>
	</li>
	<li>
		<a href=http://smilejay.com/ target=_blank>smilejay</a>
	</li>
	<li>
		<a href=http://blog.chinaunix.net/uid/10167808.html target=_blank>godbach</a>
	</li>
</ul>
</section>

  
<section id="comment_sidebar">
<h1>Recent Comments</h1>

<script type="text/javascript" src="http://abcdxyzk.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=32&excerpt_length=20"></script><a href="http://disqus.com/">Powered by Disqus</a>

</section>


</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - kk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <a title="Top" href="#" id="scroll2top" style="position: fixed; height: 50px; bottom: 30px; right: 25px; cursor: pointer; z-index: 9999; display: block; opacity: 1;"><img src="/images/scrollup.png"></a>
  <script src="/javascripts/scroll2top.js"></script>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253604690'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1253604690' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'abcdxyzk';
      
</script>





</body>
</html>
