
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>kk Blog —— 通用基础</title>

  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="kk Blog —— 通用基础" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/category.js" type="text/javascript"></script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kk Blog —— 通用基础</a></h1>
  
    <h2>学习中......</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
<li>
<form action="/search" method="get">
    <input class="search" name="query" id="query" type="text" placeholder="search...">
    <input id="btnSubmit" value="search" type="submit">
</form>
<script type="text/javascript">
var query = GetRequest("query");
if (query != null) {
	document.getElementById("query").value = query;
}
</script>
</li>
  <li><a href="/atom.xml" rel="subscribe-rss">RSS</a></li>
  
</ul>
  
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/download">Download</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/01/15/tools-cscope/">vim+cscope</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-15T15:41:00+08:00'><span class='date'>2015-01-15</span> <span class='time'>15:41:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Ctags:<br/>
按下"Ctrl+]&ldquo;, 光标会自动跳转到其定义处<br/>
按下"ctrl+t&rdquo;, 返回上一个查找的地方</p>

<hr />

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum install cscope
</span><span class='line'>sudo apt-get install cscope</span></code></pre></td></tr></table></div></figure>


<h4>生成Cscope数据</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cscope –Rbq</span></code></pre></td></tr></table></div></figure>


<h3>Cscope相关命令</h3>

<p>所有的cscope命令都是通过向主cscope命令”:cscope”传递参数选项。她最短的缩写是”:cs”。”:scscope”命令也做同样的事情并且同时会横向分隔窗口（简称：”scs”）。</p>

<p>可用的缩写有：</p>

<h4>add ：增加一个新的cscope数据库/链接库</h4>

<p>  使用方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:cs add {file|dir} [pre-path] [flags]</span></code></pre></td></tr></table></div></figure>


<p>  其中：<br/>
 [pre-path] 就是以-p选项传递给cscope的文件路径，是以相对路径表示的文件前加上的path，这样你不要切换到你数据库文件所在的目录也可以使用它了。<br/>
 [flags] 你想传递给cscope的额外旗标</p>

<p>  实例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:cscope add /root/code/vimtest/ftpd
</span><span class='line'>:cscope add /project/vim/cscope.out /usr/local/vim
</span><span class='line'>:cscope add cscope.out /usr/local/vim –C</span></code></pre></td></tr></table></div></figure>


<h4>find ：查询cscope。所有的cscope查询选项都可用除了数字5（“修改这个匹配模式”）。</h4>

<p>  使用方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:cs find {querytype} {name}</span></code></pre></td></tr></table></div></figure>


<p>  其中：
 {querytype} 即相对应于实际的cscope行接口数字，同时也相对应于nvi命令：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0或者s   —— 查找这个C符号
</span><span class='line'>1或者g   —— 查找这个定义
</span><span class='line'>2或者d   —— 查找被这个函数调用的函数（们）
</span><span class='line'>3或者c   —— 查找调用这个函数的函数（们）
</span><span class='line'>4或者t   —— 查找这个字符串
</span><span class='line'>6或者e   —— 查找这个egrep匹配模式
</span><span class='line'>7或者f   —— 查找这个文件
</span><span class='line'>8或者i   —— 查找#include这个文件的文件（们）</span></code></pre></td></tr></table></div></figure>


<p>  实例：（#号后为注释）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:cscope find c ftpd_send_resp    # 查找所有调用这个函数的函数（们）
</span><span class='line'>:cscope find 3 ftpd_send_resp # 和上面结果一样
</span><span class='line'>
</span><span class='line'>:cscope find 0 FTPD_CHECK_LOGIN   # 查找FTPD_CHECK_LOGIN这个符号
</span><span class='line'>执行结果如下：
</span><span class='line'>Cscope tag: FTPD_CHECK_LOGIN                   
</span><span class='line'>   #   line  filename / context / line
</span><span class='line'>   1     19  ftpd.h &lt;&lt;GLOBAL&gt;&gt;
</span><span class='line'>             #define FTPD_CHECK_LOGIN() \
</span><span class='line'>   2    648  ftpd.c &lt;&lt;ftpd_do_pwd&gt;&gt;
</span><span class='line'>             FTPD_CHECK_LOGIN();
</span><span class='line'>   3    661  ftpd.c &lt;&lt;ftpd_do_cwd&gt;&gt;
</span><span class='line'>             FTPD_CHECK_LOGIN();
</span><span class='line'>Enter nr of choice (&lt;CR&gt; to abort):
</span><span class='line'>
</span><span class='line'>然后输入最前面的序列号即可。</span></code></pre></td></tr></table></div></figure>


<h4>help ：显示一个简短的摘要。</h4>

<p>使用方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:cs help</span></code></pre></td></tr></table></div></figure>


<h4>kill ：杀掉一个cscope链接（或者杀掉所有的cscope链接）</h4>

<p>使用方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:cs kill {num|partial_name}</span></code></pre></td></tr></table></div></figure>


<p>为了杀掉一个cscope链接，那么链接数字或者一个部分名称必须被指定。部分名称可以简单的是cscope数据库文件路径的一部分。要特别小心使用部分路径杀死一个cscope链接。假如指定的链接数字为-1，那么所有的cscope链接都会被杀掉。</p>

<h4>reset：重新初始化所有的cscope链接。</h4>

<p>使用方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:cs reset</span></code></pre></td></tr></table></div></figure>


<h4>show：显示cscope的链接</h4>

<p>使用方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:cs show</span></code></pre></td></tr></table></div></figure>


<p>假如你在使用cscope的同时也使用ctags，|:cstag|可以允许你在跳转之前指定从一个或另一个中查找。例如，你可以选择首先从cscope数据库中查找，然后再查找你的tags文件（由ctags生成）。上述执行的顺序取决于|csto|的值。<br/>
|:cstag|当从cscope数据库中查找标识符时等同于“:cs find g”。<br/>
|:cstag|当从你的tags文件中查找标识符时等同于“|:tjump|”。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/01/14/debug-mod-timer/">mod_timer会切换cpu</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-14T23:59:01+08:00'><span class='date'>2015-01-14</span> <span class='time'>23:59:01</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://lkml.org/lkml/2009/4/16/45">https://lkml.org/lkml/2009/4/16/45</a></p>

<blockquote><p>Ingo, Thomas, all,</p>

<p>In an SMP system, tasks are scheduled on different CPUs by the
scheduler, interrupts are managed by irqbalancer daemon, but timers
are still stuck to the CPUs that they have been initialised.  Timers
queued by tasks gets re-queued on the CPU where the task gets to run
next, but timers from IRQ context like the ones in device drivers are
still stuck on the CPU they were initialised.  This framework will
help move all &lsquo;movable timers&rsquo; using a sysctl interface.</p></blockquote>

<p>kernel/timer.c 中 __mod_timer函数的部分patch：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+    cpu = smp_processor_id();
</span><span class='line'>+ if (get_sysctl_timer_migration() && idle_cpu(cpu) && !pinned) {
</span><span class='line'>+#if defined(CONFIG_NO_HZ) && (CONFIG_SMP)
</span><span class='line'>+     preferred_cpu = get_nohz_load_balancer();
</span><span class='line'>+#endif
</span><span class='line'>+     if (preferred_cpu &gt;= 0)
</span><span class='line'>+         cpu = preferred_cpu;
</span><span class='line'>+ }
</span><span class='line'>+
</span><span class='line'>+ new_base = per_cpu(tvec_bases, cpu);
</span><span class='line'>+</span></code></pre></td></tr></table></div></figure>


<hr />

<p>也就是说：如果当前进程是idle（函数idle_cpu(cpu)判定），那么在mod_timer时会根据cpu的struct rq runqueues;中的 struct sched_domain *sd; 来选一个不是idle的cpu，然后把timer移到他上去。如果都是idle，就还在本cpu。<br/>
禁用该功能可以 echo 0 > /proc/sys/kernel/timer_magration，默认的启用是1。</p>

<p>也就是说：系统默认状态下mod_timer有可能会mod_timer到其他cpu上。</p>

<hr />

<p>但是基本只有softirq时（如 <a href="/blog/2015/01/14/debug-softirq-time-count/">/blog/2015/01/14/debug-softirq-time-count/</a>），这时会的当前进程就是idle，但cpu实际并不空闲。这样的话softirq的timer在mod_timer时，会被加到其他cpu的定时器队列。如果这些timer是不允许切换cpu的（如对per_cpu变量的操作），那么就会产生bug。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/01/14/debug-softirq-time-count/">中断时间统计</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-14T23:59:00+08:00'><span class='date'>2015-01-14</span> <span class='time'>23:59:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>软中断运行在中断上下文，不会被抢占调度，只会被硬中断打断，但硬中断退出时还是继续执行没结束的软中断。</p>

<p>因为软中断不是运行在进程上下文，不具备被调度的前提，也不具备统计运行时间。系统是将softirq的时间加到当前被他打断的进程上（还是不统计softirq时间？？？有待学习）。</p>

<p>如果当前系统只运行数据包的接收服务，那么系统很可能显示的是100%idle，因为被softirq打断的进程就是idle。</p>

<p>如果softirq足够多，导致启动了ksoftirqd进程来协助处理，那么softirq的时间会被记到ksoftirqd的进程上，显示有“有点正常”了。</p>

<p>这样就会出现：当cpu个数充足时显示100%idle，然后减少到一半cpu就显示X%si。也就是说显示100%idle是不对，应该是近似的(x/2)%si</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/01/14/kernel-sched-alg1/">linux内核分析之调度算法（一）</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-14T23:49:00+08:00'><span class='date'>2015-01-14</span> <span class='time'>23:49:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.csdn.net/bullbat/article/details/7160246">http://blog.csdn.net/bullbat/article/details/7160246</a></p>

<p>linux调度算法在2.6.32中采用调度类实现模块式的调度方式。这样，能够很好的加入新的调度算法。</p>

<p>linux调度器是以模块方式提供的，这样做的目的是允许不同类型的进程可以有针对性地选择调度算法。这种模块化结构被称为调度器类，他允许多种不同哦可动态添加的调度算法并存，调度属于自己范畴的进程。每个调度器都有一个优先级，调度代码会按照优先级遍历调度类，拥有一个可执行进程的最高优先级的调度器类胜出，去选择下面要执行的那个程序。</p>

<p>linux上主要有两大类调度算法，CFS(完全公平调度算法）和实时调度算法。宏SCHED_NOMAL主要用于CFS调度，而SCHED_FIFO和SCHED_RR主要用于实时调度。如下面的宏定义：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/*
</span><span class='line'> * Scheduling policies
</span><span class='line'> */
</span><span class='line'> /*支援Real-Time Task的排程,包括有SCHED_FIFO與SCHED_RR. 
</span><span class='line'> */
</span><span class='line'> 
</span><span class='line'> /*(也稱為SCHED_OTHER): 主要用以排程
</span><span class='line'> 一般目的的Task.*/
</span><span class='line'>#define SCHED_NORMAL      0
</span><span class='line'>#define SCHED_FIFO        1
</span><span class='line'>/*task預設的 Time Slice長度為100 msecs*/
</span><span class='line'>#define SCHED_RR      2
</span><span class='line'>/*主要用以讓Task可以延長執行的時間
</span><span class='line'>(Time Slice),減少被中斷發生Task Context-Switch
</span><span class='line'>的次數.藉此可以提高 Cache的利用率 
</span><span class='line'>(每次Context-Switch都會導致Cache-Flush). 比
</span><span class='line'>較適合用在固定週期執行的Batch Jobs任
</span><span class='line'>務主機上,而不適合用在需要使用者互
</span><span class='line'>動的產品 (會由於Task切換的延遲,而
</span><span class='line'>感覺到系統效能不佳或是反應太慢).*/
</span><span class='line'>#define SCHED_BATCH       3
</span><span class='line'>/* SCHED_ISO: reserved but not implemented yet */
</span><span class='line'>/*為系統中的Idle Task排程.*/
</span><span class='line'>#define SCHED_IDLE        5</span></code></pre></td></tr></table></div></figure>


<p>linux调度算法实现的高层数据结构主要有运行实体、调度类、运行队列，下面我们主要看看这几个数据结构的字段和意义。<br/>
运行实体，rq结构体每个cpu有一个，主要存储一些基本的用于调度的信息，包括实时调度的和CFS调度的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> /*每个处理器都会配置一个rq*/
</span><span class='line'>struct rq {
</span><span class='line'>    /* runqueue lock: */
</span><span class='line'>    spinlock_t lock;
</span><span class='line'>
</span><span class='line'>    /*
</span><span class='line'>     * nr_running and cpu_load should be in the same cacheline because
</span><span class='line'>     * remote CPUs use both these fields when doing load calculation.
</span><span class='line'>     */
</span><span class='line'>     /*用以记录目前处理器rq中执行task的数量*/
</span><span class='line'>    unsigned long nr_running;
</span><span class='line'>    #define CPU_LOAD_IDX_MAX 5
</span><span class='line'>    /*用以表示处理器的负载，在每个处理器的rq中
</span><span class='line'>    都会有对应到该处理器的cpu_load参数配置，在每次
</span><span class='line'>    处理器触发scheduler tick时，都会呼叫函数
</span><span class='line'>    update_cpu_load_active,进行cpu_load的更新。在系统初始化的时候
</span><span class='line'>    会呼叫函数sched_init把rq的cpu_load array初始化为0.
</span><span class='line'>    了解他的更新方式最好的方式是通过函数update_cpu_load,公式如下澹?
</span><span class='line'>    cpu_load[0]会直接等待rq中load.weight的值。
</span><span class='line'>    cpu_load[1]=(cpu_load[1]*(2-1)+cpu_load[0])/2
</span><span class='line'>    cpu_load[2]=(cpu_load[2]*(4-1)+cpu_load[0])/4
</span><span class='line'>    cpu_load[3]=(cpu_load[3]*(8-1)+cpu_load[0])/8
</span><span class='line'>    cpu_load[4]=(cpu_load[4]*(16-1)+cpu_load[0]/16
</span><span class='line'>    呼叫函数this_cpu_load时，所返回的cpu load值是cpu_load[0]
</span><span class='line'>    而在进行cpu blance或migration时，就会呼叫函数
</span><span class='line'>    source_load target_load取得对该处理器cpu_load index值，
</span><span class='line'>    来进行计算*/
</span><span class='line'>    unsigned long cpu_load[CPU_LOAD_IDX_MAX];
</span><span class='line'>#ifdef CONFIG_NO_HZ
</span><span class='line'>    unsigned long last_tick_seen;
</span><span class='line'>    unsigned char in_nohz_recently;
</span><span class='line'>#endif
</span><span class='line'>    /* capture load from *all* tasks on this cpu: */
</span><span class='line'>    /*load-&gt;weight值，会是目前所执行的schedule entity的
</span><span class='line'>    load-&gt;weight的总和，也就是说rq的load-&gt;weight越高，
</span><span class='line'>    也表示所负责的排程单元load-&gt;weight总和越高
</span><span class='line'>    表示处理器所负荷的执行单元也越重*/
</span><span class='line'>    struct load_weight load;
</span><span class='line'>    /*在每次scheduler tick中呼叫update_cpu_load时，
</span><span class='line'>    这个值就增加一，可以用来反馈目前cpu
</span><span class='line'>    load更新的次数*/
</span><span class='line'>    unsigned long nr_load_updates;
</span><span class='line'>    /*用来累加处理器进行context switch的次数，会在
</span><span class='line'>    函数schedule呼叫时进行累加，并可以通过函数
</span><span class='line'>    nr_context_switches统计目前所有处理器总共的context switch
</span><span class='line'>    次数，或是可以透过查看档案/proc/stat中的ctxt位得知目前
</span><span class='line'>    整个系统触发context switch的次数*/
</span><span class='line'>    u64 nr_switches;
</span><span class='line'>
</span><span class='line'>    u64 nr_migrations_in;
</span><span class='line'>    /*为cfs fair scheduling class 的rq*/
</span><span class='line'>    struct cfs_rq cfs;
</span><span class='line'>    /*为real-time scheduling class 的rq*/
</span><span class='line'>    struct rt_rq rt;
</span><span class='line'>
</span><span class='line'>/*用以支援可以group cfs tasks的机制*/
</span><span class='line'>#ifdef CONFIG_FAIR_GROUP_SCHED
</span><span class='line'>    /* list of leaf cfs_rq on this cpu: */
</span><span class='line'>    /*在有设置fair group scheduling 的环境下，
</span><span class='line'>    会基于原本cfs rq中包含有若干task的group
</span><span class='line'>    所成的排程集合，也就是说当有一个group a
</span><span class='line'>    就会有自己的cfs rq用来排程自己所属的tasks,
</span><span class='line'>    而属于这group a的tasks所使用到的处理器时间
</span><span class='line'>    就会以这group a总共所分的的时间为上限。
</span><span class='line'>    基于cgroup的fair group scheduling 架构，可以创造出
</span><span class='line'>    有阶层性的task组织，根据不同task的功能群组化
</span><span class='line'>    在配置给该群主对应的处理器资源，让属于
</span><span class='line'>    该群主下的task可以透过rq机制排程。使用属于
</span><span class='line'>    该群主下的资源。
</span><span class='line'>    这个变数主要是管理CFS RQ list，操作上可以透过函数
</span><span class='line'>    list_add_leaf_cfs_rq把一个group cfs rq加入到list中，或透过
</span><span class='line'>    函数list_del_leaf_cfs_rq把一个group cfs rq移除，并可以
</span><span class='line'>    透过for_each_leaf_cfs_rq把一个rq上得所有leaf cfs_rq走一遍
</span><span class='line'>    */
</span><span class='line'>    struct list_head leaf_cfs_rq_list;
</span><span class='line'>#endif
</span><span class='line'>/*用以支援可以group real-time tasks的机制*/
</span><span class='line'>#ifdef CONFIG_RT_GROUP_SCHED
</span><span class='line'>    /*类似leaf_cfs_rq_list所扮演的角色，只是这里
</span><span class='line'>    是针对属于real-time的task,在实际操作上可以
</span><span class='line'>    透过函数list_add_leaf_rt_rq,list_del_leaf_rt_rq或
</span><span class='line'>    巨集for_each_leaf_rt_rq*/
</span><span class='line'>    struct list_head leaf_rt_rq_list;
</span><span class='line'>#endif
</span><span class='line'>
</span><span class='line'>    /*
</span><span class='line'>     * This is part of a global counter where only the total sum
</span><span class='line'>     * over all CPUs matters. A task can increase this counter on
</span><span class='line'>     * one CPU and if it got migrated afterwards it may decrease
</span><span class='line'>     * it on another CPU. Always updated under the runqueue lock:
</span><span class='line'>     */
</span><span class='line'>     /*一般来说，linux kernel 的task状态可以为TASK_RUNNING
</span><span class='line'>     TASK_INTERRUPTIBLE(sleep),
</span><span class='line'>     TASK_UNINTERRUPTIBLE(Deactivate Task,此时Task会从rq中
</span><span class='line'>     移除)或TASK_STOPPED.
</span><span class='line'>     透过这个变数会统计目前rq中有多少task属于
</span><span class='line'>     TASK_UNINTERRUPTIBLE的状态。当呼叫函数
</span><span class='line'>     active_task时，会把nr_uninterruptible值减一，并透过 该函数
</span><span class='line'>    enqueue_task把对应的task依据所在的scheduling class
</span><span class='line'>    放在 对应的rq中，并把目前rq中nr_running值加一*/
</span><span class='line'>    unsigned long nr_uninterruptible;
</span><span class='line'>    /*curr:指向目前处理器正在执行的task;
</span><span class='line'>    idle:指向属于idle-task scheduling class 的idle task;
</span><span class='line'>    stop:指向目前最高等级属于stop-task scheduling class
</span><span class='line'>    的task;*/
</span><span class='line'>    struct task_struct *curr, *idle;
</span><span class='line'>    /*基于处理器的jiffies值，用以记录下次进行处理器
</span><span class='line'>    balancing 的时间点*/
</span><span class='line'>    unsigned long next_balance;
</span><span class='line'>    /*用以存储context-switch发生时，前一个task的memory management
</span><span class='line'>    结构并可用在函数finish_task_switch中，透过函数mmdrop释放前一个
</span><span class='line'>    task的记忆体资源*/  
</span><span class='line'>    struct mm_struct *prev_mm;
</span><span class='line'>    /*用以记录目前rq的clock值，基本上该值会等于透过sched_clock_cpu
</span><span class='line'>    (cpu_of(rq))的回传值，并会在每次呼叫scheduler_tick时透过
</span><span class='line'>    函数update_rq_clock更新目前rq clock值。
</span><span class='line'>    在实作部分，函数sched_clock_cpu会透过sched_clock_local或
</span><span class='line'>    ched_clock_remote取得对应的sched_clock_data,而处理的sched_clock_data
</span><span class='line'>    值，会透过函数sched_clock_tick在每次呼叫scheduler_tick时进行更新；
</span><span class='line'>    */
</span><span class='line'>    u64 clock;
</span><span class='line'>    /*用以记录目前rq中有多少task处于等待i/o的sleep状态
</span><span class='line'>    在实际的使用上，例如当driver接受来自task的调用，但处于等待i/o
</span><span class='line'>    回复的阶段时，为了充分利用处理器的执行资源，这时
</span><span class='line'>    就可以在driver中呼叫函数io_schedule，此时
</span><span class='line'>    就会把目前rq中的nr_iowait加一，并设定目前task的io_wait为1
</span><span class='line'>    然后触发scheduling 让其他task有机会可以得到处理器执行时间*/
</span><span class='line'>    atomic_t nr_iowait;
</span><span class='line'>
</span><span class='line'>#ifdef CONFIG_SMP
</span><span class='line'>    /*root domain是基于多核心架构下的机制，
</span><span class='line'>    会由rq结构记住目前采用的root domain，其中包括了
</span><span class='line'>    目前的cpu mask(包括span,online rt overload), reference count 跟cpupri
</span><span class='line'>    当root domain有被rq参考到时，refcount 就加一，反之就减一。而cpu
</span><span class='line'>    mask span表示rq可挂上的cpu mask,noline为rq目前已经排程的
</span><span class='line'>    cpu mask cpu上执行real-time task.可以参考函数pull_rt_task，当一个rq中属于
</span><span class='line'>    real-time的task已经执行完毕，就会透过函数pull_rt_task从该
</span><span class='line'>    rq中属于rto_mask cpu mask 可以执行的处理器上，找出是否有一个处理器
</span><span class='line'>    有大于一个以上的real-time task，若有就会转到目前这个执行完成
</span><span class='line'>    real-time task 的处理器上
</span><span class='line'>    而cpupri不同于Task本身有区分140個(0-139)
</span><span class='line'>    Task Priority (0-99為RT Priority 而 100-139為Nice值 -20-19). 
</span><span class='line'>    CPU Priority本身有102個Priority (包括,-1 為Invalid,
</span><span class='line'>    0為Idle,1為Normal,2-101對應到Real-Time Priority 0-99).
</span><span class='line'>    參考函式convert_prio, Task Priority如果是 140就會對應到
</span><span class='line'>    CPU Idle,如果是大於等於100就會對應到CPU Normal,
</span><span class='line'>    若是Task Priority介於0-99之間,就會對應到CPU Real-Time Priority 101-2之間.) 
</span><span class='line'>    在實際的操作上,例如可以透過函式cpupri_find
</span><span class='line'>    帶入一個要插入的Real-Time Task,此時就會依據cpupri中
</span><span class='line'>    pri_to_cpu選擇一個目前執行Real-Time Task且該Task
</span><span class='line'>    的優先級比目前要插入的Task更低的處理器,
</span><span class='line'>    並透過CPU Mask(lowest_mask)返回目前可以選擇的處理器Mask.
</span><span class='line'>    實作的部份可以參考檔案kernel/sched_cpupri.c.
</span><span class='line'>    在初始化的過程中,會透過函式sched_init呼叫函式init_defrootdomain,
</span><span class='line'>    對Root Domain與 CPU Priority機制進行初始化.
</span><span class='line'>    */
</span><span class='line'>    struct root_domain *rd;
</span><span class='line'>    /*Schedule Domain是基於多核心架構下的機制.
</span><span class='line'>    每個處理器都會有一個基礎的Scheduling Domain,
</span><span class='line'>    Scheduling Domain可以有階層性的架構,透過parent
</span><span class='line'>    可以找到上一層的Domain,或是透過child找到
</span><span class='line'>    下一層的 Domain (NULL表示結尾.).並可透過span
</span><span class='line'>    栏位,表示這個Domain所能涵蓋的處理器範圍.
</span><span class='line'>    通常Base Domain會涵蓋系統中所有處理器的個數,
</span><span class='line'>    而Child Domain所能涵蓋的處理器個數不超過它的
</span><span class='line'>    Parent Domain. 而當在進行Scheduling Domain 中的Task Balance
</span><span class='line'>    時,就會以該Domain所能涵蓋的處理器為最大範圍.
</span><span class='line'>    同時,每個Schedule Domain都會包括一個或一個以上的
</span><span class='line'>    CPU Groups (結構為struct sched_group),並透過next變數把
</span><span class='line'>    CPU Groups串連在一起(成為一個單向的Circular linked list),
</span><span class='line'>    每個CPU Group都會有變數cpumask來定义這個CPU Group
</span><span class='line'>    所涵蓋的處理器範圍.並且CPU Group所包括的處理器
</span><span class='line'>    範圍,必需涵蓋在所屬的Schedule Domain處理器範圍中.
</span><span class='line'>    當進行Scheduling Domain的Balancing時,會以其下的CPU Groups
</span><span class='line'>    為單位,根據cpu_power （會是該Group所涵蓋的處理器
</span><span class='line'>    Tasks Loading的總和）來比較不同的CPU Groups的負荷,
</span><span class='line'>    以進行Tasks的移動,達到Balancing的目的.
</span><span class='line'>    在有支援SMP的架構下,會在函式sched_init中,呼叫open_softirq,
</span><span class='line'>    註冊 SCHED_SOFTIRQ Software IRQ与其对应的 Callback函式 
</span><span class='line'>    run_rebalance_domains. 並會在每次呼叫函式scheduler_tick時,
</span><span class='line'>    透過函式trigger_load_balance确认是否目前的jiffies值已經
</span><span class='line'>    大於RunQueue下一次要觸發Load Balance的next_balance時間值,
</span><span class='line'>    並透過函式raise_softirq觸發SCHED_SOFTIRQ Software IRQ. 
</span><span class='line'>    在Software IRQ觸發後,就會呼叫函式run_rebalance_domains,
</span><span class='line'>    並在函式rebalance_domains中,進行后续處理器上的
</span><span class='line'>    Scheduling Domain Load Balance動作.
</span><span class='line'>    有關Scheduling Domain進一步的內容,也可以參考
</span><span class='line'>    Linux Kernel文件 Documentation/scheduler/sched-domains.txt.
</span><span class='line'>    */
</span><span class='line'>    struct sched_domain *sd;
</span><span class='line'>    /*這值會等於函式idle_cpu的返回值,如果為1表示
</span><span class='line'>    目前CPU RunQueue中執行的為Idle Task. 反之為0,
</span><span class='line'>    則表示處理器執行的不是Idle Task (也就是說
</span><span class='line'>    處理器正在忙碌中.).*/
</span><span class='line'>    unsigned char idle_at_tick;
</span><span class='line'>    /* For active balancing */
</span><span class='line'>    /*若這值不為0,表示會有在Schedule排程動作
</span><span class='line'>    結束前,要呼叫的收尾函式. (实作為inline函式
</span><span class='line'>    post_schedule in kernel/sched.c),目前只有Real-Time Scheduling 
</span><span class='line'>    Class有支援這個機制(會呼叫函式has_pushable_tasks 
</span><span class='line'>    in kernel/sched_rt.c).*/
</span><span class='line'>    int post_schedule;
</span><span class='line'>    /*當RunQueue中此值為1,表示這個RunQueue正在進行
</span><span class='line'>    Fair Scheduling的Load Balance,此時會呼叫stop_one_cpu_nowait
</span><span class='line'>    暫停該RunQueue所屬處理器的排程,並透過函式
</span><span class='line'>    active_load_balance_cpu_stop,把Tasks從最忙碌的處理器,
</span><span class='line'>    移到Idle的處理器上執行.*/
</span><span class='line'>    int active_balance;
</span><span class='line'>    /*用以儲存目前進入Idle且負責進行 Load Balance
</span><span class='line'>    流程的處理器ID. 呼叫的流程為,在呼叫函式schedule時,
</span><span class='line'>    若該處理器RunQueue的nr_running為0 (也就是目前沒有
</span><span class='line'>    正在執行的Task),就會呼叫idle_balance,並觸發後續Load 
</span><span class='line'>    Balance流程.*/
</span><span class='line'>    int push_cpu;
</span><span class='line'>    /* cpu of this runqueue: */
</span><span class='line'>    /*用以儲存目前运作這個RunQueue的處理器ID*/
</span><span class='line'>    int cpu;
</span><span class='line'>    /*為1表示目前此RunQueue有在對應的處理器掛上
</span><span class='line'>    並執行.*/
</span><span class='line'>    int online;
</span><span class='line'>    /*如果RunQueue中目前有Task正在執行,這個值會
</span><span class='line'>    等於目前該RunQueue的Load Weight除以目前RunQueue
</span><span class='line'>    中Task數目的均值. 
</span><span class='line'>    (rq-&gt;avg_load_per_task = rq-&gt;load.weight / nr_running;).*/
</span><span class='line'>    unsigned long avg_load_per_task;
</span><span class='line'>
</span><span class='line'>    struct task_struct *migration_thread;
</span><span class='line'>    struct list_head migration_queue;
</span><span class='line'>    /*這個值會由Real-Time Scheduling Class呼叫函式
</span><span class='line'>    update_curr_rt,用以統計目前Real-Time Task執行時間的
</span><span class='line'>    均值,在這函式中會以目前RunQueue的clock_task
</span><span class='line'>    減去目前Task執行的起始時間,取得執行時間的
</span><span class='line'>    Delta值. (delta_exec = rq-&gt;clock_task – curr-&gt;se.exec_start; ).
</span><span class='line'>    在透過函式sched_rt_avg_update把這Delta值跟原本
</span><span class='line'>    RunQueue中的rt_avg值取平均值. 以運作的週期來看,
</span><span class='line'>    這個值可反應目前系統中Real-Time Task平均被
</span><span class='line'>    分配到的執行時間值.*/
</span><span class='line'>    u64 rt_avg;
</span><span class='line'>    /*這個值主要在函式sched_avg_update更新,以笔者手中
</span><span class='line'>    的Linux Kernel 2.6.38.6的實作來說,當RunQueue Clock
</span><span class='line'>    減去age_stamp大於 0.5秒 (=sched_avg_period),就會把這值
</span><span class='line'>    累加0.5秒 (單位都是nanoseconds). 從函式scale_rt_power
</span><span class='line'>    的實作來說,age_stamp值離RunQueue Clock越遠,表示total
</span><span class='line'>    值越大,available值也越大,而函式scale_rt_power返回的
</span><span class='line'>    div_u64計算結果也越大,最終 RunQueue的cpu_power
</span><span class='line'>    與Scheduling Domain中的Scheduling Group的cpu_power
</span><span class='line'>    值也就越大. (可參考函式update_cpu_power的實作).*/
</span><span class='line'>    u64 age_stamp;
</span><span class='line'>    /*這值會在觸發Scheduling時,若判斷目前處理器
</span><span class='line'>    RunQueue沒有正在運作的Task,就會透過函式
</span><span class='line'>    idle_balance更新這值為為目前RunQueue的clock值.
</span><span class='line'>    可用以表示這個處理器是何時進入到Idle的
</span><span class='line'>    狀態*/
</span><span class='line'>    u64 idle_stamp;
</span><span class='line'>    /*會在有Task運作且idle_stamp不為0 (表示前一個
</span><span class='line'>    狀態是在Idle)時以目前RunQueue的clock減去
</span><span class='line'>    idle_stmp所計算出的Delta值為依據,更新這個值
</span><span class='line'>    . 可反應目前處理器進入Idle狀態的時間長短*/
</span><span class='line'>    u64 avg_idle;
</span><span class='line'>#endif
</span><span class='line'>
</span><span class='line'>    /* calc_load related fields */
</span><span class='line'>    /*用以記錄下一次計算CPU Load的時間,初始值
</span><span class='line'>    為目前的jiffies加上五秒與1次的Scheduling Tick的
</span><span class='line'>    間隔 (=jiffies + LOAD_FREQ,且LOAD_FREQ=(5*HZ+1))*/
</span><span class='line'>    unsigned long calc_load_update;
</span><span class='line'>    /*會等於RunQueue中nr_running與nr_uninterruptible的
</span><span class='line'>    總和.（可參考函式calc_load_fold_active）.*/
</span><span class='line'>    long calc_load_active;
</span><span class='line'>
</span><span class='line'>#ifdef CONFIG_SCHED_HRTICK
</span><span class='line'>#ifdef CONFIG_SMP
</span><span class='line'>    /*在函式init_rq_hrtick初始化RunQueue High-Resolution 
</span><span class='line'>    Tick時,此值預設為0.
</span><span class='line'>    在函式hrtick_start中,會判斷目前觸發的RunQueue
</span><span class='line'>    跟目前處理器所使用的RunQueue是否一致,
</span><span class='line'>    若是,就直接呼叫函式hrtimer_restart,反之就會
</span><span class='line'>    依據RunQueue中hrtick_csd_pending的值,如果
</span><span class='line'>    hrtick_csd_pending為0,就會透過函式
</span><span class='line'>    __smp_call_function_single讓RunQueue所在的另一個
</span><span class='line'>    處理器執行rq-&gt;hrtick_csd.func 所指到的函式 
</span><span class='line'>    __hrtick_start. 並等待該處理器執行完畢後,
</span><span class='line'>    才重新把hrtick_csd_pending設定為1.
</span><span class='line'>    也就是說, RunQueue的hrtick_csd_pending是用來作為
</span><span class='line'>    SMP架構下,由處理器A觸發處理器B執行
</span><span class='line'>    _hrtick_start函式的一個保護機制.而有關在
</span><span class='line'>    SMP下如何由一個處理器觸發另一個處理器
</span><span class='line'>    執行函式的機制,可以參考kernel/smp.c中
</span><span class='line'>    相關smp_call_function_xxxxxxx的實作.s*/
</span><span class='line'>    int hrtick_csd_pending;
</span><span class='line'>    /*用以儲存hrtick機制中,要跨處理器執行的
</span><span class='line'>    函式結構.*/
</span><span class='line'>    struct call_single_data hrtick_csd;
</span><span class='line'>#endif
</span><span class='line'>    /*為High-Resolution Tick的结构,會透過函式
</span><span class='line'>    hrtimer_init初始化.*/
</span><span class='line'>    struct hrtimer hrtick_timer;
</span><span class='line'>#endif
</span><span class='line'>
</span><span class='line'>#ifdef CONFIG_SCHEDSTATS
</span><span class='line'>    /* latency stats */
</span><span class='line'>    /*為Scheduling Info.的統計結構,可以參考
</span><span class='line'>    include/linux/sched.h中的宣告. 例如在每次觸發
</span><span class='line'>    Schedule時,呼叫函式schedule_debug對上一個Task
</span><span class='line'>    的lock_depth進行確認(Fork一個新的Process 時,
</span><span class='line'>    會把此值預設為-1就是No-Lock,當呼叫
</span><span class='line'>    Kernel Lock時, 就會把Current Task的lock_depth加一.),
</span><span class='line'>    若lock_depth&gt;=0,就會累加Scheduling Info.的bkl_count值,
</span><span class='line'>    用以代表Task Blocking的次數.*/
</span><span class='line'>    struct sched_info rq_sched_info;
</span><span class='line'>    /*可用以表示RunQueue中的Task所得到CPU執行
</span><span class='line'>    時間的累加值.
</span><span class='line'>    在發生Task Switch時,會透過sched_info_switch呼叫
</span><span class='line'>    sched_info_arrive並以目前RunQueue Clock值更新
</span><span class='line'>    Task 的sched_info.last_arrival時間,而在Task所分配時間
</span><span class='line'>    結束後,會在函式sched_info_depart中以現在的
</span><span class='line'>    RunQueue Clock值減去Task的sched_info.last_arrival
</span><span class='line'>    時間值,得到的 Delta作為變數rq_cpu_time的累
</span><span class='line'>    加值.*/
</span><span class='line'>    unsigned long long rq_cpu_time;
</span><span class='line'>    /* could above be rq-&gt;cfs_rq.exec_clock + rq-&gt;rt_rq.rt_runtime ? */
</span><span class='line'>
</span><span class='line'>    /* sys_sched_yield() stats */
</span><span class='line'>    /*用以統計呼叫System Call sys_sched_yield的次數.*/
</span><span class='line'>    unsigned int yld_count;
</span><span class='line'>
</span><span class='line'>    /* schedule() stats */
</span><span class='line'>    unsigned int sched_switch;
</span><span class='line'>    /*可用以統計觸發Scheduling的次數. 在每次觸發
</span><span class='line'>    Scheduling時,會透過函式schedule呼叫schedule_debug,
</span><span class='line'>    呼叫schedstat_inc對這變數進行累加.*/
</span><span class='line'>    unsigned int sched_count;
</span><span class='line'>    /*可用以統計進入到Idle Task的次數. 會在函式
</span><span class='line'>    pick_next_task_idle中,呼叫schedstat_inc對這變數進行
</span><span class='line'>    累加.*/
</span><span class='line'>    unsigned int sched_goidle;
</span><span class='line'>
</span><span class='line'>    /* try_to_wake_up() stats */
</span><span class='line'>    /*用以統計Wake Up Task的次數.*/
</span><span class='line'>    unsigned int ttwu_count;
</span><span class='line'>    /*用以統計Wake Up 同一個處理器Task的次數.*/
</span><span class='line'>    unsigned int ttwu_local;
</span><span class='line'>
</span><span class='line'>    /* BKL stats */
</span><span class='line'>    unsigned int bkl_count;
</span><span class='line'>#endif
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>调度类，sched_class为对模块编程的上层支持，对于每个linux新添加进来的调度算法都需要有自己的调度类实例。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/*CFS排程機制在設計時,考慮到排程機制的
</span><span class='line'>彈性,定義了Scheduler Class的機制,讓排程機制
</span><span class='line'>可以根據設計的需求,延伸不同的排程模
</span><span class='line'>組進來,每個新加入的排程機制都必須要
</span><span class='line'>提供Scheduler Class的實作,結構為 struct sched_class*/
</span><span class='line'>struct sched_class {
</span><span class='line'>    /*會指向下一個Scheduling Class,以筆者所採用
</span><span class='line'>    的Linux Kernel 2.6.38.6而言,Scheduling Class的順序為
</span><span class='line'>    stop_sched_class-&gt;rt_sched_class-&gt;fair_sched_class-&gt;idle_sched_class*/
</span><span class='line'>    const struct sched_class *next;
</span><span class='line'>    /*當Task屬於Runnable狀態時,就會呼叫這個函式
</span><span class='line'>    把Task配置到RunQueue RBTree中,進行排程動作,
</span><span class='line'>    並呼叫inc_nr_running將RunQueue中nr_running的值
</span><span class='line'>    加一.(nr_running用以代表目前RunQueue有多少
</span><span class='line'>    Runnable Task進行排程)*/
</span><span class='line'>    void (*enqueue_task) (struct rq *rq, struct task_struct *p, int wakeup);
</span><span class='line'>    /*當Task不需要執行時,就會呼叫這個函式
</span><span class='line'>    把Task從RunQueue RBTree中移除,並呼叫
</span><span class='line'>    dec_nr_running將RunQueue中nr_running的值減一.*/
</span><span class='line'>    void (*dequeue_task) (struct rq *rq, struct task_struct *p, int sleep);
</span><span class='line'>    /*用以暫停目前正在執行中的Task,如果
</span><span class='line'>    sysctl_sched_compat_yield有設定,就會找出目前
</span><span class='line'>    RBTree中最右邊的Task(也就是vrruntime最多
</span><span class='line'>    的Task),讓目前Task的vrruntime值等於最右邊
</span><span class='line'>    Task值的vrruntime加一(可參考:
</span><span class='line'>    se-&gt;vruntime = rightmost-&gt;vruntime + 1),如此在下次
</span><span class='line'>    排程觸發時就會透過函式put_prev_task把目前
</span><span class='line'>    的Task放到RBTree的最右邊,也就等同於暫停
</span><span class='line'>    Task,讓該Task下次被執行到的機會最低.*/
</span><span class='line'>    void (*yield_task) (struct rq *rq);
</span><span class='line'>    /*用以決定一個Task是否可以中斷目前正在
</span><span class='line'>    運作的Task,取得執行權.以CFS本身的實作來說
</span><span class='line'>    (in sched_fair.c).如果想要取代目前Task的Task本身
</span><span class='line'>    的Scheduling Policy為 Batch或是Idle時,會直接返回,
</span><span class='line'>    不會用來取代目前正在執行中的Task.反之,
</span><span class='line'>    如果目前正在執行中的Task的Scheduling Policy
</span><span class='line'>    為Idle,就會直接由所傳入的Task取代目前正
</span><span class='line'>    在執行的Task.*/
</span><span class='line'>    void (*check_preempt_curr) (struct rq *rq, struct task_struct *p, int flags);
</span><span class='line'>    /*用以在排程觸發時,從RunQueue RBTree中,
</span><span class='line'>    取出符合目前Scheduling邏輯的下一個要
</span><span class='line'>    被執行的Task.*/
</span><span class='line'>    struct task_struct * (*pick_next_task) (struct rq *rq);
</span><span class='line'>    /*用以在排程觸發時,把上一個執行完畢的
</span><span class='line'>    Task放到目前RunQueue RBTree中對應的位置.*/
</span><span class='line'>    void (*put_prev_task) (struct rq *rq, struct task_struct *p);
</span><span class='line'>
</span><span class='line'>#ifdef CONFIG_SMP
</span><span class='line'>    /*通常用在執行一個新的程序,或是WakeUp
</span><span class='line'>    一個Task時,會根據目前SMP下每個處理器的
</span><span class='line'>    負荷,決定Task是否要切換到另一個處理器
</span><span class='line'>    的RunQueue去執行,執行時會返回最後目標
</span><span class='line'>    處理器的值.*/
</span><span class='line'>    int  (*select_task_rq)(struct task_struct *p, int sd_flag, int flags);
</span><span class='line'>
</span><span class='line'>    unsigned long (*load_balance) (struct rq *this_rq, int this_cpu,
</span><span class='line'>            struct rq *busiest, unsigned long max_load_move,
</span><span class='line'>            struct sched_domain *sd, enum cpu_idle_type idle,
</span><span class='line'>            int *all_pinned, int *this_best_prio);
</span><span class='line'>
</span><span class='line'>    int (*move_one_task) (struct rq *this_rq, int this_cpu,
</span><span class='line'>                  struct rq *busiest, struct sched_domain *sd,
</span><span class='line'>                  enum cpu_idle_type idle);
</span><span class='line'>    void (*pre_schedule) (struct rq *this_rq, struct task_struct *task);
</span><span class='line'>    void (*post_schedule) (struct rq *this_rq);
</span><span class='line'>    void (*task_wake_up) (struct rq *this_rq, struct task_struct *task);
</span><span class='line'>
</span><span class='line'>    void (*set_cpus_allowed)(struct task_struct *p,
</span><span class='line'>                 const struct cpumask *newmask);
</span><span class='line'>
</span><span class='line'>    void (*rq_online)(struct rq *rq);
</span><span class='line'>    void (*rq_offline)(struct rq *rq);
</span><span class='line'>#endif
</span><span class='line'>    /*這個函式用以改變Task目前所屬的Scheduling
</span><span class='line'>    Class與改變Task Group.*/
</span><span class='line'>    void (*set_curr_task) (struct rq *rq);
</span><span class='line'>    /*這是Scheduler的 Timer Tick來源,系統中觸發的
</span><span class='line'>    Scheduling Tick會呼叫這個函式 (看HZ設定多少,
</span><span class='line'>    100就是每秒呼叫這函式100次,1000就是每秒
</span><span class='line'>    呼叫這函式1000次),
</span><span class='line'>    用以讓排程機制可以決定哪些Task應該要配
</span><span class='line'>    執行與哪些Task應該要被移出RunQueue.*/
</span><span class='line'>    void (*task_tick) (struct rq *rq, struct task_struct *p, int queued);
</span><span class='line'>    void (*task_new) (struct rq *rq, struct task_struct *p);
</span><span class='line'>
</span><span class='line'>    void (*switched_from) (struct rq *this_rq, struct task_struct *task,
</span><span class='line'>                   int running);
</span><span class='line'>    void (*switched_to) (struct rq *this_rq, struct task_struct *task,
</span><span class='line'>                 int running);
</span><span class='line'>    void (*prio_changed) (struct rq *this_rq, struct task_struct *task,
</span><span class='line'>                 int oldprio, int running);
</span><span class='line'>
</span><span class='line'>    unsigned int (*get_rr_interval) (struct task_struct *task);
</span><span class='line'>
</span><span class='line'>#ifdef CONFIG_FAIR_GROUP_SCHED
</span><span class='line'>    void (*moved_group) (struct task_struct *p);
</span><span class='line'>#endif
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>调度实体，调度实体用于调度时间记账，linux中CFS和实时调度使用不同的调度实体。调度运行队列，对于不用的调度算法同样运用不用的运行队列，对于CFS调度，运用的是红黑树，而对于实时调度为组链表。在后面具体的调度算法介绍中我们会看到他们的运用。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/01/14/kernel-sched-idle/">Idle进程的切换过程</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-14T23:39:00+08:00'><span class='date'>2015-01-14</span> <span class='time'>23:39:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.chinaunix.net/uid-27767798-id-3577069.html">http://blog.chinaunix.net/uid-27767798-id-3577069.html</a></p>

<p>  每个cpu都有自己的运行队列，如果当前cpu上运行的任务都已经dequeue出运行队列，而且idle_balance也没有移动到当前运行队列的任务，那么schedule函数中，按照rt ，cfs，idle这三种调度方式顺序，寻找各自的运行任务，那么如果rt和cfs都未找到运行任务，那么最后会调用idle schedule的idle进程，作为schedule函数调度的下一个任务。</p>

<p>kernel/sched.c 中的schedule()函数中的片段</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if (prev-&gt;state && !(preempt_count() & PREEMPT_ACTIVE)) {   
</span><span class='line'>    //state大于0代表prev也就是当前运行的任务不是running状态，并且没有标记 PREEMPT_ACTIVE，就表示当前的运行的任务没有必要停留在运行队列中了
</span><span class='line'>    if (unlikely(signal_pending_state(prev-&gt;state, prev)))  //如果当前进程标记了状态是TASK_INTERRUPTIBLE，并且还有信号未处理，那么没有必要从运行队列中移除这个进程
</span><span class='line'>        prev-&gt;state = TASK_RUNNING;
</span><span class='line'>    else
</span><span class='line'>        deactivate_task(rq, prev, DEQUEUE_SLEEP);        //从运行队列中移除这个进程
</span><span class='line'>    switch_count = &prev-&gt;nvcsw;
</span><span class='line'>}
</span><span class='line'>        
</span><span class='line'>pre_schedule(rq, prev);
</span><span class='line'>
</span><span class='line'>if (unlikely(!rq-&gt;nr_running)) //如果当前运行队列没有进程可以运行了，就balance其他运行队列的任务到当前运行队列，这里balance的具体过程暂时不说
</span><span class='line'>    idle_balance(cpu, rq);
</span><span class='line'>
</span><span class='line'>put_prev_task(rq, prev);
</span><span class='line'>next = pick_next_task(rq);     //按照rt，cfs，idle优先级的顺序挑选进程，如果在rt和cfs中都没有找到能够运行的任务，那么当前cpu会切换到idle进程。</span></code></pre></td></tr></table></div></figure>


<p>  这里 PREEMPT_ACTIVE是个标志位，由于进程由于系统调用或者中断异常返回到用户态之前，都要判断是否可以被抢占，会首先判断preempt_count,等于0的时候表示没有禁止抢占，然后再去判断是否标记了need_resched,如果标记了，在去调用schedule函数，如果在某些时候禁止了抢占，禁止了一次就要preempt_count加1。可以肯定的一点是进程的state和是否在运行队列的因果关系并不是十分同步的，修改了进程的状态后，可能还需要做一些其他的工作才去调用schedule函数。引用一下其他人的例子。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>for (;;) {
</span><span class='line'>   prepare_to_wait(&wq, &__wait,TASK_UNINTERRUPTIBLE);
</span><span class='line'>   if (condition)
</span><span class='line'>     break;
</span><span class='line'>   schedule();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>  可以看出在修改了进程的state之后，并不会立刻调用schedule函数，即使立刻调用了schedule函数，也不能保证在schedule函数之前的禁止抢占开启之前有其他的抢占动作。毕竟修改进程的state和从运行队列中移除任务不是一行代码（机器码）就能搞定的事情。所以如果在修改了进程的状态之后和schedule函数禁止抢占之前有抢占动作（可能是中断异常返回），如果这个时候进程被其他进程抢占，这个时候把当前进程移除运行队列，那么这个进程将永远没有机会运行后面的代码。所以这个时候在抢占的过程之前将preempt_count标记PREEMPT_ACTIVE，这样抢占中调用schedule函数将不会从当前运行队列中移除当前进程，这样才有前面分析schedule函数代码，有判断进程state同时判断preempt_count未标记PREEMPT_ACTIVE的情况。</p>

<p>  在当前进程被移除出运行队列之前还需要判断是否有挂起的信号需要处理，如果当前进程的状态是TASK_INTERRUPTIBLE或者TASK_WAKEKILL的时候，如果还有信号未处理，那么当前进程就不需要被移除运行队列，并且将state置为running。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static inline int signal_pending_state(long state, struct task_struct *p)
</span><span class='line'>{
</span><span class='line'>    if (!(state & (TASK_INTERRUPTIBLE | TASK_WAKEKILL))) //首先判断状态不是这两个可以处理信号的状态就直接返回0，后面的逻辑不考虑了
</span><span class='line'>        return 0;
</span><span class='line'>    if (!signal_pending(p))             //如果没有信号挂起就不继续了
</span><span class='line'>        return 0;
</span><span class='line'>
</span><span class='line'>    return (state & TASK_INTERRUPTIBLE) || __fatal_signal_pending(p); //如果有信号
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<pre><code>说下 put_prev_task的逻辑，按照道理说应该是rt，cfs，idle的顺序寻找待运行态的任务。
</code></pre>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pick_next_task(struct rq *rq)
</span><span class='line'>{
</span><span class='line'>    const struct sched_class *class;
</span><span class='line'>    struct task_struct *p;
</span><span class='line'>
</span><span class='line'>    /*
</span><span class='line'>     * Optimization: we know that if all tasks are in
</span><span class='line'>     * the fair class we can call that function directly:
</span><span class='line'>     */
</span><span class='line'>    //这里注释的意思都能看懂，如果rq中的cfs队列的运行个数和rq中的运行个数相同，直接调用cfs中 的pick函数，因为默认的调度策略是cfs。
</span><span class='line'>    if (likely(rq-&gt;nr_running == rq-&gt;cfs.nr_running)) {
</span><span class='line'>        p = fair_sched_class.pick_next_task(rq);
</span><span class='line'>        if (likely(p))
</span><span class='line'>        return p;
</span><span class='line'>    }
</span><span class='line'>        
</span><span class='line'>    //这里 sched_class_highest就是rt_sched_class，所以前面没有选择出任务，那么从rt开始挑选任务，直到idle
</span><span class='line'>    class = sched_class_highest;
</span><span class='line'>         for ( ; ; ) {
</span><span class='line'>        p = class-&gt;pick_next_task(rq);
</span><span class='line'>        if (p)
</span><span class='line'>            return p;
</span><span class='line'>        /*
</span><span class='line'>         * Will never be NULL as the idle class always
</span><span class='line'>         * returns a non-NULL p:
</span><span class='line'>         */
</span><span class='line'>        class = class-&gt;next;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>  从每个调度类的代码的最后可以看出这个next关系</p>

<p>sched_rt.c中：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static const struct sched_class rt_sched_class = {
</span><span class='line'>.next = &fair_sched_class,</span></code></pre></td></tr></table></div></figure>


<p>sched_fair.c中：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static const struct sched_class fair_sched_class = {
</span><span class='line'>.next = &idle_sched_class,</span></code></pre></td></tr></table></div></figure>


<p>  那么可以试想如果rt和cfs都没有可以运行的任务，那么最后就是调用idle的pick_next_task函数</p>

<p>sched_idletask.c:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct task_struct *pick_next_task_idle(struct rq *rq)
</span><span class='line'>{
</span><span class='line'>    schedstat_inc(rq, sched_goidle);
</span><span class='line'>    calc_load_account_idle(rq);
</span><span class='line'>    return rq-&gt;idle;    //可以看到就是返回rq中idle进程。
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>  这idle进程在启动start_kernel函数的时候调用init_idle函数的时候，把当前进程（0号进程）置为每个rq的idle上。</p>

<p>kernel/sched.c:5415</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rq-&gt;curr = rq-&gt;idle = idle;</span></code></pre></td></tr></table></div></figure>


<p>  这里idle就是调用start_kernel函数的进程，就是0号进程。</p>

<p>  0号进程在fork完init进程等之后，进入cpu_idle函数，大概的逻辑是for循环调用hlt指令，每次hlt返回后，调用schedule函数，具体的流程现在还没太看懂，可以看到的是在具体的逻辑在default_idle函数中，调用了safe_halt函数</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static inline void native_safe_halt(void)
</span><span class='line'>{
</span><span class='line'>        asm volatile("sti; hlt": : :"memory");
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>  关于hlt指令的作用是：引用wiki百科</p>

<blockquote><p>  In the x86 computer architecture, HLT (halt) is an assembly language instruction which halts the CPU until the next external interrupt is fired.[1] Interrupts are signals sent by hardware devices to the CPU alerting it that an event occurred to which it should react. For example, hardware timers send interrupts to the CPU at regular intervals.</p>

<p>  The HLT instruction is executed by the operating system when there is no immediate work to be done, and the system enters its idle state. In Windows NT, for example, this instruction is run in the &ldquo;System Idle Process&rdquo;.</p></blockquote>

<p>  可以看到注释的意思是，hlt指令使得cpu挂起，直到有中断产生这个时候cpu重新开始运行。所以时钟中断会唤醒正在hlt中的cpu，让它调用schedule函数，检测是否有新的任务在rq中，如果有的话切换到新的任务，否则继续执行hlt，cpu继续挂起。</p>

<p>参考文章<br/>
1.<a href="http://blog.csdn.net/dog250/article/details/5303547">http://blog.csdn.net/dog250/article/details/5303547</a></p>

<p>2.<a href="http://en.wikipedia.org/wiki/HLT">http://en.wikipedia.org/wiki/HLT</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/18">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/16">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
<h1>Categories</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/language/'>language</a><a href='##' onmousedown=showDiv('language') id='aexp_language'><span class='exp_style' id='exp_language'>[+]</span></a><span class='right_span'>(38)</span></li>
<div id='language' class='catsub'><li><a href='/blog/cats/language~c/?opendiv=language'>c</a><a href='##' onmousedown=showDiv('language~c') id='aexp_language~c'><span class='exp_style' id='exp_language~c'>[+]</span></a><span class='right_span'>21</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~c')) document.getElementById('aexp_language~c').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~java/?opendiv=language'>java</a><a href='##' onmousedown=showDiv('language~java') id='aexp_language~java'><span class='exp_style' id='exp_language~java'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~java')) document.getElementById('aexp_language~java').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~web/?opendiv=language'>web</a><a href='##' onmousedown=showDiv('language~web') id='aexp_language~web'><span class='exp_style' id='exp_language~web'>[+]</span></a><span class='right_span'>6</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('language')) document.getElementById('aexp_language').style.visibility = 'hidden';
if (!document.getElementById('language~web')) document.getElementById('aexp_language~web').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/compiler/'>compiler</a><a href='##' onmousedown=showDiv('compiler') id='aexp_compiler'><span class='exp_style' id='exp_compiler'>[+]</span></a><span class='right_span'>(14)</span></li>
<div id='compiler' class='catsub'><li><a href='/blog/cats/compiler~base/?opendiv=compiler'>base</a><a href='##' onmousedown=showDiv('compiler~base') id='aexp_compiler~base'><span class='exp_style' id='exp_compiler~base'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler~base')) document.getElementById('aexp_compiler~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/compiler~make/?opendiv=compiler'>make</a><a href='##' onmousedown=showDiv('compiler~make') id='aexp_compiler~make'><span class='exp_style' id='exp_compiler~make'>[+]</span></a><span class='right_span'>4</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler')) document.getElementById('aexp_compiler').style.visibility = 'hidden';
if (!document.getElementById('compiler~make')) document.getElementById('aexp_compiler~make').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/assembly/'>assembly</a><a href='##' onmousedown=showDiv('assembly') id='aexp_assembly'><span class='exp_style' id='exp_assembly'>[+]</span></a><span class='right_span'>(14)</span></li>
<div id='assembly' class='catsub'><li><a href='/blog/cats/assembly~arm/?opendiv=assembly'>arm</a><a href='##' onmousedown=showDiv('assembly~arm') id='aexp_assembly~arm'><span class='exp_style' id='exp_assembly~arm'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly~arm')) document.getElementById('aexp_assembly~arm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/assembly~base/?opendiv=assembly'>base</a><a href='##' onmousedown=showDiv('assembly~base') id='aexp_assembly~base'><span class='exp_style' id='exp_assembly~base'>[+]</span></a><span class='right_span'>12</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly')) document.getElementById('aexp_assembly').style.visibility = 'hidden';
if (!document.getElementById('assembly~base')) document.getElementById('aexp_assembly~base').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/tools/'>tools</a><a href='##' onmousedown=showDiv('tools') id='aexp_tools'><span class='exp_style' id='exp_tools'>[+]</span></a><span class='right_span'>(38)</span></li>
<div id='tools' class='catsub'><li><a href='/blog/cats/tools~base/?opendiv=tools'>base</a><a href='##' onmousedown=showDiv('tools~base') id='aexp_tools~base'><span class='exp_style' id='exp_tools~base'>[+]</span></a><span class='right_span'>13</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~base')) document.getElementById('aexp_tools~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ci/?opendiv=tools'>ci</a><a href='##' onmousedown=showDiv('tools~ci') id='aexp_tools~ci'><span class='exp_style' id='exp_tools~ci'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~ci')) document.getElementById('aexp_tools~ci').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~command/?opendiv=tools'>command</a><a href='##' onmousedown=showDiv('tools~command') id='aexp_tools~command'><span class='exp_style' id='exp_tools~command'>[+]</span></a><span class='right_span'>7</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~command')) document.getElementById('aexp_tools~command').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~git/?opendiv=tools'>git</a><a href='##' onmousedown=showDiv('tools~git') id='aexp_tools~git'><span class='exp_style' id='exp_tools~git'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~git')) document.getElementById('aexp_tools~git').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~mysql/?opendiv=tools'>mysql</a><a href='##' onmousedown=showDiv('tools~mysql') id='aexp_tools~mysql'><span class='exp_style' id='exp_tools~mysql'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~mysql')) document.getElementById('aexp_tools~mysql').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ssh/?opendiv=tools'>ssh</a><a href='##' onmousedown=showDiv('tools~ssh') id='aexp_tools~ssh'><span class='exp_style' id='exp_tools~ssh'>[+]</span></a><span class='right_span'>3</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('tools')) document.getElementById('aexp_tools').style.visibility = 'hidden';
if (!document.getElementById('tools~ssh')) document.getElementById('aexp_tools~ssh').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/system/'>system</a><a href='##' onmousedown=showDiv('system') id='aexp_system'><span class='exp_style' id='exp_system'>[+]</span></a><span class='right_span'>(25)</span></li>
<div id='system' class='catsub'><li><a href='/blog/cats/system~base/?opendiv=system'>base</a><a href='##' onmousedown=showDiv('system~base') id='aexp_system~base'><span class='exp_style' id='exp_system~base'>[+]</span></a><span class='right_span'>12</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~base')) document.getElementById('aexp_system~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~centos/?opendiv=system'>centos</a><a href='##' onmousedown=showDiv('system~centos') id='aexp_system~centos'><span class='exp_style' id='exp_system~centos'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~centos')) document.getElementById('aexp_system~centos').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~ubuntu/?opendiv=system'>ubuntu</a><a href='##' onmousedown=showDiv('system~ubuntu') id='aexp_system~ubuntu'><span class='exp_style' id='exp_system~ubuntu'>[+]</span></a><span class='right_span'>8</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('system')) document.getElementById('aexp_system').style.visibility = 'hidden';
if (!document.getElementById('system~ubuntu')) document.getElementById('aexp_system~ubuntu').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/kernel/'>kernel</a><a href='##' onmousedown=showDiv('kernel') id='aexp_kernel'><span class='exp_style' id='exp_kernel'>[+]</span></a><span class='right_span'>(102)</span></li>
<div id='kernel' class='catsub'><li><a href='/blog/cats/kernel~base/?opendiv=kernel'>base</a><a href='##' onmousedown=showDiv('kernel~base') id='aexp_kernel~base'><span class='exp_style' id='exp_kernel~base'>[+]</span></a><span class='right_span'>14</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~base')) document.getElementById('aexp_kernel~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~irq/?opendiv=kernel'>irq</a><a href='##' onmousedown=showDiv('kernel~irq') id='aexp_kernel~irq'><span class='exp_style' id='exp_kernel~irq'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~irq')) document.getElementById('aexp_kernel~irq').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~kexec/?opendiv=kernel'>kexec</a><a href='##' onmousedown=showDiv('kernel~kexec') id='aexp_kernel~kexec'><span class='exp_style' id='exp_kernel~kexec'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~kexec')) document.getElementById('aexp_kernel~kexec').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~mm/?opendiv=kernel'>mm</a><a href='##' onmousedown=showDiv('kernel~mm') id='aexp_kernel~mm'><span class='exp_style' id='exp_kernel~mm'>[+]</span></a><span class='right_span'>17</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~mm')) document.getElementById('aexp_kernel~mm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~net/?opendiv=kernel'>net</a><a href='##' onmousedown=showDiv('kernel~net') id='aexp_kernel~net'><span class='exp_style' id='exp_kernel~net'>[+]</span></a><span class='right_span'>44</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~net')) document.getElementById('aexp_kernel~net').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~sched/?opendiv=kernel'>sched</a><a href='##' onmousedown=showDiv('kernel~sched') id='aexp_kernel~sched'><span class='exp_style' id='exp_kernel~sched'>[+]</span></a><span class='right_span'>16</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel')) document.getElementById('aexp_kernel').style.visibility = 'hidden';
if (!document.getElementById('kernel~sched')) document.getElementById('aexp_kernel~sched').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/android/'>android</a><a href='##' onmousedown=showDiv('android') id='aexp_android'><span class='exp_style' id='exp_android'>[+]</span></a><span class='right_span'>(18)</span></li>
<div id='android' class='catsub'><li><a href='/blog/cats/android~base/?opendiv=android'>base</a><a href='##' onmousedown=showDiv('android~base') id='aexp_android~base'><span class='exp_style' id='exp_android~base'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~base')) document.getElementById('aexp_android~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~i9507v/?opendiv=android'>i9507v</a><a href='##' onmousedown=showDiv('android~i9507v') id='aexp_android~i9507v'><span class='exp_style' id='exp_android~i9507v'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~i9507v')) document.getElementById('aexp_android~i9507v').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~me722/?opendiv=android'>me722</a><a href='##' onmousedown=showDiv('android~me722') id='aexp_android~me722'><span class='exp_style' id='exp_android~me722'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~me722')) document.getElementById('aexp_android~me722').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~nx403a/?opendiv=android'>nx403a</a><a href='##' onmousedown=showDiv('android~nx403a') id='aexp_android~nx403a'><span class='exp_style' id='exp_android~nx403a'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~nx403a')) document.getElementById('aexp_android~nx403a').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~s5830/?opendiv=android'>s5830</a><a href='##' onmousedown=showDiv('android~s5830') id='aexp_android~s5830'><span class='exp_style' id='exp_android~s5830'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('android')) document.getElementById('aexp_android').style.visibility = 'hidden';
if (!document.getElementById('android~s5830')) document.getElementById('aexp_android~s5830').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/debug/'>debug</a><a href='##' onmousedown=showDiv('debug') id='aexp_debug'><span class='exp_style' id='exp_debug'>[+]</span></a><span class='right_span'>(56)</span></li>
<div id='debug' class='catsub'><li><a href='/blog/cats/debug~base/?opendiv=debug'>base</a><a href='##' onmousedown=showDiv('debug~base') id='aexp_debug~base'><span class='exp_style' id='exp_debug~base'>[+]</span></a><span class='right_span'>16</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~base')) document.getElementById('aexp_debug~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~dwarf/?opendiv=debug'>dwarf</a><a href='##' onmousedown=showDiv('debug~dwarf') id='aexp_debug~dwarf'><span class='exp_style' id='exp_debug~dwarf'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~dwarf')) document.getElementById('aexp_debug~dwarf').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~gdb/?opendiv=debug'>gdb</a><a href='##' onmousedown=showDiv('debug~gdb') id='aexp_debug~gdb'><span class='exp_style' id='exp_debug~gdb'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~gdb')) document.getElementById('aexp_debug~gdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kdump,-crash/?opendiv=debug'>kdump、crash</a><a href='##' onmousedown=showDiv('debug~kdump、crash') id='aexp_debug~kdump、crash'><span class='exp_style' id='exp_debug~kdump、crash'>[+]</span></a><span class='right_span'>7</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kdump、crash')) document.getElementById('aexp_debug~kdump、crash').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kgdb/?opendiv=debug'>kgdb</a><a href='##' onmousedown=showDiv('debug~kgdb') id='aexp_debug~kgdb'><span class='exp_style' id='exp_debug~kgdb'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kgdb')) document.getElementById('aexp_debug~kgdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kprobe/?opendiv=debug'>kprobe</a><a href='##' onmousedown=showDiv('debug~kprobe') id='aexp_debug~kprobe'><span class='exp_style' id='exp_debug~kprobe'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kprobe')) document.getElementById('aexp_debug~kprobe').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~mark/?opendiv=debug'>mark</a><a href='##' onmousedown=showDiv('debug~mark') id='aexp_debug~mark'><span class='exp_style' id='exp_debug~mark'>[+]</span></a><span class='right_span'>13</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~mark')) document.getElementById('aexp_debug~mark').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~systemtap/?opendiv=debug'>systemtap</a><a href='##' onmousedown=showDiv('debug~systemtap') id='aexp_debug~systemtap'><span class='exp_style' id='exp_debug~systemtap'>[+]</span></a><span class='right_span'>3</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('debug')) document.getElementById('aexp_debug').style.visibility = 'hidden';
if (!document.getElementById('debug~systemtap')) document.getElementById('aexp_debug~systemtap').style.visibility = 'hidden';
</script>
<li><div style="background:#DDD; height:0.3em;"></div></li><li class='catclass'><a href='/blog/cats/algorithm/'>algorithm</a><a href='##' onmousedown=showDiv('algorithm') id='aexp_algorithm'><span class='exp_style' id='exp_algorithm'>[+]</span></a><span class='right_span'>(26)</span></li>
<div id='algorithm' class='catsub'><li><a href='/blog/cats/algorithm~base/?opendiv=algorithm'>base</a><a href='##' onmousedown=showDiv('algorithm~base') id='aexp_algorithm~base'><span class='exp_style' id='exp_algorithm~base'>[+]</span></a><span class='right_span'>19</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~base')) document.getElementById('aexp_algorithm~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~dp/?opendiv=algorithm'>dp</a><a href='##' onmousedown=showDiv('algorithm~dp') id='aexp_algorithm~dp'><span class='exp_style' id='exp_algorithm~dp'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~dp')) document.getElementById('aexp_algorithm~dp').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~ds/?opendiv=algorithm'>ds</a><a href='##' onmousedown=showDiv('algorithm~ds') id='aexp_algorithm~ds'><span class='exp_style' id='exp_algorithm~ds'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~ds')) document.getElementById('aexp_algorithm~ds').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~tc/?opendiv=algorithm'>tc</a><a href='##' onmousedown=showDiv('algorithm~tc') id='aexp_algorithm~tc'><span class='exp_style' id='exp_algorithm~tc'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm')) document.getElementById('aexp_algorithm').style.visibility = 'hidden';
if (!document.getElementById('algorithm~tc')) document.getElementById('aexp_algorithm~tc').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/blog/'>blog</a><a href='##' onmousedown=showDiv('blog') id='aexp_blog'><span class='exp_style' id='exp_blog'>[+]</span></a><span class='right_span'>(11)</span></li>
<div id='blog' class='catsub'><li><a href='/blog/cats/blog~hello/?opendiv=blog'>hello</a><a href='##' onmousedown=showDiv('blog~hello') id='aexp_blog~hello'><span class='exp_style' id='exp_blog~hello'>[+]</span></a><span class='right_span'>1</span></li>
<div id='blog~hello' class='catsub2'><li><a href='/blog/cats/blog~hello~hi/?opendiv=blog~hello'>hi</a><span class='right_span'>1</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~hello')) document.getElementById('aexp_blog~hello').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~jekyll/?opendiv=blog'>jekyll</a><a href='##' onmousedown=showDiv('blog~jekyll') id='aexp_blog~jekyll'><span class='exp_style' id='exp_blog~jekyll'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~jekyll')) document.getElementById('aexp_blog~jekyll').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~markdown/?opendiv=blog'>markdown</a><a href='##' onmousedown=showDiv('blog~markdown') id='aexp_blog~markdown'><span class='exp_style' id='exp_blog~markdown'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~markdown')) document.getElementById('aexp_blog~markdown').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~octopress/?opendiv=blog'>octopress</a><a href='##' onmousedown=showDiv('blog~octopress') id='aexp_blog~octopress'><span class='exp_style' id='exp_blog~octopress'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~octopress')) document.getElementById('aexp_blog~octopress').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~ruby/?opendiv=blog'>ruby</a><a href='##' onmousedown=showDiv('blog~ruby') id='aexp_blog~ruby'><span class='exp_style' id='exp_blog~ruby'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog')) document.getElementById('aexp_blog').style.visibility = 'hidden';
if (!document.getElementById('blog~ruby')) document.getElementById('aexp_blog~ruby').style.visibility = 'hidden';
</script>

</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Date Categories</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/2015/'>2015</a><a href='##' onmousedown=showDiv('2015')><span class='exp_style' id='exp_2015'>[+]</span></a><span class='right_span'>(91)</span></li>
<div id='2015' class='catsub'><li><a href='/blog/cats/2015~05/?opendiv=2015'>2015-05</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2015~04/?opendiv=2015'>2015-04</a><span class='right_span'>23</span></li>
<li><a href='/blog/cats/2015~03/?opendiv=2015'>2015-03</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2015~02/?opendiv=2015'>2015-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2015~01/?opendiv=2015'>2015-01</a><span class='right_span'>19</span></li>
</div><li class='catclass'><a href='/blog/cats/2014/'>2014</a><a href='##' onmousedown=showDiv('2014')><span class='exp_style' id='exp_2014'>[+]</span></a><span class='right_span'>(112)</span></li>
<div id='2014' class='catsub'><li><a href='/blog/cats/2014~12/?opendiv=2014'>2014-12</a><span class='right_span'>21</span></li>
<li><a href='/blog/cats/2014~11/?opendiv=2014'>2014-11</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2014~10/?opendiv=2014'>2014-10</a><span class='right_span'>13</span></li>
<li><a href='/blog/cats/2014~09/?opendiv=2014'>2014-09</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~08/?opendiv=2014'>2014-08</a><span class='right_span'>15</span></li>
<li><a href='/blog/cats/2014~07/?opendiv=2014'>2014-07</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~06/?opendiv=2014'>2014-06</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2014~05/?opendiv=2014'>2014-05</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~04/?opendiv=2014'>2014-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2014~03/?opendiv=2014'>2014-03</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~02/?opendiv=2014'>2014-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2014~01/?opendiv=2014'>2014-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2013/'>2013</a><a href='##' onmousedown=showDiv('2013')><span class='exp_style' id='exp_2013'>[+]</span></a><span class='right_span'>(60)</span></li>
<div id='2013' class='catsub'><li><a href='/blog/cats/2013~12/?opendiv=2013'>2013-12</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~11/?opendiv=2013'>2013-11</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~10/?opendiv=2013'>2013-10</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~09/?opendiv=2013'>2013-09</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~08/?opendiv=2013'>2013-08</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~07/?opendiv=2013'>2013-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2013~06/?opendiv=2013'>2013-06</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2013~05/?opendiv=2013'>2013-05</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~03/?opendiv=2013'>2013-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2013~02/?opendiv=2013'>2013-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2013~01/?opendiv=2013'>2013-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2012/'>2012</a><a href='##' onmousedown=showDiv('2012')><span class='exp_style' id='exp_2012'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2012' class='catsub'><li><a href='/blog/cats/2012~12/?opendiv=2012'>2012-12</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~11/?opendiv=2012'>2012-11</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~10/?opendiv=2012'>2012-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~08/?opendiv=2012'>2012-08</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2012~05/?opendiv=2012'>2012-05</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~04/?opendiv=2012'>2012-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2012~03/?opendiv=2012'>2012-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2012~02/?opendiv=2012'>2012-02</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2012~01/?opendiv=2012'>2012-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2011/'>2011</a><a href='##' onmousedown=showDiv('2011')><span class='exp_style' id='exp_2011'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2011' class='catsub'><li><a href='/blog/cats/2011~12/?opendiv=2011'>2011-12</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2011~11/?opendiv=2011'>2011-11</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2011~08/?opendiv=2011'>2011-08</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~07/?opendiv=2011'>2011-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~06/?opendiv=2011'>2011-06</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~05/?opendiv=2011'>2011-05</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~04/?opendiv=2011'>2011-04</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~03/?opendiv=2011'>2011-03</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2011~02/?opendiv=2011'>2011-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2011~01/?opendiv=2011'>2011-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2010/'>2010</a><a href='##' onmousedown=showDiv('2010')><span class='exp_style' id='exp_2010'>[+]</span></a><span class='right_span'>(1)</span></li>
<div id='2010' class='catsub'><li><a href='/blog/cats/2010~07/?opendiv=2010'>2010-07</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2009/'>2009</a><a href='##' onmousedown=showDiv('2009')><span class='exp_style' id='exp_2009'>[+]</span></a><span class='right_span'>(8)</span></li>
<div id='2009' class='catsub'><li><a href='/blog/cats/2009~12/?opendiv=2009'>2009-12</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2009~10/?opendiv=2009'>2009-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2009~09/?opendiv=2009'>2009-09</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2009~07/?opendiv=2009'>2009-07</a><span class='right_span'>1</span></li>
</div>
</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Tags</h1>
<ul class="tag-cloud">
<a style="font-size: 131%" href="/tags/gdb/">gdb(6)</a>
<a style="font-size: 100%" href="/tags/hello/">hello(1)</a>
<a style="font-size: 150%" href="/tags/koj/">koj(18)</a>
<a style="font-size: 112%" href="/tags/nvidia/">nvidia(2)</a>
<a style="font-size: 100%" href="/tags/patch/">patch(1)</a>
<a style="font-size: 100%" href="/tags/reg-exp/">reg_exp(1)</a>

</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/05/21/kernel-sched-waitqueue-sample/">字符设备驱动和等待队列样例</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/21/kernel-sched-waitqueue/">Linux内核中的等待队列</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/21/kernel-base-chardev/">字符设备驱动程序</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/20/android-4.4.2/">编译android4.4.2源码</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/15/kernel-net-ipv6/">ipv6初始化和处理流程分析</a>
      </li>
    
  </ul>
</section>
<section>
<h1>Links</h1>
<ul>
	<li>
		<a href=http://hi.baidu.com/abcdxyzk target=_blank>My blog</a>
	</li>
</ul>
</section>

  
<section id="comment_sidebar">
<h1>Recent Comments</h1>

<script type="text/javascript" src="http://abcdxyzk.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=32&excerpt_length=20"></script><a href="http://disqus.com/">Powered by Disqus</a>

</section>


</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - kk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <a title="Top" href="#" id="scroll2top" style="position: fixed; height: 50px; bottom: 30px; right: 25px; cursor: pointer; z-index: 9999; display: block; opacity: 1;"><img src="/images/scrollup.png"></a>
  <script src="/javascripts/scroll2top.js"></script>
<!--  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253604690'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1253604690' type='text/javascript'%3E%3C/script%3E"));</script> -->
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'abcdxyzk';
      
</script>





</body>
</html>
