
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>kk Blog —— 通用基础</title>

  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="kk Blog —— 通用基础" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/category.js" type="text/javascript"></script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kk Blog —— 通用基础</a></h1>
  
    <h2>cp -rf * .</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
<li>
<form action="/search" method="get">
    <input class="search" name="query" id="query" type="text" placeholder="search...">
    <input id="btnSubmit" value="search" type="submit">
</form>
<script type="text/javascript">
var query = GetRequest("query");
if (query != null) {
	document.getElementById("query").value = query;
}
</script>
</li>
  <li><a href="/atom.xml" rel="subscribe-rss">RSS</a></li>
  
</ul>
  
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/download">Download</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/04/14/kernel-net-sock-raw/">Linux网络编程：原始套接字 SOCK_RAW</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-14T21:27:00+08:00'><span class='date'>2015-04-14</span> <span class='time'>21:27:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.chinaunix.net/uid-23069658-id-3280895.html">http://blog.chinaunix.net/uid-23069658-id-3280895.html</a></p>

<h4>一、修改iphdr+tcphdr</h4>

<p>对于TCP或UDP的程序开发，焦点在Data字段，我们没法直接对TCP或UDP头部字段进行赤裸裸的修改，当然还有IP头。换句话说，我们对它们头部操作的空间非常受限，只能使用它们已经开放给我们的诸如源、目的IP，源、目的端口等等。</p>

<p>原始套接字的创建方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>socket(AF_INET, SOCK_RAW, protocol);</span></code></pre></td></tr></table></div></figure>


<p>  重点在protocol字段，这里就不能简单的将其值为0了。在头文件netinet/in.h中定义了系统中该字段目前能取的值，注意：有些系统中不一定实现了netinet/in.h中的所有协议。源代码的linux/in.h中和netinet/in.h中的内容一样。我们常见的有IPPROTO_TCP，IPPROTO_UDP和IPPROTO_ICMP。</p>

<p>用这种方式我就可以得到原始的IP包了，然后就可以自定义IP所承载的具体协议类型，如TCP，UDP或ICMP，并手动对每种承载在IP协议之上的报文进行填充。</p>

<p>先简单复习一下TCP报文的格式</p>

<p><img src="/images/kernel/2015-04-14-1.jpg" alt="" /></p>

<p><img src="/images/kernel/2015-04-14-2.jpg" alt="" /></p>

<p>原始套接字还提供了一个非常有用的参数IP_HDRINCL：</p>

<p>1、当开启该参数时：我们可以从IP报文首部第一个字节开始依次构造整个IP报文的所有选项，但是IP报文头部中的标识字段(设置为0时)和IP首部校验和字段总是由内核自己维护的，不需要我们关心。</p>

<p>2、如果不开启该参数：我们所构造的报文是从IP首部之后的第一个字节开始，IP首部由内核自己维护，首部中的协议字段被设置成调用socket()函数时我们所传递给它的第三个参数。</p>

<p> 开启IP_HDRINCL特性的模板代码一般为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>const int on =1;
</span><span class='line'>if (setsockopt (sockfd, IPPROTO_IP, IP_HDRINCL, &on, sizeof(on)) &lt; 0) {
</span><span class='line'>&#9;printf("setsockopt error!\n");
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>所以，我们还得复习一下IP报文的首部格式：</p>

<p><img src="/images/kernel/2015-04-14-3.jpg" alt="" /></p>

<p>同样，我们重点关注IP首部中的着色部分区段的填充情况。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;errno.h&gt;
</span><span class='line'>#include &lt;string.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;netdb.h&gt;
</span><span class='line'>#include &lt;sys/socket.h&gt;
</span><span class='line'>#include &lt;sys/types.h&gt;
</span><span class='line'>#include &lt;netinet/in.h&gt;
</span><span class='line'>#include &lt;netinet/ip.h&gt;
</span><span class='line'>#include &lt;arpa/inet.h&gt;
</span><span class='line'>#include &lt;linux/tcp.h&gt;
</span><span class='line'>
</span><span class='line'>#include &lt;linux/if_ether.h&gt;
</span><span class='line'>#include &lt;linux/if_arp.h&gt;
</span><span class='line'>#include &lt;linux/sockios.h&gt;
</span><span class='line'>
</span><span class='line'>unsigned csum_tcpudp_nofold(unsigned saddr, unsigned daddr,
</span><span class='line'>&#9;&#9;&#9;unsigned len, unsigned proto, unsigned sum)
</span><span class='line'>{
</span><span class='line'>&#9;unsigned long long s = (unsigned)sum;
</span><span class='line'>&#9;s += (unsigned)saddr;
</span><span class='line'>&#9;s += (unsigned)daddr;
</span><span class='line'>&#9;s += (proto + len) &lt;&lt; 8;
</span><span class='line'>&#9;s += (s &gt;&gt; 32);
</span><span class='line'>&#9;return (unsigned)s;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>unsigned short check_sum(unsigned short *addr, int len, unsigned sum)
</span><span class='line'>{
</span><span class='line'>&#9;int nleft = len;
</span><span class='line'>&#9;unsigned short *w = addr;
</span><span class='line'>&#9;unsigned short ret = 0;
</span><span class='line'>&#9;while (nleft &gt; 1) {
</span><span class='line'>&#9;&#9;sum += *w++;
</span><span class='line'>&#9;&#9;nleft -= 2;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (nleft == 1) {
</span><span class='line'>&#9;&#9;*(unsigned char *)(&ret) = *(unsigned char *)w;
</span><span class='line'>&#9;&#9;sum += ret;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;sum = (sum&gt;&gt;16) + (sum&0xffff);
</span><span class='line'>&#9;sum += (sum&gt;&gt;16);
</span><span class='line'>&#9;ret = ~sum;
</span><span class='line'>&#9;return ret;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>//在该函数中构造整个IP报文，最后调用sendto函数将报文发送出去
</span><span class='line'>void attack(int skfd, struct sockaddr_in *target, unsigned short srcport)
</span><span class='line'>{
</span><span class='line'>&#9;char buf[256] = {0};
</span><span class='line'>&#9;struct ip *ip;
</span><span class='line'>&#9;struct tcphdr *tcp;
</span><span class='line'>&#9;int ip_len;
</span><span class='line'>&#9;int op_len = 12;
</span><span class='line'>
</span><span class='line'>&#9;//在我们TCP的报文中Data没有字段，所以整个IP报文的长度
</span><span class='line'>&#9;ip_len = sizeof(struct ip) + sizeof(struct tcphdr) + op_len;
</span><span class='line'>
</span><span class='line'>&#9;//开始填充IP首部
</span><span class='line'>&#9;ip=(struct ip*)buf;
</span><span class='line'>&#9;ip-&gt;ip_v = IPVERSION;
</span><span class='line'>&#9;ip-&gt;ip_hl = sizeof(struct ip)&gt;&gt;2;
</span><span class='line'>&#9;ip-&gt;ip_tos = 0;
</span><span class='line'>&#9;ip-&gt;ip_len = htons(ip_len);
</span><span class='line'>&#9;ip-&gt;ip_id = 0;
</span><span class='line'>&#9;ip-&gt;ip_off = 0;
</span><span class='line'>&#9;ip-&gt;ip_ttl = MAXTTL;
</span><span class='line'>&#9;ip-&gt;ip_p = IPPROTO_TCP;
</span><span class='line'>&#9;ip-&gt;ip_sum = 0;
</span><span class='line'>&#9;ip-&gt;ip_dst = target-&gt;sin_addr;
</span><span class='line'>
</span><span class='line'>&#9;//开始填充TCP首部
</span><span class='line'>&#9;tcp = (struct tcphdr*)(buf+sizeof(struct ip));
</span><span class='line'>&#9;tcp-&gt;source = htons(srcport);
</span><span class='line'>&#9;tcp-&gt;dest = target-&gt;sin_port;
</span><span class='line'>&#9;srand(time(NULL));
</span><span class='line'>&#9;tcp-&gt;doff = (sizeof(struct tcphdr) + op_len) &gt;&gt; 2; // tcphdr + option
</span><span class='line'>&#9;tcp-&gt;syn = 1;
</span><span class='line'>&#9;tcp-&gt;check = 0;
</span><span class='line'>&#9;tcp-&gt;window = ntohs(14600);
</span><span class='line'>
</span><span class='line'>&#9;int i = ip_len - op_len;
</span><span class='line'>&#9;// mss = 1460
</span><span class='line'>&#9;buf[i++] = 0x02;
</span><span class='line'>&#9;buf[i++] = 0x04;
</span><span class='line'>&#9;buf[i++] = 0x05;
</span><span class='line'>&#9;buf[i++] = 0xb4;
</span><span class='line'>&#9;// sack
</span><span class='line'>&#9;buf[i++] = 0x01;
</span><span class='line'>&#9;buf[i++] = 0x01;
</span><span class='line'>&#9;buf[i++] = 0x04;
</span><span class='line'>&#9;buf[i++] = 0x02;
</span><span class='line'>&#9;// wsscale = 7
</span><span class='line'>&#9;buf[i++] = 0x01;
</span><span class='line'>&#9;buf[i++] = 0x03;
</span><span class='line'>&#9;buf[i++] = 0x03;
</span><span class='line'>&#9;buf[i++] = 0x07;
</span><span class='line'>
</span><span class='line'>&#9;int T = 1;
</span><span class='line'>&#9;while(1) {
</span><span class='line'>&#9;&#9;if (T == 0) break;
</span><span class='line'>&#9;&#9;T--;
</span><span class='line'>&#9;&#9;tcp-&gt;seq = random();
</span><span class='line'>&#9;&#9;//源地址伪造，我们随便任意生成个地址，让服务器一直等待下去
</span><span class='line'>&#9;&#9;//ip-&gt;ip_src.s_addr = random();
</span><span class='line'>&#9;&#9;//自定义源地址192.168.204.136 = 0xc0a8cc88; 反转赋值
</span><span class='line'>&#9;&#9;ip-&gt;ip_src.s_addr = 0x88cca8c0;
</span><span class='line'>&#9;&#9;unsigned sum = csum_tcpudp_nofold(ip-&gt;ip_src.s_addr, ip-&gt;ip_dst.s_addr, sizeof(struct tcphdr)+op_len, IPPROTO_TCP, 0);
</span><span class='line'>&#9;&#9;tcp-&gt;check = check_sum((unsigned short*)tcp, sizeof(struct tcphdr)+op_len, sum);
</span><span class='line'>//        ip-&gt;ip_sum = check_sum((unsigned short*)ip, sizeof(struct ip), 0);
</span><span class='line'>&#9;&#9;sendto(skfd, buf, ip_len, 0, (struct sockaddr*)target, sizeof(struct sockaddr_in));
</span><span class='line'>&#9;}
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int main(int argc, char** argv)
</span><span class='line'>{
</span><span class='line'>&#9;int skfd;
</span><span class='line'>&#9;struct sockaddr_in target;
</span><span class='line'>&#9;struct hostent *host;
</span><span class='line'>&#9;const int on = 1;
</span><span class='line'>&#9;unsigned short srcport;
</span><span class='line'>
</span><span class='line'>&#9;if (argc != 4) {
</span><span class='line'>&#9;&#9;printf("Usage:%s dstip dstport srcport\n", argv[0]);
</span><span class='line'>&#9;&#9;exit(1);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;bzero(&target, sizeof(struct sockaddr_in));
</span><span class='line'>&#9;target.sin_family = AF_INET;
</span><span class='line'>&#9;target.sin_port = htons(atoi(argv[2]));
</span><span class='line'>
</span><span class='line'>&#9;if (inet_aton(argv[1], &target.sin_addr) == 0) {
</span><span class='line'>&#9;&#9;host = gethostbyname(argv[1]);
</span><span class='line'>&#9;&#9;if(host == NULL) {
</span><span class='line'>&#9;&#9;&#9;printf("TargetName Error:%s\n", hstrerror(h_errno));
</span><span class='line'>&#9;&#9;&#9;exit(1);
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;target.sin_addr = *(struct in_addr *)(host-&gt;h_addr_list[0]);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;//将协议字段置为IPPROTO_TCP，来创建一个TCP的原始套接字
</span><span class='line'>&#9;if (0 &gt; (skfd = socket(AF_INET, SOCK_RAW, IPPROTO_TCP))) {
</span><span class='line'>&#9;&#9;perror("Create Error");
</span><span class='line'>&#9;&#9;exit(1);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;//用模板代码来开启IP_HDRINCL特性，我们完全自己手动构造IP报文
</span><span class='line'>&#9;if (0 &gt; setsockopt(skfd, IPPROTO_IP, IP_HDRINCL, &on, sizeof(on))) {
</span><span class='line'>&#9;&#9;perror("IP_HDRINCL failed");
</span><span class='line'>&#9;&#9;exit(1);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;//因为只有root用户才可以play with raw socket :)
</span><span class='line'>&#9;setuid(getpid());
</span><span class='line'>&#9;srcport = atoi(argv[3]);
</span><span class='line'>&#9;attack(skfd, &target, srcport);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>原始套接字上也可以调用connet、bind之类的函数</li>
</ul>


<hr />

<h4>修改mac+iphdr+tcphdr</h4>

<p>blog.chinaunix.net/uid-23069658-id-3283534.html</p>

<p>在Linux系统中要从链路层(MAC)直接收发数帧，比较普遍的做法就是用libpcap和libnet两个动态库来实现。但今天我们就要用原始套接字来实现这个功能。</p>

<p><img src="/images/kernel/2015-04-14-4.jpg" alt="" /></p>

<p>这里的2字节帧类型用来指示该数据帧所承载的上层协议是IP、ARP或其他。</p>

<p>为了实现直接从链路层收发数据帧，我们要用到原始套接字的如下形式：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>socket(PF_PACKET, type, protocol)</span></code></pre></td></tr></table></div></figure>


<p>1、其中type字段可取SOCK_RAW或SOCK_DGRAM。它们两个都使用一种与设备无关的标准物理层地址结构struct sockaddr_ll{}，但具体操作的报文格式不同：</p>

<p>SOCK_RAW：直接向网络硬件驱动程序发送(或从网络硬件驱动程序接收)没有任何处理的完整数据报文(包括物理帧的帧头)，这就要求我们必须了解对应设备的物理帧帧头结构，才能正确地装载和分析报文。也就是说我们用这种套接字从网卡驱动上收上来的报文包含了MAC头部，如果我们要用这种形式的套接字直接向网卡发送数据帧，那么我们必须自己组装我们MAC头部。这正符合我们的需求。</p>

<p>SOCK_DGRAM：这种类型的套接字对于收到的数据报文的物理帧帧头会被系统自动去掉，然后再将其往协议栈上层传递；同样地，在发送时数据时，系统将会根据sockaddr_ll结构中的目的地址信息为数据报文添加一个合适的MAC帧头。</p>

<p>2、protocol字段，常见的，一般情况下该字段取ETH_P_IP，ETH_P_ARP，ETH_P_RARP或ETH_P_ALL，当然链路层协议很多，肯定不止我们说的这几个，但我们一般只关心这几个就够我们用了。这里简单提一下网络数据收发的一点基础。协议栈在组织数据收发流程时需要处理好两个方面的问题：“从上倒下”，即数据发送的任务；“从下到上”，即数据接收的任务。数据发送相对接收来说要容易些，因为对于数据接收而言，网卡驱动还要明确什么样的数据该接收、什么样的不该接收等问题。protocol字段可选的四个值及其意义如下：</p>

<p>protocol        值        作用<br/>
ETH_P_IP      0X0800   只接收发往目的MAC是本机的IP类型的数据帧<br/>
ETH_P_ARP     0X0806   只接收发往目的MAC是本机的ARP类型的数据帧<br/>
ETH_P_RARP    0X8035   只接受发往目的MAC是本机的RARP类型的数据帧<br/>
ETH_P_ALL     0X0003   接收发往目的MAC是本机的所有类型(ip,arp,rarp)的数据帧，同时还可以接收从本机发出去的所有数据帧。在混杂模式打开的情况下，还会接收到发往目的MAC为非本地硬件地址的数据帧。</p>

<p>protocol字段可取的所有协议参见/usr/include/linux/if_ether.h头文件里的定义。</p>

<p>最后，格外需要留心一点的就是，发送数据的时候需要自己组织整个以太网数据帧。和地址相关的结构体就不能再用前面的struct sockaddr_in{}了，而是struct sockaddr_ll{}，如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct sockaddr_ll{
</span><span class='line'>&#9;unsigned short sll_family; /* 总是 AF_PACKET */
</span><span class='line'>&#9;unsigned short sll_protocol; /* 物理层的协议 */
</span><span class='line'>&#9;int sll_ifindex; /* 接口号 */
</span><span class='line'>&#9;unsigned short sll_hatype; /* 报头类型 */
</span><span class='line'>&#9;unsigned char sll_pkttype; /* 分组类型 */
</span><span class='line'>&#9;unsigned char sll_halen; /* 地址长度 */
</span><span class='line'>&#9;unsigned char sll_addr[8]; /* 物理层地址 */
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>  sll_protocoll：取值在linux/if_ether.h中，可以指定我们所感兴趣的二层协议；</p>

<p>  sll_ifindex：置为0表示处理所有接口，对于单网卡的机器就不存在“所有”的概念了。如果你有多网卡，该字段的值一般通过ioctl来搞定，模板代码如下，如果我们要获取eth0接口的序号，可以使用如下代码来获取：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct  sockaddr_ll  sll;
</span><span class='line'>struct ifreq ifr;
</span><span class='line'>
</span><span class='line'>strcpy(ifr.ifr_name, "eth0");
</span><span class='line'>ioctl(sockfd, SIOCGIFINDEX, &ifr);
</span><span class='line'>sll.sll_ifindex = ifr.ifr_ifindex;</span></code></pre></td></tr></table></div></figure>


<p>  sll_hatype：ARP硬件地址类型，定义在 linux/if_arp.h 中。 取ARPHRD_ETHER时表示为以太网。</p>

<p>  sll_pkttype：包含分组类型。目前，有效的分组类型有：目标地址是本地主机的分组用的 PACKET_HOST，物理层广播分组用的 PACKET_BROADCAST ，发送到一个物理层多路广播地址的分组用的 PACKET_MULTICAST，在混杂(promiscuous)模式下的设备驱动器发向其他主机的分组用的 PACKET_OTHERHOST，源于本地主机的分组被环回到分组套接口用的 PACKET_OUTGOING。这些类型只对接收到的分组有意义。</p>

<p>  sll_addr和sll_halen指示物理层(如以太网，802.3，802.4或802.5等)地址及其长度，严格依赖于具体的硬件设备。类似于获取接口索引sll_ifindex，要获取接口的物理地址，可以采用如下代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct ifreq ifr;
</span><span class='line'>
</span><span class='line'>strcpy(ifr.ifr_name, "eth0");
</span><span class='line'>ioctl(sockfd, SIOCGIFHWADDR, &ifr);</span></code></pre></td></tr></table></div></figure>


<p> 缺省情况下，从任何接口收到的符合指定协议的所有数据报文都会被传送到原始PACKET套接字口，而使用bind系统调用并以一个sochddr_ll结构体对象将PACKET套接字与某个网络接口相绑定，就可使我们的PACKET原始套接字只接收指定接口的数据报文。</p>

<p> 接下来我们简单介绍一下网卡是怎么收报的，如果你对这部分已经很了解可以跳过这部分内容。网卡从线路上收到信号流，网卡的驱动程序会去检查数据帧开始的前6个字节，即目的主机的MAC地址，如果和自己的网卡地址一致它才会接收这个帧，不符合的一般都是直接无视。然后该数据帧会被网络驱动程序分解，IP报文将通过网络协议栈，最后传送到应用程序那里。往上层传递的过程就是一个校验和“剥头”的过程，由协议栈各层去实现。</p>

<p>接下来我们来写个简单的抓包程序，将那些发给本机的IPv4报文全打印出来：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;errno.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;sys/socket.h&gt;
</span><span class='line'>#include &lt;sys/types.h&gt;
</span><span class='line'>#include &lt;netinet/in.h&gt;
</span><span class='line'>#include &lt;netinet/ip.h&gt;
</span><span class='line'>#include &lt;netinet/if_ether.h&gt;
</span><span class='line'>
</span><span class='line'>int main(int argc, char **argv)
</span><span class='line'>{
</span><span class='line'>&#9;int sock, n;
</span><span class='line'>&#9;char buffer[2048];
</span><span class='line'>&#9;struct ethhdr *eth;
</span><span class='line'>&#9;struct iphdr *iph;
</span><span class='line'>
</span><span class='line'>&#9;if (0 &gt; (sock = socket(PF_PACKET, SOCK_RAW, htons(ETH_P_IP)))) {
</span><span class='line'>&#9;&#9;perror("socket");
</span><span class='line'>&#9;&#9;exit(1);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;while (1) {
</span><span class='line'>&#9;&#9;printf("=====================================\n");
</span><span class='line'>&#9;&#9;//注意：在这之前我没有调用bind函数，原因是什么呢？
</span><span class='line'>&#9;&#9;n = recvfrom(sock, buffer, 2048, 0, NULL, NULL);
</span><span class='line'>&#9;&#9;printf("%d bytes read\n", n);
</span><span class='line'>
</span><span class='line'>&#9;&#9;//接收到的数据帧头6字节是目的MAC地址，紧接着6字节是源MAC地址。
</span><span class='line'>&#9;&#9;eth = (struct ethhdr*)buffer;
</span><span class='line'>&#9;&#9;printf("Dest MAC addr:%02x:%02x:%02x:%02x:%02x:%02x\n",eth-&gt;h_dest[0],eth-&gt;h_dest[1],eth-&gt;h_dest[2],eth-&gt;h_dest[3],eth-&gt;h_dest[4],eth-&gt;h_dest[5]);
</span><span class='line'>&#9;&#9;printf("Source MAC addr:%02x:%02x:%02x:%02x:%02x:%02x\n",eth-&gt;h_source[0],eth-&gt;h_source[1],eth-&gt;h_source[2],eth-&gt;h_source[3],eth-&gt;h_source[4],eth-&gt;h_source[5]);
</span><span class='line'>
</span><span class='line'>&#9;&#9;iph = (struct iphdr*)(buffer + sizeof(struct ethhdr));
</span><span class='line'>&#9;&#9;//我们只对IPV4且没有选项字段的IPv4报文感兴趣
</span><span class='line'>&#9;&#9;if(iph-&gt;version == 4 && iph-&gt;ihl == 5){
</span><span class='line'>&#9;&#9;&#9;unsigned char *sd, *dd;
</span><span class='line'>&#9;&#9;&#9;sd = (unsigned char*)&iph-&gt;saddr;
</span><span class='line'>&#9;&#9;&#9;dd = (unsigned char*)&iph-&gt;daddr;
</span><span class='line'>&#9;&#9;&#9;printf("Source Host: %d.%d.%d.%d Dest host: %d.%d.%d.%d\n", sd[0], sd[1], sd[2], sd[3], dd[0], dd[1], dd[2], dd[3]);
</span><span class='line'>&#9;&#9;//    printf("Source host:%s\n", inet_ntoa(iph-&gt;saddr));
</span><span class='line'>&#9;&#9;//    printf("Dest host:%s\n", inet_ntoa(iph-&gt;daddr));
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>构造mac源地址包，注意目标mac地址要正确，可以本机先抓包看看是什么</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;errno.h&gt;
</span><span class='line'>#include &lt;string.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;netdb.h&gt;
</span><span class='line'>#include &lt;sys/socket.h&gt;
</span><span class='line'>#include &lt;sys/types.h&gt;
</span><span class='line'>#include &lt;netinet/in.h&gt;
</span><span class='line'>#include &lt;netinet/ip.h&gt;
</span><span class='line'>#include &lt;arpa/inet.h&gt;
</span><span class='line'>#include &lt;linux/tcp.h&gt;
</span><span class='line'>
</span><span class='line'>#include &lt;linux/if_ether.h&gt;
</span><span class='line'>#include &lt;linux/if_arp.h&gt;
</span><span class='line'>#include &lt;linux/sockios.h&gt;
</span><span class='line'>
</span><span class='line'>unsigned csum_tcpudp_nofold(unsigned saddr, unsigned daddr,
</span><span class='line'>&#9;&#9;&#9;unsigned len, unsigned proto, unsigned sum)
</span><span class='line'>{
</span><span class='line'>&#9;unsigned long long s = (unsigned)sum;
</span><span class='line'>&#9;s += (unsigned)saddr;
</span><span class='line'>&#9;s += (unsigned)daddr;
</span><span class='line'>&#9;s += (proto + len) &lt;&lt; 8;
</span><span class='line'>&#9;s += (s &gt;&gt; 32);
</span><span class='line'>&#9;return (unsigned)s;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>unsigned short check_sum(unsigned short *addr, int len, unsigned sum)
</span><span class='line'>{
</span><span class='line'>&#9;int nleft = len;
</span><span class='line'>&#9;unsigned short *w = addr;
</span><span class='line'>&#9;unsigned short ret = 0;
</span><span class='line'>&#9;while (nleft &gt; 1) {
</span><span class='line'>&#9;&#9;sum += *w++;
</span><span class='line'>&#9;&#9;nleft -= 2;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (nleft == 1) {
</span><span class='line'>&#9;&#9;*(unsigned char *)(&ret) = *(unsigned char *)w;
</span><span class='line'>&#9;&#9;sum += ret;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;sum = (sum&gt;&gt;16) + (sum&0xffff);
</span><span class='line'>&#9;sum += (sum&gt;&gt;16);
</span><span class='line'>&#9;ret = ~sum;
</span><span class='line'>&#9;return ret;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int change(char c)
</span><span class='line'>{
</span><span class='line'>&#9;if (c &gt;= 'a') return c-'a'+10;
</span><span class='line'>&#9;if (c &gt;= 'A') return c-'A'+10;
</span><span class='line'>&#9;return c-'0';
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>//在该函数中构造整个IP报文，最后调用sendto函数将报文发送出去
</span><span class='line'>void attack(int skfd, struct sockaddr_ll *target, char **argv)
</span><span class='line'>{
</span><span class='line'>&#9;char buf[512]={0};
</span><span class='line'>&#9;struct ethhdr *eth;
</span><span class='line'>&#9;struct ip *ip;
</span><span class='line'>&#9;struct tcphdr *tcp;
</span><span class='line'>&#9;int pks_len;
</span><span class='line'>&#9;int i;
</span><span class='line'>&#9;int op_len = 12;
</span><span class='line'>&#9;unsigned short dstport;
</span><span class='line'>&#9;dstport = atoi(argv[3]);
</span><span class='line'>
</span><span class='line'>&#9;//在我们TCP的报文中Data没有字段，所以整个IP报文的长度
</span><span class='line'>&#9;pks_len = sizeof(struct ethhdr) + sizeof(struct ip) + sizeof(struct tcphdr) + op_len;
</span><span class='line'>&#9;eth = (struct ethhdr *) buf;
</span><span class='line'>&#9;/*
</span><span class='line'>&#9;eth-&gt;h_dest[0] = 0x00;
</span><span class='line'>&#9;eth-&gt;h_dest[1] = 0x50;
</span><span class='line'>&#9;eth-&gt;h_dest[2] = 0x56;
</span><span class='line'>&#9;eth-&gt;h_dest[3] = 0xee;
</span><span class='line'>&#9;eth-&gt;h_dest[4] = 0x14;
</span><span class='line'>&#9;eth-&gt;h_dest[5] = 0xa6;
</span><span class='line'>&#9;*/
</span><span class='line'>
</span><span class='line'>&#9;for (i=0;i&lt;6;i++)
</span><span class='line'>&#9;&#9;eth-&gt;h_dest[i] = change(argv[1][i*3])*16 + change(argv[1][i*3+1]);
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9;eth-&gt;h_source[0] = 0x00;
</span><span class='line'>&#9;eth-&gt;h_source[1] = 0x0b;
</span><span class='line'>&#9;eth-&gt;h_source[2] = 0x28;
</span><span class='line'>&#9;eth-&gt;h_source[3] = 0xd7;
</span><span class='line'>&#9;eth-&gt;h_source[4] = 0x26;
</span><span class='line'>&#9;eth-&gt;h_source[5] = 0xa6;
</span><span class='line'>&#9;*/
</span><span class='line'>&#9;eth-&gt;h_proto = ntohs(ETH_P_IP);
</span><span class='line'>
</span><span class='line'>&#9;//开始填充IP首部
</span><span class='line'>&#9;ip=(struct ip*)(buf + sizeof(struct ethhdr));
</span><span class='line'>&#9;ip-&gt;ip_v = IPVERSION;
</span><span class='line'>&#9;ip-&gt;ip_hl = sizeof(struct ip) &gt;&gt; 2;
</span><span class='line'>&#9;ip-&gt;ip_tos = 0;
</span><span class='line'>&#9;ip-&gt;ip_len = htons(pks_len - sizeof(struct ethhdr));
</span><span class='line'>&#9;ip-&gt;ip_id = 0;
</span><span class='line'>&#9;ip-&gt;ip_off = 0;
</span><span class='line'>&#9;ip-&gt;ip_ttl = MAXTTL;
</span><span class='line'>&#9;ip-&gt;ip_p = IPPROTO_TCP;
</span><span class='line'>&#9;ip-&gt;ip_sum = 0;
</span><span class='line'>&#9;ip-&gt;ip_dst.s_addr = inet_addr(argv[2]);
</span><span class='line'>
</span><span class='line'>&#9;//开始填充TCP首部
</span><span class='line'>&#9;srand(time(NULL));
</span><span class='line'>&#9;tcp = (struct tcphdr*)(buf + sizeof(struct ethhdr) + sizeof(struct ip));
</span><span class='line'>&#9;tcp-&gt;source = random()%50000+10000;
</span><span class='line'>&#9;tcp-&gt;dest = ntohs(dstport);
</span><span class='line'>&#9;tcp-&gt;seq = random();
</span><span class='line'>&#9;tcp-&gt;doff = (sizeof(struct tcphdr) + op_len) &gt;&gt; 2;
</span><span class='line'>&#9;tcp-&gt;syn = 1;
</span><span class='line'>&#9;tcp-&gt;check = 0;
</span><span class='line'>&#9;tcp-&gt;window = ntohs(14600);
</span><span class='line'>
</span><span class='line'>&#9;i = pks_len - op_len;
</span><span class='line'>&#9;// mss = 1460
</span><span class='line'>&#9;buf[i++] = 0x02;
</span><span class='line'>&#9;buf[i++] = 0x04;
</span><span class='line'>&#9;buf[i++] = 0x05;
</span><span class='line'>&#9;buf[i++] = 0xb4;
</span><span class='line'>&#9;// sack
</span><span class='line'>&#9;buf[i++] = 0x01;
</span><span class='line'>&#9;buf[i++] = 0x01;
</span><span class='line'>&#9;buf[i++] = 0x04;
</span><span class='line'>&#9;buf[i++] = 0x02;
</span><span class='line'>&#9;// wsscale = 7
</span><span class='line'>&#9;buf[i++] = 0x01;
</span><span class='line'>&#9;buf[i++] = 0x03;
</span><span class='line'>&#9;buf[i++] = 0x03;
</span><span class='line'>&#9;buf[i++] = 0x07;
</span><span class='line'>
</span><span class='line'>&#9;int T = 1;
</span><span class='line'>&#9;while(1) {
</span><span class='line'>&#9;&#9;if (T == 0) break;
</span><span class='line'>&#9;&#9;T--;
</span><span class='line'>&#9;&#9;//源地址伪造，我们随便任意生成个地址，让服务器一直等待下去
</span><span class='line'>&#9;&#9;ip-&gt;ip_src.s_addr = random();
</span><span class='line'>&#9;&#9;//自定义源地址192.168.204.136 =&gt; 0xc0a8cc88
</span><span class='line'>&#9;&#9;//ip-&gt;ip_src.s_addr = 0x8fcca8c0;
</span><span class='line'>&#9;&#9;unsigned sum = csum_tcpudp_nofold(ip-&gt;ip_src.s_addr, ip-&gt;ip_dst.s_addr, sizeof(struct tcphdr)+op_len, IPPROTO_TCP, 0);
</span><span class='line'>&#9;&#9;tcp-&gt;check = check_sum((unsigned short*)tcp, sizeof(struct tcphdr)+op_len, sum);
</span><span class='line'>&#9;&#9;ip-&gt;ip_sum = check_sum((unsigned short*)ip, sizeof(struct ip), 0);
</span><span class='line'>&#9;&#9;sendto(skfd, buf, pks_len, 0, (struct sockaddr*)target, sizeof(struct sockaddr_ll));
</span><span class='line'>&#9;}
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int main(int argc, char** argv)
</span><span class='line'>{
</span><span class='line'>&#9;int skfd;
</span><span class='line'>&#9;struct sockaddr_ll target;
</span><span class='line'>&#9;struct hostent *host;
</span><span class='line'>&#9;const int on=1;
</span><span class='line'>
</span><span class='line'>&#9;if (argc != 4) {
</span><span class='line'>&#9;&#9;printf("Usage:%s dstmac dstip dstport\n", argv[0]);
</span><span class='line'>&#9;&#9;exit(1);
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (strlen(argv[1]) != 17) {
</span><span class='line'>&#9;&#9;printf("Usage: dstmac must be xx:xx:xx:xx:xx:xx\n");
</span><span class='line'>&#9;&#9;exit(1);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;//将协议字段置为IPPROTO_TCP，来创建一个TCP的原始套接字
</span><span class='line'>&#9;if (0 &gt; (skfd = socket(PF_PACKET, SOCK_RAW, htons(ETH_P_IP)))) {
</span><span class='line'>&#9;&#9;perror("Create Error");
</span><span class='line'>&#9;&#9;exit(1);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;// mac
</span><span class='line'>&#9;bzero(&target, sizeof(struct sockaddr_ll));
</span><span class='line'>
</span><span class='line'>&#9;struct ifreq ifr;
</span><span class='line'>&#9;strncpy(ifr.ifr_name, "eth0", IFNAMSIZ);
</span><span class='line'>&#9;ioctl(skfd, SIOCGIFINDEX, &ifr);
</span><span class='line'>&#9;target.sll_ifindex = ifr.ifr_ifindex;
</span><span class='line'>&#9;/*
</span><span class='line'>&#9;target.sll_family = AF_PACKET;
</span><span class='line'>&#9;target.sll_protocol = ntohs(80);
</span><span class='line'>&#9;target.sll_hatype = ARPHRD_ETHER;
</span><span class='line'>&#9;target.sll_pkttype = PACKET_OTHERHOST;
</span><span class='line'>&#9;target.sll_halen = ETH_ALEN;
</span><span class='line'>&#9;memset(target.sll_addr,0,8);
</span><span class='line'>&#9;target.sll_addr[0] = 0x00;
</span><span class='line'>&#9;target.sll_addr[1] = 0x0C;
</span><span class='line'>&#9;target.sll_addr[2] = 0x29;
</span><span class='line'>&#9;target.sll_addr[3] = 0x61;
</span><span class='line'>&#9;target.sll_addr[4] = 0xB6;
</span><span class='line'>&#9;target.sll_addr[5] = 0x43;
</span><span class='line'>&#9;*/
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;/*
</span><span class='line'>&#9;//http://blog.chinaunix.net/uid-305141-id-2133781.html
</span><span class='line'>&#9;struct sockaddr_ll sll;
</span><span class='line'>&#9;struct ifreq ifstruct;
</span><span class='line'>&#9;memset (&sll, 0, sizeof (sll));
</span><span class='line'>&#9;sll.sll_family = PF_PACKET;
</span><span class='line'>&#9;sll.sll_protocol = htons (ETH_P_IP);
</span><span class='line'>
</span><span class='line'>&#9;strcpy (ifstruct.ifr_name, "eth0");
</span><span class='line'>&#9;ioctl (skfd, SIOCGIFINDEX, &ifstruct);
</span><span class='line'>&#9;sll.sll_ifindex = ifstruct.ifr_ifindex;
</span><span class='line'>
</span><span class='line'>&#9;strcpy (ifstruct.ifr_name, "eth0");
</span><span class='line'>&#9;ioctl (skfd, SIOCGIFHWADDR, &ifstruct);
</span><span class='line'>&#9;memcpy (sll.sll_addr, ifstruct.ifr_ifru.ifru_hwaddr.sa_data, ETH_ALEN);
</span><span class='line'>&#9;sll.sll_halen = ETH_ALEN;
</span><span class='line'>
</span><span class='line'>&#9;if (bind (skfd, (struct sockaddr *) &sll, sizeof (sll)) == -1) {
</span><span class='line'>&#9;&#9;printf ("bind:   ERROR\n");
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;memset(&ifstruct, 0, sizeof(ifstruct));
</span><span class='line'>&#9;strcpy (ifstruct.ifr_name, "eth0");
</span><span class='line'>&#9;if (ioctl (skfd, SIOCGIFFLAGS, &ifstruct) == -1) {
</span><span class='line'>&#9;&#9;perror ("iotcl()\n");
</span><span class='line'>&#9;&#9;printf ("Fun:%s Line:%d\n", __func__, __LINE__);
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;ifstruct.ifr_flags |= IFF_PROMISC;
</span><span class='line'>
</span><span class='line'>&#9;if(ioctl(skfd, SIOCSIFFLAGS, &ifstruct) == -1) {
</span><span class='line'>&#9;&#9;perror("iotcl()\n");
</span><span class='line'>&#9;&#9;printf ("Fun:%s Line:%d\n", __func__, __LINE__);
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;} 
</span><span class='line'>*/
</span><span class='line'>&#9;//因为只有root用户才可以play with raw socket :)
</span><span class='line'>&#9;setuid(getpid());
</span><span class='line'>//    attack(skfd, &sll, srcport);
</span><span class='line'>&#9;attack(skfd, &target, argv);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/04/10/kernel-net-skbuff/">sk_buff详解</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-10T15:46:00+08:00'><span class='date'>2015-04-10</span> <span class='time'>15:46:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="/download/kernel/sk_buff%E8%AF%A6%E8%A7%A3.pdf">sk_buff详解</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/04/10/kernel-net-rcvmsg/">Linux TCP数据包接收处理 tcp_recvmsg</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-10T15:29:00+08:00'><span class='date'>2015-04-10</span> <span class='time'>15:29:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.csdn.net/mrpre/article/details/33347221">http://blog.csdn.net/mrpre/article/details/33347221</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* 
</span><span class='line'> *    This routine copies from a sock struct into the user buffer.
</span><span class='line'> *
</span><span class='line'> *    Technical note: in 2.3 we work on _locked_ socket, so that
</span><span class='line'> *    tricks with *seq access order and skb-&gt;users are not required.
</span><span class='line'> *    Probably, code can be easily improved even more.
</span><span class='line'> */
</span><span class='line'>
</span><span class='line'>int tcp_recvmsg(struct kiocb *iocb, struct sock *sk, struct msghdr *msg,
</span><span class='line'>&#9;&#9;size_t len, int nonblock, int flags, int *addr_len)
</span><span class='line'>{
</span><span class='line'>&#9;struct tcp_sock *tp = tcp_sk(sk);
</span><span class='line'>&#9;int copied = 0;
</span><span class='line'>&#9;u32 peek_seq;
</span><span class='line'>&#9;u32 *seq;
</span><span class='line'>&#9;unsigned long used;
</span><span class='line'>&#9;int err;
</span><span class='line'>&#9;int target;    /* Read at least this many bytes */
</span><span class='line'>&#9;long timeo;
</span><span class='line'>&#9;struct task_struct *user_recv = NULL;
</span><span class='line'>&#9;int copied_early = 0;
</span><span class='line'>&#9;struct sk_buff *skb;
</span><span class='line'>&#9;u32 urg_hole = 0;
</span><span class='line'>
</span><span class='line'>&#9;//功能：“锁住sk”，并非真正的加锁，而是执行sk-&gt;sk_lock.owned = 1 
</span><span class='line'>&#9;//目的：这样软中断上下文能够通过owned ，判断该sk是否处于进程上下文。
</span><span class='line'>&#9;//提供一种同步机制。
</span><span class='line'>&#9;lock_sock(sk);
</span><span class='line'>
</span><span class='line'>&#9;TCP_CHECK_TIMER(sk);
</span><span class='line'>
</span><span class='line'>&#9;err = -ENOTCONN;
</span><span class='line'>&#9;if (sk-&gt;sk_state == TCP_LISTEN)
</span><span class='line'>&#9;&#9;goto out;
</span><span class='line'>
</span><span class='line'>&#9;//获取延迟，如果用户设置为非阻塞，那么timeo ==0000 0000 0000 0000
</span><span class='line'>&#9;//如果用户使用默认recv系统调用
</span><span class='line'>&#9;//则为阻塞，此时timeo ==0111 1111 1111 1111
</span><span class='line'>&#9;//timeo 就2个值
</span><span class='line'>&#9;timeo = sock_rcvtimeo(sk, nonblock);
</span><span class='line'>
</span><span class='line'>&#9;/* Urgent data needs to be handled specially. */
</span><span class='line'>&#9;if (flags & MSG_OOB)
</span><span class='line'>&#9;&#9;goto recv_urg;
</span><span class='line'>
</span><span class='line'>&#9;//待拷贝的下一个序列号
</span><span class='line'>&#9;seq = &tp-&gt;copied_seq;
</span><span class='line'>
</span><span class='line'>&#9;//设置了MSG_PEEK，表示不让数据从缓冲区移除，目的是下一次调用recv函数
</span><span class='line'>&#9;//仍然能够读到相同数据
</span><span class='line'>&#9;if (flags & MSG_PEEK) {
</span><span class='line'>&#9;&#9;peek_seq = tp-&gt;copied_seq;
</span><span class='line'>&#9;&#9;seq = &peek_seq;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;//如果设置了MSG_WAITALL，则target  ==len，即recv函数中的参数len
</span><span class='line'>&#9;//如果没设置MSG_WAITALL，则target  == 1
</span><span class='line'>&#9;target = sock_rcvlowat(sk, flags & MSG_WAITALL, len);
</span><span class='line'>
</span><span class='line'>&#9;//大循环
</span><span class='line'>&#9;do {
</span><span class='line'>&#9;&#9;u32 offset;
</span><span class='line'>
</span><span class='line'>&#9;&#9;/* Are we at urgent data? Stop if we have read anything or have SIGURG pending. */
</span><span class='line'>&#9;&#9;if (tp-&gt;urg_data && tp-&gt;urg_seq == *seq) {
</span><span class='line'>&#9;&#9;&#9;if (copied)
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;&#9;if (signal_pending(current)) {
</span><span class='line'>&#9;&#9;&#9;&#9;copied = timeo ? sock_intr_errno(timeo) : -EAGAIN;
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;}
</span><span class='line'>
</span><span class='line'>&#9;&#9;/* Next get a buffer. */
</span><span class='line'>
</span><span class='line'>&#9;&#9;//小循环
</span><span class='line'>&#9;&#9;skb_queue_walk(&sk-&gt;sk_receive_queue, skb) {
</span><span class='line'>&#9;&#9;&#9;/* Now that we have two receive queues this
</span><span class='line'>&#9;&#9;&#9;&#9;* shouldn't happen.
</span><span class='line'>&#9;&#9;&#9;&#9;*/
</span><span class='line'>&#9;&#9;&#9;if (WARN(before(*seq, TCP_SKB_CB(skb)-&gt;seq),
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;KERN_INFO "recvmsg bug: copied %X "
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;      "seq %X rcvnxt %X fl %X\n", *seq,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;      TCP_SKB_CB(skb)-&gt;seq, tp-&gt;rcv_nxt,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;      flags))
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;//如果用户的缓冲区(即用户malloc的buf)长度够大，offset一般是0。
</span><span class='line'>&#9;&#9;&#9;//即 “下次准备拷贝数据的序列号”==此时获取报文的起始序列号
</span><span class='line'>&#9;&#9;&#9;//什么情况下offset &gt;0呢？很简答，如果用户缓冲区12字节，而这个skb有120字节
</span><span class='line'>&#9;&#9;&#9;//那么一次recv系统调用，只能获取skb中的前12个字节，下一次执行recv系统调用
</span><span class='line'>&#9;&#9;&#9;//offset就是12了，offset表示从第12个字节开始读取数据，前12个字节已经读取了。
</span><span class='line'>&#9;&#9;&#9;//那这个"已经读取12字节"这个消息，存在哪呢？
</span><span class='line'>&#9;&#9;&#9;//在*seq = &tp-&gt;copied_seq;中
</span><span class='line'>&#9;&#9;&#9;offset = *seq - TCP_SKB_CB(skb)-&gt;seq;
</span><span class='line'>&#9;&#9;&#9;if (tcp_hdr(skb)-&gt;syn)
</span><span class='line'>&#9;&#9;&#9;&#9;offset--;
</span><span class='line'>&#9;&#9;&#9;if (offset &lt; skb-&gt;len)
</span><span class='line'>&#9;&#9;&#9;&#9;goto found_ok_skb;
</span><span class='line'>&#9;&#9;&#9;if (tcp_hdr(skb)-&gt;fin)
</span><span class='line'>&#9;&#9;&#9;&#9;goto found_fin_ok;
</span><span class='line'>&#9;&#9;&#9;WARN(!(flags & MSG_PEEK), KERN_INFO "recvmsg bug 2: "
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;"copied %X seq %X rcvnxt %X fl %X\n",
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;*seq, TCP_SKB_CB(skb)-&gt;seq,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;tp-&gt;rcv_nxt, flags);
</span><span class='line'>&#9;&#9;}
</span><span class='line'>
</span><span class='line'>&#9;&#9;//执行到了这里，表明小循环中break了，既然break了，说明sk_receive_queue中
</span><span class='line'>&#9;&#9;//已经没有skb可以读取了
</span><span class='line'>&#9;&#9;//如果没有执行到这里说明前面的小循环中执行了goto，读到有用的skb，或者读到fin都会goto。
</span><span class='line'>&#9;&#9;//没有skb可以读取，说明什么？
</span><span class='line'>&#9;&#9;//可能性1：当用户第一次调用recv时，压根没有数据到来
</span><span class='line'>&#9;&#9;//可能性2：skb-&gt;len一共20字节，假设用户调用一次 recv，读取12字节，再调用recv，
</span><span class='line'>&#9;&#9;//读取12字节，此时skb由于上次已经被读取了12字节，只剩下8字节。
</span><span class='line'>&#9;&#9;//于是代码的逻辑上，再会要求获取skb，来读取剩下的8字节。
</span><span class='line'>
</span><span class='line'>&#9;&#9;//可能性1的情况下，copied == 0，肯定不会进这个if。后续将执行休眠
</span><span class='line'>&#9;&#9;//可能性2的情况下，情况比较复杂。可能性2表明数据没有读够用户想要的len长度
</span><span class='line'>&#9;&#9;//虽然进程上下文中，没有读够数据，但是可能我们在读数据的时候
</span><span class='line'>&#9;&#9;//软中断把数据放到backlog队列中了，而backlog对队列中的数据或许恰好让我们读够数
</span><span class='line'>&#9;&#9;//据。
</span><span class='line'>
</span><span class='line'>&#9;&#9;//copied了数据的，copied肯定&gt;=1，而target 是1或者len
</span><span class='line'>&#9;&#9;//copied只能取0(可能性1)，或者0~len(可能性2)
</span><span class='line'>&#9;&#9;//copied &gt;= target 表示我们取得我们想要的数据了，何必进行休眠，直接return
</span><span class='line'>&#9;&#9;//如果copied 没有达到我们想要的数据，则看看sk_backlog是否为空
</span><span class='line'>&#9;&#9;//空的话，尽力了，只能尝试休眠
</span><span class='line'>&#9;&#9;//非空的话，还有一线希望，我们去sk_backlog找找数据，看看是否能够达到我们想要的
</span><span class='line'>&#9;&#9;//数据大小
</span><span class='line'>
</span><span class='line'>&#9;&#9;//我觉得copied == target是会出现的，但是出现的话，也不会进现在这个流程
</span><span class='line'>&#9;&#9;//，如有不对，请各位大神指正，告诉我
</span><span class='line'>&#9;&#9;//说明情况下copied == target
</span><span class='line'>
</span><span class='line'>&#9;&#9;/* Well, if we have backlog, try to process it now yet. */
</span><span class='line'>&#9;&#9;if (copied &gt;= target && !sk-&gt;sk_backlog.tail)
</span><span class='line'>&#9;&#9;&#9;break;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;&#9;if (copied) {
</span><span class='line'>&#9;&#9;&#9;//可能性2，拷贝了数据，但是没有拷贝到指定大小
</span><span class='line'>&#9;&#9;&#9;if (sk-&gt;sk_err ||
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;sk-&gt;sk_state == TCP_CLOSE ||
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;(sk-&gt;sk_shutdown & RCV_SHUTDOWN) ||
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;!timeo ||
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;signal_pending(current))
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;} else {
</span><span class='line'>&#9;&#9;&#9;//可能性1
</span><span class='line'>&#9;&#9;&#9;if (sock_flag(sk, SOCK_DONE))
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;if (sk-&gt;sk_err) {
</span><span class='line'>&#9;&#9;&#9;&#9;copied = sock_error(sk);
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;if (sk-&gt;sk_shutdown & RCV_SHUTDOWN)
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;if (sk-&gt;sk_state == TCP_CLOSE) {
</span><span class='line'>&#9;&#9;&#9;&#9;if (!sock_flag(sk, SOCK_DONE)) {
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;/* This occurs when user tries to read
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;* from never connected socket.
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;*/
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;copied = -ENOTCONN;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;//是否是阻塞的，不是，就return了。
</span><span class='line'>&#9;&#9;&#9;if (!timeo) {
</span><span class='line'>&#9;&#9;&#9;&#9;copied = -EAGAIN;
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;if (signal_pending(current)) {
</span><span class='line'>&#9;&#9;&#9;&#9;copied = sock_intr_errno(timeo);
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;}
</span><span class='line'>
</span><span class='line'>&#9;&#9;tcp_cleanup_rbuf(sk, copied);
</span><span class='line'>
</span><span class='line'>&#9;&#9;//sysctl_tcp_low_latency 默认0tp-&gt;ucopy.task == user_recv肯定也成立
</span><span class='line'>
</span><span class='line'>&#9;&#9;if (!sysctl_tcp_low_latency && tp-&gt;ucopy.task == user_recv) {
</span><span class='line'>&#9;&#9;&#9;/* Install new reader */
</span><span class='line'>&#9;&#9;&#9;if (!user_recv && !(flags & (MSG_TRUNC | MSG_PEEK))) {
</span><span class='line'>&#9;&#9;&#9;&#9;user_recv = current;
</span><span class='line'>&#9;&#9;&#9;&#9;tp-&gt;ucopy.task = user_recv;
</span><span class='line'>&#9;&#9;&#9;&#9;tp-&gt;ucopy.iov = msg-&gt;msg_iov;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;tp-&gt;ucopy.len = len;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;WARN_ON(tp-&gt;copied_seq != tp-&gt;rcv_nxt &&
</span><span class='line'>&#9;&#9;&#9;&#9;!(flags & (MSG_PEEK | MSG_TRUNC)));
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;/* Ugly... If prequeue is not empty, we have to
</span><span class='line'>&#9;&#9;&#9;&#9;* process it before releasing socket, otherwise
</span><span class='line'>&#9;&#9;&#9;&#9;* order will be broken at second iteration.
</span><span class='line'>&#9;&#9;&#9;&#9;* More elegant solution is required!!!
</span><span class='line'>&#9;&#9;&#9;&#9;*
</span><span class='line'>&#9;&#9;&#9;&#9;* Look: we have the following (pseudo)queues:
</span><span class='line'>&#9;&#9;&#9;&#9;*
</span><span class='line'>&#9;&#9;&#9;&#9;* 1. packets in flight
</span><span class='line'>&#9;&#9;&#9;&#9;* 2. backlog
</span><span class='line'>&#9;&#9;&#9;&#9;* 3. prequeue
</span><span class='line'>&#9;&#9;&#9;&#9;* 4. receive_queue
</span><span class='line'>&#9;&#9;&#9;&#9;*
</span><span class='line'>&#9;&#9;&#9;&#9;* Each queue can be processed only if the next ones
</span><span class='line'>&#9;&#9;&#9;&#9;* are empty. At this point we have empty receive_queue.
</span><span class='line'>&#9;&#9;&#9;&#9;* But prequeue _can_ be not empty after 2nd iteration,
</span><span class='line'>&#9;&#9;&#9;&#9;* when we jumped to start of loop because backlog
</span><span class='line'>&#9;&#9;&#9;&#9;* processing added something to receive_queue.
</span><span class='line'>&#9;&#9;&#9;&#9;* We cannot release_sock(), because backlog contains
</span><span class='line'>&#9;&#9;&#9;&#9;* packets arrived _after_ prequeued ones.
</span><span class='line'>&#9;&#9;&#9;&#9;*
</span><span class='line'>&#9;&#9;&#9;&#9;* Shortly, algorithm is clear --- to process all
</span><span class='line'>&#9;&#9;&#9;&#9;* the queues in order. We could make it more directly,
</span><span class='line'>&#9;&#9;&#9;&#9;* requeueing packets from backlog to prequeue, if
</span><span class='line'>&#9;&#9;&#9;&#9;* is not empty. It is more elegant, but eats cycles,
</span><span class='line'>&#9;&#9;&#9;&#9;* unfortunately.
</span><span class='line'>&#9;&#9;&#9;&#9;*/
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;if (!skb_queue_empty(&tp-&gt;ucopy.prequeue))
</span><span class='line'>&#9;&#9;&#9;&#9;goto do_prequeue;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;/* __ Set realtime policy in scheduler __ */
</span><span class='line'>&#9;&#9;}
</span><span class='line'>
</span><span class='line'>&#9;&#9;if (copied &gt;= target) {
</span><span class='line'>&#9;&#9;&#9;/* Do not sleep, just process backlog. */
</span><span class='line'>&#9;&#9;&#9;release_sock(sk);
</span><span class='line'>&#9;&#9;&#9;lock_sock(sk);
</span><span class='line'>&#9;&#9;} else
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;sk_wait_data(sk, &timeo); 
</span><span class='line'>&#9;&#9;//在此处睡眠了，将在tcp_prequeue函数中调用wake_up_interruptible_poll唤醒
</span><span class='line'>&#9;&#9;
</span><span class='line'>&#9;&#9;//软中断会判断用户是正在读取检查并且睡眠了，如果是的话，就直接把数据拷贝
</span><span class='line'>&#9;&#9;//到prequeue队列，然后唤醒睡眠的进程。因为进程睡眠，表示没有读到想要的字节数
</span><span class='line'>&#9;&#9;//此时，软中断有数据到来，直接给进程，这样进程就能以最快的速度被唤醒。
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;&#9;if (user_recv) {
</span><span class='line'>&#9;&#9;&#9;int chunk;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;/* __ Restore normal policy in scheduler __ */
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;if ((chunk = len - tp-&gt;ucopy.len) != 0) {
</span><span class='line'>&#9;&#9;&#9;&#9;NET_ADD_STATS_USER(sock_net(sk), LINUX_MIB_TCPDIRECTCOPYFROMBACKLOG, chunk);
</span><span class='line'>&#9;&#9;&#9;&#9;len -= chunk;
</span><span class='line'>&#9;&#9;&#9;&#9;copied += chunk;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;if (tp-&gt;rcv_nxt == tp-&gt;copied_seq &&
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;!skb_queue_empty(&tp-&gt;ucopy.prequeue)) {
</span><span class='line'>do_prequeue:
</span><span class='line'>&#9;&#9;&#9;&#9;tcp_prequeue_process(sk);
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;&#9;if ((chunk = len - tp-&gt;ucopy.len) != 0) {
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;NET_ADD_STATS_USER(sock_net(sk), LINUX_MIB_TCPDIRECTCOPYFROMPREQUEUE, chunk);
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;len -= chunk;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;copied += chunk;
</span><span class='line'>&#9;&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;if ((flags & MSG_PEEK) &&
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;(peek_seq - copied - urg_hole != tp-&gt;copied_seq)) {
</span><span class='line'>&#9;&#9;&#9;if (net_ratelimit())
</span><span class='line'>&#9;&#9;&#9;&#9;printk(KERN_DEBUG "TCP(%s:%d): Application bug, race in MSG_PEEK.\n",
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;      current-&gt;comm, task_pid_nr(current));
</span><span class='line'>&#9;&#9;&#9;peek_seq = tp-&gt;copied_seq;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;continue;
</span><span class='line'>
</span><span class='line'>&#9;found_ok_skb:
</span><span class='line'>&#9;&#9;/* Ok so how much can we use? */
</span><span class='line'>&#9;&#9;//skb中还有多少聚聚没有拷贝。
</span><span class='line'>&#9;&#9;//正如前面所说的，offset是上次已经拷贝了的，这次从offset开始接下去拷贝
</span><span class='line'>&#9;&#9;&#9;&#9;used = skb-&gt;len - offset;
</span><span class='line'>&#9;&#9;//很有可能used的大小，即skb剩余长度，依然大于用户的缓冲区大小(len)。所以依然
</span><span class='line'>&#9;&#9;//只能拷贝len长度。一般来说，用户还得执行一次recv系统调用。直到skb中的数据读完
</span><span class='line'>&#9;&#9;if (len &lt; used)
</span><span class='line'>&#9;&#9;&#9;used = len;
</span><span class='line'>
</span><span class='line'>&#9;&#9;/* Do we have urgent data here? */
</span><span class='line'>&#9;&#9;if (tp-&gt;urg_data) {
</span><span class='line'>&#9;&#9;&#9;u32 urg_offset = tp-&gt;urg_seq - *seq;
</span><span class='line'>&#9;&#9;&#9;if (urg_offset &lt; used) {
</span><span class='line'>&#9;&#9;&#9;&#9;if (!urg_offset) {
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;if (!sock_flag(sk, SOCK_URGINLINE)) {
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;++*seq;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;urg_hole++;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;offset++;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;used--;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;if (!used)
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;goto skip_copy;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;&#9;} else
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;used = urg_offset;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;}
</span><span class='line'>
</span><span class='line'>&#9;&#9;if (!(flags & MSG_TRUNC)) {
</span><span class='line'>&#9;&#9;&#9;{
</span><span class='line'>&#9;&#9;&#9;&#9;//一般都会进这个if，进行数据的拷贝，把能够读到的数据，放到用户的缓冲区
</span><span class='line'>&#9;&#9;&#9;&#9;err = skb_copy_datagram_iovec(skb, offset,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;msg-&gt;msg_iov, used);
</span><span class='line'>&#9;&#9;&#9;&#9;if (err) {
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;/* Exception. Bailout! */
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;if (!copied)
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;copied = -EFAULT;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;}
</span><span class='line'>
</span><span class='line'>&#9;&#9;//更新标志位，seq 是指针，指向了tp-&gt;copied_seq
</span><span class='line'>&#9;&#9;//used是我们有能力拷贝的数据大小，即已经拷贝到用户缓冲区的大小
</span><span class='line'>&#9;&#9;//正如前面所说，如果用户的缓冲区很小，一次recv拷贝不玩skb中的数据，
</span><span class='line'>&#9;&#9;//我们需要保存已经拷贝了的大小，下次recv时，从这个大小处继续拷贝。
</span><span class='line'>&#9;&#9;//所以需要更新copied_seq。
</span><span class='line'>&#9;&#9;*seq += used;
</span><span class='line'>&#9;&#9;copied += used;
</span><span class='line'>&#9;&#9;len -= used;
</span><span class='line'>
</span><span class='line'>&#9;&#9;tcp_rcv_space_adjust(sk);
</span><span class='line'>
</span><span class='line'>skip_copy:
</span><span class='line'>&#9;&#9;if (tp-&gt;urg_data && after(tp-&gt;copied_seq, tp-&gt;urg_seq)) {
</span><span class='line'>&#9;&#9;&#9;tp-&gt;urg_data = 0;
</span><span class='line'>&#9;&#9;&#9;tcp_fast_path_check(sk);
</span><span class='line'>&#9;&#9;}
</span><span class='line'>
</span><span class='line'>&#9;&#9;//这个就是判断我们是否拷贝完了skb中的数据，如果没有continue
</span><span class='line'>&#9;&#9;//这种情况下，len经过 len -= used; ，已经变成0，所以continue的效果相当于
</span><span class='line'>&#9;&#9;//退出了这个大循环。可以理解，你只能拷贝len长度，拷贝完之后，那就return了。
</span><span class='line'>
</span><span class='line'>&#9;&#9;//还有一种情况used + offset ==  skb-&gt;len，表示skb拷贝完了。这时我们只需要释放skb
</span><span class='line'>&#9;&#9;//下面会讲到
</span><span class='line'>&#9;&#9;if (used + offset &lt; skb-&gt;len)
</span><span class='line'>&#9;&#9;&#9;continue;
</span><span class='line'>
</span><span class='line'>&#9;&#9;//看看这个数据报文是否含有fin，含有fin，则goto到found_fin_ok
</span><span class='line'>&#9;&#9;if (tcp_hdr(skb)-&gt;fin)
</span><span class='line'>&#9;&#9;&#9;goto found_fin_ok;
</span><span class='line'>
</span><span class='line'>&#9;&#9;//执行到这里，标明used + offset ==  skb-&gt;len，报文也拷贝完了，那就把skb摘链释放
</span><span class='line'>&#9;&#9;if (!(flags & MSG_PEEK)) {
</span><span class='line'>&#9;&#9;&#9;sk_eat_skb(sk, skb, copied_early);
</span><span class='line'>&#9;&#9;&#9;copied_early = 0;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;//这个cintinue不一定是退出大循环，可能还会执行循环。
</span><span class='line'>&#9;&#9;//假设用户设置缓冲区12字节，你skb-&gt;len长度20字节。
</span><span class='line'>&#9;&#9;//第一次recv读取了12字节，skb剩下8，下一次调用recv再想读取12，
</span><span class='line'>&#9;&#9;//但是只能读取到这8字节了。
</span><span class='line'>&#9;&#9;//此时len 变量长度为4，那么这个continue依旧在这个循环中，
</span><span class='line'>&#9;&#9;//函数还是再次从do开始，使用skb_queue_walk，找skb
</span><span class='line'>&#9;&#9;//如果sk_receive_queue中skb仍旧有，那么继续读，直到len == 0
</span><span class='line'>&#9;&#9;//如果没有skb了，我们怎么办？我们的len还有4字节怎么办？
</span><span class='line'>&#9;&#9;//这得看用户设置的recv函数阻塞与否，即和timeo变量相关了。
</span><span class='line'>&#9;&#9;continue;
</span><span class='line'>
</span><span class='line'>&#9;found_fin_ok:
</span><span class='line'>&#9;&#9;/* Process the FIN. */
</span><span class='line'>&#9;&#9;++*seq;
</span><span class='line'>&#9;&#9;if (!(flags & MSG_PEEK)) {
</span><span class='line'>&#9;&#9;&#9;//把skb从sk_receive_queue中摘链
</span><span class='line'>&#9;&#9;&#9;sk_eat_skb(sk, skb, copied_early);
</span><span class='line'>&#9;&#9;&#9;copied_early = 0;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;break;
</span><span class='line'>&#9;} while (len &gt; 0);
</span><span class='line'>
</span><span class='line'>&#9;//到这里是大循环退出
</span><span class='line'>&#9;//休眠过的进程，然后退出大循环 ，才满足 if (user_recv) 条件
</span><span class='line'>&#9;if (user_recv) {
</span><span class='line'>&#9;&#9;if (!skb_queue_empty(&tp-&gt;ucopy.prequeue)) {
</span><span class='line'>&#9;&#9;&#9;int chunk;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;tp-&gt;ucopy.len = copied &gt; 0 ? len : 0;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;tcp_prequeue_process(sk);
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;if (copied &gt; 0 && (chunk = len - tp-&gt;ucopy.len) != 0) {
</span><span class='line'>&#9;&#9;&#9;&#9;NET_ADD_STATS_USER(sock_net(sk), LINUX_MIB_TCPDIRECTCOPYFROMPREQUEUE, chunk);
</span><span class='line'>&#9;&#9;&#9;&#9;len -= chunk;
</span><span class='line'>&#9;&#9;&#9;&#9;copied += chunk;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;}
</span><span class='line'>
</span><span class='line'>&#9;&#9;//数据读取完毕，清零
</span><span class='line'>&#9;&#9;tp-&gt;ucopy.task = NULL;
</span><span class='line'>&#9;&#9;tp-&gt;ucopy.len = 0;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;/* According to UNIX98, msg_name/msg_namelen are ignored
</span><span class='line'>&#9;&#9;* on connected socket. I was just happy when found this 8) --ANK
</span><span class='line'>&#9;&#9;*/
</span><span class='line'>
</span><span class='line'>&#9;/* Clean up data we have read: This will do ACK frames. */
</span><span class='line'>&#9;//很重要，将更新缓存，并且适当的时候发送ack
</span><span class='line'>&#9;tcp_cleanup_rbuf(sk, copied);
</span><span class='line'>
</span><span class='line'>&#9;TCP_CHECK_TIMER(sk);
</span><span class='line'>&#9;release_sock(sk);
</span><span class='line'>&#9;return copied;
</span><span class='line'>
</span><span class='line'>out:
</span><span class='line'>&#9;TCP_CHECK_TIMER(sk);
</span><span class='line'>&#9;release_sock(sk);
</span><span class='line'>&#9;return err;
</span><span class='line'>
</span><span class='line'>recv_urg:
</span><span class='line'>&#9;err = tcp_recv_urg(sk, msg, len, flags);
</span><span class='line'>&#9;goto out;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/04/10/kernel-net-v4rcv/">Linux TCP数据包接收处理 tcp_v4_rcv</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-10T15:23:00+08:00'><span class='date'>2015-04-10</span> <span class='time'>15:23:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.sina.com.cn/s/blog_52355d840100b6sd.html">http://blog.sina.com.cn/s/blog_52355d840100b6sd.html</a></p>

<h4>tcp_v4_rcv函数</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int tcp_v4_rcv(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>&#9;const struct iphdr *iph;
</span><span class='line'>&#9;struct tcphdr *th;
</span><span class='line'>&#9;struct sock *sk;
</span><span class='line'>&#9;int ret;
</span><span class='line'>&#9;  
</span><span class='line'>&#9;//如果不是发往本地的数据包，则直接丢弃
</span><span class='line'>&#9;if (skb-&gt;pkt_type != PACKET_HOST)
</span><span class='line'>&#9;&#9;goto discard_it;
</span><span class='line'>
</span><span class='line'>&#9;TCP_INC_STATS_BH(TCP_MIB_INSEGS);
</span><span class='line'>
</span><span class='line'>&#9;//包长是否大于TCP头的长度
</span><span class='line'>&#9;if (!pskb_may_pull(skb, sizeof(struct tcphdr)))
</span><span class='line'>&#9;&#9;goto discard_it;
</span><span class='line'>
</span><span class='line'>&#9;//取得TCP首部
</span><span class='line'>&#9;th = tcp_hdr(skb);
</span><span class='line'>
</span><span class='line'>&#9;//检查TCP首部的长度和TCP首部中的doff字段是否匹配
</span><span class='line'>&#9;if (th-&gt;doff &lt; sizeof(struct tcphdr) / 4)
</span><span class='line'>&#9;&#9;goto bad_packet;
</span><span class='line'>
</span><span class='line'>&#9;//检查TCP首部到TCP数据之间的偏移是否越界
</span><span class='line'>&#9;if (!pskb_may_pull(skb, th-&gt;doff * 4))
</span><span class='line'>&#9;&#9;goto discard_it;
</span><span class='line'>
</span><span class='line'>&#9;if (!skb_csum_unnecessary(skb) && tcp_v4_checksum_init(skb))
</span><span class='line'>&#9;&#9;goto bad_packet;
</span><span class='line'>
</span><span class='line'>&#9; th = tcp_hdr(skb);
</span><span class='line'>&#9;iph = ip_hdr(skb);
</span><span class='line'>&#9;TCP_SKB_CB(skb)-&gt;seq = ntohl(th-&gt;seq);
</span><span class='line'>
</span><span class='line'>&#9;//计算end_seq,实际上，end_seq是数据包的结束序列号，实际上是期待TCP确认
</span><span class='line'>&#9;//包中ACK的数值，在数据传输过程中，确认包ACK的数值等于本次数据包SEQ
</span><span class='line'>&#9;//号加上本数据包的有效载荷，即skb-&gt;len - th-&gt;doff * 4,但是在处理SYN报文或者
</span><span class='line'>&#9;//FIN报文的时候，确认包的ACK等于本次处理数据包的SEQ+1,考虑到这种情况，
</span><span class='line'>&#9;//期待下一个数据包的ACK就变成了TCP_SKB_CB(skb)-&gt;seq + th-&gt;syn + th-&gt;fin +
</span><span class='line'>&#9;//skb-&gt;len - th-&gt;doff * 4
</span><span class='line'>
</span><span class='line'>&#9;// TCP_SKB_CB宏会返回skb-&gt;cb[0],一个类型为tcp_skb_cb的结构指针，这个结
</span><span class='line'>&#9;//构保存了TCP首部选项和其他的一些状态信息
</span><span class='line'>
</span><span class='line'>&#9;TCP_SKB_CB(skb)-&gt;end_seq = (TCP_SKB_CB(skb)-&gt;seq + th-&gt;syn + th-&gt;fin +
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;skb-&gt;len - th-&gt;doff * 4);
</span><span class='line'>&#9;TCP_SKB_CB(skb)-&gt;ack_seq = ntohl(th-&gt;ack_seq);
</span><span class='line'>&#9;TCP_SKB_CB(skb)-&gt;when   = 0;
</span><span class='line'>&#9;TCP_SKB_CB(skb)-&gt;flags    = iph-&gt;tos;
</span><span class='line'>&#9;TCP_SKB_CB(skb)-&gt;sacked = 0;
</span><span class='line'>
</span><span class='line'>&#9;//根据四元组查找相应连接的sock结构，大体有两个步骤，
</span><span class='line'>&#9;//首先用__inet_lookup_established函数查找已经处于establish状态的连接，
</span><span class='line'>&#9;//如果查找不到的话，就调用__inet_lookup_listener函数查找是否存在四元组相
</span><span class='line'>&#9;//匹配的处于listen状态的sock,这个时候实际上是被动的接收来自其他主机的连接
</span><span class='line'>&#9;//请求
</span><span class='line'>
</span><span class='line'>&#9;//如果查找不到匹配的sock,则直接丢弃数据包
</span><span class='line'>&#9;sk = __inet_lookup(&tcp_hashinfo, iph-&gt;saddr, th-&gt;source,
</span><span class='line'>&#9;&#9;&#9;   iph-&gt;daddr, th-&gt;dest, inet_iif(skb));
</span><span class='line'>&#9;if (!sk)
</span><span class='line'>&#9;&#9;goto no_tcp_socket;
</span><span class='line'>
</span><span class='line'>&#9;//检查sock是否处于半关闭状态
</span><span class='line'>&#9;process:
</span><span class='line'>&#9;if (sk-&gt;sk_state == TCP_TIME_WAIT)
</span><span class='line'>&#9;&#9;goto do_time_wait;
</span><span class='line'> 
</span><span class='line'>&#9;//检查IPSEC规则
</span><span class='line'>&#9;if (!xfrm4_policy_check(sk, XFRM_POLICY_IN, skb))
</span><span class='line'>&#9;&#9;goto discard_and_relse;
</span><span class='line'>&#9;nf_reset(skb);
</span><span class='line'>
</span><span class='line'>&#9;//检查BPF规则
</span><span class='line'>&#9;if (sk_filter(sk, skb))
</span><span class='line'>&#9;&#9;goto discard_and_relse;
</span><span class='line'>
</span><span class='line'>&#9;skb-&gt;dev = NULL;
</span><span class='line'>
</span><span class='line'>&#9;//这里主要是和release_sock函数实现互斥，release_sock中调用了
</span><span class='line'>&#9;// spin_lock_bh(&sk-&gt;sk_lock.slock);
</span><span class='line'>&#9;bh_lock_sock_nested(sk);
</span><span class='line'>&#9;ret = 0;
</span><span class='line'>
</span><span class='line'>&#9;//查看是否有用户态进程对该sock进行了锁定
</span><span class='line'>&#9;//如果sock_owned_by_user为真，则sock的状态不能进行更改
</span><span class='line'>&#9;if (!sock_owned_by_user(sk)) {
</span><span class='line'>
</span><span class='line'>#ifdef CONFIG_NET_DMA
</span><span class='line'>&#9;&#9;struct tcp_sock *tp = tcp_sk(sk);
</span><span class='line'>&#9;&#9;if (!tp-&gt;ucopy.dma_chan && tp-&gt;ucopy.pinned_list)
</span><span class='line'>&#9;&#9;&#9;tp-&gt;ucopy.dma_chan = get_softnet_dma();
</span><span class='line'>&#9;&#9;if (tp-&gt;ucopy.dma_chan)
</span><span class='line'>&#9;&#9;&#9;ret = tcp_v4_do_rcv(sk, skb);
</span><span class='line'>&#9;&#9;else
</span><span class='line'>#endif
</span><span class='line'>&#9;&#9;{
</span><span class='line'>&#9;&#9;&#9;//进入预备处理队列
</span><span class='line'>&#9;&#9;&#9;if (!tcp_prequeue(sk, skb))
</span><span class='line'>&#9;&#9;&#9;&#9;ret = tcp_v4_do_rcv(sk, skb);
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;} else
</span><span class='line'>&#9;&#9;//如果数据包被用户进程锁定，则数据包进入后备处理队列，并且该进程进入
</span><span class='line'>&#9;&#9;//套接字的后备处理等待队列sk-&gt;lock.wq
</span><span class='line'>&#9;&#9;sk_add_backlog(sk, skb);
</span><span class='line'>&#9;bh_unlock_sock(sk);
</span><span class='line'>
</span><span class='line'>&#9;sock_put(sk);
</span><span class='line'>&#9;return ret;
</span><span class='line'>
</span><span class='line'>no_tcp_socket:
</span><span class='line'>&#9;if (!xfrm4_policy_check(NULL, XFRM_POLICY_IN, skb))
</span><span class='line'>&#9;&#9;goto discard_it;
</span><span class='line'>
</span><span class='line'>&#9;if (skb-&gt;len &lt; (th-&gt;doff &lt;&lt; 2) || tcp_checksum_complete(skb)) {
</span><span class='line'>bad_packet:
</span><span class='line'>&#9;&#9;TCP_INC_STATS_BH(TCP_MIB_INERRS);
</span><span class='line'>&#9;} else {
</span><span class='line'>&#9;&#9;tcp_v4_send_reset(NULL, skb);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>discard_it:
</span><span class='line'>&#9;kfree_skb(skb);
</span><span class='line'>&#9;return 0;
</span><span class='line'>
</span><span class='line'>discard_and_relse:
</span><span class='line'>&#9;sock_put(sk);
</span><span class='line'>&#9;goto discard_it;
</span><span class='line'>
</span><span class='line'>do_time_wait:
</span><span class='line'>&#9;if (!xfrm4_policy_check(NULL, XFRM_POLICY_IN, skb)) {
</span><span class='line'>&#9;&#9;inet_twsk_put(inet_twsk(sk));
</span><span class='line'>&#9;&#9;goto discard_it;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;if (skb-&gt;len &lt; (th-&gt;doff &lt;&lt; 2) || tcp_checksum_complete(skb)) {
</span><span class='line'>&#9;&#9;TCP_INC_STATS_BH(TCP_MIB_INERRS);
</span><span class='line'>&#9;&#9;inet_twsk_put(inet_twsk(sk));
</span><span class='line'>&#9;&#9;goto discard_it;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;switch (tcp_timewait_state_process(inet_twsk(sk), skb, th)) {
</span><span class='line'>&#9;case TCP_TW_SYN: {
</span><span class='line'>&#9;&#9;struct sock *sk2 = inet_lookup_listener(&tcp_hashinfo,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;iph-&gt;daddr, th-&gt;dest,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;inet_iif(skb));
</span><span class='line'>&#9;&#9;if (sk2) {
</span><span class='line'>&#9;&#9;&#9;inet_twsk_deschedule(inet_twsk(sk), &tcp_death_row);
</span><span class='line'>&#9;&#9;&#9;inet_twsk_put(inet_twsk(sk));
</span><span class='line'>&#9;&#9;&#9;sk = sk2;
</span><span class='line'>&#9;&#9;&#9;goto process;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;case TCP_TW_ACK:
</span><span class='line'>&#9;&#9;tcp_v4_timewait_ack(sk, skb);
</span><span class='line'>&#9;&#9;break;
</span><span class='line'>&#9;case TCP_TW_RST:
</span><span class='line'>&#9;&#9;goto no_tcp_socket;
</span><span class='line'>&#9;case TCP_TW_SUCCESS:;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;goto discard_it;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/04/10/kernel-net-syncookie/">SYN cookies机制下连接的建立</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-10T14:34:00+08:00'><span class='date'>2015-04-10</span> <span class='time'>14:34:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.csdn.net/justlinux2010/article/details/12619761">http://blog.csdn.net/justlinux2010/article/details/12619761</a></p>

<p>  在正常情况下，服务器端接收到客户端发送的SYN包，会分配一个连接请求块（即request_sock结构），用于保存连接请求信息，并且发送SYN+ACK包给客户端，然后将连接请求块添加到半连接队列中。客户端接收到SYN+ACK包后，会发送ACK包对服务器端的包进行确认。服务器端收到客户端的确认后，根据保存的连接信息，构建一个新的连接，放到监听套接字的连接队列中，等待用户层accept连接。这是正常的情况，但是在并发过高或者遭受SYN flood攻击的情况下，半连接队列的槽位数量很快就会耗尽，会导致丢弃新的连接请求，SYN cookies技术可以使服务器在半连接队列已满的情况下仍能处理新的SYN请求。</p>

<p>  如果开启了SYN cookies选项，在半连接队列满时，SYN cookies并不丢弃SYN请求，而是将源目的IP、源目的端口号、接收到的客户端初始序列号以及其他一些安全数值等信息进行hash运算，并加密后得到服务器端的初始序列号，称之为cookie。服务器端在发送初始序列号为cookie的SYN+ACK包后，会将分配的连接请求块释放。如果接收到客户端的ACK包，服务器端将客户端的ACK序列号减1得到的值，与上述要素hash运算得到的值比较，如果相等，直接完成三次握手，构建新的连接。SYN cookies机制的核心就是避免攻击造成的大量构造无用的连接请求块，导致内存耗尽，而无法处理正常的连接请求。</p>

<p>  启用SYN cookies是通过在启动环境中设置以下命令完成：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo 1 &gt; /proc/sys/net/ipv4/tcp_syncookies</span></code></pre></td></tr></table></div></figure>


<p>  注意，即使开启该机制并不意味着所有的连接都是用SYN cookies机制来完成连接的建立，只有在半连接队列已满的情况下才会触发SYN cookies机制。由于SYN cookies机制严重违背TCP协议，不允许使用TCP扩展，可能对某些服务造成严重的性能影响（如SMTP转发），对于防御SYN flood攻击的确有效。对于没有收到攻击的高负载服务器，不要开启此选项，可以通过修改tcp_max_syn_backlog、tcp_synack_retries和tcp_abort_on_overflow系统参数来调节。</p>

<p>下面来看看内核中是怎么通过SYN cookie机制来完成连接的建立。</p>

<p>  客户端的连接请求由</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tcp_v4_do_rcv()
</span><span class='line'>&#9;tcp_rcv_state_process()
</span><span class='line'>&#9;&#9;icsk-&gt;icsk_af_ops-&gt;conn_request()
</span><span class='line'>&#9;&#9;&#9;tcp_v4_conn_request()</span></code></pre></td></tr></table></div></figure>


<p>函数处理。tcp_v4_conn_request()中有一个局部变量want_cookie，用来标识是否使用SYN cookies机制。want_cookie的初始值为0，如果半连接队列已满，并且开启了tcp_syncookies系统参数，则将其值设置为1，如下所示：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int tcp_v4_conn_request(struct sock *sk, struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>#ifdef CONFIG_SYN_COOKIES
</span><span class='line'>&#9;int want_cookie = 0;
</span><span class='line'>#else
</span><span class='line'>#define want_cookie 0 /* Argh, why doesn't gcc optimize this :( */
</span><span class='line'>#endif
</span><span class='line'>
</span><span class='line'>...... 
</span><span class='line'>
</span><span class='line'>&#9;/* TW buckets are converted to open requests without
</span><span class='line'>&#9; * limitations, they conserve resources and peer is
</span><span class='line'>&#9; * evidently real one.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;if (inet_csk_reqsk_queue_is_full(sk) && !isn) {
</span><span class='line'>#ifdef CONFIG_SYN_COOKIES
</span><span class='line'>&#9;&#9;if (sysctl_tcp_syncookies) {
</span><span class='line'>&#9;&#9;&#9;want_cookie = 1;
</span><span class='line'>&#9;&#9;} else
</span><span class='line'>#endif
</span><span class='line'>&#9;   
</span><span class='line'>&#9;&#9;goto drop;
</span><span class='line'>&#9;}
</span><span class='line'>......
</span><span class='line'>
</span><span class='line'>drop:
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>  如果没有开启SYN cookies机制，在半连接队列满时，会跳转到drop处，返回0。在调用tcp_v4_conn_request()的tcp_rcv_state_process()中会直接释放SKB包。</p>

<p>  我们前面提高过，造成半连接队列满有两种情况（不考虑半连接队列很小的情况），一种是负载过高，正常的连接数过多；另一种是SYN flood攻击。如果是第一种情况，此时是否继续构建连接，则要取决于连接队列的情况及半连接队列的重传情况，如下所示：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if (sk_acceptq_is_full(sk) && inet_csk_reqsk_queue_young(sk) &gt; 1)
</span><span class='line'>&#9;goto drop;</span></code></pre></td></tr></table></div></figure>


<p>  sk_acceptq_is_full()函数很好理解，根据字面意思就可以看出，该函数是检查连接队列是否已满。inet_csk_reqsk_queue_young()函数返回半连接队列中未重传过SYN+ACK段的连接请求块数量。如果连接队列已满并且半连接队列中的连接请求块中未重传的数量大于1，则会跳转到drop处，丢弃SYN包。如果半连接队列中未重传的请求块数量大于1，则表示未来可能有2个完成的连接，这些新完成的连接要放到连接队列中，但此时连接队列已满。如果在接收到三次握手中最后的ACK后连接队列中没有空闲的位置，会忽略接收到的ACK包，连接建立会推迟，所以此时最好丢掉部分新的连接请求，空出资源以完成正在进行的连接建立过程。还要注意，这个判断并没有考虑半连接队列是否已满的问题。从这里可以看出，即使开启了SYN cookies机制并不意味着一定可以完成连接的建立。</p>

<p>  如果可以继续连接的建立，调用inet_reqsk_alloc()分配连接请求块，如下所示：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>req = inet_reqsk_alloc(&tcp_request_sock_ops);
</span><span class='line'>if (!req)
</span><span class='line'>&#9;goto drop;</span></code></pre></td></tr></table></div></figure>


<p>  看到这里可能就有人疑惑，既然开启了SYN cookies机制，仍然分配连接请求块，那和正常的连接构建也没有什么区别了。这里之所以要分配连接请求块是用于发送SYN+ACK包给客户端，发送后会释放掉，并不会加入到半连接队列中。</p>

<p>  接下来就是计算cookie的值，由cookie_v4_init_sequence()函数完成，如下所示：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if (want_cookie) {
</span><span class='line'>#ifdef CONFIG_SYN_COOKIES
</span><span class='line'>&#9;syn_flood_warning(skb);
</span><span class='line'>&#9;req-&gt;cookie_ts = tmp_opt.tstamp_ok;
</span><span class='line'>#endif
</span><span class='line'>&#9;isn = cookie_v4_init_sequence(sk, skb, &req-&gt;mss);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>  计算得到的cookie值会保存在连接请求块tcp_request_sock结构的snt_isn成员中，接着会调用__tcp_v4_send_synack()函数发送SYN+ACK包，然后释放前面分配的连接请求块，如下所示：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if (__tcp_v4_send_synack(sk, req, dst) || want_cookie)
</span><span class='line'>&#9;goto drop_and_free;</span></code></pre></td></tr></table></div></figure>


<p>  在服务器端发送完SYN+ACK包后，我们看到在服务器端没有保存任何关于这个未完成连接的信息，所以在接收到客户端的ACK包后，只能根据前面发送的SYN+ACK包中的cookie值来决定是否继续构建连接。</p>

<p>  我们接下来看接收到ACK包后的处理情况。ACK包在tcp_v4_do_rcv()函数中调用的tcp_v4_hnd_req()中处理，如下所示：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct sock *tcp_v4_hnd_req(struct sock *sk, struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>&#9;......
</span><span class='line'> 
</span><span class='line'>#ifdef CONFIG_SYN_COOKIES
</span><span class='line'>&#9;if (!th-&gt;rst && !th-&gt;syn && th-&gt;ack)
</span><span class='line'>&#9;&#9;sk = cookie_v4_check(sk, skb, &(IPCB(skb)-&gt;opt));
</span><span class='line'>#endif
</span><span class='line'>&#9;return sk;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>  由于在服务器端没有保存未完成连接的信息，所以在半连接队列或ehash散列表中都不会找到对应的sock结构。如果开启了SYN cookies机制，则会检查接收到的数据包是否是ACK包，如果是，在cookie_v4_check()中会调用cookie_check()函数检查ACK包中的cookie值是否有效。如果有效，则会分配request_sock结构，并根据ACK包初始化相应的成员，开始构建描述连接的sock结构。创建过程和正常的连接创建过程一样。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/33">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/31">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
<h1>Categories</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/language/'>language</a><a href='##' onmousedown=showDiv('language') id='aexp_language'><span class='exp_style' id='exp_language'>[+]</span></a><span class='right_span'>(40)</span></li>
<div id='language' class='catsub'><li><a href='/blog/cats/language~c/?opendiv=language'>c</a><a href='##' onmousedown=showDiv('language~c') id='aexp_language~c'><span class='exp_style' id='exp_language~c'>[+]</span></a><span class='right_span'>23</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~c')) document.getElementById('aexp_language~c').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~java/?opendiv=language'>java</a><a href='##' onmousedown=showDiv('language~java') id='aexp_language~java'><span class='exp_style' id='exp_language~java'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~java')) document.getElementById('aexp_language~java').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~web/?opendiv=language'>web</a><a href='##' onmousedown=showDiv('language~web') id='aexp_language~web'><span class='exp_style' id='exp_language~web'>[+]</span></a><span class='right_span'>6</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('language')) document.getElementById('aexp_language').style.visibility = 'hidden';
if (!document.getElementById('language~web')) document.getElementById('aexp_language~web').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/compiler/'>compiler</a><a href='##' onmousedown=showDiv('compiler') id='aexp_compiler'><span class='exp_style' id='exp_compiler'>[+]</span></a><span class='right_span'>(14)</span></li>
<div id='compiler' class='catsub'><li><a href='/blog/cats/compiler~base/?opendiv=compiler'>base</a><a href='##' onmousedown=showDiv('compiler~base') id='aexp_compiler~base'><span class='exp_style' id='exp_compiler~base'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler~base')) document.getElementById('aexp_compiler~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/compiler~make/?opendiv=compiler'>make</a><a href='##' onmousedown=showDiv('compiler~make') id='aexp_compiler~make'><span class='exp_style' id='exp_compiler~make'>[+]</span></a><span class='right_span'>4</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler')) document.getElementById('aexp_compiler').style.visibility = 'hidden';
if (!document.getElementById('compiler~make')) document.getElementById('aexp_compiler~make').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/assembly/'>assembly</a><a href='##' onmousedown=showDiv('assembly') id='aexp_assembly'><span class='exp_style' id='exp_assembly'>[+]</span></a><span class='right_span'>(15)</span></li>
<div id='assembly' class='catsub'><li><a href='/blog/cats/assembly~arm/?opendiv=assembly'>arm</a><a href='##' onmousedown=showDiv('assembly~arm') id='aexp_assembly~arm'><span class='exp_style' id='exp_assembly~arm'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly~arm')) document.getElementById('aexp_assembly~arm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/assembly~base/?opendiv=assembly'>base</a><a href='##' onmousedown=showDiv('assembly~base') id='aexp_assembly~base'><span class='exp_style' id='exp_assembly~base'>[+]</span></a><span class='right_span'>13</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly')) document.getElementById('aexp_assembly').style.visibility = 'hidden';
if (!document.getElementById('assembly~base')) document.getElementById('aexp_assembly~base').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/tools/'>tools</a><a href='##' onmousedown=showDiv('tools') id='aexp_tools'><span class='exp_style' id='exp_tools'>[+]</span></a><span class='right_span'>(51)</span></li>
<div id='tools' class='catsub'><li><a href='/blog/cats/tools~base/?opendiv=tools'>base</a><a href='##' onmousedown=showDiv('tools~base') id='aexp_tools~base'><span class='exp_style' id='exp_tools~base'>[+]</span></a><span class='right_span'>13</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~base')) document.getElementById('aexp_tools~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ci/?opendiv=tools'>ci</a><a href='##' onmousedown=showDiv('tools~ci') id='aexp_tools~ci'><span class='exp_style' id='exp_tools~ci'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~ci')) document.getElementById('aexp_tools~ci').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~command/?opendiv=tools'>command</a><a href='##' onmousedown=showDiv('tools~command') id='aexp_tools~command'><span class='exp_style' id='exp_tools~command'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~command')) document.getElementById('aexp_tools~command').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~git/?opendiv=tools'>git</a><a href='##' onmousedown=showDiv('tools~git') id='aexp_tools~git'><span class='exp_style' id='exp_tools~git'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~git')) document.getElementById('aexp_tools~git').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~haproxy/?opendiv=tools'>haproxy</a><a href='##' onmousedown=showDiv('tools~haproxy') id='aexp_tools~haproxy'><span class='exp_style' id='exp_tools~haproxy'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~haproxy')) document.getElementById('aexp_tools~haproxy').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~mysql/?opendiv=tools'>mysql</a><a href='##' onmousedown=showDiv('tools~mysql') id='aexp_tools~mysql'><span class='exp_style' id='exp_tools~mysql'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~mysql')) document.getElementById('aexp_tools~mysql').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ssh/?opendiv=tools'>ssh</a><a href='##' onmousedown=showDiv('tools~ssh') id='aexp_tools~ssh'><span class='exp_style' id='exp_tools~ssh'>[+]</span></a><span class='right_span'>3</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('tools')) document.getElementById('aexp_tools').style.visibility = 'hidden';
if (!document.getElementById('tools~ssh')) document.getElementById('aexp_tools~ssh').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/system/'>system</a><a href='##' onmousedown=showDiv('system') id='aexp_system'><span class='exp_style' id='exp_system'>[+]</span></a><span class='right_span'>(54)</span></li>
<div id='system' class='catsub'><li><a href='/blog/cats/system~base/?opendiv=system'>base</a><a href='##' onmousedown=showDiv('system~base') id='aexp_system~base'><span class='exp_style' id='exp_system~base'>[+]</span></a><span class='right_span'>17</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~base')) document.getElementById('aexp_system~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~centos/?opendiv=system'>centos</a><a href='##' onmousedown=showDiv('system~centos') id='aexp_system~centos'><span class='exp_style' id='exp_system~centos'>[+]</span></a><span class='right_span'>8</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~centos')) document.getElementById('aexp_system~centos').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~cgroup/?opendiv=system'>cgroup</a><a href='##' onmousedown=showDiv('system~cgroup') id='aexp_system~cgroup'><span class='exp_style' id='exp_system~cgroup'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~cgroup')) document.getElementById('aexp_system~cgroup').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~kvm/?opendiv=system'>kvm</a><a href='##' onmousedown=showDiv('system~kvm') id='aexp_system~kvm'><span class='exp_style' id='exp_system~kvm'>[+]</span></a><span class='right_span'>7</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~kvm')) document.getElementById('aexp_system~kvm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~namespace/?opendiv=system'>namespace</a><a href='##' onmousedown=showDiv('system~namespace') id='aexp_system~namespace'><span class='exp_style' id='exp_system~namespace'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~namespace')) document.getElementById('aexp_system~namespace').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~ubuntu/?opendiv=system'>ubuntu</a><a href='##' onmousedown=showDiv('system~ubuntu') id='aexp_system~ubuntu'><span class='exp_style' id='exp_system~ubuntu'>[+]</span></a><span class='right_span'>9</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('system')) document.getElementById('aexp_system').style.visibility = 'hidden';
if (!document.getElementById('system~ubuntu')) document.getElementById('aexp_system~ubuntu').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/kernel/'>kernel</a><a href='##' onmousedown=showDiv('kernel') id='aexp_kernel'><span class='exp_style' id='exp_kernel'>[+]</span></a><span class='right_span'>(163)</span></li>
<div id='kernel' class='catsub'><li><a href='/blog/cats/kernel~base/?opendiv=kernel'>base</a><a href='##' onmousedown=showDiv('kernel~base') id='aexp_kernel~base'><span class='exp_style' id='exp_kernel~base'>[+]</span></a><span class='right_span'>19</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~base')) document.getElementById('aexp_kernel~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~fs/?opendiv=kernel'>fs</a><a href='##' onmousedown=showDiv('kernel~fs') id='aexp_kernel~fs'><span class='exp_style' id='exp_kernel~fs'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~fs')) document.getElementById('aexp_kernel~fs').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~irq/?opendiv=kernel'>irq</a><a href='##' onmousedown=showDiv('kernel~irq') id='aexp_kernel~irq'><span class='exp_style' id='exp_kernel~irq'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~irq')) document.getElementById('aexp_kernel~irq').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~kexec/?opendiv=kernel'>kexec</a><a href='##' onmousedown=showDiv('kernel~kexec') id='aexp_kernel~kexec'><span class='exp_style' id='exp_kernel~kexec'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~kexec')) document.getElementById('aexp_kernel~kexec').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~mm/?opendiv=kernel'>mm</a><a href='##' onmousedown=showDiv('kernel~mm') id='aexp_kernel~mm'><span class='exp_style' id='exp_kernel~mm'>[+]</span></a><span class='right_span'>33</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~mm')) document.getElementById('aexp_kernel~mm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~net/?opendiv=kernel'>net</a><a href='##' onmousedown=showDiv('kernel~net') id='aexp_kernel~net'><span class='exp_style' id='exp_kernel~net'>[+]</span></a><span class='right_span'>80</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~net')) document.getElementById('aexp_kernel~net').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~sched/?opendiv=kernel'>sched</a><a href='##' onmousedown=showDiv('kernel~sched') id='aexp_kernel~sched'><span class='exp_style' id='exp_kernel~sched'>[+]</span></a><span class='right_span'>19</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel')) document.getElementById('aexp_kernel').style.visibility = 'hidden';
if (!document.getElementById('kernel~sched')) document.getElementById('aexp_kernel~sched').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/android/'>android</a><a href='##' onmousedown=showDiv('android') id='aexp_android'><span class='exp_style' id='exp_android'>[+]</span></a><span class='right_span'>(22)</span></li>
<div id='android' class='catsub'><li><a href='/blog/cats/android~base/?opendiv=android'>base</a><a href='##' onmousedown=showDiv('android~base') id='aexp_android~base'><span class='exp_style' id='exp_android~base'>[+]</span></a><span class='right_span'>13</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~base')) document.getElementById('aexp_android~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~i9507v/?opendiv=android'>i9507v</a><a href='##' onmousedown=showDiv('android~i9507v') id='aexp_android~i9507v'><span class='exp_style' id='exp_android~i9507v'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~i9507v')) document.getElementById('aexp_android~i9507v').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~me722/?opendiv=android'>me722</a><a href='##' onmousedown=showDiv('android~me722') id='aexp_android~me722'><span class='exp_style' id='exp_android~me722'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~me722')) document.getElementById('aexp_android~me722').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~nx403a/?opendiv=android'>nx403a</a><a href='##' onmousedown=showDiv('android~nx403a') id='aexp_android~nx403a'><span class='exp_style' id='exp_android~nx403a'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~nx403a')) document.getElementById('aexp_android~nx403a').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~s5830/?opendiv=android'>s5830</a><a href='##' onmousedown=showDiv('android~s5830') id='aexp_android~s5830'><span class='exp_style' id='exp_android~s5830'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('android')) document.getElementById('aexp_android').style.visibility = 'hidden';
if (!document.getElementById('android~s5830')) document.getElementById('aexp_android~s5830').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/debug/'>debug</a><a href='##' onmousedown=showDiv('debug') id='aexp_debug'><span class='exp_style' id='exp_debug'>[+]</span></a><span class='right_span'>(70)</span></li>
<div id='debug' class='catsub'><li><a href='/blog/cats/debug~base/?opendiv=debug'>base</a><a href='##' onmousedown=showDiv('debug~base') id='aexp_debug~base'><span class='exp_style' id='exp_debug~base'>[+]</span></a><span class='right_span'>18</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~base')) document.getElementById('aexp_debug~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~dwarf/?opendiv=debug'>dwarf</a><a href='##' onmousedown=showDiv('debug~dwarf') id='aexp_debug~dwarf'><span class='exp_style' id='exp_debug~dwarf'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~dwarf')) document.getElementById('aexp_debug~dwarf').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~gdb/?opendiv=debug'>gdb</a><a href='##' onmousedown=showDiv('debug~gdb') id='aexp_debug~gdb'><span class='exp_style' id='exp_debug~gdb'>[+]</span></a><span class='right_span'>8</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~gdb')) document.getElementById('aexp_debug~gdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kdump,-crash/?opendiv=debug'>kdump、crash</a><a href='##' onmousedown=showDiv('debug~kdump、crash') id='aexp_debug~kdump、crash'><span class='exp_style' id='exp_debug~kdump、crash'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kdump、crash')) document.getElementById('aexp_debug~kdump、crash').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kgdb/?opendiv=debug'>kgdb</a><a href='##' onmousedown=showDiv('debug~kgdb') id='aexp_debug~kgdb'><span class='exp_style' id='exp_debug~kgdb'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kgdb')) document.getElementById('aexp_debug~kgdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kprobe/?opendiv=debug'>kprobe</a><a href='##' onmousedown=showDiv('debug~kprobe') id='aexp_debug~kprobe'><span class='exp_style' id='exp_debug~kprobe'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kprobe')) document.getElementById('aexp_debug~kprobe').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~mark/?opendiv=debug'>mark</a><a href='##' onmousedown=showDiv('debug~mark') id='aexp_debug~mark'><span class='exp_style' id='exp_debug~mark'>[+]</span></a><span class='right_span'>17</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~mark')) document.getElementById('aexp_debug~mark').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~perf/?opendiv=debug'>perf</a><a href='##' onmousedown=showDiv('debug~perf') id='aexp_debug~perf'><span class='exp_style' id='exp_debug~perf'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~perf')) document.getElementById('aexp_debug~perf').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~systemtap/?opendiv=debug'>systemtap</a><a href='##' onmousedown=showDiv('debug~systemtap') id='aexp_debug~systemtap'><span class='exp_style' id='exp_debug~systemtap'>[+]</span></a><span class='right_span'>5</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('debug')) document.getElementById('aexp_debug').style.visibility = 'hidden';
if (!document.getElementById('debug~systemtap')) document.getElementById('aexp_debug~systemtap').style.visibility = 'hidden';
</script>
<li><div style="background:#DDD; height:0.3em;"></div></li><li class='catclass'><a href='/blog/cats/algorithm/'>algorithm</a><a href='##' onmousedown=showDiv('algorithm') id='aexp_algorithm'><span class='exp_style' id='exp_algorithm'>[+]</span></a><span class='right_span'>(27)</span></li>
<div id='algorithm' class='catsub'><li><a href='/blog/cats/algorithm~base/?opendiv=algorithm'>base</a><a href='##' onmousedown=showDiv('algorithm~base') id='aexp_algorithm~base'><span class='exp_style' id='exp_algorithm~base'>[+]</span></a><span class='right_span'>20</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~base')) document.getElementById('aexp_algorithm~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~dp/?opendiv=algorithm'>dp</a><a href='##' onmousedown=showDiv('algorithm~dp') id='aexp_algorithm~dp'><span class='exp_style' id='exp_algorithm~dp'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~dp')) document.getElementById('aexp_algorithm~dp').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~ds/?opendiv=algorithm'>ds</a><a href='##' onmousedown=showDiv('algorithm~ds') id='aexp_algorithm~ds'><span class='exp_style' id='exp_algorithm~ds'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~ds')) document.getElementById('aexp_algorithm~ds').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~tc/?opendiv=algorithm'>tc</a><a href='##' onmousedown=showDiv('algorithm~tc') id='aexp_algorithm~tc'><span class='exp_style' id='exp_algorithm~tc'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm')) document.getElementById('aexp_algorithm').style.visibility = 'hidden';
if (!document.getElementById('algorithm~tc')) document.getElementById('aexp_algorithm~tc').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/blog/'>blog</a><a href='##' onmousedown=showDiv('blog') id='aexp_blog'><span class='exp_style' id='exp_blog'>[+]</span></a><span class='right_span'>(11)</span></li>
<div id='blog' class='catsub'><li><a href='/blog/cats/blog~hello/?opendiv=blog'>hello</a><a href='##' onmousedown=showDiv('blog~hello') id='aexp_blog~hello'><span class='exp_style' id='exp_blog~hello'>[+]</span></a><span class='right_span'>1</span></li>
<div id='blog~hello' class='catsub2'><li><a href='/blog/cats/blog~hello~hi/?opendiv=blog~hello'>hi</a><span class='right_span'>1</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~hello')) document.getElementById('aexp_blog~hello').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~jekyll/?opendiv=blog'>jekyll</a><a href='##' onmousedown=showDiv('blog~jekyll') id='aexp_blog~jekyll'><span class='exp_style' id='exp_blog~jekyll'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~jekyll')) document.getElementById('aexp_blog~jekyll').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~markdown/?opendiv=blog'>markdown</a><a href='##' onmousedown=showDiv('blog~markdown') id='aexp_blog~markdown'><span class='exp_style' id='exp_blog~markdown'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~markdown')) document.getElementById('aexp_blog~markdown').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~octopress/?opendiv=blog'>octopress</a><a href='##' onmousedown=showDiv('blog~octopress') id='aexp_blog~octopress'><span class='exp_style' id='exp_blog~octopress'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~octopress')) document.getElementById('aexp_blog~octopress').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~ruby/?opendiv=blog'>ruby</a><a href='##' onmousedown=showDiv('blog~ruby') id='aexp_blog~ruby'><span class='exp_style' id='exp_blog~ruby'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog')) document.getElementById('aexp_blog').style.visibility = 'hidden';
if (!document.getElementById('blog~ruby')) document.getElementById('aexp_blog~ruby').style.visibility = 'hidden';
</script>

</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Date Categories</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/2016/'>2016</a><a href='##' onmousedown=showDiv('2016')><span class='exp_style' id='exp_2016'>[+]</span></a><span class='right_span'>(9)</span></li>
<div id='2016' class='catsub'><li><a href='/blog/cats/2016~03/?opendiv=2016'>2016-03</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2016~02/?opendiv=2016'>2016-02</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2016~01/?opendiv=2016'>2016-01</a><span class='right_span'>6</span></li>
</div><li class='catclass'><a href='/blog/cats/2015/'>2015</a><a href='##' onmousedown=showDiv('2015')><span class='exp_style' id='exp_2015'>[+]</span></a><span class='right_span'>(207)</span></li>
<div id='2015' class='catsub'><li><a href='/blog/cats/2015~12/?opendiv=2015'>2015-12</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2015~11/?opendiv=2015'>2015-11</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2015~10/?opendiv=2015'>2015-10</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2015~09/?opendiv=2015'>2015-09</a><span class='right_span'>18</span></li>
<li><a href='/blog/cats/2015~08/?opendiv=2015'>2015-08</a><span class='right_span'>25</span></li>
<li><a href='/blog/cats/2015~07/?opendiv=2015'>2015-07</a><span class='right_span'>31</span></li>
<li><a href='/blog/cats/2015~06/?opendiv=2015'>2015-06</a><span class='right_span'>24</span></li>
<li><a href='/blog/cats/2015~05/?opendiv=2015'>2015-05</a><span class='right_span'>22</span></li>
<li><a href='/blog/cats/2015~04/?opendiv=2015'>2015-04</a><span class='right_span'>23</span></li>
<li><a href='/blog/cats/2015~03/?opendiv=2015'>2015-03</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2015~02/?opendiv=2015'>2015-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2015~01/?opendiv=2015'>2015-01</a><span class='right_span'>19</span></li>
</div><li class='catclass'><a href='/blog/cats/2014/'>2014</a><a href='##' onmousedown=showDiv('2014')><span class='exp_style' id='exp_2014'>[+]</span></a><span class='right_span'>(112)</span></li>
<div id='2014' class='catsub'><li><a href='/blog/cats/2014~12/?opendiv=2014'>2014-12</a><span class='right_span'>21</span></li>
<li><a href='/blog/cats/2014~11/?opendiv=2014'>2014-11</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2014~10/?opendiv=2014'>2014-10</a><span class='right_span'>13</span></li>
<li><a href='/blog/cats/2014~09/?opendiv=2014'>2014-09</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~08/?opendiv=2014'>2014-08</a><span class='right_span'>15</span></li>
<li><a href='/blog/cats/2014~07/?opendiv=2014'>2014-07</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~06/?opendiv=2014'>2014-06</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2014~05/?opendiv=2014'>2014-05</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~04/?opendiv=2014'>2014-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2014~03/?opendiv=2014'>2014-03</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~02/?opendiv=2014'>2014-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2014~01/?opendiv=2014'>2014-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2013/'>2013</a><a href='##' onmousedown=showDiv('2013')><span class='exp_style' id='exp_2013'>[+]</span></a><span class='right_span'>(60)</span></li>
<div id='2013' class='catsub'><li><a href='/blog/cats/2013~12/?opendiv=2013'>2013-12</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~11/?opendiv=2013'>2013-11</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~10/?opendiv=2013'>2013-10</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~09/?opendiv=2013'>2013-09</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~08/?opendiv=2013'>2013-08</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~07/?opendiv=2013'>2013-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2013~06/?opendiv=2013'>2013-06</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2013~05/?opendiv=2013'>2013-05</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~03/?opendiv=2013'>2013-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2013~02/?opendiv=2013'>2013-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2013~01/?opendiv=2013'>2013-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2012/'>2012</a><a href='##' onmousedown=showDiv('2012')><span class='exp_style' id='exp_2012'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2012' class='catsub'><li><a href='/blog/cats/2012~12/?opendiv=2012'>2012-12</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~11/?opendiv=2012'>2012-11</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~10/?opendiv=2012'>2012-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~08/?opendiv=2012'>2012-08</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2012~05/?opendiv=2012'>2012-05</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~04/?opendiv=2012'>2012-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2012~03/?opendiv=2012'>2012-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2012~02/?opendiv=2012'>2012-02</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2012~01/?opendiv=2012'>2012-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2011/'>2011</a><a href='##' onmousedown=showDiv('2011')><span class='exp_style' id='exp_2011'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2011' class='catsub'><li><a href='/blog/cats/2011~12/?opendiv=2011'>2011-12</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2011~11/?opendiv=2011'>2011-11</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2011~08/?opendiv=2011'>2011-08</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~07/?opendiv=2011'>2011-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~06/?opendiv=2011'>2011-06</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~05/?opendiv=2011'>2011-05</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~04/?opendiv=2011'>2011-04</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~03/?opendiv=2011'>2011-03</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2011~02/?opendiv=2011'>2011-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2011~01/?opendiv=2011'>2011-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2010/'>2010</a><a href='##' onmousedown=showDiv('2010')><span class='exp_style' id='exp_2010'>[+]</span></a><span class='right_span'>(1)</span></li>
<div id='2010' class='catsub'><li><a href='/blog/cats/2010~07/?opendiv=2010'>2010-07</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2009/'>2009</a><a href='##' onmousedown=showDiv('2009')><span class='exp_style' id='exp_2009'>[+]</span></a><span class='right_span'>(8)</span></li>
<div id='2009' class='catsub'><li><a href='/blog/cats/2009~12/?opendiv=2009'>2009-12</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2009~10/?opendiv=2009'>2009-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2009~09/?opendiv=2009'>2009-09</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2009~07/?opendiv=2009'>2009-07</a><span class='right_span'>1</span></li>
</div>
</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Tags</h1>
<ul class="tag-cloud">
<a style="font-size: 131%" href="/tags/gdb/">gdb(6)</a>
<a style="font-size: 100%" href="/tags/hello/">hello(1)</a>
<a style="font-size: 150%" href="/tags/koj/">koj(18)</a>
<a style="font-size: 112%" href="/tags/nvidia/">nvidia(2)</a>
<a style="font-size: 100%" href="/tags/patch/">patch(1)</a>
<a style="font-size: 100%" href="/tags/reg-exp/">reg_exp(1)</a>

</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/03/09/kernel-net-bonding-source/">bonding的源代码分析</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/09/kernel-net-bonding/">七种网卡绑定模式详解</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/29/kernel-net-connect/">socket建立连接 sys_connect</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/21/kernel-net-udp-sum/">udp checksum</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/21/system-base-init/">Linux系统启动过程分析</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub</h1>
  
  <a href="https://github.com/abcdxyzk">abcdxyzk on GitHub</a>
  
</section>

<section>
<h1>Links</h1>
<ul>
	<li>
		<a href=http://hi.baidu.com/abcdxyzk target=_blank>My blog</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/zhangskd target=_blank>zhangsk</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/justlinux2010 target=_blank>justlinux2010</a>
	</li>
	<li>
		<a href=http://simohayha.iteye.com/ target=_blank>simohayha</a>
	</li>
	<li>
		<a href=http://linux.chinaunix.net/techdoc/net/ target=_blank>技术文档</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/cybertan target=_blank>cybertan</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/newnewman80 target=_blank>newnewman80</a>
	</li>
	<li>
		<a href=http://www.cppblog.com/fwxjj/ target=_blank>fwxjj</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/ustc_dylan target=_blank>ustc_dylan</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/nkguohao target=_blank>nkguohao</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/yusiguyuan target=_blank>yusiguyuan</a>
	</li>
	<li>
		<a href=http://www.oenhan.com/ target=_blank>oenhan</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/bullbat target=_blank>bullbat</a>
	</li>
	<li>
		<a href=http://www.wowotech.net/ target=_blank>wowotech</a>
	</li>
	<li>
		<a href=http://www.lenky.info/ target=_blank>lenky</a>
	</li>
	<li>
		<a href=http://smilejay.com/ target=_blank>smilejay</a>
	</li>
	<li>
		<a href=http://blog.chinaunix.net/uid/10167808.html target=_blank>godbach</a>
	</li>
</ul>
</section>

  
<section id="comment_sidebar">
<h1>Recent Comments</h1>

<script type="text/javascript" src="http://abcdxyzk.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=32&excerpt_length=20"></script><a href="http://disqus.com/">Powered by Disqus</a>

</section>


</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - kk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <a title="Top" href="#" id="scroll2top" style="position: fixed; height: 50px; bottom: 30px; right: 25px; cursor: pointer; z-index: 9999; display: block; opacity: 1;"><img src="/images/scrollup.png"></a>
  <script src="/javascripts/scroll2top.js"></script>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253604690'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1253604690' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'abcdxyzk';
      
</script>





</body>
</html>
