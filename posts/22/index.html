
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>kk Blog —— 通用基础</title>

  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="kk Blog —— 通用基础" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/category.js" type="text/javascript"></script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kk Blog —— 通用基础</a></h1>
  
    <h2>cp -rf * .</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
<li>
<form action="/search" method="get">
    <input class="search" name="query" id="query" type="text" placeholder="search...">
    <input id="btnSubmit" value="search" type="submit">
</form>
<script type="text/javascript">
var query = GetRequest("query");
if (query != null) {
	document.getElementById("query").value = query;
}
</script>
</li>
  <li><a href="/atom.xml" rel="subscribe-rss">RSS</a></li>
  
</ul>
  
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/download">Download</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/07/02/debug-crash-kmem/">crash kmem</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-02T10:29:00+08:00'><span class='date'>2015-07-02</span> <span class='time'>10:29:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>一、kmem -s 查看slab</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>crash&gt; kmem -s
</span><span class='line'>CACHE            NAME                 OBJSIZE  ALLOCATED     TOTAL  SLABS  SSIZE
</span><span class='line'>...
</span><span class='line'>ffff8808132d1ac0 request_sock_TCP         128          2        30      1     4k
</span><span class='line'>ffff8808135e1400 sock_inode_cache         704        298       470     94     4k
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h4>二、kmem -S 查看slab中详细内容</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>crash&gt; kmem -S request_sock_TCP
</span><span class='line'>CACHE            NAME                 OBJSIZE  ALLOCATED     TOTAL  SLABS  SSIZE
</span><span class='line'>ffff8808132d1ac0 request_sock_TCP         128          2        30      1     4k
</span><span class='line'>SLAB              MEMORY            TOTAL  ALLOCATED  FREE
</span><span class='line'>ffff88078b9c6000  ffff88078b9c60c0     30          2    28
</span><span class='line'>FREE / [ALLOCATED]
</span><span class='line'>   ffff88078b9c60c0
</span><span class='line'>   ffff88078b9c6140
</span><span class='line'>   ffff88078b9c61c0
</span><span class='line'>   ffff88078b9c6240
</span><span class='line'>   ffff88078b9c62c0
</span><span class='line'>   ffff88078b9c6340
</span><span class='line'>   ffff88078b9c63c0
</span><span class='line'>   ffff88078b9c6440
</span><span class='line'>   ffff88078b9c64c0
</span><span class='line'>   ffff88078b9c6540
</span><span class='line'>   ffff88078b9c65c0
</span><span class='line'>   ffff88078b9c6640
</span><span class='line'>   ffff88078b9c66c0
</span><span class='line'>  [ffff88078b9c6740]
</span><span class='line'>  [ffff88078b9c67c0]
</span><span class='line'>   ffff88078b9c6840
</span><span class='line'>   ffff88078b9c68c0
</span><span class='line'>   ffff88078b9c6940
</span><span class='line'>   ffff88078b9c69c0
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>request_sock_TCP 是 struct request_sock 类型，所以对于已分配的地址可以直接查看</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>crash&gt; struct request_sock 0xffff88078b9c6740
</span><span class='line'>struct request_sock {
</span><span class='line'>  dl_next = 0x0, 
</span><span class='line'>  mss = 1460, 
</span><span class='line'>  retrans = 0 '\000', 
</span><span class='line'>  cookie_ts = 0 '\000', 
</span><span class='line'>  window_clamp = 8388480, 
</span><span class='line'>  rcv_wnd = 14600, 
</span><span class='line'>  ts_recent = 0, 
</span><span class='line'>  expires = 4302901768, 
</span><span class='line'>  rsk_ops = 0xffffffff81c0e840 &lt;tcp_request_sock_ops&gt;, 
</span><span class='line'>  sk = 0xffff880771dad800, 
</span><span class='line'>  secid = 3039208612, 
</span><span class='line'>  peer_secid = 3672081930
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><a href="http://blog.csdn.net/u011279649/article/details/17529315">http://blog.csdn.net/u011279649/article/details/17529315</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/07/02/kernel-net-info/">查看所有tcp连接</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-02T10:06:00+08:00'><span class='date'>2015-07-02</span> <span class='time'>10:06:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://roclinux.cn/?p=2418">http://roclinux.cn/?p=2418</a></p>

<p><a href="http://blog.csdn.net/justlinux2010/article/details/21028797">http://blog.csdn.net/justlinux2010/article/details/21028797</a></p>

<h4>一、查看连接</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>netstat -an</span></code></pre></td></tr></table></div></figure>


<p>或</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ss</span></code></pre></td></tr></table></div></figure>


<h4>二、查看连接详细信息</h4>

<p>上面的命令也是从<code>/proc/net/tcp</code>和<code>/proc/net/tcp6</code>中读取的</p>

<p>/proc/net/tcp中的内容由tcp4_seq_show()函数打印，该函数中有三种打印形式，我们这里这只列出状态是TCP_SEQ_STATE_LISTENING或TCP_SEQ_STATE_ESTABLISHED的情况，如下所示：</p>

<p><img src="/images/kernel/2015-07-02.png" alt="" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/06/18/android-bootloader/">Android系统典型bootloader分析</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-18T11:23:00+08:00'><span class='date'>2015-06-18</span> <span class='time'>11:23:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://security.tencent.com/index.php/blog/msg/38">http://security.tencent.com/index.php/blog/msg/38</a></p>

<h4>1、bootloader是什么？</h4>

<p>  简单地说，bootloader 就是在操作系统内核运行之前运行的一段小程序。通过这段小程序，我们可以初始化硬件设备、建立内存空间的映射图，从而将系统的软硬件环境带到一个合适的状态，以便为最终调用操作系统内核准备好正确的环境。</p>

<p>  Android系统基于Linux，所以bootloader部分也是与传统的嵌入式设备上运行的Linux没有什么区别。由于除Google外的大部分Android厂商都没有提供bootloader的源代码，所以分析手机设备的bootloader需要使用逆向工程的手段，当然由于有了Google官方的开源bootloader代码做参考，能让分析工作轻松不少。本文中使用的分析工具为IDA 6.5，针对的手机设备为N9006，固件版本为N9006ZCUDMK2。</p>

<h4>2、bootloader典型结构</h4>

<p>  这部分会以高通MSM8960为例子介绍下Bootloader的典型结构。</p>

<p>  高通MSM8960中包含多个运算单元，分别负责引导过程中的不同功能，sbl1的代码负责加载sbl2，sbl2加载tz和sbl3，sbl3加载apppsbl，appsbl加载HLOS。</p>

<p><img src="/images/android/2015-06-18-1.png" alt="" /><br/>
图1 SecureBoot 3.0 的Code Flow</p>

<p><img src="/images/android/2015-06-18-2.png" alt="" /><br/>
图2 MSM8960引导过程简化流程图</p>

<h4>3、Note3的bootloader结构分析</h4>

<p>  国行版Note3（N9006）使用的CPU是MSM8974，它的bootloader结构与典型的MSM8960差不多，最大的区别就是把sbl1,sbl2,sbl3整合进了一个文件sbl1中，TrustZone和APPSBL都由sbl1进行验证和加载，以下为几个主要功能的加载代码分析。</p>

<p>  sbl1的功能是对硬件进行初始化并加载其他模块，需要加载的模块信息按顺序保存在sbl1中，对应每个模块的数据是一段大小为0x64字节的模块信息数据内，sbl1中有一个循环负责验证和加载所有需要的其他模块（tz，rpm，wdt，appsbl），加载代码会根据模块信息内的数据调用不同的加载器加载和验证的代码，具体代码如下图。</p>

<p><img src="/images/android/2015-06-18-3.jpg" alt="" /><br/>
图3 sbl1中循环加载全部模块的代码</p>

<p><img src="/images/android/2015-06-18-4.jpg" alt="" /><br/>
图4 sbl1中对待加载模块进行验证</p>

<p><img src="/images/android/2015-06-18-5.jpg" alt="" /><br/>
图5 TZ模块信息数据</p>

<p><img src="/images/android/2015-06-18-6.jpg" alt="" /><br/>
图6 APPSBL模块信息数据</p>

<p>  固件包里的tz.mbn是加载在TrustZone中的模块，模块格式为elf，这个模块中的代码和系统其他模块代码运行在互相隔离的区域内，权限也比其他模块更高，三星KNOX的很多底层安全特性也是在这部分中实现，关于TrustZone的更多资料可以参考arm官方的说明。</p>

<p>  固件包里的aboot.mbn就是APPSBL模块，模块格式为bin，文件最前面的0x28字节的头部描述了bin的加载地址等信息，后面的数据就是实际加载到内存中的映像，整个bootloader中这个模块的代码量最大（很大一部分是openssl的代码），linux内核的验证和加载（正常启动和Recovery模式），ODIN模式等等代码都包含在这个模块内。</p>

<p><img src="/images/android/2015-06-18-7.jpg" alt="" /><br/>
图7 aboot.mbn文件头</p>

<p><img src="/images/android/2015-06-18-8.jpg" alt="" /><br/>
图8 根据按键和共享内存中的数据确定引导模式</p>

<p><img src="/images/android/2015-06-18-9.jpg" alt="" /><br/>
图9 三星特有的ODIN刷机模式代码</p>

<h4>4、Note3的bootloader中KNOX系统的底层代码初步分析</h4>

<p>  Note3提供了一个企业安全套装KNOX，这个系统包含了底层的Customizable Secure Boot和TrustZone-based Integrity Measurement Architecture(TIMA，目前为2.0版本)，系统层的SecurityEnhancements for Android（SE-Android）和应用层的Samsung KNOX Container，Encrypted File System（EFS），Virtual Private Network（VPN），其中Customizable Secure Boot和TIMA的代码包含在Bootloader的aboot.mbn，tz.mbn，NON-HLOS.bin中，功能为保障加载的内核在加载时和运行期的完整性。</p>

<p>  通过前面的分析，我们已经知道了tz.mbn和aboot.mbn在加载时已经由sbl1验证过完整性，tz.mbn加载后会在CPU的安全环境下运行，从高权限的隔离区域内对系统的完整性进行监控，而负责加载android内核的aboot.mbn中包含对内核的完整性检测，三星在bootloader每一部分的结尾都会加上自己的签名，加载前会对签名进行验证，以保障系统未被修改过。</p>

<p><img src="/images/android/2015-06-18-10.jpg" alt="" /><br/>
图10  tz.mbn中初始化TIMA系统的的代码</p>

<p><img src="/images/android/2015-06-18-11.jpg" alt="" /><br/>
图11 aboot.mbn中对内核是否使用SEANDROID进行验证</p>

<p>  当任何一部分检测代码发现系统异常状况后，就会调用SMC指令通知TrustZone中运行的TIMA系统设置fuse为系统完整性被破坏，此fuse数据一旦被设置后没有办法被重置，系统也无法再次进入KNOX系统。</p>

<p><img src="/images/android/2015-06-18-12.jpg" alt="" /><br/>
图12 加载内核前对内核签名和TIMA的测点进行验证</p>

<p><img src="/images/android/2015-06-18-13.jpg" alt="" /><br/>
图13 系统完整性检测失败后设置fuse值</p>

<p>  当以上所有检测都通过后，bootloader会把内核复制到指定的内存地址并跳到内核的入口继续执行，到此，就进入了系统内核代码的范畴，bootloader的使命也就完成了，跳到linux内核入口的代码见图14。</p>

<p><img src="/images/android/2015-06-18-14.jpg" alt="" /><br/>
图14 内核加载和校验完成后跳到内核的入口点继续执行</p>

<p>  另外，除了这两个模块外Modem固件相关的NON-HLOS.bin中也有大量TIMA系统相关的文件，由于TIMA系统包含大量硬件相关代码（使用三星猎户座CPU的N900中TIMA系统的实现与高通CPU的N9006差别很大），如果需要进行进一步的分析TIMA在modem中的行为，需要对TrustZone，modem工作方式等有更多了解。</p>

<p><img src="/images/android/2015-06-18-15.jpg" alt="" /><br/>
图15 NON-HLOS.bin中包含的大量TIMA相关文件</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/06/18/kernel-net-ipv6-code/">IPV6 实现</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-18T10:44:00+08:00'><span class='date'>2015-06-18</span> <span class='time'>10:44:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.cnblogs.com/super-king/p/ipv6_implement.html">http://www.cnblogs.com/super-king/p/ipv6_implement.html</a></p>

<p>code extract from 2.6.24.
在文件 net/ipv6/af_inet6.c 中包含了ipv6协议初始化的主函数。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int __init inet6_init(void)
</span><span class='line'>{
</span><span class='line'>&#9;struct sk_buff *dummy_skb;
</span><span class='line'>&#9;struct list_head *r;
</span><span class='line'>&#9;int err;
</span><span class='line'>&#9;//inet6_skb_parm必须小于等于skb中的cb
</span><span class='line'>&#9;BUILD_BUG_ON(sizeof(struct inet6_skb_parm) &gt; sizeof(dummy_skb-&gt;cb));
</span><span class='line'>
</span><span class='line'>&#9;//初始化tcpv6_prot结构中的一些与slab相关的字段，然后添加到 proto_list 全局连表
</span><span class='line'>&#9;err = proto_register(&tcpv6_prot, 1);
</span><span class='line'>&#9;if (err)
</span><span class='line'>&#9;&#9;goto out;
</span><span class='line'>&#9;//udp协议同上
</span><span class='line'>&#9;err = proto_register(&udpv6_prot, 1);
</span><span class='line'>&#9;if (err)
</span><span class='line'>&#9;&#9;goto out_unregister_tcp_proto;
</span><span class='line'>&#9;//udp-lite传输协议，主要用于多媒体传输，参考kernel中的 Documentation/networking/udplite.txt
</span><span class='line'>&#9;err = proto_register(&udplitev6_prot, 1);
</span><span class='line'>&#9;if (err)
</span><span class='line'>&#9;&#9;goto out_unregister_udp_proto;
</span><span class='line'>&#9;//原始套接字同上
</span><span class='line'>&#9;err = proto_register(&rawv6_prot, 1);
</span><span class='line'>&#9;if (err)
</span><span class='line'>&#9;&#9;goto out_unregister_udplite_proto;
</span><span class='line'>
</span><span class='line'>&#9;/* Register the socket-side information for inet6_create.  */
</span><span class='line'>&#9;for(r = &inetsw6[0]; r &lt; &inetsw6[SOCK_MAX]; ++r) //初始化一个协议连表数组
</span><span class='line'>&#9;&#9;INIT_LIST_HEAD(r);
</span><span class='line'>&#9;/* We MUST register RAW sockets before we create the ICMP6, IGMP6, or NDISC control sockets. */
</span><span class='line'>&#9;//根据参数数据结构中标识的协议类型，把这数据结构添加到上面的协议连表数组中
</span><span class='line'>&#9;inet6_register_protosw(&rawv6_protosw);
</span><span class='line'>
</span><span class='line'>&#9;/* Register the family here so that the init calls below will be able to create sockets. (?? is this dangerous ??) */
</span><span class='line'>&#9;//注册ipv6协议族，主要是注册socket创建函数
</span><span class='line'>&#9;err = sock_register(&inet6_family_ops);
</span><span class='line'>&#9;if (err)
</span><span class='line'>&#9;&#9;goto out_unregister_raw_proto;
</span><span class='line'>
</span><span class='line'>&#9;/* Initialise ipv6 mibs */
</span><span class='line'>&#9;err = init_ipv6_mibs(); //所有ipv6相关的统计信息
</span><span class='line'>&#9;if (err)
</span><span class='line'>&#9;&#9;goto out_unregister_sock;
</span><span class='line'>&#9;/* ipngwg API draft makes clear that the correct semantics for TCP and UDP is to consider one TCP and UDP instance 
</span><span class='line'>&#9; * in a host availiable by both INET and INET6 APIs and able to communicate via both network protocols.
</span><span class='line'>&#9; */
</span><span class='line'>#ifdef CONFIG_SYSCTL
</span><span class='line'>&#9;ipv6_sysctl_register(); // ipv6协议proc条件项初始化
</span><span class='line'>#endif
</span><span class='line'>&#9;//icmp协议注册
</span><span class='line'>&#9;err = icmpv6_init(&inet6_family_ops);
</span><span class='line'>&#9;if (err)
</span><span class='line'>&#9;&#9;goto icmp_fail;
</span><span class='line'>&#9;//邻居协议（arp）初始化       
</span><span class='line'>&#9;err = ndisc_init(&inet6_family_ops);
</span><span class='line'>&#9;if (err)
</span><span class='line'>&#9;&#9;goto ndisc_fail;
</span><span class='line'>&#9;//igmp协议初始化       
</span><span class='line'>&#9;err = igmp6_init(&inet6_family_ops);
</span><span class='line'>&#9;if (err)
</span><span class='line'>&#9;&#9;goto igmp_fail;
</span><span class='line'>&#9;//ipv6协议相关的 netfilter 初始化     
</span><span class='line'>&#9;err = ipv6_netfilter_init();
</span><span class='line'>&#9;if (err)
</span><span class='line'>&#9;&#9;goto netfilter_fail;
</span><span class='line'>
</span><span class='line'>&#9;/* Create /proc/foo6 entries. */
</span><span class='line'>#ifdef CONFIG_PROC_FS //注册/proc/中协议统计输出项
</span><span class='line'>&#9;err = -ENOMEM;
</span><span class='line'>&#9;if (raw6_proc_init())
</span><span class='line'>&#9;&#9;goto proc_raw6_fail;
</span><span class='line'>&#9;if (tcp6_proc_init())
</span><span class='line'>&#9;&#9;goto proc_tcp6_fail;
</span><span class='line'>&#9;if (udp6_proc_init())
</span><span class='line'>&#9;&#9;goto proc_udp6_fail;
</span><span class='line'>&#9;if (udplite6_proc_init())
</span><span class='line'>&#9;&#9;goto proc_udplite6_fail;
</span><span class='line'>&#9;if (ipv6_misc_proc_init())
</span><span class='line'>&#9;&#9;goto proc_misc6_fail;
</span><span class='line'>&#9;if (ac6_proc_init())
</span><span class='line'>&#9;&#9;goto proc_anycast6_fail;
</span><span class='line'>&#9;if (if6_proc_init())
</span><span class='line'>&#9;&#9;goto proc_if6_fail;
</span><span class='line'>#endif
</span><span class='line'>&#9;ip6_route_init(); //ipv6 路由初始化
</span><span class='line'>&#9;ip6_flowlabel_init();//ipv6 中流标记，注册了输出流标记的 proc
</span><span class='line'>
</span><span class='line'>&#9;//rtnetlink相关部分和路由模板中一些字段和其他一些功能的初始化
</span><span class='line'>&#9;err = addrconf_init();
</span><span class='line'>&#9;if (err)
</span><span class='line'>&#9;&#9;goto addrconf_fail;
</span><span class='line'>&#9;/* Init v6 extension headers. */
</span><span class='line'>&#9;//ipv6 新添加的扩展头初始化，参考ipv6介绍
</span><span class='line'>&#9;ipv6_rthdr_init();
</span><span class='line'>&#9;ipv6_frag_init();
</span><span class='line'>&#9;ipv6_nodata_init();
</span><span class='line'>&#9;ipv6_destopt_init();
</span><span class='line'>
</span><span class='line'>&#9;/* Init v6 transport protocols. */
</span><span class='line'>&#9;//最主要的传输层协议初始化
</span><span class='line'>&#9;udpv6_init();
</span><span class='line'>&#9;udplitev6_init();
</span><span class='line'>&#9;tcpv6_init();
</span><span class='line'>
</span><span class='line'>&#9;//最后注册ipv6协议，注册协议处理函数
</span><span class='line'>&#9;ipv6_packet_init();
</span><span class='line'>&#9;err = 0;
</span><span class='line'>out:
</span><span class='line'>&#9;return err;
</span><span class='line'>&#9;...... //下面就是错误处理的过程
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>下面我们主要看ipv6协议部分流程，其他部分在各自相关文章中介绍。</p>

<p>ipv6扩展头，路由包头注册</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void __init ipv6_rthdr_init(void)
</span><span class='line'>{
</span><span class='line'>&#9;if (inet6_add_protocol(&rthdr_protocol, IPPROTO_ROUTING) &lt; 0)
</span><span class='line'>&#9;&#9;printk(KERN_ERR "ipv6_rthdr_init: Could not register protocol\n");
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>ipv6扩展头，分片包头注册</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void __init ipv6_frag_init(void)
</span><span class='line'>{
</span><span class='line'>&#9;if (inet6_add_protocol(&frag_protocol, IPPROTO_FRAGMENT) &lt; 0)
</span><span class='line'>&#9;&#9;printk(KERN_ERR "ipv6_frag_init: Could not register protocol\n");
</span><span class='line'>
</span><span class='line'>&#9;ip6_frags.ctl = &ip6_frags_ctl;
</span><span class='line'>&#9;ip6_frags.hashfn = ip6_hashfn;
</span><span class='line'>&#9;ip6_frags.constructor = ip6_frag_init;
</span><span class='line'>&#9;ip6_frags.destructor = NULL;
</span><span class='line'>&#9;ip6_frags.skb_free = NULL;
</span><span class='line'>&#9;ip6_frags.qsize = sizeof(struct frag_queue);
</span><span class='line'>&#9;ip6_frags.match = ip6_frag_match;
</span><span class='line'>&#9;ip6_frags.frag_expire = ip6_frag_expire;
</span><span class='line'>&#9;inet_frags_init(&ip6_frags);
</span><span class='line'>}
</span><span class='line'>void __init ipv6_nodata_init(void)
</span><span class='line'>{
</span><span class='line'>&#9;if (inet6_add_protocol(&nodata_protocol, IPPROTO_NONE) &lt; 0)
</span><span class='line'>&#9;&#9;printk(KERN_ERR "ipv6_nodata_init: Could not register protocol\n");
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ipv6扩展头，目的选项包头注册</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void __init ipv6_destopt_init(void)
</span><span class='line'>{
</span><span class='line'>&#9;if (inet6_add_protocol(&destopt_protocol, IPPROTO_DSTOPTS) &lt; 0)
</span><span class='line'>&#9;&#9;printk(KERN_ERR "ipv6_destopt_init: Could not register protocol\n");
</span><span class='line'>}
</span><span class='line'>&#9;注册ipv6协议处理函数
</span><span class='line'>void __init ipv6_packet_init(void)
</span><span class='line'>{
</span><span class='line'>&#9;dev_add_pack(&ipv6_packet_type);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>当netif_receive_skb函数向上层递交skb时会根据协议类型调用相关的协议处理函数，那么就会调用到 ipv6_rcv函数了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct packet_type ipv6_packet_type = {
</span><span class='line'>&#9;.type = __constant_htons(ETH_P_IPV6),
</span><span class='line'>&#9;.func = ipv6_rcv,
</span><span class='line'>&#9;.gso_send_check = ipv6_gso_send_check,
</span><span class='line'>&#9;.gso_segment = ipv6_gso_segment,
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>ipv6协议处理函数</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int ipv6_rcv(struct sk_buff *skb, struct net_device *dev, struct packet_type *pt, struct net_device *orig_dev)
</span><span class='line'>{
</span><span class='line'>&#9;struct ipv6hdr *hdr;
</span><span class='line'>&#9;u32             pkt_len;
</span><span class='line'>&#9;struct inet6_dev *idev;
</span><span class='line'>
</span><span class='line'>&#9;if (dev-&gt;nd_net != &init_net) {
</span><span class='line'>&#9;&#9;kfree_skb(skb);
</span><span class='line'>&#9;&#9;return 0;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//mac地址是其他主机的包
</span><span class='line'>&#9;if (skb-&gt;pkt_type == PACKET_OTHERHOST) {
</span><span class='line'>&#9;&#9;kfree_skb(skb);
</span><span class='line'>&#9;&#9;return 0;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;rcu_read_lock();
</span><span class='line'>&#9;//获取ipv6相关的配置结构
</span><span class='line'>&#9;idev = __in6_dev_get(skb-&gt;dev);
</span><span class='line'>
</span><span class='line'>&#9;IP6_INC_STATS_BH(idev, IPSTATS_MIB_INRECEIVES);
</span><span class='line'>&#9;//是否共享，如果是，新clone一个
</span><span class='line'>&#9;if ((skb = skb_share_check(skb, GFP_ATOMIC)) == NULL) {
</span><span class='line'>&#9;&#9;IP6_INC_STATS_BH(idev, IPSTATS_MIB_INDISCARDS);
</span><span class='line'>&#9;&#9;rcu_read_unlock();
</span><span class='line'>&#9;&#9;goto out;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//清空保存扩展头解析结果的数据结构
</span><span class='line'>&#9;memset(IP6CB(skb), 0, sizeof(struct inet6_skb_parm));
</span><span class='line'>
</span><span class='line'>&#9;//保存接收这个数据包的设备索引
</span><span class='line'>&#9;IP6CB(skb)-&gt;iif = skb-&gt;dst ? ip6_dst_idev(skb-&gt;dst)-&gt;dev-&gt;ifindex : dev-&gt;ifindex;
</span><span class='line'>
</span><span class='line'>&#9;//有足够的头长度，ipv6是40字节
</span><span class='line'>&#9;if (unlikely(!pskb_may_pull(skb, sizeof(*hdr))))
</span><span class='line'>&#9;&#9;goto err;
</span><span class='line'>
</span><span class='line'>&#9;hdr = ipv6_hdr(skb); //获取头
</span><span class='line'>
</span><span class='line'>&#9;if (hdr-&gt;version != 6) //验证版本
</span><span class='line'>&#9;&#9;goto err;
</span><span class='line'>
</span><span class='line'>&#9;//传输头（扩展头）在网络头后面
</span><span class='line'>&#9;skb-&gt;transport_header = skb-&gt;network_header + sizeof(*hdr);
</span><span class='line'>&#9;//保存下一个扩展头协议在ipv6头结构中的偏移
</span><span class='line'>&#9;IP6CB(skb)-&gt;nhoff = offsetof(struct ipv6hdr, nexthdr);
</span><span class='line'>&#9;pkt_len = ntohs(hdr-&gt;payload_len); //ipv6负载数据长度
</span><span class='line'>
</span><span class='line'>&#9;/* pkt_len may be zero if Jumbo payload option is present */
</span><span class='line'>&#9;if (pkt_len || hdr-&gt;nexthdr != NEXTHDR_HOP) { //没有使用扩展头逐个跳段选项
</span><span class='line'>&#9;&#9;if (pkt_len + sizeof(struct ipv6hdr) &gt; skb-&gt;len) { //数据长度不对
</span><span class='line'>&#9;&#9;&#9;IP6_INC_STATS_BH(idev, IPSTATS_MIB_INTRUNCATEDPKTS);
</span><span class='line'>&#9;&#9;&#9;goto drop;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;//如果skb-&gt;len &gt; (pkt_len + sizeof(struct ipv6hdr))试着缩小skb-&gt;len的长度
</span><span class='line'>&#9;&#9;//相对ipv4来说简单多了，自己看吧
</span><span class='line'>&#9;&#9;if (pskb_trim_rcsum(skb, pkt_len + sizeof(struct ipv6hdr))) {
</span><span class='line'>&#9;&#9;&#9;IP6_INC_STATS_BH(idev, IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;&#9;&#9;goto drop;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;hdr = ipv6_hdr(skb); //重新获取ip头
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (hdr-&gt;nexthdr == NEXTHDR_HOP) { //使用了扩展头逐个跳段选项
</span><span class='line'>&#9;&#9;if (ipv6_parse_hopopts(skb) &lt; 0) {//处理这个选项
</span><span class='line'>&#9;&#9;&#9;IP6_INC_STATS_BH(idev, IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;&#9;&#9;rcu_read_unlock();
</span><span class='line'>&#9;&#9;&#9;return 0;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;rcu_read_unlock();
</span><span class='line'>&#9;//进入ipv6的netfilter然后调用ip6_rcv_finish
</span><span class='line'>&#9;return NF_HOOK(PF_INET6,NF_IP6_PRE_ROUTING, skb, dev, NULL, ip6_rcv_finish);
</span><span class='line'>err:
</span><span class='line'>&#9;IP6_INC_STATS_BH(idev, IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>drop:
</span><span class='line'>&#9;rcu_read_unlock();
</span><span class='line'>&#9;kfree_skb(skb);
</span><span class='line'>out:
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>解析扩展头逐个跳段中的巨量负载选项</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int ipv6_parse_hopopts(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>&#9;struct inet6_skb_parm *opt = IP6CB(skb); //获取扩展头结果结构
</span><span class='line'>&#9;/* skb_network_header(skb) is equal to skb-&gt;data, and skb_network_header_len(skb) is always equal to
</span><span class='line'>&#9; * sizeof(struct ipv6hdr) by definition of hop-by-hop options.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;//验证数据有足够的长度
</span><span class='line'>&#9;if (!pskb_may_pull(skb, sizeof(struct ipv6hdr) + 8) || !pskb_may_pull(skb, (sizeof(struct ipv6hdr) +
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;//下面的意思是取得扩展首部中的长度
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;((skb_transport_header(skb)[1] + 1) &lt;&lt; 3)))) {
</span><span class='line'>&#9;&#9;kfree_skb(skb);
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;opt-&gt;hop = sizeof(struct ipv6hdr); //40字节
</span><span class='line'>&#9;if (ip6_parse_tlv(tlvprochopopt_lst, skb)) { //实际的解析工作
</span><span class='line'>&#9;&#9;//把传输头移动到扩展首部之后
</span><span class='line'>&#9;&#9;skb-&gt;transport_header += (skb_transport_header(skb)[1] + 1) &lt;&lt; 3;
</span><span class='line'>&#9;&#9;opt = IP6CB(skb);
</span><span class='line'>&#9;&#9;opt-&gt;nhoff = sizeof(struct ipv6hdr); //进行了ipv6扩展头解析，保存下一个扩展头协议字段的偏移
</span><span class='line'>&#9;&#9;return 1;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;return -1;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>解析tlv编码的扩展选项头</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int ip6_parse_tlv(struct tlvtype_proc *procs, struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>&#9;struct tlvtype_proc *curr;
</span><span class='line'>&#9;const unsigned char *nh = skb_network_header(skb); //获取网络头
</span><span class='line'>&#9;int off = skb_network_header_len(skb); //获取网络头长度
</span><span class='line'>&#9;int len = (skb_transport_header(skb)[1] + 1) &lt;&lt; 3; //首部扩展头长度
</span><span class='line'>
</span><span class='line'>&#9;if (skb_transport_offset(skb) + len &gt; skb_headlen(skb)) //长度错误
</span><span class='line'>&#9;&#9;goto bad;
</span><span class='line'>&#9;off += 2; //跳过下一个首部和首部扩展长度这两个字节
</span><span class='line'>&#9;len -= 2;
</span><span class='line'>
</span><span class='line'>&#9;while (len &gt; 0) {
</span><span class='line'>&#9;&#9;int optlen = nh[off + 1] + 2; //获取选项数据长度 + 2 (2是选项类型和选项数据长度两字节)
</span><span class='line'>&#9;&#9;switch (nh[off]) { //选项类型
</span><span class='line'>&#9;&#9;&#9;case IPV6_TLV_PAD0: //Pad1选项
</span><span class='line'>&#9;&#9;&#9;&#9;optlen = 1;
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;&#9;case IPV6_TLV_PADN://PadN选项
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;&#9;default: //其他选项
</span><span class='line'>&#9;&#9;&#9;&#9;if (optlen &gt; len)
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;goto bad;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;&#9;for (curr = procs; curr-&gt;type &gt;= 0; curr++) {
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;if (curr-&gt;type == nh[off]) { //类型匹配，调用参数函数处理，参考下面ipv6选项处理
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;/* type specific length/alignment checks will be performed in the func(). */
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;if (curr-&gt;func(skb, off) == 0)
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;&#9;return 0;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;&#9;if (curr-&gt;type &lt; 0) {
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;if (ip6_tlvopt_unknown(skb, off) == 0) //处理未知选项
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;return 0;
</span><span class='line'>&#9;&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;off += optlen; //偏移增加，这样到下一个选项
</span><span class='line'>&#9;&#9;len -= optlen; //长度递减
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (len == 0)
</span><span class='line'>&#9;&#9;return 1; //正确解析完毕
</span><span class='line'>bad:
</span><span class='line'>&#9;kfree_skb(skb);
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>处理未知的选项</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int ip6_tlvopt_unknown(struct sk_buff *skb, int optoff)
</span><span class='line'>{
</span><span class='line'>&#9;//根据选项类型标识符的要求进行处理
</span><span class='line'>&#9;switch ((skb_network_header(skb)[optoff] & 0xC0) &gt;&gt; 6) {
</span><span class='line'>&#9;&#9;case 0: /* ignore */
</span><span class='line'>&#9;&#9;&#9;return 1;
</span><span class='line'>&#9;&#9;case 1: /* drop packet */
</span><span class='line'>&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;case 3: /* Send ICMP if not a multicast address and drop packet */
</span><span class='line'>&#9;&#9;&#9;/* Actually, it is redundant check. icmp_send will recheck in any case. */
</span><span class='line'>&#9;&#9;&#9;if (ipv6_addr_is_multicast(&ipv6_hdr(skb)-&gt;daddr)) //目的是多播地址
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;case 2: /* send ICMP PARM PROB regardless and drop packet */
</span><span class='line'>&#9;&#9;&#9;//给包的源地址发送一个 ICMP "参数存在问题", 编码 2 的报文, 指针指向无法识别的选项类型
</span><span class='line'>&#9;&#9;&#9;icmpv6_param_prob(skb, ICMPV6_UNK_OPTION, optoff);
</span><span class='line'>&#9;&#9;&#9;return 0;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;kfree_skb(skb);
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>到这需要解释一下，上面解析ipv6选项只是解析了第一层的扩展头，在后面可能还有其他扩展头会在后面解析。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>inline int ip6_rcv_finish( struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>&#9;if (skb-&gt;dst == NULL) //没有路由，进行路由查找
</span><span class='line'>&#9;&#9;ip6_route_input(skb); //路由部分将在路由实现文章中介绍
</span><span class='line'>
</span><span class='line'>&#9;return dst_input(skb);
</span><span class='line'>}
</span><span class='line'>static inline int dst_input(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>&#9;int err;
</span><span class='line'>&#9;for (;;) {
</span><span class='line'>&#9;&#9;err = skb-&gt;dst-&gt;input(skb); //调用路由的输入函数
</span><span class='line'>&#9;&#9;if (likely(err == 0))
</span><span class='line'>&#9;&#9;&#9;return err;
</span><span class='line'>
</span><span class='line'>&#9;&#9;/* Oh, Jamal... Seems, I will not forgive you this mess. :-) */
</span><span class='line'>&#9;&#9;if (unlikely(err != NET_XMIT_BYPASS))
</span><span class='line'>&#9;&#9;&#9;return err;
</span><span class='line'>&#9;}
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>现在我们假设包是到本地的，那么上面的input函数就是</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int ip6_input(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>&#9;//进入ipv6 netfilter NF_IP6_LOCAL_IN hook 然后调用 ip6_input_finish
</span><span class='line'>&#9;return NF_HOOK(PF_INET6, NF_IP6_LOCAL_IN, skb, skb-&gt;dev, NULL, ip6_input_finish);
</span><span class='line'>}
</span><span class='line'>static int ip6_input_finish(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>&#9;struct inet6_protocol *ipprot;
</span><span class='line'>&#9;struct sock *raw_sk;
</span><span class='line'>&#9;unsigned int nhoff;
</span><span class='line'>&#9;int nexthdr;
</span><span class='line'>&#9;u8 hash;
</span><span class='line'>&#9;struct inet6_dev *idev;
</span><span class='line'>
</span><span class='line'>&#9;/* Parse extension headers */
</span><span class='line'>&#9;rcu_read_lock();
</span><span class='line'>resubmit:
</span><span class='line'>&#9;idev = ip6_dst_idev(skb-&gt;dst);
</span><span class='line'>&#9;//将skb-&gt;data指针移动到传输层头
</span><span class='line'>&#9;if (!pskb_pull(skb, skb_transport_offset(skb)))
</span><span class='line'>&#9;&#9;goto discard;
</span><span class='line'>
</span><span class='line'>&#9;nhoff = IP6CB(skb)-&gt;nhoff;
</span><span class='line'>&#9;nexthdr = skb_network_header(skb)[nhoff];//下一个扩展头协议
</span><span class='line'>
</span><span class='line'>&#9;//处理原始sock
</span><span class='line'>&#9;raw_sk = sk_head(&raw_v6_htable[nexthdr & (MAX_INET_PROTOS - 1)]);
</span><span class='line'>&#9;if (raw_sk && !ipv6_raw_deliver(skb, nexthdr))
</span><span class='line'>&#9;&#9;raw_sk = NULL;
</span><span class='line'>
</span><span class='line'>&#9;//向上层协议栈递交数据，看初始化时注册的一些协议，主要是tcp，udp等，还包括一些ip扩展头的处理
</span><span class='line'>&#9;hash = nexthdr & (MAX_INET_PROTOS - 1);
</span><span class='line'>&#9;if ((ipprot = rcu_dereference(inet6_protos[hash])) != NULL) {
</span><span class='line'>&#9;&#9;int ret;
</span><span class='line'>&#9;&#9;if (ipprot-&gt;flags & INET6_PROTO_FINAL) {
</span><span class='line'>&#9;&#9;&#9;struct ipv6hdr *hdr;
</span><span class='line'>&#9;&#9;&#9;/* Free reference early: we don't need it any more,                        
</span><span class='line'>&#9;&#9;&#9;   and it may hold ip_conntrack module loaded indefinitely. */
</span><span class='line'>&#9;&#9;&#9;nf_reset(skb);
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;skb_postpull_rcsum(skb, skb_network_header(skb), skb_network_header_len(skb));
</span><span class='line'>&#9;&#9;&#9;hdr = ipv6_hdr(skb);
</span><span class='line'>&#9;&#9;&#9;if (ipv6_addr_is_multicast(&hdr-&gt;daddr) && !ipv6_chk_mcast_addr(skb-&gt;dev, &hdr-&gt;daddr, &hdr-&gt;saddr)
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&& !ipv6_is_mld(skb, nexthdr))
</span><span class='line'>&#9;&#9;&#9;&#9;goto discard;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;//处理 IPSEC v6 的相关部分
</span><span class='line'>&#9;&#9;if (!(ipprot-&gt;flags & INET6_PROTO_NOPOLICY) && !xfrm6_policy_check(NULL, XFRM_POLICY_IN, skb))
</span><span class='line'>&#9;&#9;&#9;goto discard;
</span><span class='line'>
</span><span class='line'>&#9;&#9;ret = ipprot-&gt;handler(skb); //上层协议处理，看下面ipv6扩展头处理
</span><span class='line'>&#9;&#9;if (ret &gt; 0)
</span><span class='line'>&#9;&#9;&#9;goto resubmit; //重新处理
</span><span class='line'>&#9;&#9;else if (ret == 0)
</span><span class='line'>&#9;&#9;&#9;IP6_INC_STATS_BH(idev, IPSTATS_MIB_INDELIVERS);
</span><span class='line'>&#9;} else { //没有找到上层处理函数
</span><span class='line'>&#9;&#9;if (!raw_sk) {
</span><span class='line'>&#9;&#9;&#9;if (xfrm6_policy_check(NULL, XFRM_POLICY_IN, skb)) {
</span><span class='line'>&#9;&#9;&#9;&#9;IP6_INC_STATS_BH(idev, IPSTATS_MIB_INUNKNOWNPROTOS);
</span><span class='line'>&#9;&#9;&#9;&#9;icmpv6_send(skb, ICMPV6_PARAMPROB, ICMPV6_UNK_NEXTHDR, nhoff, skb-&gt;dev);
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;} else
</span><span class='line'>&#9;&#9;&#9;IP6_INC_STATS_BH(idev, IPSTATS_MIB_INDELIVERS);
</span><span class='line'>&#9;&#9;kfree_skb(skb);
</span><span class='line'>&#9;}
</span><span class='line'>&#9;rcu_read_unlock();
</span><span class='line'>&#9;return 0;
</span><span class='line'>discard:
</span><span class='line'>&#9;IP6_INC_STATS_BH(idev, IPSTATS_MIB_INDISCARDS);
</span><span class='line'>&#9;rcu_read_unlock();
</span><span class='line'>&#9;kfree_skb(skb);
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>ipv6选项处理</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct tlvtype_proc tlvprochopopt_lst[] = {
</span><span class='line'>&#9;{
</span><span class='line'>&#9;&#9;.type   = IPV6_TLV_ROUTERALERT,
</span><span class='line'>&#9;&#9;.func   = ipv6_hop_ra,
</span><span class='line'>&#9;},
</span><span class='line'>&#9;{
</span><span class='line'>&#9;&#9;.type   = IPV6_TLV_JUMBO,
</span><span class='line'>&#9;&#9;.func   = ipv6_hop_jumbo,
</span><span class='line'>&#9;},
</span><span class='line'>&#9;{ -1, }
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>解析路由警告选项</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int ipv6_hop_ra(struct sk_buff *skb, int optoff)
</span><span class='line'>{
</span><span class='line'>&#9;const unsigned char *nh = skb_network_header(skb); //获取网络头
</span><span class='line'>
</span><span class='line'>&#9;if (nh[optoff + 1] == 2) { //路由警告选项长度必须是2 ? rfc 要求是 4
</span><span class='line'>&#9;&#9;IP6CB(skb)-&gt;ra = optoff; //记录警告类型
</span><span class='line'>&#9;&#9;return 1;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;LIMIT_NETDEBUG(KERN_DEBUG "ipv6_hop_ra: wrong RA length %d\n", nh[optoff + 1]);
</span><span class='line'>&#9;kfree_skb(skb);
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>解析jumbo frame选项</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int ipv6_hop_jumbo(struct sk_buff *skb, int optoff)
</span><span class='line'>{
</span><span class='line'>&#9;const unsigned char *nh = skb_network_header(skb);
</span><span class='line'>&#9;u32 pkt_len;
</span><span class='line'>&#9;//选项数据长度必须是4，选项类型必须是 0xc2， ＆3 后必须是2
</span><span class='line'>&#9;if (nh[optoff + 1] != 4 || (optoff & 3) != 2) {
</span><span class='line'>&#9;&#9;LIMIT_NETDEBUG(KERN_DEBUG "ipv6_hop_jumbo: wrong jumbo opt length/alignment %d\n", nh[optoff+1]);
</span><span class='line'>&#9;&#9;IP6_INC_STATS_BH(ipv6_skb_idev(skb), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;&#9;goto drop;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;pkt_len = ntohl(*(__be32 *)(nh + optoff + 2)); //获取整个负载长度
</span><span class='line'>&#9;if (pkt_len &lt;= IPV6_MAXPLEN) { //小于65535 是不对地
</span><span class='line'>&#9;&#9;IP6_INC_STATS_BH(ipv6_skb_idev(skb), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;&#9;icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, optoff+2);
</span><span class='line'>&#9;&#9;return 0;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (ipv6_hdr(skb)-&gt;payload_len) { //原ipv6头中就不应该有负载长度了
</span><span class='line'>&#9;&#9;IP6_INC_STATS_BH(ipv6_skb_idev(skb), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;&#9;icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, optoff);
</span><span class='line'>&#9;&#9;return 0;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (pkt_len &gt; skb-&gt;len - sizeof(struct ipv6hdr)) { //长度超出了 skb 的实际长度
</span><span class='line'>&#9;&#9;IP6_INC_STATS_BH(ipv6_skb_idev(skb), IPSTATS_MIB_INTRUNCATEDPKTS);
</span><span class='line'>&#9;&#9;goto drop;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//如果必要试图缩减 skb 的长度
</span><span class='line'>&#9;if (pskb_trim_rcsum(skb, pkt_len + sizeof(struct ipv6hdr)))
</span><span class='line'>&#9;&#9;goto drop;
</span><span class='line'>
</span><span class='line'>&#9;return 1;
</span><span class='line'>drop:
</span><span class='line'>&#9;kfree_skb(skb);
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>目的选项处理</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct tlvtype_proc tlvprocdestopt_lst[] = {
</span><span class='line'>#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)
</span><span class='line'>&#9;{
</span><span class='line'>&#9;&#9;.type   = IPV6_TLV_HAO,
</span><span class='line'>&#9;&#9;.func   = ipv6_dest_hao,
</span><span class='line'>&#9;},
</span><span class='line'>#endif
</span><span class='line'>&#9;{-1,    NULL}
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>解析目的选项</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int ipv6_dest_hao(struct sk_buff *skb, int optoff)
</span><span class='line'>{
</span><span class='line'>&#9;struct ipv6_destopt_hao *hao;
</span><span class='line'>&#9;struct inet6_skb_parm *opt = IP6CB(skb);
</span><span class='line'>&#9;struct ipv6hdr *ipv6h = ipv6_hdr(skb);
</span><span class='line'>&#9;struct in6_addr tmp_addr;
</span><span class='line'>&#9;int ret;
</span><span class='line'>
</span><span class='line'>&#9;if (opt-&gt;dsthao) { //已经处理
</span><span class='line'>&#9;&#9;LIMIT_NETDEBUG(KERN_DEBUG "hao duplicated\n");
</span><span class='line'>&#9;&#9;goto discard;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;opt-&gt;dsthao = opt-&gt;dst1;
</span><span class='line'>&#9;opt-&gt;dst1 = 0;
</span><span class='line'>
</span><span class='line'>&#9;//获取网络头后面的选项部分
</span><span class='line'>&#9;hao = (struct ipv6_destopt_hao *)(skb_network_header(skb) + optoff);
</span><span class='line'>
</span><span class='line'>&#9;if (hao-&gt;length != 16) { //长度要求
</span><span class='line'>&#9;&#9;LIMIT_NETDEBUG(KERN_DEBUG "hao invalid option length = %d\n", hao-&gt;length);
</span><span class='line'>&#9;&#9;goto discard;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (!(ipv6_addr_type(&hao-&gt;addr) & IPV6_ADDR_UNICAST)) { //地址不是单播
</span><span class='line'>&#9;&#9;LIMIT_NETDEBUG(KERN_DEBUG "hao is not an unicast addr: " NIP6_FMT "\n", NIP6(hao-&gt;addr));
</span><span class='line'>&#9;&#9;goto discard;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//IPSEC相关
</span><span class='line'>&#9;ret = xfrm6_input_addr(skb, (xfrm_address_t *)&ipv6h-&gt;daddr, (xfrm_address_t *)&hao-&gt;addr, IPPROTO_DSTOPTS);
</span><span class='line'>&#9;if (unlikely(ret &lt; 0))
</span><span class='line'>&#9;&#9;goto discard;
</span><span class='line'>
</span><span class='line'>&#9;if (skb_cloned(skb)) { //如果包是cloned
</span><span class='line'>&#9;&#9;//分配新的内存数据
</span><span class='line'>&#9;&#9;if (pskb_expand_head(skb, 0, 0, GFP_ATOMIC))
</span><span class='line'>&#9;&#9;&#9;goto discard;
</span><span class='line'>
</span><span class='line'>&#9;&#9;//重新指向各头
</span><span class='line'>&#9;&#9;hao = (struct ipv6_destopt_hao *)(skb_network_header(skb) + optoff);
</span><span class='line'>&#9;&#9;ipv6h = ipv6_hdr(skb);
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (skb-&gt;ip_summed == CHECKSUM_COMPLETE)
</span><span class='line'>&#9;&#9;skb-&gt;ip_summed = CHECKSUM_NONE;
</span><span class='line'>
</span><span class='line'>&#9;//把ip头中的源地址与选项中的地址交换
</span><span class='line'>&#9;ipv6_addr_copy(&tmp_addr, &ipv6h-&gt;saddr);
</span><span class='line'>&#9;ipv6_addr_copy(&ipv6h-&gt;saddr, &hao-&gt;addr);
</span><span class='line'>&#9;ipv6_addr_copy(&hao-&gt;addr, &tmp_addr);
</span><span class='line'>
</span><span class='line'>&#9;if (skb-&gt;tstamp.tv64 == 0)
</span><span class='line'>&#9;&#9;__net_timestamp(skb); //记录时间截
</span><span class='line'>
</span><span class='line'>&#9;return 1;
</span><span class='line'>discard:
</span><span class='line'>&#9;kfree_skb(skb);
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>ipv6扩展头处理</h4>

<p>我们只介绍根ipv6扩展头相关的实现，像其他的扩展头(tcp, udp)等虽然也是叫扩展头但实际是传输层的内容，将在其他文章中介绍。</p>

<p>路由扩展首部</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct ipv6_rt_hdr {
</span><span class='line'>&#9;__u8            nexthdr;
</span><span class='line'>&#9;__u8            hdrlen;
</span><span class='line'>&#9;__u8            type;
</span><span class='line'>&#9;__u8            segments_left;
</span><span class='line'>
</span><span class='line'>&#9;/* type specific data variable length field */
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>路由扩展首部处理结构</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct inet6_protocol rthdr_protocol = {
</span><span class='line'>&#9;.handler        =       ipv6_rthdr_rcv,
</span><span class='line'>&#9;.flags          =       INET6_PROTO_NOPOLICY | INET6_PROTO_GSO_EXTHDR,
</span><span class='line'>};
</span><span class='line'>static int ipv6_rthdr_rcv(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>&#9;struct inet6_skb_parm *opt = IP6CB(skb);
</span><span class='line'>&#9;struct in6_addr *addr = NULL;
</span><span class='line'>&#9;struct in6_addr daddr;
</span><span class='line'>&#9;struct inet6_dev *idev;
</span><span class='line'>&#9;int n, i;
</span><span class='line'>&#9;struct ipv6_rt_hdr *hdr;
</span><span class='line'>&#9;struct rt0_hdr *rthdr;
</span><span class='line'>&#9;int accept_source_route = ipv6_devconf.accept_source_route;
</span><span class='line'>
</span><span class='line'>&#9;idev = in6_dev_get(skb-&gt;dev); //包进入设备
</span><span class='line'>&#9;if (idev) {
</span><span class='line'>&#9;&#9;if (accept_source_route &gt; idev-&gt;cnf.accept_source_route) //默认数量大于了手动调节(proc中）的数量
</span><span class='line'>&#9;&#9;&#9;accept_source_route = idev-&gt;cnf.accept_source_route;
</span><span class='line'>&#9;&#9;in6_dev_put(idev);
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//skb长度和内存空间正确
</span><span class='line'>&#9;if (!pskb_may_pull(skb, skb_transport_offset(skb) + 8) || !pskb_may_pull(skb, (skb_transport_offset(skb) +
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;((skb_transport_header(skb)[1] + 1) &lt;&lt; 3)))) {
</span><span class='line'>&#9;&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;&#9;kfree_skb(skb);
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;hdr = (struct ipv6_rt_hdr *)skb_transport_header(skb); //路由扩展头
</span><span class='line'>&#9;//是到多播地址或硬件地址不是到本机的地址
</span><span class='line'>&#9;if (ipv6_addr_is_multicast(&ipv6_hdr(skb)-&gt;daddr) || skb-&gt;pkt_type != PACKET_HOST) {
</span><span class='line'>&#9;&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INADDRERRORS);
</span><span class='line'>&#9;&#9;kfree_skb(skb);
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>looped_back:
</span><span class='line'>&#9;if (hdr-&gt;segments_left == 0) { //根据rfc要求 分段剩余为0
</span><span class='line'>&#9;&#9;switch (hdr-&gt;type) {
</span><span class='line'>#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)
</span><span class='line'>&#9;&#9;&#9;case IPV6_SRCRT_TYPE_2:
</span><span class='line'>&#9;&#9;&#9;&#9;/* Silently discard type 2 header unless it was processed by own */
</span><span class='line'>&#9;&#9;&#9;&#9;if (!addr) {
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INADDRERRORS);
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;kfree_skb(skb);
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;return -1;
</span><span class='line'>&#9;&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>#endif
</span><span class='line'>&#9;&#9;&#9;default:
</span><span class='line'>&#9;&#9;&#9;&#9;break;
</span><span class='line'>
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;opt-&gt;lastopt = opt-&gt;srcrt = skb_network_header_len(skb);
</span><span class='line'>&#9;&#9;skb-&gt;transport_header += (hdr-&gt;hdrlen + 1) &lt;&lt; 3; //下一个传输头的位置
</span><span class='line'>&#9;&#9;opt-&gt;dst0 = opt-&gt;dst1;
</span><span class='line'>&#9;&#9;opt-&gt;dst1 = 0;
</span><span class='line'>&#9;&#9;opt-&gt;nhoff = (&hdr-&gt;nexthdr) - skb_network_header(skb); //记录下一个头数据相对网络头的偏移量
</span><span class='line'>&#9;&#9;return 1;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;switch (hdr-&gt;type) {
</span><span class='line'>#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)
</span><span class='line'>&#9;&#9;case IPV6_SRCRT_TYPE_2:
</span><span class='line'>&#9;&#9;&#9;if (accept_source_route &lt; 0)
</span><span class='line'>&#9;&#9;&#9;&#9;goto unknown_rh;
</span><span class='line'>&#9;&#9;&#9;/* Silently discard invalid RTH type 2 */
</span><span class='line'>&#9;&#9;&#9;if (hdr-&gt;hdrlen != 2 || hdr-&gt;segments_left != 1) {
</span><span class='line'>&#9;&#9;&#9;&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;&#9;&#9;&#9;kfree_skb(skb);
</span><span class='line'>&#9;&#9;&#9;&#9;return -1;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;break;
</span><span class='line'>#endif
</span><span class='line'>&#9;&#9;default:
</span><span class='line'>&#9;&#9;&#9;goto unknown_rh;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;/* This is the routing header forwarding algorithm from RFC 2460, page 16. */
</span><span class='line'>
</span><span class='line'>&#9;n = hdr-&gt;hdrlen &gt;&gt; 1; //计算路由首部中的地址数量
</span><span class='line'>&#9;if (hdr-&gt;segments_left &gt; n) {
</span><span class='line'>&#9;&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;&#9;icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, ((&hdr-&gt;segments_left) - skb_network_header(skb)));
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;/* We are about to mangle packet header. Be careful!                                       
</span><span class='line'>&#9;   Do not damage packets queued somewhere.  */
</span><span class='line'>&#9;if (skb_cloned(skb)) {
</span><span class='line'>&#9;&#9;/* the copy is a forwarded packet */
</span><span class='line'>&#9;&#9;if (pskb_expand_head(skb, 0, 0, GFP_ATOMIC)) {
</span><span class='line'>&#9;&#9;&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_OUTDISCARDS);
</span><span class='line'>&#9;&#9;&#9;kfree_skb(skb);
</span><span class='line'>&#9;&#9;&#9;return -1;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;hdr = (struct ipv6_rt_hdr *)skb_transport_header(skb);
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (skb-&gt;ip_summed == CHECKSUM_COMPLETE)
</span><span class='line'>&#9;&#9;skb-&gt;ip_summed = CHECKSUM_NONE;
</span><span class='line'>
</span><span class='line'>&#9;i = n - --hdr-&gt;segments_left; //计算地址向量(地址列表)中要"访问"的下一个地址
</span><span class='line'>
</span><span class='line'>&#9;rthdr = (struct rt0_hdr *) hdr;
</span><span class='line'>&#9;addr = rthdr-&gt;addr; //指向地址列表首部
</span><span class='line'>&#9;addr += i - 1; //移动到下一个地址
</span><span class='line'>
</span><span class='line'>&#9;switch (hdr-&gt;type) {
</span><span class='line'>#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)
</span><span class='line'>&#9;&#9;case IPV6_SRCRT_TYPE_2:
</span><span class='line'>&#9;&#9;&#9;if (xfrm6_input_addr(skb, (xfrm_address_t *)addr, (xfrm_address_t *)&ipv6_hdr(skb)-&gt;saddr, IPPROTO_ROUTING) &lt; 0) {
</span><span class='line'>&#9;&#9;&#9;&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INADDRERRORS);
</span><span class='line'>&#9;&#9;&#9;&#9;kfree_skb(skb);
</span><span class='line'>&#9;&#9;&#9;&#9;return -1;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;if (!ipv6_chk_home_addr(addr)) {
</span><span class='line'>&#9;&#9;&#9;&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INADDRERRORS);
</span><span class='line'>&#9;&#9;&#9;&#9;kfree_skb(skb);
</span><span class='line'>&#9;&#9;&#9;&#9;return -1;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;&#9;break;
</span><span class='line'>#endif
</span><span class='line'>&#9;&#9;default:
</span><span class='line'>&#9;&#9;&#9;break;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (ipv6_addr_is_multicast(addr)) { //这个地址是多播地址
</span><span class='line'>&#9;&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INADDRERRORS);
</span><span class='line'>&#9;&#9;kfree_skb(skb);
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//交换 IPv6 目的地址和这个地址
</span><span class='line'>&#9;ipv6_addr_copy(&daddr, addr);
</span><span class='line'>&#9;ipv6_addr_copy(addr, &ipv6_hdr(skb)-&gt;daddr);
</span><span class='line'>&#9;ipv6_addr_copy(&ipv6_hdr(skb)-&gt;daddr, &daddr);
</span><span class='line'>&#9;dst_release(xchg(&skb-&gt;dst, NULL));
</span><span class='line'>
</span><span class='line'>&#9;ip6_route_input(skb); //路由查找处理，将在其他文章中介绍
</span><span class='line'>
</span><span class='line'>&#9;if (skb-&gt;dst-&gt;error) {
</span><span class='line'>&#9;&#9;skb_push(skb, skb-&gt;data - skb_network_header(skb));
</span><span class='line'>&#9;&#9;dst_input(skb);
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;if (skb-&gt;dst-&gt;dev-&gt;flags & IFF_LOOPBACK) { //路由查找后要发送到的目的设备是回环
</span><span class='line'>&#9;&#9;if (ipv6_hdr(skb)-&gt;hop_limit &lt;= 1) { //跳数限制小于1
</span><span class='line'>&#9;&#9;&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;&#9;&#9;//给源地址发送一个 ICMP "超时 – 传输超过跳数限制" 的报文, 并且抛弃此包
</span><span class='line'>&#9;&#9;&#9;icmpv6_send(skb, ICMPV6_TIME_EXCEED, ICMPV6_EXC_HOPLIMIT, 0, skb-&gt;dev);
</span><span class='line'>&#9;&#9;&#9;kfree_skb(skb);
</span><span class='line'>&#9;&#9;&#9;return -1;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;ipv6_hdr(skb)-&gt;hop_limit--;
</span><span class='line'>&#9;&#9;goto looped_back;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//将data之中移动到网络头
</span><span class='line'>&#9;skb_push(skb, skb-&gt;data - skb_network_header(skb));
</span><span class='line'>&#9;dst_input(skb); //这时包应该被转发了
</span><span class='line'>&#9;return -1;
</span><span class='line'>unknown_rh:
</span><span class='line'>&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, (&hdr-&gt;type) - skb_network_header(skb));
</span><span class='line'>&#9;return -1;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ipv6分配包扩展首部处理</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct inet6_protocol frag_protocol =
</span><span class='line'>{
</span><span class='line'>&#9;.handler        =       ipv6_frag_rcv,
</span><span class='line'>&#9;.flags          =       INET6_PROTO_NOPOLICY,
</span><span class='line'>};
</span><span class='line'>static int ipv6_frag_rcv(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>&#9;struct frag_hdr *fhdr;
</span><span class='line'>&#9;struct frag_queue *fq;
</span><span class='line'>&#9;struct ipv6hdr *hdr = ipv6_hdr(skb);
</span><span class='line'>
</span><span class='line'>&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_REASMREQDS);
</span><span class='line'>
</span><span class='line'>&#9;/* Jumbo payload inhibits frag. header */
</span><span class='line'>&#9;if (hdr-&gt;payload_len == 0) { //是Jumbo payload，不是分片包
</span><span class='line'>&#9;&#9;IP6_INC_STATS(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;&#9;icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, skb_network_header_len(skb));
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//有碎片头空间
</span><span class='line'>&#9;if (!pskb_may_pull(skb, (skb_transport_offset(skb) + sizeof(struct frag_hdr)))) {
</span><span class='line'>&#9;&#9;IP6_INC_STATS(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;&#9;icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, skb_network_header_len(skb));
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;hdr = ipv6_hdr(skb);
</span><span class='line'>&#9;fhdr = (struct frag_hdr *)skb_transport_header(skb); //分片头
</span><span class='line'>
</span><span class='line'>&#9;if (!(fhdr-&gt;frag_off & htons(0xFFF9))) { //没有分片偏移，不是分片包
</span><span class='line'>&#9;&#9;/* It is not a fragmented frame */
</span><span class='line'>&#9;&#9;skb-&gt;transport_header += sizeof(struct frag_hdr); //传输头向后移动到下一个头
</span><span class='line'>&#9;&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_REASMOKS);
</span><span class='line'>&#9;&#9;IP6CB(skb)-&gt;nhoff = (u8 *)fhdr - skb_network_header(skb);
</span><span class='line'>&#9;&#9;return 1;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (atomic_read(&ip6_frags.mem) &gt; ip6_frags_ctl.high_thresh) //内存使用超过限制
</span><span class='line'>&#9;&#9;ip6_evictor(ip6_dst_idev(skb-&gt;dst));
</span><span class='line'>
</span><span class='line'>&#9;//查找或创建分片队列头
</span><span class='line'>&#9;if ((fq = fq_find(fhdr-&gt;identification, &hdr-&gt;saddr, &hdr-&gt;daddr, ip6_dst_idev(skb-&gt;dst))) != NULL) {
</span><span class='line'>&#9;&#9;int ret;
</span><span class='line'>&#9;&#9;spin_lock(&fq-&gt;q.lock);
</span><span class='line'>&#9;&#9;ret = ip6_frag_queue(fq, skb, fhdr, IP6CB(skb)-&gt;nhoff); //入队重组
</span><span class='line'>&#9;&#9;spin_unlock(&fq-&gt;q.lock);
</span><span class='line'>&#9;&#9;fq_put(fq);
</span><span class='line'>&#9;&#9;return ret;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_REASMFAILS);
</span><span class='line'>&#9;kfree_skb(skb);
</span><span class='line'>&#9;return -1;
</span><span class='line'>}
</span><span class='line'>static __inline__ struct frag_queue * fq_find(__be32 id, struct in6_addr *src, struct in6_addr *dst, struct inet6_dev *idev)
</span><span class='line'>{
</span><span class='line'>&#9;struct inet_frag_queue *q;
</span><span class='line'>&#9;struct ip6_create_arg arg;
</span><span class='line'>&#9;unsigned int hash;
</span><span class='line'>
</span><span class='line'>&#9;arg.id = id;
</span><span class='line'>&#9;arg.src = src;
</span><span class='line'>&#9;arg.dst = dst;
</span><span class='line'>&#9;hash = ip6qhashfn(id, src, dst); //id，源，目的进行 hash
</span><span class='line'>
</span><span class='line'>&#9;q = inet_frag_find(&ip6_frags, &arg, hash); //查找或创建
</span><span class='line'>&#9;if (q == NULL)
</span><span class='line'>&#9;&#9;goto oom;
</span><span class='line'>
</span><span class='line'>&#9;return container_of(q, struct frag_queue, q); //成功返回
</span><span class='line'>oom: //没内存了
</span><span class='line'>&#9;IP6_INC_STATS_BH(idev, IPSTATS_MIB_REASMFAILS);
</span><span class='line'>&#9;return NULL;
</span><span class='line'>}
</span><span class='line'>struct inet_frag_queue *inet_frag_find(struct inet_frags *f, void *key, unsigned int hash)
</span><span class='line'>{
</span><span class='line'>&#9;struct inet_frag_queue *q;
</span><span class='line'>&#9;struct hlist_node *n;
</span><span class='line'>
</span><span class='line'>&#9;read_lock(&f-&gt;lock);
</span><span class='line'>&#9;hlist_for_each_entry(q, n, &f-&gt;hash[hash], list) { //在hash桶中查找
</span><span class='line'>
</span><span class='line'>&#9;&#9;if (f-&gt;match(q, key)) { //调用匹配函数进行匹配，具体函数很简单参考初始化时的ipv6_frag_init函数
</span><span class='line'>&#9;&#9;&#9;atomic_inc(&q-&gt;refcnt);
</span><span class='line'>&#9;&#9;&#9;read_unlock(&f-&gt;lock);
</span><span class='line'>&#9;&#9;&#9;return q;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//没有找到就创建一个
</span><span class='line'>&#9;return inet_frag_create(f, key, hash);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>创建分片队列</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct inet_frag_queue *inet_frag_create(struct inet_frags *f, void *arg, unsigned int hash)
</span><span class='line'>{
</span><span class='line'>&#9;struct inet_frag_queue *q;
</span><span class='line'>
</span><span class='line'>&#9;q = inet_frag_alloc(f, arg); //分配一个
</span><span class='line'>&#9;if (q == NULL)
</span><span class='line'>&#9;&#9;return NULL;
</span><span class='line'>&#9;//添加到 hash 表
</span><span class='line'>&#9;return inet_frag_intern(q, f, hash, arg);
</span><span class='line'>}
</span><span class='line'>static struct inet_frag_queue *inet_frag_alloc(struct inet_frags *f, void *arg)
</span><span class='line'>{
</span><span class='line'>&#9;struct inet_frag_queue *q;
</span><span class='line'>
</span><span class='line'>&#9;q = kzalloc(f-&gt;qsize, GFP_ATOMIC); //分配一个队列头，大小是 sizeof(struct frag_queue)
</span><span class='line'>&#9;if (q == NULL)
</span><span class='line'>&#9;&#9;return NULL;
</span><span class='line'>
</span><span class='line'>&#9;f-&gt;constructor(q, arg); //拷贝地址和 id 到队列头结构中
</span><span class='line'>&#9;atomic_add(f-&gt;qsize, &f-&gt;mem);
</span><span class='line'>&#9;setup_timer(&q-&gt;timer, f-&gt;frag_expire, (unsigned long)q);
</span><span class='line'>&#9;spin_lock_init(&q-&gt;lock);
</span><span class='line'>&#9;atomic_set(&q-&gt;refcnt, 1);
</span><span class='line'>&#9;return q;
</span><span class='line'>}
</span><span class='line'>static struct inet_frag_queue *inet_frag_intern(struct inet_frag_queue *qp_in, struct inet_frags *f, unsigned int hash, void *arg)
</span><span class='line'>{
</span><span class='line'>&#9;struct inet_frag_queue *qp;
</span><span class='line'>#ifdef CONFIG_SMP
</span><span class='line'>&#9;struct hlist_node *n;
</span><span class='line'>#endif
</span><span class='line'>
</span><span class='line'>&#9;write_lock(&f-&gt;lock);
</span><span class='line'>#ifdef CONFIG_SMP
</span><span class='line'>&#9;//其他cpu可能已经创建了一个，所以要再次检查
</span><span class='line'>&#9;hlist_for_each_entry(qp, n, &f-&gt;hash[hash], list) {
</span><span class='line'>&#9;&#9;if (f-&gt;match(qp, arg)) { //已经创建
</span><span class='line'>&#9;&#9;&#9;atomic_inc(&qp-&gt;refcnt);
</span><span class='line'>&#9;&#9;&#9;write_unlock(&f-&gt;lock);
</span><span class='line'>&#9;&#9;&#9;qp_in-&gt;last_in |= COMPLETE;
</span><span class='line'>&#9;&#9;&#9;inet_frag_put(qp_in, f); //释放新分配的
</span><span class='line'>&#9;&#9;&#9;return qp;
</span><span class='line'>
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>#endif
</span><span class='line'>&#9;qp = qp_in;
</span><span class='line'>&#9;if (!mod_timer(&qp-&gt;timer, jiffies + f-&gt;ctl-&gt;timeout)) //启动定时器
</span><span class='line'>&#9;&#9;atomic_inc(&qp-&gt;refcnt);
</span><span class='line'>
</span><span class='line'>&#9;//增加引用计数，然后添加到hash表
</span><span class='line'>&#9;atomic_inc(&qp-&gt;refcnt);
</span><span class='line'>&#9;hlist_add_head(&qp-&gt;list, &f-&gt;hash[hash]);
</span><span class='line'>&#9;list_add_tail(&qp-&gt;lru_list, &f-&gt;lru_list);
</span><span class='line'>&#9;f-&gt;nqueues++;
</span><span class='line'>&#9;write_unlock(&f-&gt;lock);
</span><span class='line'>&#9;return qp;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>入队重组</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int ip6_frag_queue(struct frag_queue *fq, struct sk_buff *skb, struct frag_hdr *fhdr, int nhoff)
</span><span class='line'>{
</span><span class='line'>&#9;struct sk_buff *prev, *next;
</span><span class='line'>&#9;struct net_device *dev;
</span><span class='line'>&#9;int offset, end;
</span><span class='line'>
</span><span class='line'>&#9;if (fq-&gt;q.last_in & COMPLETE) //重组已经完成
</span><span class='line'>&#9;&#9;goto err;
</span><span class='line'>
</span><span class='line'>&#9;//分片开始位置
</span><span class='line'>&#9;offset = ntohs(fhdr-&gt;frag_off) & ~0x7;//偏移必须8字节对齐
</span><span class='line'>&#9;//分片在整个包中的结束位置 包负载长度 - 分片头长度
</span><span class='line'>&#9;end = offset + (ntohs(ipv6_hdr(skb)-&gt;payload_len) -  ((u8 *)(fhdr + 1) - (u8 *)(ipv6_hdr(skb) + 1)));
</span><span class='line'>
</span><span class='line'>&#9;//结束位置 &gt; 65535
</span><span class='line'>&#9;if ((unsigned int)end &gt; IPV6_MAXPLEN) {
</span><span class='line'>&#9;&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;&#9;icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, ((u8 *)&fhdr-&gt;frag_off - skb_network_header(skb)));
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//校验和已经完成
</span><span class='line'>&#9;if (skb-&gt;ip_summed == CHECKSUM_COMPLETE) {
</span><span class='line'>&#9;&#9;const unsigned char *nh = skb_network_header(skb);
</span><span class='line'>&#9;&#9;//减去分片包头的校验和
</span><span class='line'>&#9;&#9;skb-&gt;csum = csum_sub(skb-&gt;csum, csum_partial(nh, (u8 *)(fhdr + 1) - nh, 0));
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//最后一个碎片包
</span><span class='line'>&#9;if (!(fhdr-&gt;frag_off & htons(IP6_MF))) {
</span><span class='line'>&#9;&#9;/* If we already have some bits beyond end or have different end, the segment is corrupted. */
</span><span class='line'>&#9;&#9;if (end &lt; fq-&gt;q.len || ((fq-&gt;q.last_in & LAST_IN) && end != fq-&gt;q.len)) //分片出现错误
</span><span class='line'>&#9;&#9;&#9;goto err;
</span><span class='line'>
</span><span class='line'>&#9;&#9;fq-&gt;q.last_in |= LAST_IN; //标识最后一个分片
</span><span class='line'>&#9;&#9;fq-&gt;q.len = end; //记录包总长度
</span><span class='line'>&#9;} else {
</span><span class='line'>&#9;&#9;/* Check if the fragment is rounded to 8 bytes. Required by the RFC. */
</span><span class='line'>&#9;&#9;if (end & 0x7) { //碎片结尾也需要8字节对齐
</span><span class='line'>&#9;&#9;&#9;/* RFC2460 says always send parameter problem in this case. -DaveM */
</span><span class='line'>&#9;&#9;&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), PSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;&#9;&#9;icmpv6_param_prob(skb, ICMPV6_HDR_FIELD, offsetof(struct ipv6hdr, payload_len));
</span><span class='line'>&#9;&#9;&#9;return -1;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;&#9;if (end &gt; fq-&gt;q.len) {
</span><span class='line'>&#9;&#9;&#9;/* Some bits beyond end -&gt; corruption. */
</span><span class='line'>&#9;&#9;&#9;if (fq-&gt;q.last_in & LAST_IN)
</span><span class='line'>&#9;&#9;&#9;&#9;goto err;
</span><span class='line'>&#9;&#9;&#9;fq-&gt;q.len = end; //记录已经得到的碎片的最大长度
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (end == offset) //开始 = 结束
</span><span class='line'>&#9;&#9;goto err;
</span><span class='line'>
</span><span class='line'>&#9;//skb-&gt;data 指向碎片首部头后数据部分
</span><span class='line'>&#9;if (!pskb_pull(skb, (u8 *) (fhdr + 1) - skb-&gt;data))
</span><span class='line'>&#9;&#9;goto err;
</span><span class='line'>&#9;//如果需要缩短skb的内存长度
</span><span class='line'>&#9;if (pskb_trim_rcsum(skb, end - offset))
</span><span class='line'>&#9;&#9;goto err;
</span><span class='line'>
</span><span class='line'>&#9;//找出碎片所在位置
</span><span class='line'>&#9;prev = NULL;
</span><span class='line'>&#9;for(next = fq-&gt;q.fragments; next != NULL; next = next-&gt;next) {
</span><span class='line'>&#9;&#9;if (FRAG6_CB(next)-&gt;offset &gt;= offset)
</span><span class='line'>&#9;&#9;&#9;break;  /* bingo! */
</span><span class='line'>&#9;&#9;prev = next;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;if (prev) { //有前一个碎片
</span><span class='line'>&#9;&#9;//前一个碎片 (开始 + 长度) - 这个碎片的开始. 计算出重叠部分
</span><span class='line'>&#9;&#9;int i = (FRAG6_CB(prev)-&gt;offset + prev-&gt;len) - offset;
</span><span class='line'>&#9;&#9;if (i &gt; 0) { //有重叠
</span><span class='line'>&#9;&#9;&#9;offset += i; //调整这个碎片的开始位置
</span><span class='line'>&#9;&#9;&#9;if (end &lt;= offset) //调整后出错
</span><span class='line'>&#9;&#9;&#9;&#9;goto err;
</span><span class='line'>&#9;&#9;&#9;if (!pskb_pull(skb, i))//skb-&gt;data += i;
</span><span class='line'>&#9;&#9;&#9;&#9;goto err;
</span><span class='line'>&#9;&#9;&#9;if (skb-&gt;ip_summed != CHECKSUM_UNNECESSARY)
</span><span class='line'>&#9;&#9;&#9;&#9;skb-&gt;ip_summed = CHECKSUM_NONE;
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//有下一个碎片，且开始位置 &lt; 这个碎片的结束位置
</span><span class='line'>&#9;while (next && FRAG6_CB(next)-&gt;offset &lt; end) {
</span><span class='line'>&#9;&#9;//这个碎片的结束位置  - 下一个碎片的开始位置，计算重叠
</span><span class='line'>&#9;&#9;int i = end - FRAG6_CB(next)-&gt;offset; /* overlap is 'i' bytes */
</span><span class='line'>&#9;&#9;if (i &lt; next-&gt;len) { //重叠长度 &lt; 下一个碎片的长度
</span><span class='line'>&#9;&#9;&#9;if (!pskb_pull(next, i)) //next-&gt;data += i;
</span><span class='line'>&#9;&#9;&#9;&#9;goto err;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;FRAG6_CB(next)-&gt;offset += i;    //下一个碎片开始位置调整
</span><span class='line'>&#9;&#9;&#9;fq-&gt;q.meat -= i; //总长度减少
</span><span class='line'>&#9;&#9;&#9;if (next-&gt;ip_summed != CHECKSUM_UNNECESSARY)
</span><span class='line'>&#9;&#9;&#9;&#9;next-&gt;ip_summed = CHECKSUM_NONE;
</span><span class='line'>&#9;&#9;&#9;break;
</span><span class='line'>
</span><span class='line'>&#9;&#9;} else { //这个碎片完全复盖了下一个碎片
</span><span class='line'>&#9;&#9;&#9;struct sk_buff *free_it = next; //释放这个碎片
</span><span class='line'>&#9;&#9;&#9;next = next-&gt;next;//调整下一个碎片指针
</span><span class='line'>&#9;&#9;&#9;//调整队列指针
</span><span class='line'>&#9;&#9;&#9;if (prev)
</span><span class='line'>&#9;&#9;&#9;&#9;prev-&gt;next = next;
</span><span class='line'>&#9;&#9;&#9;else
</span><span class='line'>&#9;&#9;&#9;&#9;fq-&gt;q.fragments = next;
</span><span class='line'>
</span><span class='line'>&#9;&#9;&#9;fq-&gt;q.meat -= free_it-&gt;len;
</span><span class='line'>&#9;&#9;&#9;frag_kfree_skb(free_it, NULL); //释放被复盖的包
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;FRAG6_CB(skb)-&gt;offset = offset; //这个碎片包记录自己的开始位置
</span><span class='line'>
</span><span class='line'>&#9;//插入这个碎片到队列
</span><span class='line'>&#9;skb-&gt;next = next;
</span><span class='line'>&#9;if (prev)
</span><span class='line'>&#9;&#9;prev-&gt;next = skb;
</span><span class='line'>&#9;else
</span><span class='line'>&#9;&#9;fq-&gt;q.fragments = skb;
</span><span class='line'>
</span><span class='line'>&#9;dev = skb-&gt;dev;
</span><span class='line'>&#9;if (dev) {
</span><span class='line'>&#9;&#9;fq-&gt;iif = dev-&gt;ifindex;
</span><span class='line'>&#9;&#9;skb-&gt;dev = NULL;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;fq-&gt;q.stamp = skb-&gt;tstamp;
</span><span class='line'>&#9;fq-&gt;q.meat += skb-&gt;len; //累加总长度
</span><span class='line'>&#9;atomic_add(skb-&gt;truesize, &ip6_frags.mem);
</span><span class='line'>
</span><span class='line'>&#9;if (offset == 0) { //偏移为0
</span><span class='line'>&#9;&#9;fq-&gt;nhoffset = nhoff;
</span><span class='line'>&#9;&#9;fq-&gt;q.last_in |= FIRST_IN; //标识开始碎片
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//碎片已经聚齐，记录长度 = 包中标识的长度
</span><span class='line'>&#9;if (fq-&gt;q.last_in == (FIRST_IN | LAST_IN) && fq-&gt;q.meat == fq-&gt;q.len)
</span><span class='line'>&#9;&#9;return ip6_frag_reasm(fq, prev, dev); //重组
</span><span class='line'>&#9;//没有聚齐，移动队列连表到lru连表尾部
</span><span class='line'>&#9;write_lock(&ip6_frags.lock);
</span><span class='line'>&#9;list_move_tail(&fq-&gt;q.lru_list, &ip6_frags.lru_list);
</span><span class='line'>&#9;write_unlock(&ip6_frags.lock);
</span><span class='line'>&#9;return -1;
</span><span class='line'>err:
</span><span class='line'>&#9;IP6_INC_STATS(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_REASMFAILS);
</span><span class='line'>&#9;kfree_skb(skb);
</span><span class='line'>&#9;return -1;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>重组ip头</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static int ip6_frag_reasm(struct frag_queue *fq, struct sk_buff *prev, struct net_device *dev)
</span><span class='line'>{
</span><span class='line'>&#9;struct sk_buff *fp, *head = fq-&gt;q.fragments;
</span><span class='line'>&#9;int    payload_len;
</span><span class='line'>&#9;unsigned int nhoff;
</span><span class='line'>
</span><span class='line'>&#9;fq_kill(fq); //把这个重组队列出队
</span><span class='line'>
</span><span class='line'>&#9;/* Make the one we just received the head. */
</span><span class='line'>&#9;if (prev) {
</span><span class='line'>&#9;&#9;//下面是把head指向的skb复制到fp，然后把fp插入到head指向的位置
</span><span class='line'>&#9;&#9;head = prev-&gt;next;
</span><span class='line'>&#9;&#9;fp = skb_clone(head, GFP_ATOMIC);
</span><span class='line'>
</span><span class='line'>&#9;&#9;if (!fp)
</span><span class='line'>&#9;&#9;&#9;goto out_oom;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;&#9;fp-&gt;next = head-&gt;next;
</span><span class='line'>&#9;&#9;prev-&gt;next = fp;
</span><span class='line'>&#9;&#9;//把真正的头skb复制到head指针的skb
</span><span class='line'>&#9;&#9;skb_morph(head, fq-&gt;q.fragments);
</span><span class='line'>&#9;&#9;head-&gt;next = fq-&gt;q.fragments-&gt;next;
</span><span class='line'>
</span><span class='line'>&#9;&#9;kfree_skb(fq-&gt;q.fragments);//释放原来的头
</span><span class='line'>&#9;&#9;fq-&gt;q.fragments = head;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;/* Unfragmented part is taken from the first segment. */
</span><span class='line'>&#9;//计算负载总长度
</span><span class='line'>&#9;payload_len = ((head-&gt;data - skb_network_header(head)) - sizeof(struct ipv6hdr) + fq-&gt;q.len -  sizeof(struct frag_hdr));
</span><span class='line'>&#9;if (payload_len &gt; IPV6_MAXPLEN) //超过65535
</span><span class='line'>&#9;&#9;goto out_oversize;
</span><span class='line'>
</span><span class='line'>&#9;/* Head of list must not be cloned. */
</span><span class='line'>&#9;//如果skb被克隆，从新分配他的data
</span><span class='line'>&#9;if (skb_cloned(head) && pskb_expand_head(head, 0, 0, GFP_ATOMIC))
</span><span class='line'>&#9;&#9;goto out_oom;
</span><span class='line'>
</span><span class='line'>&#9;/* If the first fragment is fragmented itself, we split it to two chunks: the first with data and paged part
</span><span class='line'>&#9; * and the second, holding only fragments.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;if (skb_shinfo(head)-&gt;frag_list) {//如果头自己已经被分片
</span><span class='line'>&#9;&#9;struct sk_buff *clone;
</span><span class='line'>&#9;&#9;int i, plen = 0;
</span><span class='line'>
</span><span class='line'>&#9;&#9;if ((clone = alloc_skb(0, GFP_ATOMIC)) == NULL)
</span><span class='line'>&#9;&#9;&#9;goto out_oom;
</span><span class='line'>
</span><span class='line'>&#9;&#9;//把这个clone插入到头后               
</span><span class='line'>&#9;&#9;clone-&gt;next = head-&gt;next;
</span><span class='line'>&#9;&#9;head-&gt;next = clone;
</span><span class='line'>&#9;&#9;//把头的分片给这个clone
</span><span class='line'>&#9;&#9;skb_shinfo(clone)-&gt;frag_list = skb_shinfo(head)-&gt;frag_list;
</span><span class='line'>&#9;&#9;skb_shinfo(head)-&gt;frag_list = NULL;
</span><span class='line'>&#9;&#9;//头使用了页面，计算总长度
</span><span class='line'>&#9;&#9;for (i = 0; i &lt; skb_shinfo(head)-&gt;nr_frags; i++)
</span><span class='line'>&#9;&#9;&#9;plen += skb_shinfo(head)-&gt;frags[i].size;
</span><span class='line'>
</span><span class='line'>&#9;&#9;clone-&gt;len = clone-&gt;data_len = head-&gt;data_len - plen;
</span><span class='line'>&#9;&#9;head-&gt;data_len -= clone-&gt;len;
</span><span class='line'>&#9;&#9;head-&gt;len -= clone-&gt;len;
</span><span class='line'>&#9;&#9;clone-&gt;csum = 0;
</span><span class='line'>&#9;&#9;clone-&gt;ip_summed = head-&gt;ip_summed;
</span><span class='line'>&#9;&#9;atomic_add(clone-&gt;truesize, &ip6_frags.mem);
</span><span class='line'>&#9;}
</span><span class='line'>&#9;/* We have to remove fragment header from datagram and to relocate                         
</span><span class='line'>&#9; * header in order to calculate ICV correctly. */
</span><span class='line'>&#9;nhoff = fq-&gt;nhoffset;
</span><span class='line'>&#9;//把传输头（分片头）中的下一个头字段值赋给网络头中的下一个头字段
</span><span class='line'>&#9;skb_network_header(head)[nhoff] = skb_transport_header(head)[0];
</span><span class='line'>&#9;//把分片首部复盖掉
</span><span class='line'>&#9;memmove(head-&gt;head + sizeof(struct frag_hdr), head-&gt;head, (head-&gt;data - head-&gt;head) - sizeof(struct frag_hdr));
</span><span class='line'>&#9;//调整相应的各个层的头位置
</span><span class='line'>&#9;head-&gt;mac_header += sizeof(struct frag_hdr);
</span><span class='line'>&#9;head-&gt;network_header += sizeof(struct frag_hdr);
</span><span class='line'>
</span><span class='line'>&#9;skb_shinfo(head)-&gt;frag_list = head-&gt;next; //保存碎片连表
</span><span class='line'>&#9;skb_reset_transport_header(head);//重新调整网络头，现在指向分片头后的头
</span><span class='line'>&#9;skb_push(head, head-&gt;data - skb_network_header(head));//使head-&gt;data指向网络头
</span><span class='line'>&#9;atomic_sub(head-&gt;truesize, &ip6_frags.mem);
</span><span class='line'>
</span><span class='line'>&#9;for (fp = head-&gt;next; fp; fp = fp-&gt;next) { //统计分片总长度
</span><span class='line'>&#9;&#9;head-&gt;data_len += fp-&gt;len;
</span><span class='line'>&#9;&#9;head-&gt;len += fp-&gt;len;
</span><span class='line'>&#9;&#9;if (head-&gt;ip_summed != fp-&gt;ip_summed)
</span><span class='line'>&#9;&#9;&#9;head-&gt;ip_summed = CHECKSUM_NONE;
</span><span class='line'>&#9;&#9;else if (head-&gt;ip_summed == CHECKSUM_COMPLETE)
</span><span class='line'>&#9;&#9;&#9;head-&gt;csum = csum_add(head-&gt;csum, fp-&gt;csum); //添加各分片的累加和
</span><span class='line'>
</span><span class='line'>&#9;&#9;head-&gt;truesize += fp-&gt;truesize;
</span><span class='line'>&#9;&#9;atomic_sub(fp-&gt;truesize, &ip6_frags.mem);
</span><span class='line'>&#9;}
</span><span class='line'>&#9;head-&gt;next = NULL;
</span><span class='line'>&#9;head-&gt;dev = dev;
</span><span class='line'>&#9;head-&gt;tstamp = fq-&gt;q.stamp;
</span><span class='line'>&#9;ipv6_hdr(head)-&gt;payload_len = htons(payload_len); //总长度
</span><span class='line'>&#9;IP6CB(head)-&gt;nhoff = nhoff;
</span><span class='line'>
</span><span class='line'>&#9;/* Yes, and fold redundant checksum back. 8) */
</span><span class='line'>&#9;if (head-&gt;ip_summed == CHECKSUM_COMPLETE) //添加网络头累加和
</span><span class='line'>&#9;&#9;head-&gt;csum = csum_partial(skb_network_header(head), skb_network_header_len(head), head-&gt;csum);
</span><span class='line'>
</span><span class='line'>&#9;rcu_read_lock();
</span><span class='line'>&#9;IP6_INC_STATS_BH(__in6_dev_get(dev), IPSTATS_MIB_REASMOKS);
</span><span class='line'>&#9;rcu_read_unlock();
</span><span class='line'>&#9;fq-&gt;q.fragments = NULL;
</span><span class='line'>&#9;return 1;
</span><span class='line'>&#9;...... //下面是错误处理
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>无数据扩展头</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct inet6_protocol nodata_protocol = {
</span><span class='line'>&#9;.handler        =       ipv6_nodata_rcv,
</span><span class='line'>&#9;.flags          =       INET6_PROTO_NOPOLICY,
</span><span class='line'>};
</span><span class='line'>static int ipv6_nodata_rcv(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>&#9;kfree_skb(skb);
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>目的选项首部处理</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static struct inet6_protocol destopt_protocol = {
</span><span class='line'>&#9;.handler        =       ipv6_destopt_rcv,
</span><span class='line'>&#9;.flags          =       INET6_PROTO_NOPOLICY | INET6_PROTO_GSO_EXTHDR,
</span><span class='line'>};
</span><span class='line'>static int ipv6_destopt_rcv(struct sk_buff *skb)
</span><span class='line'>{
</span><span class='line'>&#9;struct inet6_skb_parm *opt = IP6CB(skb);
</span><span class='line'>#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)
</span><span class='line'>&#9;__u16 dstbuf;
</span><span class='line'>#endif
</span><span class='line'>&#9;struct dst_entry *dst;
</span><span class='line'>&#9;//长度验证
</span><span class='line'>&#9;if (!pskb_may_pull(skb, skb_transport_offset(skb) + 8) || !pskb_may_pull(skb, (skb_transport_offset(skb) +
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;((skb_transport_header(skb)[1] + 1) &lt;&lt; 3)))) {
</span><span class='line'>&#9;&#9;IP6_INC_STATS_BH(ip6_dst_idev(skb-&gt;dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;&#9;kfree_skb(skb);
</span><span class='line'>&#9;&#9;return -1;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;opt-&gt;lastopt = opt-&gt;dst1 = skb_network_header_len(skb); //网络头长度
</span><span class='line'>#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)
</span><span class='line'>&#9;dstbuf = opt-&gt;dst1;
</span><span class='line'>#endif
</span><span class='line'>&#9;dst = dst_clone(skb-&gt;dst); //增加dst的引用计数
</span><span class='line'>&#9;//解析tlv，上面已经看到过了
</span><span class='line'>&#9;if (ip6_parse_tlv(tlvprocdestopt_lst, skb)) {
</span><span class='line'>&#9;&#9;dst_release(dst);
</span><span class='line'>&#9;&#9;skb-&gt;transport_header += (skb_transport_header(skb)[1] + 1) &lt;&lt; 3; //调整网络头位置
</span><span class='line'>&#9;&#9;opt = IP6CB(skb);
</span><span class='line'>#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)
</span><span class='line'>&#9;&#9;opt-&gt;nhoff = dstbuf;
</span><span class='line'>#else
</span><span class='line'>&#9;&#9;opt-&gt;nhoff = opt-&gt;dst1;
</span><span class='line'>#endif
</span><span class='line'>&#9;&#9;return 1;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;IP6_INC_STATS_BH(ip6_dst_idev(dst), IPSTATS_MIB_INHDRERRORS);
</span><span class='line'>&#9;dst_release(dst);
</span><span class='line'>&#9;return -1;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h2 class="entry-title"><a href="/blog/2015/06/12/kernel-net-tcp-close/">linux内核中tcp连接的断开处理</a></h2>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-12T17:21:00+08:00'><span class='date'>2015-06-12</span> <span class='time'>17:21:00</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://simohayha.iteye.com/blog/503856">http://simohayha.iteye.com/blog/503856</a></p>

<p>我们这次主要来分析相关的两个断开函数close和shotdown以及相关的套接口选项SO_LINGER。这里要注意SO_LINGER对shutdown无任何影响。它只对close起作用。</p>

<p>先来坎SO_LINGER所对应的数据结构：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct linger {
</span><span class='line'>&#9;//linger的开关
</span><span class='line'>&#9;int     l_onoff;    /* Linger active        */
</span><span class='line'>&#9;//所等待的时间。
</span><span class='line'>&#9;int     l_linger;   /* How long to linger for   */
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>这里对这个套接口选项就不详细介绍了，在unix网络编程中有详细的介绍，我们这里只会分析内核的处理代码。</p>

<p>首先来看close函数，我们知道缺醒情况下,close是立即返回，但是如果套接口的发送缓冲区还有未发送的数据，系统将会试着把这些数据发送给对端。而这个缺醒情况我们是可以通过SO_LINGER来改变的。还有一个要注意就是close调用并不一定会引发tcp的断开连接。因为close只是将这个socket的引用计数减一(主要是针对多个进程)，而真正要直接引发断开，则需要用shutdown函数。</p>

<p>内核中socket的close的系统调用是sock_close，而在sock_close中，直接调用sock_release来实现功能，因此这里我们直接看sock_release的源码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void sock_release(struct socket *sock)
</span><span class='line'>{
</span><span class='line'>&#9;if (sock-&gt;ops) {
</span><span class='line'>&#9;&#9;struct module *owner = sock-&gt;ops-&gt;owner;
</span><span class='line'>
</span><span class='line'>&#9;&#9;//调用inet_stream_ops的inet_release函数
</span><span class='line'>&#9;&#9;sock-&gt;ops-&gt;release(sock);
</span><span class='line'>&#9;&#9;//将ops致空。
</span><span class='line'>&#9;&#9;sock-&gt;ops = NULL;
</span><span class='line'>&#9;&#9;module_put(owner);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;//这个域貌似是26.31新加的，具体做什么的还不知道。
</span><span class='line'>&#9;if (sock-&gt;fasync_list)
</span><span class='line'>&#9;&#9;printk(KERN_ERR "sock_release: fasync list not empty!\n");
</span><span class='line'>
</span><span class='line'>&#9;//更新全局的socket数目
</span><span class='line'>&#9;percpu_sub(sockets_in_use, 1);
</span><span class='line'>&#9;if (!sock-&gt;file) {
</span><span class='line'>&#9;&#9;//更新inode的引用计数
</span><span class='line'>&#9;&#9;iput(SOCK_INODE(sock));
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>&#9;}
</span><span class='line'>&#9;sock-&gt;file = NULL;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>然后来看inet_release的实现，这个函数主要用来通过SO_LINGER套接字来得到超时时间，然后调用tcp_close来关闭sock。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int inet_release(struct socket *sock)
</span><span class='line'>{
</span><span class='line'>&#9;struct sock *sk = sock-&gt;sk;
</span><span class='line'>
</span><span class='line'>&#9;if (sk) {
</span><span class='line'>&#9;&#9;long timeout;
</span><span class='line'>
</span><span class='line'>&#9;&#9;/* Applications forget to leave groups before exiting */
</span><span class='line'>&#9;&#9;ip_mc_drop_socket(sk);
</span><span class='line'>
</span><span class='line'>&#9;&#9;timeout = 0;
</span><span class='line'>&#9;&#9;//判断是否设置SO_LINGER并且不是处于正在shutdowning，则设置timeout为l_linger(也就是我们设置的值).
</span><span class='line'>&#9;&#9;if (sock_flag(sk, SOCK_LINGER) &&
</span><span class='line'>&#9;&#9;&#9;!(current-&gt;flags & PF_EXITING))
</span><span class='line'>&#9;&#9;&#9;timeout = sk-&gt;sk_lingertime;
</span><span class='line'>&#9;&#9;sock-&gt;sk = NULL;
</span><span class='line'>&#9;&#9;//调用tcp_close.
</span><span class='line'>&#9;&#9;sk-&gt;sk_prot-&gt;close(sk, timeout);
</span><span class='line'>&#9;}
</span><span class='line'>&#9;return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>tcp_close函数比较长我们这里分段来分析它,首先来看第一部分。这里要注意几点：</p>

<p>1 当close掉一个服务端的父socket的时候，内核会先处理半连接队列然后是已经accept了的队列，最后才会处理父sock。</p>

<p>2 处理接收缓冲区的数据的时候，直接遍历receive_queue(前面blog有介绍)，然后统计未发送的socket。我们知道close是不管接收buf的，也就是他会把接收buf释放掉，然后发送rst给对端的。</p>

<p>3 当so_linger有设置并且超时时间为0,则发送rst给对端，并且清空发送和接收buf。这个也不会引起最终的四分组终止序列。</p>

<p>4 当接收缓冲区有未读数据，则直接发送rst给对端。这个也不会引起最终的四分组终止序列。</p>

<p>5 当so_linger有设置，并且超时不为0,或者so_linger没有设置，此时都会引起最终的四分组终止序列来终止连接。(通过send_fin来发送fin,并引发四分组终止序列).而在send_fin中会发送掉发送缓冲区中的数据。</p>

<p>来看代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void tcp_close(struct sock *sk, long timeout)
</span><span class='line'>{
</span><span class='line'>&#9;struct sk_buff *skb;
</span><span class='line'>&#9;int data_was_unread = 0;
</span><span class='line'>&#9;int state;
</span><span class='line'>
</span><span class='line'>&#9;lock_sock(sk);
</span><span class='line'>&#9;sk-&gt;sk_shutdown = SHUTDOWN_MASK;
</span><span class='line'>
</span><span class='line'>&#9;//如果处于tcp_listen说明将要关闭的这个socket是一个服务端的主socket。
</span><span class='line'>&#9;if (sk-&gt;sk_state == TCP_LISTEN) {
</span><span class='line'>&#9;&#9;//设置sock状态.
</span><span class='line'>&#9;&#9;tcp_set_state(sk, TCP_CLOSE);
</span><span class='line'>
</span><span class='line'>&#9;&#9;//这个函数主要用来清理半连接队列(下面会简要分析这个函数)
</span><span class='line'>&#9;&#9;/* Special case. */
</span><span class='line'>&#9;&#9;inet_csk_listen_stop(sk);
</span><span class='line'>&#9;&#9;//处理要关闭的sock
</span><span class='line'>&#9;&#9;goto adjudge_to_death;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;//遍历sk_receive_queue也就是输入buf队列。然后统计还没有读取的数据。
</span><span class='line'>&#9;while ((skb = __skb_dequeue(&sk-&gt;sk_receive_queue)) != NULL) {
</span><span class='line'>&#9;&#9;u32 len = TCP_SKB_CB(skb)-&gt;end_seq - TCP_SKB_CB(skb)-&gt;seq -
</span><span class='line'>&#9;&#9;&#9;  tcp_hdr(skb)-&gt;fin;
</span><span class='line'>&#9;&#9;data_was_unread += len;
</span><span class='line'>&#9;&#9;//free这个skb
</span><span class='line'>&#9;&#9;__kfree_skb(skb);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;sk_mem_reclaim(sk);
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;//第一个if主要是实现了rfc2525的2.17,也就是关闭的时候，如果接收buf中有未读数据，则发送一个rst给对端。(下面有摘抄相关内容)
</span><span class='line'>&#9;if (data_was_unread) {
</span><span class='line'>&#9;&#9;/* Unread data was tossed, zap the connection. */
</span><span class='line'>&#9;&#9;NET_INC_STATS_USER(sock_net(sk), LINUX_MIB_TCPABORTONCLOSE);
</span><span class='line'>&#9;&#9;//设置状态
</span><span class='line'>&#9;&#9;tcp_set_state(sk, TCP_CLOSE);
</span><span class='line'>&#9;&#9;//发送rst
</span><span class='line'>&#9;&#9;tcp_send_active_reset(sk, GFP_KERNEL);
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//第二个if主要是判断so_linger套接字,并且超时时间为0。此时我们就直接丢掉所有的发送缓冲区中的数据
</span><span class='line'>&#9;else if (sock_flag(sk, SOCK_LINGER) && !sk-&gt;sk_lingertime) {
</span><span class='line'>&#9;&#9;/* Check zero linger _after_ checking for unread data. */
</span><span class='line'>&#9;&#9;//调用tcp_disconnect，这个函数主要用来断开和对端的连接，这个函数下面会介绍。
</span><span class='line'>&#9;&#9;sk-&gt;sk_prot-&gt;disconnect(sk, 0);
</span><span class='line'>&#9;&#9;NET_INC_STATS_USER(sock_net(sk), LINUX_MIB_TCPABORTONDATA);
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//这个函数主要用来判断是否需要发送fin，也就是判断状态。下面我会详细介绍这个函数。
</span><span class='line'>&#9;else if (tcp_close_state(sk)) {
</span><span class='line'>
</span><span class='line'>&#9;&#9;//发送fin.
</span><span class='line'>&#9;&#9;tcp_send_fin(sk);
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;//等待一段时间。这里的timeout，如果有设置so_linger的话就是l_linger.这里主要是等待发送缓冲区的buf发送(如果超时时间不为0).
</span><span class='line'>&#9;sk_stream_wait_close(sk, timeout);
</span><span class='line'>&#9;........................
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h5>rfc2525的2.17的介绍：</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>When an application closes a connection in such a way that it can no longer read any received data, 
</span><span class='line'>the TCP SHOULD, per section 4.2.2.13 of RFC 1122, send a RST if there is any unread received data, 
</span><span class='line'>or if any new data is received. A TCP that fails to do so exhibits "Failure to RST on close with data pending".</span></code></pre></td></tr></table></div></figure>


<p>ok，现在来看上面遇到的3个函数，一个是inet_csk_listen_stop,一个是tcp_close_state,一个是tcp_disconnect.我们一个个来看他们。</p>

<p>首先是inet_csk_listen_stop函数。我们知道这个函数主要用来清理所有的半连接队列。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void inet_csk_listen_stop(struct sock *sk)
</span><span class='line'>{
</span><span class='line'>&#9;struct inet_connection_sock *icsk = inet_csk(sk);
</span><span class='line'>&#9;struct request_sock *acc_req;
</span><span class='line'>&#9;struct request_sock *req;
</span><span class='line'>
</span><span class='line'>&#9;//首先删除keepalive定时器。
</span><span class='line'>&#9;inet_csk_delete_keepalive_timer(sk);
</span><span class='line'>
</span><span class='line'>&#9;/* make all the listen_opt local to us */
</span><span class='line'>&#9;//得到accept 队列。
</span><span class='line'>&#9;acc_req = reqsk_queue_yank_acceptq(&icsk-&gt;icsk_accept_queue);
</span><span class='line'>
</span><span class='line'>&#9;//然后销毁掉所有的半连接队列，也就是listen_sock队列
</span><span class='line'>&#9;reqsk_queue_destroy(&icsk-&gt;icsk_accept_queue);
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&#9;//遍历accept队列断开与对端的连接。
</span><span class='line'>&#9;while ((req = acc_req) != NULL) {
</span><span class='line'>&#9;...............................................
</span><span class='line'>
</span><span class='line'>&#9;&#9;//调用tcp_disconnect来断开与对端的连接。这里注意是非阻塞的。
</span><span class='line'>&#9;&#9;sk-&gt;sk_prot-&gt;disconnect(child, O_NONBLOCK);
</span><span class='line'>
</span><span class='line'>&#9;&#9;sock_orphan(child);
</span><span class='line'>
</span><span class='line'>&#9;&#9;percpu_counter_inc(sk-&gt;sk_prot-&gt;orphan_count);
</span><span class='line'>
</span><span class='line'>&#9;&#9;//销毁这个sock。
</span><span class='line'>&#9;&#9;inet_csk_destroy_sock(child);
</span><span class='line'>
</span><span class='line'>&#9;&#9;........................................
</span><span class='line'>&#9;}
</span><span class='line'>&#9;WARN_ON(sk-&gt;sk_ack_backlog);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>接下来来看tcp_disconnect函数。这个函数主要用来断开和对端的连接.它会释放读写队列，发送rst，清除定时器等等一系列操作。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int tcp_disconnect(struct sock *sk, int flags)
</span><span class='line'>{
</span><span class='line'>&#9;struct inet_sock *inet = inet_sk(sk);
</span><span class='line'>&#9;struct inet_connection_sock *icsk = inet_csk(sk);
</span><span class='line'>&#9;struct tcp_sock *tp = tcp_sk(sk);
</span><span class='line'>&#9;int err = 0;
</span><span class='line'>&#9;int old_state = sk-&gt;sk_state;
</span><span class='line'>
</span><span class='line'>&#9;if (old_state != TCP_CLOSE)
</span><span class='line'>&#9;&#9;tcp_set_state(sk, TCP_CLOSE);
</span><span class='line'>&#9;...................
</span><span class='line'>
</span><span class='line'>&#9;//清除定时器，重传，delack等。
</span><span class='line'>&#9;tcp_clear_xmit_timers(sk);
</span><span class='line'>&#9;//直接free掉接收buf。
</span><span class='line'>&#9;__skb_queue_purge(&sk-&gt;sk_receive_queue);
</span><span class='line'>&#9;//free掉写buf。
</span><span class='line'>&#9;tcp_write_queue_purge(sk);
</span><span class='line'>&#9;__skb_queue_purge(&tp-&gt;out_of_order_queue);
</span><span class='line'>#ifdef CONFIG_NET_DMA
</span><span class='line'>&#9;__skb_queue_purge(&sk-&gt;sk_async_wait_queue);
</span><span class='line'>#endif
</span><span class='line'>
</span><span class='line'>&#9;inet-&gt;dport = 0;
</span><span class='line'>
</span><span class='line'>&#9;if (!(sk-&gt;sk_userlocks & SOCK_BINDADDR_LOCK))
</span><span class='line'>&#9;&#9;inet_reset_saddr(sk);
</span><span class='line'>&#9;&#9;..........................................
</span><span class='line'>&#9;//设置状态。
</span><span class='line'>&#9;tcp_set_ca_state(sk, TCP_CA_Open);
</span><span class='line'>&#9;//清理掉重传的一些标记
</span><span class='line'>&#9;tcp_clear_retrans(tp);
</span><span class='line'>&#9;inet_csk_delack_init(sk);
</span><span class='line'>&#9;tcp_init_send_head(sk);
</span><span class='line'>&#9;memset(&tp-&gt;rx_opt, 0, sizeof(tp-&gt;rx_opt));
</span><span class='line'>&#9;__sk_dst_reset(sk);
</span><span class='line'>
</span><span class='line'>&#9;WARN_ON(inet-&gt;num && !icsk-&gt;icsk_bind_hash);
</span><span class='line'>
</span><span class='line'>&#9;sk-&gt;sk_error_report(sk);
</span><span class='line'>&#9;return err;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>紧接着是tcp_close_state函数这个函数就是用来判断是否应该发送fin:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//这个数组表示了当close后，tcp的状态变化，可以看到注释很清楚，包含了3部分。这里也就是通过current也就是tcp的状态取得new state也就是close的状态，然后再和TCP_ACTION_FIN按位于，得到action
</span><span class='line'>static const unsigned char new_state[16] = {
</span><span class='line'>  /* current state:        new state:      action:  */
</span><span class='line'>  /* (Invalid)      */ TCP_CLOSE,
</span><span class='line'>  /* TCP_ESTABLISHED    */ TCP_FIN_WAIT1 | TCP_ACTION_FIN,
</span><span class='line'>  /* TCP_SYN_SENT   */ TCP_CLOSE,
</span><span class='line'>  /* TCP_SYN_RECV   */ TCP_FIN_WAIT1 | TCP_ACTION_FIN,
</span><span class='line'>  /* TCP_FIN_WAIT1  */ TCP_FIN_WAIT1,
</span><span class='line'>  /* TCP_FIN_WAIT2  */ TCP_FIN_WAIT2,
</span><span class='line'>  /* TCP_TIME_WAIT  */ TCP_CLOSE,
</span><span class='line'>  /* TCP_CLOSE      */ TCP_CLOSE,
</span><span class='line'>  /* TCP_CLOSE_WAIT */ TCP_LAST_ACK  | TCP_ACTION_FIN,
</span><span class='line'>  /* TCP_LAST_ACK   */ TCP_LAST_ACK,
</span><span class='line'>  /* TCP_LISTEN     */ TCP_CLOSE,
</span><span class='line'>  /* TCP_CLOSING    */ TCP_CLOSING,
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>static int tcp_close_state(struct sock *sk)
</span><span class='line'>{
</span><span class='line'>&#9;//取得new state
</span><span class='line'>&#9;int next = (int)new_state[sk-&gt;sk_state];
</span><span class='line'>&#9;int ns = next & TCP_STATE_MASK;
</span><span class='line'>
</span><span class='line'>&#9;tcp_set_state(sk, ns);
</span><span class='line'>
</span><span class='line'>&#9;//得到action
</span><span class='line'>&#9;return next & TCP_ACTION_FIN;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>接下来来看tcp_close的剩余部分的代码，剩下的部分就是处理一些状态以及通知这里只有一个要注意的就是TCP_LINGER2这个套接字，这个套接字能够设置等待fin的超时时间，也就是tcp_sock的域linger2.我们知道系统还有一个sysctl_tcp_fin_timeout，也就是提供了一个sys文件系统的接口来修改这个值，不过我们如果设置linger2为一个大于0的值的话，内核就会取linger2这个值。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>adjudge_to_death:
</span><span class='line'>
</span><span class='line'>&#9;//得到sock的状态。
</span><span class='line'>&#9;state = sk-&gt;sk_state;
</span><span class='line'>&#9;sock_hold(sk);
</span><span class='line'>&#9;sock_orphan(sk);
</span><span class='line'>
</span><span class='line'>&#9;//唤醒阻塞在这个sock的队列(前面有详细介绍这个函数)
</span><span class='line'>&#9;release_sock(sk);
</span><span class='line'>
</span><span class='line'>&#9;local_bh_disable();
</span><span class='line'>&#9;bh_lock_sock(sk);
</span><span class='line'>&#9;WARN_ON(sock_owned_by_user(sk));
</span><span class='line'>
</span><span class='line'>&#9;//全局的cpu变量引用计数减一。
</span><span class='line'>&#9;percpu_counter_inc(sk-&gt;sk_prot-&gt;orphan_count);
</span><span class='line'>
</span><span class='line'>&#9;/* Have we already been destroyed by a softirq or backlog? */
</span><span class='line'>&#9;if (state != TCP_CLOSE && sk-&gt;sk_state == TCP_CLOSE)
</span><span class='line'>&#9;&#9;goto out;
</span><span class='line'>
</span><span class='line'>&#9;//如果状态为TCP_FIN_WAIT2,说明接收了ack，在等待对端的fin。
</span><span class='line'>&#9;if (sk-&gt;sk_state == TCP_FIN_WAIT2) {
</span><span class='line'>&#9;&#9;struct tcp_sock *tp = tcp_sk(sk);
</span><span class='line'>&#9;&#9;//超时时间小于0,则说明马上超时，设置状态为tcp_close,然后发送rst给对端。
</span><span class='line'>&#9;&#9;if (tp-&gt;linger2 &lt; 0) {
</span><span class='line'>&#9;&#9;&#9;tcp_set_state(sk, TCP_CLOSE);
</span><span class='line'>&#9;&#9;&#9;tcp_send_active_reset(sk, GFP_ATOMIC);
</span><span class='line'>&#9;&#9;&#9;NET_INC_STATS_BH(sock_net(sk),
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;LINUX_MIB_TCPABORTONLINGER);
</span><span class='line'>&#9;&#9;} else {
</span><span class='line'>&#9;&#9;&#9;//得到等待fin的超时时间。这里主要也就是在linger2和sysctl_tcp_fin_timeout中来取得。
</span><span class='line'>&#9;&#9;&#9;const int tmo = tcp_fin_time(sk);
</span><span class='line'>&#9;&#9;&#9;//如果超时时间太长，则启动keepalive定时器发送探测报。
</span><span class='line'>&#9;&#9;&#9;if (tmo &gt; TCP_TIMEWAIT_LEN) {
</span><span class='line'>&#9;&#9;&#9;&#9;inet_csk_reset_keepalive_timer(sk,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;tmo - TCP_TIMEWAIT_LEN);
</span><span class='line'>&#9;&#9;&#9;} else {
</span><span class='line'>&#9;&#9;&#9;&#9;//否则进入time_wait状态。
</span><span class='line'>&#9;&#9;&#9;&#9;tcp_time_wait(sk, TCP_FIN_WAIT2, tmo);
</span><span class='line'>&#9;&#9;&#9;&#9;goto out;
</span><span class='line'>&#9;&#9;&#9;}
</span><span class='line'>&#9;&#9;}
</span><span class='line'>&#9;}
</span><span class='line'>&#9;......................................
</span><span class='line'>
</span><span class='line'>&#9;//如果sk的状态为tcp_close则destroy掉这个sk
</span><span class='line'>&#9;if (sk-&gt;sk_state == TCP_CLOSE)
</span><span class='line'>&#9;&#9;inet_csk_destroy_sock(sk);
</span><span class='line'>&#9;/* Otherwise, socket is reprieved until protocol close. */
</span><span class='line'>
</span><span class='line'>out:
</span><span class='line'>&#9;bh_unlock_sock(sk);
</span><span class='line'>&#9;local_bh_enable();
</span><span class='line'>&#9;sock_put(sk);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>然后来看send_fin的实现，这个函数用来发送一个fin，并且尽量发送完发送缓冲区中的数据：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void tcp_send_fin(struct sock *sk)
</span><span class='line'>{
</span><span class='line'>&#9;struct tcp_sock *tp = tcp_sk(sk);
</span><span class='line'>&#9;//取得写bufer的尾部。
</span><span class='line'>&#9;struct sk_buff *skb = tcp_write_queue_tail(sk);
</span><span class='line'>&#9;int mss_now;
</span><span class='line'>
</span><span class='line'>&#9;/* Optimization, tack on the FIN if we have a queue of
</span><span class='line'>&#9; * unsent frames.  But be careful about outgoing SACKS
</span><span class='line'>&#9; * and IP options.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;mss_now = tcp_current_mss(sk);
</span><span class='line'>&#9;//如果发送队列不为空，此时我们只需要设置sk buffer的标记位(也就是tcp报文的控制位为fin)，可以看到我们是加到写buffer的尾部，这里是为了能尽量将写buffer中的数据全部传出)
</span><span class='line'>&#9;if (tcp_send_head(sk) != NULL) {
</span><span class='line'>&#9;&#9;TCP_SKB_CB(skb)-&gt;flags |= TCPCB_FLAG_FIN;
</span><span class='line'>&#9;&#9;TCP_SKB_CB(skb)-&gt;end_seq++;
</span><span class='line'>&#9;&#9;tp-&gt;write_seq++;
</span><span class='line'>&#9;} else {
</span><span class='line'>&#9;..................................
</span><span class='line'>&#9;&#9;//到这里标明发送缓冲区位空，因此我们需要新建一个sk buffer，然后设置标记位，并加入到写buffer。
</span><span class='line'>&#9;&#9;skb_reserve(skb, MAX_TCP_HEADER);
</span><span class='line'>&#9;&#9;/* FIN eats a sequence byte, write_seq advanced by tcp_queue_skb(). */
</span><span class='line'>&#9;&#9;tcp_init_nondata_skb(skb, tp-&gt;write_seq,
</span><span class='line'>&#9;&#9;&#9;&#9;&#9; TCPCB_FLAG_ACK | TCPCB_FLAG_FIN);
</span><span class='line'>&#9;&#9;tcp_queue_skb(sk, skb);
</span><span class='line'>&#9;}
</span><span class='line'>&#9;//发送写缓冲区中的数据。
</span><span class='line'>&#9;__tcp_push_pending_frames(sk, mss_now, TCP_NAGLE_OFF);
</span><span class='line'>}
</span><span class='line'>void __tcp_push_pending_frames(struct sock *sk, unsigned int cur_mss,
</span><span class='line'>&#9;&#9;&#9;&#9;   int nonagle)
</span><span class='line'>{
</span><span class='line'>&#9;struct sk_buff *skb = tcp_send_head(sk);
</span><span class='line'>
</span><span class='line'>&#9;if (!skb)
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>
</span><span class='line'>&#9;/* If we are closed, the bytes will have to remain here.
</span><span class='line'>&#9; * In time closedown will finish, we empty the write queue and
</span><span class='line'>&#9; * all will be happy.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;if (unlikely(sk-&gt;sk_state == TCP_CLOSE))
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>&#9;//发送数据，这里关闭了nagle。也就是立即将数据全部发送出去(我前面的blog有详细解释这个函数).
</span><span class='line'>&#9;if (tcp_write_xmit(sk, cur_mss, nonagle, 0, GFP_ATOMIC))
</span><span class='line'>&#9;&#9;tcp_check_probe_timer(sk);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>接下来来看shutdown的实现。在2.26.31中，系统调用的实现有些变化。</h4>

<p>这里我们要知道shutdown会将写缓冲区的数据发出，然后唤醒阻塞的进程，来读取读缓冲区中的数据。</p>

<p>这个系统调用所对应的内核函数就是os_shutdown_socket。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#define SHUT_RD 0
</span><span class='line'>#define SHUT_WR 1
</span><span class='line'>#define SHUT_RDWR 2
</span><span class='line'>
</span><span class='line'>int os_shutdown_socket(int fd, int r, int w)
</span><span class='line'>{
</span><span class='line'>&#9;int what, err;
</span><span class='line'>
</span><span class='line'>&#9;if (r && w)
</span><span class='line'>&#9;&#9;what = SHUT_RDWR;
</span><span class='line'>&#9;else if (r)
</span><span class='line'>&#9;&#9;what = SHUT_RD;
</span><span class='line'>&#9;else if (w)
</span><span class='line'>&#9;&#9;what = SHUT_WR;
</span><span class='line'>&#9;else
</span><span class='line'>&#9;&#9;return -EINVAL;
</span><span class='line'>
</span><span class='line'>&#9;//调用socket的shutdown也就是kernel_sock_shutdown
</span><span class='line'>&#9;err = shutdown(fd, what);
</span><span class='line'>&#9;if (err &lt; 0)
</span><span class='line'>&#9;&#9;return -errno;
</span><span class='line'>&#9;return 0;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>int kernel_sock_shutdown(struct socket *sock, enum sock_shutdown_cmd how)
</span><span class='line'>{
</span><span class='line'>&#9;//他最终会调用inet_shutdown
</span><span class='line'>&#9;return sock-&gt;ops-&gt;shutdown(sock, how);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>来看inet_shutdown的实现.这个函数的主要工作就是通过判断sock的状态不同来调用相关的函数：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int inet_shutdown(struct socket *sock, int how)
</span><span class='line'>{
</span><span class='line'>&#9;struct sock *sk = sock-&gt;sk;
</span><span class='line'>&#9;int err = 0;
</span><span class='line'>
</span><span class='line'>&#9;/* This should really check to make sure
</span><span class='line'>&#9; * the socket is a TCP socket. (WHY AC...)
</span><span class='line'>&#9; */
</span><span class='line'>&#9;//这里要注意每个how都是加1的，这说明在内核里读写是为1,2,3
</span><span class='line'>&#9;how++; /* maps 0-&gt;1 has the advantage of making bit 1 rcvs and
</span><span class='line'>&#9;&#9;&#9;   1-&gt;2 bit 2 snds.
</span><span class='line'>&#9;&#9;&#9;   2-&gt;3 */
</span><span class='line'>&#9;//判断how的合法性。
</span><span class='line'>&#9;if ((how & ~SHUTDOWN_MASK) || !how) /* MAXINT-&gt;0 */
</span><span class='line'>&#9;&#9;return -EINVAL;
</span><span class='line'>&#9;//锁住sock
</span><span class='line'>&#9;lock_sock(sk);
</span><span class='line'>
</span><span class='line'>&#9;//SS_CONNECTING说明这个sock的连接正在处理中。state域表示socket当前的内部状态
</span><span class='line'>&#9;if (sock-&gt;state == SS_CONNECTING) {
</span><span class='line'>&#9;&#9;//如果状态为这几个状态，说明是处于半连接处理阶段，此时设置状态为SS_DISCONNECTING
</span><span class='line'>&#9;&#9;if ((1 &lt;&lt; sk-&gt;sk_state) &
</span><span class='line'>&#9;&#9;&#9;(TCPF_SYN_SENT | TCPF_SYN_RECV | TCPF_CLOSE))
</span><span class='line'>&#9;&#9;&#9;sock-&gt;state = SS_DISCONNECTING;
</span><span class='line'>&#9;&#9;else
</span><span class='line'>&#9;&#9;&#9;//否则设置为连接完毕
</span><span class='line'>&#9;&#9;&#9;sock-&gt;state = SS_CONNECTED;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;//除过TCP_LISTEN以及TCP_SYN_SENT状态外的其他状态最终都会进入sk-&gt;sk_prot-&gt;shutdown也就是tcp_shutdown函数。
</span><span class='line'>
</span><span class='line'>&#9;switch (sk-&gt;sk_state) {
</span><span class='line'>&#9;//如果状态为tco_close则设置错误号，然后进入default处理
</span><span class='line'>&#9;case TCP_CLOSE:
</span><span class='line'>&#9;&#9;err = -ENOTCONN;
</span><span class='line'>&#9;&#9;/* Hack to wake up other listeners, who can poll for
</span><span class='line'>&#9;&#9;   POLLHUP, even on eg. unconnected UDP sockets -- RR */
</span><span class='line'>&#9;default:
</span><span class='line'>&#9;&#9;sk-&gt;sk_shutdown |= how;
</span><span class='line'>&#9;&#9;if (sk-&gt;sk_prot-&gt;shutdown)
</span><span class='line'>&#9;&#9;&#9;sk-&gt;sk_prot-&gt;shutdown(sk, how);
</span><span class='line'>&#9;&#9;break;
</span><span class='line'>
</span><span class='line'>&#9;/* Remaining two branches are temporary solution for missing
</span><span class='line'>&#9; * close() in multithreaded environment. It is _not_ a good idea,
</span><span class='line'>&#9; * but we have no choice until close() is repaired at VFS level.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;case TCP_LISTEN:
</span><span class='line'>&#9;&#9;//如果不为SHUT_RD则跳出switch，否则进入tcp_syn_sent的处理。
</span><span class='line'>&#9;&#9;if (!(how & RCV_SHUTDOWN))
</span><span class='line'>&#9;&#9;&#9;break;
</span><span class='line'>&#9;&#9;/* Fall through */
</span><span class='line'>&#9;case TCP_SYN_SENT:
</span><span class='line'>&#9;&#9;//断开连接，然后设置state
</span><span class='line'>&#9;&#9;err = sk-&gt;sk_prot-&gt;disconnect(sk, O_NONBLOCK);
</span><span class='line'>&#9;&#9;sock-&gt;state = err ? SS_DISCONNECTING : SS_UNCONNECTED;
</span><span class='line'>&#9;&#9;break;
</span><span class='line'>&#9;}
</span><span class='line'>
</span><span class='line'>&#9;/* Wake up anyone sleeping in poll. */
</span><span class='line'>&#9;//唤醒阻塞在这个socket上的进程，这里是为了将读缓冲区的数据尽量读完。
</span><span class='line'>&#9;sk-&gt;sk_state_change(sk);
</span><span class='line'>&#9;release_sock(sk);
</span><span class='line'>&#9;return err;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>来看tcp_shutdown函数。</p>

<p>这里要注意，当只关闭读的话，并不会引起发送fin，也就是只会设置个标记，然后在读取数据的时候返回错误。而关闭写端，则就会引起发送fin。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void tcp_shutdown(struct sock *sk, int how)
</span><span class='line'>{
</span><span class='line'>&#9;/*  We need to grab some memory, and put together a FIN,
</span><span class='line'>&#9; *  and then put it into the queue to be sent.
</span><span class='line'>&#9; *      Tim MacKenzie(tym@dibbler.cs.monash.edu.au) 4 Dec '92.
</span><span class='line'>&#9; */
</span><span class='line'>&#9;//如果为SHUT_RD则直接返回。
</span><span class='line'>&#9;if (!(how & SEND_SHUTDOWN))
</span><span class='line'>&#9;&#9;return;
</span><span class='line'>
</span><span class='line'>&#9;/* If we've already sent a FIN, or it's a closed state, skip this. */
</span><span class='line'>&#9;//这里英文注释很详细我就不多解释了。
</span><span class='line'>&#9;if ((1 &lt;&lt; sk-&gt;sk_state) &
</span><span class='line'>&#9;&#9;(TCPF_ESTABLISHED | TCPF_SYN_SENT |
</span><span class='line'>&#9;&#9; TCPF_SYN_RECV | TCPF_CLOSE_WAIT)) {
</span><span class='line'>&#9;&#9;/* Clear out any half completed packets.  FIN if needed. */
</span><span class='line'>&#9;&#9;//和tcp_close那边处理一样
</span><span class='line'>&#9;&#9;if (tcp_close_state(sk))
</span><span class='line'>&#9;&#9;&#9;tcp_send_fin(sk);
</span><span class='line'>&#9;}
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>最后来看sock_def_readable它就是sk->sk_state_change。也就是用来唤醒阻塞的进程。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>static void sock_def_readable(struct sock *sk, int len)
</span><span class='line'>{
</span><span class='line'>&#9;read_lock(&sk-&gt;sk_callback_lock);
</span><span class='line'>&#9;//判断是否有进程在等待这个sk
</span><span class='line'>&#9;if (sk_has_sleeper(sk))
</span><span class='line'>&#9;//有的话，唤醒进程，这里可以看到递交给上层的是POLLIN,也就是读事件。
</span><span class='line'>&#9;wake_up_interruptible_sync_poll(sk-&gt;sk_sleep, POLLIN |
</span><span class='line'>&#9;&#9;&#9;&#9;&#9;&#9;POLLRDNORM | POLLRDBAND);
</span><span class='line'>
</span><span class='line'>&#9;//这里异步唤醒，可以看到这里也是POLL_IN.
</span><span class='line'>&#9;sk_wake_async(sk, SOCK_WAKE_WAITD, POLL_IN);
</span><span class='line'>&#9;read_unlock(&sk-&gt;sk_callback_lock);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>可以看到shutdown函数只会处理SEND_SHUTDOWN。并且当调用shutdown之后，读缓冲区，还可以继续读取。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/23">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/21">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
<h1>Categories</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/language/'>language</a><a href='##' onmousedown=showDiv('language') id='aexp_language'><span class='exp_style' id='exp_language'>[+]</span></a><span class='right_span'>(40)</span></li>
<div id='language' class='catsub'><li><a href='/blog/cats/language~c/?opendiv=language'>c</a><a href='##' onmousedown=showDiv('language~c') id='aexp_language~c'><span class='exp_style' id='exp_language~c'>[+]</span></a><span class='right_span'>23</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~c')) document.getElementById('aexp_language~c').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~java/?opendiv=language'>java</a><a href='##' onmousedown=showDiv('language~java') id='aexp_language~java'><span class='exp_style' id='exp_language~java'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('language~java')) document.getElementById('aexp_language~java').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/language~web/?opendiv=language'>web</a><a href='##' onmousedown=showDiv('language~web') id='aexp_language~web'><span class='exp_style' id='exp_language~web'>[+]</span></a><span class='right_span'>6</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('language')) document.getElementById('aexp_language').style.visibility = 'hidden';
if (!document.getElementById('language~web')) document.getElementById('aexp_language~web').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/compiler/'>compiler</a><a href='##' onmousedown=showDiv('compiler') id='aexp_compiler'><span class='exp_style' id='exp_compiler'>[+]</span></a><span class='right_span'>(14)</span></li>
<div id='compiler' class='catsub'><li><a href='/blog/cats/compiler~base/?opendiv=compiler'>base</a><a href='##' onmousedown=showDiv('compiler~base') id='aexp_compiler~base'><span class='exp_style' id='exp_compiler~base'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler~base')) document.getElementById('aexp_compiler~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/compiler~make/?opendiv=compiler'>make</a><a href='##' onmousedown=showDiv('compiler~make') id='aexp_compiler~make'><span class='exp_style' id='exp_compiler~make'>[+]</span></a><span class='right_span'>4</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('compiler')) document.getElementById('aexp_compiler').style.visibility = 'hidden';
if (!document.getElementById('compiler~make')) document.getElementById('aexp_compiler~make').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/assembly/'>assembly</a><a href='##' onmousedown=showDiv('assembly') id='aexp_assembly'><span class='exp_style' id='exp_assembly'>[+]</span></a><span class='right_span'>(15)</span></li>
<div id='assembly' class='catsub'><li><a href='/blog/cats/assembly~arm/?opendiv=assembly'>arm</a><a href='##' onmousedown=showDiv('assembly~arm') id='aexp_assembly~arm'><span class='exp_style' id='exp_assembly~arm'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly~arm')) document.getElementById('aexp_assembly~arm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/assembly~base/?opendiv=assembly'>base</a><a href='##' onmousedown=showDiv('assembly~base') id='aexp_assembly~base'><span class='exp_style' id='exp_assembly~base'>[+]</span></a><span class='right_span'>13</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('assembly')) document.getElementById('aexp_assembly').style.visibility = 'hidden';
if (!document.getElementById('assembly~base')) document.getElementById('aexp_assembly~base').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/tools/'>tools</a><a href='##' onmousedown=showDiv('tools') id='aexp_tools'><span class='exp_style' id='exp_tools'>[+]</span></a><span class='right_span'>(55)</span></li>
<div id='tools' class='catsub'><li><a href='/blog/cats/tools~base/?opendiv=tools'>base</a><a href='##' onmousedown=showDiv('tools~base') id='aexp_tools~base'><span class='exp_style' id='exp_tools~base'>[+]</span></a><span class='right_span'>14</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~base')) document.getElementById('aexp_tools~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ci/?opendiv=tools'>ci</a><a href='##' onmousedown=showDiv('tools~ci') id='aexp_tools~ci'><span class='exp_style' id='exp_tools~ci'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~ci')) document.getElementById('aexp_tools~ci').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~command/?opendiv=tools'>command</a><a href='##' onmousedown=showDiv('tools~command') id='aexp_tools~command'><span class='exp_style' id='exp_tools~command'>[+]</span></a><span class='right_span'>13</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~command')) document.getElementById('aexp_tools~command').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~git/?opendiv=tools'>git</a><a href='##' onmousedown=showDiv('tools~git') id='aexp_tools~git'><span class='exp_style' id='exp_tools~git'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~git')) document.getElementById('aexp_tools~git').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~graphviz,-codeviz/?opendiv=tools'>graphviz、codeviz</a><a href='##' onmousedown=showDiv('tools~graphviz、codeviz') id='aexp_tools~graphviz、codeviz'><span class='exp_style' id='exp_tools~graphviz、codeviz'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~graphviz、codeviz')) document.getElementById('aexp_tools~graphviz、codeviz').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~haproxy/?opendiv=tools'>haproxy</a><a href='##' onmousedown=showDiv('tools~haproxy') id='aexp_tools~haproxy'><span class='exp_style' id='exp_tools~haproxy'>[+]</span></a><span class='right_span'>9</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~haproxy')) document.getElementById('aexp_tools~haproxy').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~mysql/?opendiv=tools'>mysql</a><a href='##' onmousedown=showDiv('tools~mysql') id='aexp_tools~mysql'><span class='exp_style' id='exp_tools~mysql'>[+]</span></a><span class='right_span'>6</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('tools~mysql')) document.getElementById('aexp_tools~mysql').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/tools~ssh/?opendiv=tools'>ssh</a><a href='##' onmousedown=showDiv('tools~ssh') id='aexp_tools~ssh'><span class='exp_style' id='exp_tools~ssh'>[+]</span></a><span class='right_span'>3</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('tools')) document.getElementById('aexp_tools').style.visibility = 'hidden';
if (!document.getElementById('tools~ssh')) document.getElementById('aexp_tools~ssh').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/system/'>system</a><a href='##' onmousedown=showDiv('system') id='aexp_system'><span class='exp_style' id='exp_system'>[+]</span></a><span class='right_span'>(54)</span></li>
<div id='system' class='catsub'><li><a href='/blog/cats/system~base/?opendiv=system'>base</a><a href='##' onmousedown=showDiv('system~base') id='aexp_system~base'><span class='exp_style' id='exp_system~base'>[+]</span></a><span class='right_span'>17</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~base')) document.getElementById('aexp_system~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~centos/?opendiv=system'>centos</a><a href='##' onmousedown=showDiv('system~centos') id='aexp_system~centos'><span class='exp_style' id='exp_system~centos'>[+]</span></a><span class='right_span'>8</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~centos')) document.getElementById('aexp_system~centos').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~cgroup/?opendiv=system'>cgroup</a><a href='##' onmousedown=showDiv('system~cgroup') id='aexp_system~cgroup'><span class='exp_style' id='exp_system~cgroup'>[+]</span></a><span class='right_span'>11</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~cgroup')) document.getElementById('aexp_system~cgroup').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~kvm/?opendiv=system'>kvm</a><a href='##' onmousedown=showDiv('system~kvm') id='aexp_system~kvm'><span class='exp_style' id='exp_system~kvm'>[+]</span></a><span class='right_span'>7</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~kvm')) document.getElementById('aexp_system~kvm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~namespace/?opendiv=system'>namespace</a><a href='##' onmousedown=showDiv('system~namespace') id='aexp_system~namespace'><span class='exp_style' id='exp_system~namespace'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('system~namespace')) document.getElementById('aexp_system~namespace').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/system~ubuntu/?opendiv=system'>ubuntu</a><a href='##' onmousedown=showDiv('system~ubuntu') id='aexp_system~ubuntu'><span class='exp_style' id='exp_system~ubuntu'>[+]</span></a><span class='right_span'>9</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('system')) document.getElementById('aexp_system').style.visibility = 'hidden';
if (!document.getElementById('system~ubuntu')) document.getElementById('aexp_system~ubuntu').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/kernel/'>kernel</a><a href='##' onmousedown=showDiv('kernel') id='aexp_kernel'><span class='exp_style' id='exp_kernel'>[+]</span></a><span class='right_span'>(163)</span></li>
<div id='kernel' class='catsub'><li><a href='/blog/cats/kernel~base/?opendiv=kernel'>base</a><a href='##' onmousedown=showDiv('kernel~base') id='aexp_kernel~base'><span class='exp_style' id='exp_kernel~base'>[+]</span></a><span class='right_span'>19</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~base')) document.getElementById('aexp_kernel~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~fs/?opendiv=kernel'>fs</a><a href='##' onmousedown=showDiv('kernel~fs') id='aexp_kernel~fs'><span class='exp_style' id='exp_kernel~fs'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~fs')) document.getElementById('aexp_kernel~fs').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~irq/?opendiv=kernel'>irq</a><a href='##' onmousedown=showDiv('kernel~irq') id='aexp_kernel~irq'><span class='exp_style' id='exp_kernel~irq'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~irq')) document.getElementById('aexp_kernel~irq').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~kexec/?opendiv=kernel'>kexec</a><a href='##' onmousedown=showDiv('kernel~kexec') id='aexp_kernel~kexec'><span class='exp_style' id='exp_kernel~kexec'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~kexec')) document.getElementById('aexp_kernel~kexec').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~mm/?opendiv=kernel'>mm</a><a href='##' onmousedown=showDiv('kernel~mm') id='aexp_kernel~mm'><span class='exp_style' id='exp_kernel~mm'>[+]</span></a><span class='right_span'>33</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~mm')) document.getElementById('aexp_kernel~mm').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~net/?opendiv=kernel'>net</a><a href='##' onmousedown=showDiv('kernel~net') id='aexp_kernel~net'><span class='exp_style' id='exp_kernel~net'>[+]</span></a><span class='right_span'>80</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel~net')) document.getElementById('aexp_kernel~net').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/kernel~sched/?opendiv=kernel'>sched</a><a href='##' onmousedown=showDiv('kernel~sched') id='aexp_kernel~sched'><span class='exp_style' id='exp_kernel~sched'>[+]</span></a><span class='right_span'>19</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('kernel')) document.getElementById('aexp_kernel').style.visibility = 'hidden';
if (!document.getElementById('kernel~sched')) document.getElementById('aexp_kernel~sched').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/android/'>android</a><a href='##' onmousedown=showDiv('android') id='aexp_android'><span class='exp_style' id='exp_android'>[+]</span></a><span class='right_span'>(22)</span></li>
<div id='android' class='catsub'><li><a href='/blog/cats/android~base/?opendiv=android'>base</a><a href='##' onmousedown=showDiv('android~base') id='aexp_android~base'><span class='exp_style' id='exp_android~base'>[+]</span></a><span class='right_span'>13</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~base')) document.getElementById('aexp_android~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~i9507v/?opendiv=android'>i9507v</a><a href='##' onmousedown=showDiv('android~i9507v') id='aexp_android~i9507v'><span class='exp_style' id='exp_android~i9507v'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~i9507v')) document.getElementById('aexp_android~i9507v').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~me722/?opendiv=android'>me722</a><a href='##' onmousedown=showDiv('android~me722') id='aexp_android~me722'><span class='exp_style' id='exp_android~me722'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~me722')) document.getElementById('aexp_android~me722').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~nx403a/?opendiv=android'>nx403a</a><a href='##' onmousedown=showDiv('android~nx403a') id='aexp_android~nx403a'><span class='exp_style' id='exp_android~nx403a'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('android~nx403a')) document.getElementById('aexp_android~nx403a').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/android~s5830/?opendiv=android'>s5830</a><a href='##' onmousedown=showDiv('android~s5830') id='aexp_android~s5830'><span class='exp_style' id='exp_android~s5830'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('android')) document.getElementById('aexp_android').style.visibility = 'hidden';
if (!document.getElementById('android~s5830')) document.getElementById('aexp_android~s5830').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/debug/'>debug</a><a href='##' onmousedown=showDiv('debug') id='aexp_debug'><span class='exp_style' id='exp_debug'>[+]</span></a><span class='right_span'>(75)</span></li>
<div id='debug' class='catsub'><li><a href='/blog/cats/debug~base/?opendiv=debug'>base</a><a href='##' onmousedown=showDiv('debug~base') id='aexp_debug~base'><span class='exp_style' id='exp_debug~base'>[+]</span></a><span class='right_span'>19</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~base')) document.getElementById('aexp_debug~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~dwarf/?opendiv=debug'>dwarf</a><a href='##' onmousedown=showDiv('debug~dwarf') id='aexp_debug~dwarf'><span class='exp_style' id='exp_debug~dwarf'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~dwarf')) document.getElementById('aexp_debug~dwarf').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~gdb/?opendiv=debug'>gdb</a><a href='##' onmousedown=showDiv('debug~gdb') id='aexp_debug~gdb'><span class='exp_style' id='exp_debug~gdb'>[+]</span></a><span class='right_span'>8</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~gdb')) document.getElementById('aexp_debug~gdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kdump,-crash/?opendiv=debug'>kdump、crash</a><a href='##' onmousedown=showDiv('debug~kdump、crash') id='aexp_debug~kdump、crash'><span class='exp_style' id='exp_debug~kdump、crash'>[+]</span></a><span class='right_span'>10</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kdump、crash')) document.getElementById('aexp_debug~kdump、crash').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kgdb/?opendiv=debug'>kgdb</a><a href='##' onmousedown=showDiv('debug~kgdb') id='aexp_debug~kgdb'><span class='exp_style' id='exp_debug~kgdb'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kgdb')) document.getElementById('aexp_debug~kgdb').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~kprobe/?opendiv=debug'>kprobe</a><a href='##' onmousedown=showDiv('debug~kprobe') id='aexp_debug~kprobe'><span class='exp_style' id='exp_debug~kprobe'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~kprobe')) document.getElementById('aexp_debug~kprobe').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~ksplice/?opendiv=debug'>ksplice</a><a href='##' onmousedown=showDiv('debug~ksplice') id='aexp_debug~ksplice'><span class='exp_style' id='exp_debug~ksplice'>[+]</span></a><span class='right_span'>3</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~ksplice')) document.getElementById('aexp_debug~ksplice').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~mark/?opendiv=debug'>mark</a><a href='##' onmousedown=showDiv('debug~mark') id='aexp_debug~mark'><span class='exp_style' id='exp_debug~mark'>[+]</span></a><span class='right_span'>17</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~mark')) document.getElementById('aexp_debug~mark').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~perf/?opendiv=debug'>perf</a><a href='##' onmousedown=showDiv('debug~perf') id='aexp_debug~perf'><span class='exp_style' id='exp_debug~perf'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('debug~perf')) document.getElementById('aexp_debug~perf').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/debug~systemtap/?opendiv=debug'>systemtap</a><a href='##' onmousedown=showDiv('debug~systemtap') id='aexp_debug~systemtap'><span class='exp_style' id='exp_debug~systemtap'>[+]</span></a><span class='right_span'>5</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('debug')) document.getElementById('aexp_debug').style.visibility = 'hidden';
if (!document.getElementById('debug~systemtap')) document.getElementById('aexp_debug~systemtap').style.visibility = 'hidden';
</script>
<li><div style="background:#DDD; height:0.3em;"></div></li><li class='catclass'><a href='/blog/cats/algorithm/'>algorithm</a><a href='##' onmousedown=showDiv('algorithm') id='aexp_algorithm'><span class='exp_style' id='exp_algorithm'>[+]</span></a><span class='right_span'>(27)</span></li>
<div id='algorithm' class='catsub'><li><a href='/blog/cats/algorithm~base/?opendiv=algorithm'>base</a><a href='##' onmousedown=showDiv('algorithm~base') id='aexp_algorithm~base'><span class='exp_style' id='exp_algorithm~base'>[+]</span></a><span class='right_span'>20</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~base')) document.getElementById('aexp_algorithm~base').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~dp/?opendiv=algorithm'>dp</a><a href='##' onmousedown=showDiv('algorithm~dp') id='aexp_algorithm~dp'><span class='exp_style' id='exp_algorithm~dp'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~dp')) document.getElementById('aexp_algorithm~dp').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~ds/?opendiv=algorithm'>ds</a><a href='##' onmousedown=showDiv('algorithm~ds') id='aexp_algorithm~ds'><span class='exp_style' id='exp_algorithm~ds'>[+]</span></a><span class='right_span'>4</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm~ds')) document.getElementById('aexp_algorithm~ds').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/algorithm~tc/?opendiv=algorithm'>tc</a><a href='##' onmousedown=showDiv('algorithm~tc') id='aexp_algorithm~tc'><span class='exp_style' id='exp_algorithm~tc'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('algorithm')) document.getElementById('aexp_algorithm').style.visibility = 'hidden';
if (!document.getElementById('algorithm~tc')) document.getElementById('aexp_algorithm~tc').style.visibility = 'hidden';
</script>
<li class='catclass'><a href='/blog/cats/blog/'>blog</a><a href='##' onmousedown=showDiv('blog') id='aexp_blog'><span class='exp_style' id='exp_blog'>[+]</span></a><span class='right_span'>(11)</span></li>
<div id='blog' class='catsub'><li><a href='/blog/cats/blog~hello/?opendiv=blog'>hello</a><a href='##' onmousedown=showDiv('blog~hello') id='aexp_blog~hello'><span class='exp_style' id='exp_blog~hello'>[+]</span></a><span class='right_span'>1</span></li>
<div id='blog~hello' class='catsub2'><li><a href='/blog/cats/blog~hello~hi/?opendiv=blog~hello'>hi</a><span class='right_span'>1</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~hello')) document.getElementById('aexp_blog~hello').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~jekyll/?opendiv=blog'>jekyll</a><a href='##' onmousedown=showDiv('blog~jekyll') id='aexp_blog~jekyll'><span class='exp_style' id='exp_blog~jekyll'>[+]</span></a><span class='right_span'>2</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~jekyll')) document.getElementById('aexp_blog~jekyll').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~markdown/?opendiv=blog'>markdown</a><a href='##' onmousedown=showDiv('blog~markdown') id='aexp_blog~markdown'><span class='exp_style' id='exp_blog~markdown'>[+]</span></a><span class='right_span'>1</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~markdown')) document.getElementById('aexp_blog~markdown').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~octopress/?opendiv=blog'>octopress</a><a href='##' onmousedown=showDiv('blog~octopress') id='aexp_blog~octopress'><span class='exp_style' id='exp_blog~octopress'>[+]</span></a><span class='right_span'>5</span></li>
<script language='javascript' type='text/javascript'>
if (!document.getElementById('blog~octopress')) document.getElementById('aexp_blog~octopress').style.visibility = 'hidden';
</script>
<li><a href='/blog/cats/blog~ruby/?opendiv=blog'>ruby</a><a href='##' onmousedown=showDiv('blog~ruby') id='aexp_blog~ruby'><span class='exp_style' id='exp_blog~ruby'>[+]</span></a><span class='right_span'>2</span></li>
</div><script language='javascript' type='text/javascript'>
if (!document.getElementById('blog')) document.getElementById('aexp_blog').style.visibility = 'hidden';
if (!document.getElementById('blog~ruby')) document.getElementById('aexp_blog~ruby').style.visibility = 'hidden';
</script>

</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Date Categories</h1>
<head>
</head>
<body>
<div id="menu">
<ul>
<li class='catclass'><a href='/blog/cats/2016/'>2016</a><a href='##' onmousedown=showDiv('2016')><span class='exp_style' id='exp_2016'>[+]</span></a><span class='right_span'>(18)</span></li>
<div id='2016' class='catsub'><li><a href='/blog/cats/2016~03/?opendiv=2016'>2016-03</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2016~02/?opendiv=2016'>2016-02</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2016~01/?opendiv=2016'>2016-01</a><span class='right_span'>6</span></li>
</div><li class='catclass'><a href='/blog/cats/2015/'>2015</a><a href='##' onmousedown=showDiv('2015')><span class='exp_style' id='exp_2015'>[+]</span></a><span class='right_span'>(207)</span></li>
<div id='2015' class='catsub'><li><a href='/blog/cats/2015~12/?opendiv=2015'>2015-12</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2015~11/?opendiv=2015'>2015-11</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2015~10/?opendiv=2015'>2015-10</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2015~09/?opendiv=2015'>2015-09</a><span class='right_span'>18</span></li>
<li><a href='/blog/cats/2015~08/?opendiv=2015'>2015-08</a><span class='right_span'>25</span></li>
<li><a href='/blog/cats/2015~07/?opendiv=2015'>2015-07</a><span class='right_span'>31</span></li>
<li><a href='/blog/cats/2015~06/?opendiv=2015'>2015-06</a><span class='right_span'>24</span></li>
<li><a href='/blog/cats/2015~05/?opendiv=2015'>2015-05</a><span class='right_span'>22</span></li>
<li><a href='/blog/cats/2015~04/?opendiv=2015'>2015-04</a><span class='right_span'>23</span></li>
<li><a href='/blog/cats/2015~03/?opendiv=2015'>2015-03</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2015~02/?opendiv=2015'>2015-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2015~01/?opendiv=2015'>2015-01</a><span class='right_span'>19</span></li>
</div><li class='catclass'><a href='/blog/cats/2014/'>2014</a><a href='##' onmousedown=showDiv('2014')><span class='exp_style' id='exp_2014'>[+]</span></a><span class='right_span'>(112)</span></li>
<div id='2014' class='catsub'><li><a href='/blog/cats/2014~12/?opendiv=2014'>2014-12</a><span class='right_span'>21</span></li>
<li><a href='/blog/cats/2014~11/?opendiv=2014'>2014-11</a><span class='right_span'>19</span></li>
<li><a href='/blog/cats/2014~10/?opendiv=2014'>2014-10</a><span class='right_span'>13</span></li>
<li><a href='/blog/cats/2014~09/?opendiv=2014'>2014-09</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~08/?opendiv=2014'>2014-08</a><span class='right_span'>15</span></li>
<li><a href='/blog/cats/2014~07/?opendiv=2014'>2014-07</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~06/?opendiv=2014'>2014-06</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2014~05/?opendiv=2014'>2014-05</a><span class='right_span'>7</span></li>
<li><a href='/blog/cats/2014~04/?opendiv=2014'>2014-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2014~03/?opendiv=2014'>2014-03</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2014~02/?opendiv=2014'>2014-02</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2014~01/?opendiv=2014'>2014-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2013/'>2013</a><a href='##' onmousedown=showDiv('2013')><span class='exp_style' id='exp_2013'>[+]</span></a><span class='right_span'>(60)</span></li>
<div id='2013' class='catsub'><li><a href='/blog/cats/2013~12/?opendiv=2013'>2013-12</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~11/?opendiv=2013'>2013-11</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~10/?opendiv=2013'>2013-10</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~09/?opendiv=2013'>2013-09</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~08/?opendiv=2013'>2013-08</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2013~07/?opendiv=2013'>2013-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2013~06/?opendiv=2013'>2013-06</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2013~05/?opendiv=2013'>2013-05</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2013~03/?opendiv=2013'>2013-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2013~02/?opendiv=2013'>2013-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2013~01/?opendiv=2013'>2013-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2012/'>2012</a><a href='##' onmousedown=showDiv('2012')><span class='exp_style' id='exp_2012'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2012' class='catsub'><li><a href='/blog/cats/2012~12/?opendiv=2012'>2012-12</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~11/?opendiv=2012'>2012-11</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~10/?opendiv=2012'>2012-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2012~08/?opendiv=2012'>2012-08</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2012~05/?opendiv=2012'>2012-05</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2012~04/?opendiv=2012'>2012-04</a><span class='right_span'>9</span></li>
<li><a href='/blog/cats/2012~03/?opendiv=2012'>2012-03</a><span class='right_span'>6</span></li>
<li><a href='/blog/cats/2012~02/?opendiv=2012'>2012-02</a><span class='right_span'>5</span></li>
<li><a href='/blog/cats/2012~01/?opendiv=2012'>2012-01</a><span class='right_span'>2</span></li>
</div><li class='catclass'><a href='/blog/cats/2011/'>2011</a><a href='##' onmousedown=showDiv('2011')><span class='exp_style' id='exp_2011'>[+]</span></a><span class='right_span'>(35)</span></li>
<div id='2011' class='catsub'><li><a href='/blog/cats/2011~12/?opendiv=2011'>2011-12</a><span class='right_span'>8</span></li>
<li><a href='/blog/cats/2011~11/?opendiv=2011'>2011-11</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2011~08/?opendiv=2011'>2011-08</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~07/?opendiv=2011'>2011-07</a><span class='right_span'>3</span></li>
<li><a href='/blog/cats/2011~06/?opendiv=2011'>2011-06</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~05/?opendiv=2011'>2011-05</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~04/?opendiv=2011'>2011-04</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2011~03/?opendiv=2011'>2011-03</a><span class='right_span'>11</span></li>
<li><a href='/blog/cats/2011~02/?opendiv=2011'>2011-02</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2011~01/?opendiv=2011'>2011-01</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2010/'>2010</a><a href='##' onmousedown=showDiv('2010')><span class='exp_style' id='exp_2010'>[+]</span></a><span class='right_span'>(1)</span></li>
<div id='2010' class='catsub'><li><a href='/blog/cats/2010~07/?opendiv=2010'>2010-07</a><span class='right_span'>1</span></li>
</div><li class='catclass'><a href='/blog/cats/2009/'>2009</a><a href='##' onmousedown=showDiv('2009')><span class='exp_style' id='exp_2009'>[+]</span></a><span class='right_span'>(8)</span></li>
<div id='2009' class='catsub'><li><a href='/blog/cats/2009~12/?opendiv=2009'>2009-12</a><span class='right_span'>1</span></li>
<li><a href='/blog/cats/2009~10/?opendiv=2009'>2009-10</a><span class='right_span'>4</span></li>
<li><a href='/blog/cats/2009~09/?opendiv=2009'>2009-09</a><span class='right_span'>2</span></li>
<li><a href='/blog/cats/2009~07/?opendiv=2009'>2009-07</a><span class='right_span'>1</span></li>
</div>
</ul>
</div>
</body>
</html>
</section>

<section>
<h1>Tags</h1>
<ul class="tag-cloud">
<a style="font-size: 131%" href="/tags/gdb/">gdb(6)</a>
<a style="font-size: 100%" href="/tags/hello/">hello(1)</a>
<a style="font-size: 150%" href="/tags/koj/">koj(18)</a>
<a style="font-size: 112%" href="/tags/nvidia/">nvidia(2)</a>
<a style="font-size: 100%" href="/tags/patch/">patch(1)</a>
<a style="font-size: 100%" href="/tags/reg-exp/">reg_exp(1)</a>

</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/03/29/debug-ksplice-detail/">理解Ksplice执行过程</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/29/debug-ksplice-base/">内核热补丁技术揭秘</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/29/debug-ksplice/">ksplice 使用</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/28/debug-ftrace/">ftrace 简介</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/28/debug-debugedit_el7/">debugedit，find-debuginfo 改进及el7</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub</h1>
  
  <a href="https://github.com/abcdxyzk">abcdxyzk on GitHub</a>
  
</section>

<section>
<h1>Links</h1>
<ul>
	<li>
		<a href=http://hi.baidu.com/abcdxyzk target=_blank>My blog</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/zhangskd target=_blank>zhangsk</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/justlinux2010 target=_blank>justlinux2010</a>
	</li>
	<li>
		<a href=http://simohayha.iteye.com/ target=_blank>simohayha</a>
	</li>
	<li>
		<a href=http://linux.chinaunix.net/techdoc/net/ target=_blank>技术文档</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/cybertan target=_blank>cybertan</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/newnewman80 target=_blank>newnewman80</a>
	</li>
	<li>
		<a href=http://www.cppblog.com/fwxjj/ target=_blank>fwxjj</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/ustc_dylan target=_blank>ustc_dylan</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/nkguohao target=_blank>nkguohao</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/yusiguyuan target=_blank>yusiguyuan</a>
	</li>
	<li>
		<a href=http://www.oenhan.com/ target=_blank>oenhan</a>
	</li>
	<li>
		<a href=http://blog.csdn.net/bullbat target=_blank>bullbat</a>
	</li>
	<li>
		<a href=http://www.wowotech.net/ target=_blank>wowotech</a>
	</li>
	<li>
		<a href=http://www.lenky.info/ target=_blank>lenky</a>
	</li>
	<li>
		<a href=http://smilejay.com/ target=_blank>smilejay</a>
	</li>
	<li>
		<a href=http://blog.chinaunix.net/uid/10167808.html target=_blank>godbach</a>
	</li>
</ul>
</section>

  
<section id="comment_sidebar">
<h1>Recent Comments</h1>

<script type="text/javascript" src="http://abcdxyzk.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=32&excerpt_length=20"></script><a href="http://disqus.com/">Powered by Disqus</a>

</section>


</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - kk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <a title="Top" href="#" id="scroll2top" style="position: fixed; height: 50px; bottom: 30px; right: 25px; cursor: pointer; z-index: 9999; display: block; opacity: 1;"><img src="/images/scrollup.png"></a>
  <script src="/javascripts/scroll2top.js"></script>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253604690'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1253604690' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'abcdxyzk';
      
</script>





</body>
</html>
